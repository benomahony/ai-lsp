{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"4a41b40a96e5444ea105a5b04890e708"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"84068"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a794644d9b6edde49dfd799164ee4","spanId":"5d39c62de80e6d5f","flags":256,"name":"Initializing AI Language Server","kind":1,"startTimeUnixNano":"1762971239641474000","endTimeUnixNano":"1762971239641474000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Initializing AI Language Server"}},{"key":"logfire.msg","value":{"stringValue":"Initializing AI Language Server"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"77"}}],"status":{}},{"traceId":"019a79464696ae8ac54cf80a48966bf1","spanId":"0911b51f31ed32fd","flags":256,"name":"AI agent initialized successfully","kind":1,"startTimeUnixNano":"1762971240085992000","endTimeUnixNano":"1762971240085992000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI agent initialized successfully"}},{"key":"logfire.msg","value":{"stringValue":"AI agent initialized successfully"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"115"}}],"status":{}},{"traceId":"019a794646af7322ca6d0470c8cbf161","spanId":"5ab69ae7a44ef971","flags":256,"name":"Document opened: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762971240111188000","endTimeUnixNano":"1762971240111188000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document opened: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document opened: file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_open"}},{"key":"code.lineno","value":{"intValue":"291"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79464a9b94e1672695f2ab86afb1","spanId":"b71aeb1b7bf4d0db","parentSpanId":"aa38013c77d7efc1","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762971241116096000","endTimeUnixNano":"1762971241116096000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7946500c88b20b1d8c951012caa7","spanId":"9de8269d252a452d","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762971242508076000","endTimeUnixNano":"1762971242508076000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79464a9b94e1672695f2ab86afb1","spanId":"aa38013c77d7efc1","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762971241115616000","endTimeUnixNano":"1762971242515718000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762971242511840000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a79465014e80e7a31a138a0a89069","spanId":"94e71703d5fdf578","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762971242516719000","endTimeUnixNano":"1762971242516719000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7946509e9181b8f530b28f5e5163","spanId":"2225a4d22a632f17","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762971242654758000","endTimeUnixNano":"1762971242654758000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7946509fbe131632c392672b5f8b","spanId":"a88c6c2ec3092ba4","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762971242655051000","endTimeUnixNano":"1762971242655051000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a794651ed07e3b6035246fd48d528","spanId":"e9d80909cae35b14","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762971242989864000","endTimeUnixNano":"1762971242989864000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a794651eedc2d7701ea9433b436f7","spanId":"6f987651fcd96c16","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762971242990220000","endTimeUnixNano":"1762971242990220000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a794654870b69b0ab35edf90e4767","spanId":"1f675a1b4079b79c","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762971243655241000","endTimeUnixNano":"1762971243655241000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a794654871f2b5f5d42bad0697597","spanId":"bfe304446bf34735","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762971243655579000","endTimeUnixNano":"1762971243655579000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a79464a9b94e1672695f2ab86afb1","spanId":"a1b08c28befc4aac","parentSpanId":"6a627c700d1408cf","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762971241118964000","endTimeUnixNano":"1762971242508544000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a79464a9b94e1672695f2ab86afb1","spanId":"6a627c700d1408cf","parentSpanId":"aa38013c77d7efc1","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762971241117073000","endTimeUnixNano":"1762971242508735000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this python code for issues:\\n\\n```python\\nimport asyncio\\nimport os\\nfrom pathlib import Path\\nfrom typing import Any, Literal\\nfrom importlib.metadata import version\\nimport logfire\\n\\n# pyrefly: ignore [missing-import]\\nfrom lsprotocol.types import (\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    TEXT_DOCUMENT_DID_CHANGE,\\n    TEXT_DOCUMENT_DID_OPEN,\\n    TEXT_DOCUMENT_DID_SAVE,\\n    CodeAction,\\n    CodeActionKind,\\n    CodeActionOptions,\\n    CodeActionParams,\\n    Command,\\n    Diagnostic,\\n    DiagnosticSeverity,\\n    DidChangeTextDocumentParams,\\n    DidOpenTextDocumentParams,\\n    DidSaveTextDocumentParams,\\n    Position,\\n    Range,\\n    TextEdit,\\n    WorkspaceEdit,\\n)\\nfrom pydantic import BaseModel, Field\\nfrom pydantic_ai import Agent\\nfrom pydantic_ai.models import KnownModelName\\nfrom pydantic_settings import BaseSettings\\n\\n# pyrefly: ignore [missing-import]\\nfrom pygls.server import LanguageServer\\n\\n\\nclass Settings(BaseSettings):\\n    ai_lsp_model: KnownModelName = Field(default=\\\"google-gla:gemini-2.5-flash\\\")\\n    debounce_ms: int = Field(default=1000)\\n    max_cache_size: int = Field(default=50)\\n    configure_logfire: bool = Field(default=True)\\n    otel_exporter_otlp_endpoint: str = Field(default=\\\"http://localhost:4318\\\")\\n\\n\\nsettings = Settings()\\n\\n\\nos.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\\n\\nif settings.configure_logfire:\\n    logfire.configure(send_to_logfire=False, service_name=\\\"ai-lsp\\\")\\n    logfire.instrument_pydantic_ai()\\n    logfire.instrument_httpx(capture_all=True)\\n\\n\\nclass SuggestedFix(BaseModel):\\n    title: str\\n    target_snippet: str\\n    replacement_snippet: str\\n\\n\\nclass CodeIssue(BaseModel):\\n    issue_snippet: str\\n    severity: Literal[\\\"error\\\", \\\"warning\\\", \\\"info\\\", \\\"hint\\\"]\\n    message: str\\n    suggested_fixes: list[SuggestedFix] | None = None\\n\\n\\nclass DiagnosticResult(BaseModel):\\n    issues: list[CodeIssue]\\n\\n\\nclass AILanguageServer(LanguageServer):\\n    def __init__(self):\\n        super().__init__(\\\"ai-lsp\\\", version(\\\"ai-lsp\\\"))\\n        logfire.info(\\\"Initializing AI Language Server\\\")\\n        self._pending_tasks: dict[str, asyncio.Task[Any]] = {}\\n        self._analysis_locks: dict[str, asyncio.Lock] = {}\\n\\n        self.agent: Agent[DiagnosticResult, Any] = Agent(\\n            model=settings.ai_lsp_model,\\n            output_type=DiagnosticResult,\\n            system_prompt=\\\"\\\"\\\"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\\\"\\\"\\\",\\n        )\\n        logfire.info(\\\"AI agent initialized successfully\\\")\\n\\n    def find_snippet_in_text(\\n        self, text: str, snippet: str\\n    ) -> list[tuple[int, int, int, int]]:\\n        \\\"\\\"\\\"Find all occurrences of code snippet in text, return positions as (start_line, start_col, end_line, end_col)\\\"\\\"\\\"\\n        snippet = snippet.strip()\\n        positions = []\\n\\n        # Search for all occurrences of snippet\\n        start_pos = 0\\n        while True:\\n            start_pos = text.find(snippet, start_pos)\\n            if start_pos == -1:\\n                break\\n\\n            # Convert character position to line/column\\n            lines = text[:start_pos].split(\\\"\\\\n\\\")\\n            start_line = len(lines) - 1\\n            start_col = len(lines[-1])\\n\\n            # Calculate end position\\n            snippet_lines = snippet.split(\\\"\\\\n\\\")\\n            if len(snippet_lines) == 1:\\n                end_line = start_line\\n                end_col = start_col + len(snippet)\\n            else:\\n                end_line = start_line + len(snippet_lines) - 1\\n                end_col = len(snippet_lines[-1])\\n\\n            positions.append((start_line, start_col, end_line, end_col))\\n            start_pos += 1  # Move past this occurrence\\n\\n        if not positions:\\n            logfire.warn(f\\\"Could not find snippet '{snippet}' in text\\\")\\n        else:\\n            logfire.debug(f\\\"Found {len(positions)} occurrences of '{snippet[:20]}...'\\\")\\n\\n        return positions\\n\\n    async def debounced_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Debounced analysis that cancels previous calls\\\"\\\"\\\"\\n        # Cancel any existing task for this URI\\n        if uri in self._pending_tasks:\\n            self._pending_tasks[uri].cancel()\\n            _ = self._pending_tasks.pop(uri, None)\\n\\n        # Create new task\\n        task: asyncio.Task[None] = asyncio.create_task(self._delayed_analyze(uri, text))\\n        self._pending_tasks[uri] = task\\n\\n        try:\\n            await task\\n        except asyncio.CancelledError:\\n            logfire.debug(f\\\"Analysis cancelled for {uri}\\\")\\n        finally:\\n            # Clean up completed task\\n            if uri in self._pending_tasks and self._pending_tasks[uri] == task:\\n                _ = self._pending_tasks.pop(uri)\\n\\n    async def _delayed_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Wait for debounce period then analyze\\\"\\\"\\\"\\n        await asyncio.sleep(settings.debounce_ms / 1000.0)\\n        diagnostics = await self.analyze_document(uri, text)\\n        # pyrefly: ignore [missing-attribute]\\n        self.publish_diagnostics(uri, diagnostics)\\n        logfire.debug(f\\\"Published {len(diagnostics)} diagnostics for {uri}\\\")\\n\\n    async def analyze_document(self, uri: str, text: str) -> list[Diagnostic]:\\n        # Ensure we have a lock for this URI\\n        lock = self._analysis_locks.setdefault(uri, asyncio.Lock())\\n        async with lock:\\n            with logfire.span(\\\"analyze_document\\\", uri=uri):\\n                logfire.info(f\\\"Starting AI analysis for {uri}\\\")\\n\\n                try:\\n                    file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n                    language = self._detect_language(file_path)\\n\\n                    prompt = f\\\"\\\"\\\"Analyze this {language} code for issues:\\n\\n```{language}\\n{text}\\n```\\n\\nFile: {file_path.name}\\\"\\\"\\\"\\n\\n                    result = await self.agent.run(prompt)\\n                    logfire.info(\\n                        f\\\"AI analysis completed, found {len(result.output.issues)} issues\\\"\\n                    )\\n\\n                    diagnostics = []\\n                    for issue in result.output.issues:\\n                        positions = self.find_snippet_in_text(text, issue.issue_snippet)\\n\\n                        if positions:\\n                            start_line, start_col, end_line, end_col = positions[0]\\n                            diagnostic = Diagnostic(\\n                                range=Range(\\n                                    start=Position(\\n                                        line=start_line, character=start_col\\n                                    ),\\n                                    end=Position(line=end_line, character=end_col),\\n                                ),\\n                                message=f\\\"AI LSP: {issue.message}\\\",\\n                                severity=self._get_diagnostic_severity(issue.severity),\\n                                source=\\\"ai-lsp\\\",\\n                                data={\\n                                    \\\"issue_snippet\\\": issue.issue_snippet,\\n                                    \\\"suggested_fixes\\\": [\\n                                        {\\n                                            \\\"title\\\": fix.title,\\n                                            \\\"target_snippet\\\": fix.target_snippet,\\n                                            \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                        }\\n                                        for fix in (issue.suggested_fixes or [])\\n                                    ],\\n                                },\\n                            )\\n                            diagnostics.append(diagnostic)\\n\\n                    return diagnostics\\n\\n                except Exception as e:\\n                    logfire.error(\\n                        f\\\"AI analysis failed for {uri}: {str(e)}\\\", _exc_info=True\\n                    )\\n                    return []\\n\\n    def _get_diagnostic_severity(self, severity: str) -> DiagnosticSeverity:\\n        match severity:\\n            case \\\"error\\\":\\n                return DiagnosticSeverity.Error\\n            case \\\"warning\\\":\\n                return DiagnosticSeverity.Warning\\n            case \\\"info\\\":\\n                return DiagnosticSeverity.Information\\n            case \\\"hint\\\":\\n                return DiagnosticSeverity.Hint\\n            case _:\\n                return DiagnosticSeverity.Information\\n\\n    def _detect_language(self, file_path: Path) -> str:\\n        match file_path.suffix:\\n            case \\\".py\\\":\\n                return \\\"python\\\"\\n            case \\\".js\\\":\\n                return \\\"javascript\\\"\\n            case \\\".ts\\\":\\n                return \\\"typescript\\\"\\n            case \\\".jsx\\\":\\n                return \\\"jsx\\\"\\n            case \\\".tsx\\\":\\n                return \\\"tsx\\\"\\n            case \\\".rs\\\":\\n                return \\\"rust\\\"\\n            case \\\".go\\\":\\n                return \\\"go\\\"\\n            case \\\".java\\\":\\n                return \\\"java\\\"\\n            case \\\".cpp\\\":\\n                return \\\"cpp\\\"\\n            case \\\".c\\\":\\n                return \\\"c\\\"\\n            case \\\".lua\\\":\\n                return \\\"lua\\\"\\n            case _:\\n                return \\\"text\\\"\\n\\n\\nserver = AILanguageServer()\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_OPEN)\\nasync def did_open(params: DidOpenTextDocumentParams):\\n    logfire.info(f\\\"Document opened: {params.text_document.uri}\\\")\\n    doc = params.text_document\\n    await server.debounced_analyze(doc.uri, doc.text)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_SAVE)\\nasync def did_save(params: DidSaveTextDocumentParams):\\n    logfire.info(f\\\"Document saved: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_CHANGE)\\nasync def did_change(params: DidChangeTextDocumentParams):\\n    logfire.debug(f\\\"Document changed: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    CodeActionOptions(code_action_kinds=[CodeActionKind.QuickFix]),\\n)\\nasync def code_actions(params: CodeActionParams) -> list[CodeAction]:\\n    with logfire.span(\\\"code_actions\\\", uri=params.text_document.uri):\\n        actions: list[CodeAction] = []\\n        uri = params.text_document.uri\\n        doc = server.workspace.get_text_document(uri)\\n\\n        for diagnostic in params.context.diagnostics:\\n            if diagnostic.source != \\\"ai-lsp\\\" or not diagnostic.data:\\n                continue\\n\\n            suggested_fixes = diagnostic.data.get(\\\"suggested_fixes\\\", [])\\n\\n            for fix_data in suggested_fixes:\\n                target_positions = server.find_snippet_in_text(\\n                    doc.source, fix_data[\\\"target_snippet\\\"]\\n                )\\n\\n                if target_positions:\\n                    with logfire.span(\\\"creating_quick_fix\\\", title=fix_data[\\\"title\\\"]):\\n                        start_line, start_col, end_line, end_col = target_positions[0]\\n                        fix_range = Range(\\n                            start=Position(line=start_line, character=start_col),\\n                            end=Position(line=end_line, character=end_col),\\n                        )\\n\\n                        edit = WorkspaceEdit(\\n                            changes={\\n                                uri: [\\n                                    TextEdit(\\n                                        range=fix_range,\\n                                        new_text=fix_data[\\\"replacement_snippet\\\"],\\n                                    )\\n                                ]\\n                            }\\n                        )\\n\\n                        action = CodeAction(\\n                            title=f\\\"Apply: {fix_data['title']}\\\",\\n                            kind=CodeActionKind.QuickFix,\\n                            edit=edit,\\n                            diagnostics=[diagnostic],\\n                            is_preferred=True,\\n                        )\\n                        actions.append(action)\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Regenerate AI fix\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Regenerate fix\\\",\\n                        command=\\\"ai-lsp.regenerateFix\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.data.get(\\\"issue_snippet\\\"),\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Dismiss AI suggestion\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Dismiss\\\",\\n                        command=\\\"ai-lsp.dismiss\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n        return actions\\n\\n\\n@server.command(\\\"ai-lsp.regenerateFix\\\")\\nasync def regenerate_fix(*args):\\n    if len(args) < 4:\\n        return\\n\\n    uri, issue_snippet, line, character = args[0], args[1], args[2], args[3]\\n\\n    with logfire.span(\\\"regenerate_fix\\\", uri=uri, issue_snippet=issue_snippet):\\n        logfire.info(\\n            f\\\"Regenerating fix for '{issue_snippet}' at {uri}:{line}:{character}\\\"\\n        )\\n\\n        doc = server.workspace.get_text_document(uri)\\n        file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n        language = server._detect_language(file_path)\\n\\n        prompt = f\\\"\\\"\\\"Analyze this specific code issue and provide NEW suggested fixes.\\n\\nIssue snippet: {issue_snippet}\\n\\nFull code context:\\n```{language}\\n{doc.source}\\n```\\n\\nFile: {file_path.name}\\n\\nFocus ONLY on the issue at the snippet shown. Provide fresh, alternative fixes if possible.\\\"\\\"\\\"\\n\\n        try:\\n            result = await server.agent.run(prompt)\\n\\n            if not result.output.issues:\\n                logfire.warn(\\\"No issues returned for regeneration\\\")\\n                return\\n\\n            regenerated_issue = result.output.issues[0]\\n\\n            current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n            updated_diags = []\\n\\n            for diag in current_diags:\\n                if (\\n                    diag.source == \\\"ai-lsp\\\"\\n                    and diag.range.start.line == line\\n                    and diag.range.start.character == character\\n                ):\\n                    positions = server.find_snippet_in_text(\\n                        doc.source, regenerated_issue.issue_snippet\\n                    )\\n                    if positions:\\n                        start_line, start_col, end_line, end_col = positions[0]\\n                        updated_diag = Diagnostic(\\n                            range=Range(\\n                                start=Position(line=start_line, character=start_col),\\n                                end=Position(line=end_line, character=end_col),\\n                            ),\\n                            message=f\\\"AI LSP: {regenerated_issue.message}\\\",\\n                            severity=server._get_diagnostic_severity(\\n                                regenerated_issue.severity\\n                            ),\\n                            source=\\\"ai-lsp\\\",\\n                            data={\\n                                \\\"issue_snippet\\\": regenerated_issue.issue_snippet,\\n                                \\\"suggested_fixes\\\": [\\n                                    {\\n                                        \\\"title\\\": fix.title,\\n                                        \\\"target_snippet\\\": fix.target_snippet,\\n                                        \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                    }\\n                                    for fix in (regenerated_issue.suggested_fixes or [])\\n                                ],\\n                            },\\n                        )\\n                        updated_diags.append(updated_diag)\\n                        logfire.info(\\n                            f\\\"Regenerated diagnostic with {len(regenerated_issue.suggested_fixes or [])} new fixes\\\"\\n                        )\\n                else:\\n                    updated_diags.append(diag)\\n\\n            server.publish_diagnostics(uri, updated_diags)\\n\\n        except Exception as e:\\n            logfire.error(f\\\"Failed to regenerate fix: {str(e)}\\\", _exc_info=True)\\n\\n\\n@server.command(\\\"ai-lsp.dismiss\\\")\\ndef dismiss_suggestion(*args):\\n    if len(args) < 3:\\n        return\\n\\n    uri, line, character = args[0], args[1], args[2]\\n\\n    with logfire.span(\\\"dismiss_suggestion\\\", uri=uri, line=line, character=character):\\n        logfire.info(f\\\"Dismissing suggestion at {uri}:{line}:{character}\\\")\\n\\n        doc = server.workspace.get_text_document(uri)\\n        diagnostics = []\\n\\n        current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n        for diag in current_diags:\\n            if (\\n                diag.source == \\\"ai-lsp\\\"\\n                and diag.range.start.line == line\\n                and diag.range.start.character == character\\n            ):\\n                continue\\n            diagnostics.append(diag)\\n\\n        server.publish_diagnostics(uri, diagnostics)\\n\\n\\ndef app():\\n    server.start_io()\\n\\n\\nif __name__ == \\\"__main__\\\":\\n    app()\\n\\n```\\n\\nFile: main.py\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"4a41b40a96e5444ea105a5b04890e708"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"84068"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a794658708d0e64ba1ed92eb4480c","spanId":"e49416ced173a42b","parentSpanId":"56ea6310c854b7a3","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762971244657449000","endTimeUnixNano":"1762971244657449000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7946588d67664405e1137ce1c5f0","spanId":"45f6902f1f53ed38","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762971244685865000","endTimeUnixNano":"1762971244685865000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a794658708d0e64ba1ed92eb4480c","spanId":"56ea6310c854b7a3","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762971244656885000","endTimeUnixNano":"1762971244694184000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"d6ae5738e90564b59bad5ea502d5749f68a582be0f2c9b9bde5866723629d7bc"}}],"events":[{"timeUnixNano":"1762971244690741000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 725, in _connect_and_send_request\n    conn = await self._connector.connect(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        req, traces=traces, timeout=real_timeout\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/connector.py\", line 642, in connect\n    proto = await self._create_connection(req, traces, timeout)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/connector.py\", line 1209, in _create_connection\n    _, proto = await self._create_direct_connection(req, traces, timeout)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/connector.py\", line 1550, in _create_direct_connection\n    transp, proto = await self._wrap_create_connection(\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<7 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/connector.py\", line 1268, in _wrap_create_connection\n    sock = await aiohappyeyeballs.start_connection(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohappyeyeballs/impl.py\", line 87, in start_connection\n    sock, _, _ = await _staggered.staggered_race(\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<13 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohappyeyeballs/_staggered.py\", line 165, in staggered_race\n    done = await _wait_one(\n           ^^^^^^^^^^^^^^^^\n        (*tasks, start_next) if start_next else tasks, loop\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohappyeyeballs/_staggered.py\", line 46, in _wait_one\n    return await wait_next\n           ^^^^^^^^^^^^^^^\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a794658966dd14bd1a3c0dcb2f3af","spanId":"e55f874603b05a2b","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762971244694386000","endTimeUnixNano":"1762971244694386000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a794658a63e65ca564d618d98187d","spanId":"ce3dd7fd0877a169","flags":256,"name":"Document saved: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762971244710061000","endTimeUnixNano":"1762971244710061000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document saved: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document saved: file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_save"}},{"key":"code.lineno","value":{"intValue":"298"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a794658a63f93df524c5ddf11f06c","spanId":"fed60874f3017c4e","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762971244710307000","endTimeUnixNano":"1762971244710307000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79465c8e3b7b4f44a5b8eea497b3","spanId":"210f3cdb7a61ff92","parentSpanId":"df05a48cf566b422","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762971245710826000","endTimeUnixNano":"1762971245710826000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a794658708d0e64ba1ed92eb4480c","spanId":"b89dfd0f0273f96b","parentSpanId":"1019305335e5c47d","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762971244659621000","endTimeUnixNano":"1762971244686492000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a794658708d0e64ba1ed92eb4480c","spanId":"1019305335e5c47d","parentSpanId":"56ea6310c854b7a3","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762971244658802000","endTimeUnixNano":"1762971244686754000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this python code for issues:\\n\\n```python\\nimport asyncio\\nimport os\\nfrom pathlib import Path\\nfrom typing import Any, Literal\\nfrom importlib.metadata import version\\nimport logfire\\n\\n# pyrefly: ignore [missing-import]\\nfrom lsprotocol.types import (\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    TEXT_DOCUMENT_DID_CHANGE,\\n    TEXT_DOCUMENT_DID_OPEN,\\n    TEXT_DOCUMENT_DID_SAVE,\\n    CodeAction,\\n    CodeActionKind,\\n    CodeActionOptions,\\n    CodeActionParams,\\n    Command,\\n    Diagnostic,\\n    DiagnosticSeverity,\\n    DidChangeTextDocumentParams,\\n    DidOpenTextDocumentParams,\\n    DidSaveTextDocumentParams,\\n    Position,\\n    Range,\\n    TextEdit,\\n    WorkspaceEdit,\\n)\\nfrom pydantic import BaseModel, Field\\nfrom pydantic_ai import Agent\\nfrom pydantic_ai.models import KnownModelName\\nfrom pydantic_settings import BaseSettings\\n\\n# pyrefly: ignore [missing-import]\\nfrom pygls.server import LanguageServer\\n\\n\\nclass Settings(BaseSettings):\\n    ai_lsp_model: KnownModelName = Field(default=\\\"google-gla:gemini-2.5-flash\\\")\\n    debounce_ms: int = Field(default=1000)\\n    max_cache_size: int = Field(default=50)\\n    configure_logfire: bool = Field(default=True)\\n    otel_exporter_otlp_endpoint: str = Field(default=\\\"http://localhost:4318\\\")\\n\\n\\nsettings = Settings()\\n\\n\\nos.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\\n\\nif settings.configure_logfire:\\n    logfire.configure(send_to_logfire=False, service_name=\\\"ai-lsp\\\")\\n    logfire.instrument_pydantic_ai()\\n    logfire.instrument_httpx(capture_all=True)\\n\\n\\nclass SuggestedFix(BaseModel):\\n    title: str\\n    target_snippet: str\\n    replacement_snippet: str\\n\\n\\nclass CodeIssue(BaseModel):\\n    issue_snippet: str\\n    severity: Literal[\\\"error\\\", \\\"warning\\\", \\\"info\\\", \\\"hint\\\"]\\n    message: str\\n    suggested_fixes: list[SuggestedFix] | None = None\\n\\n\\nclass DiagnosticResult(BaseModel):\\n    issues: list[CodeIssue]\\n\\n\\nclass AILanguageServer(LanguageServer):\\n    def __init__(self):\\n        super().__init__(\\\"ai-lsp\\\", version(\\\"ai-lsp\\\"))\\n        logfire.info(\\\"Initializing AI Language Server\\\")\\n        self._pending_tasks: dict[str, asyncio.Task[Any]] = {}\\n        self._analysis_locks: dict[str, asyncio.Lock] = {}\\n\\n        self.agent: Agent[DiagnosticResult, Any] = Agent(\\n            model=settings.ai_lsp_model,\\n            output_type=DiagnosticResult,\\n            system_prompt=\\\"\\\"\\\"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\\\"\\\"\\\",\\n        )\\n        logfire.info(\\\"AI agent initialized successfully\\\")\\n\\n    def find_snippet_in_text(\\n        self, text: str, snippet: str\\n    ) -> list[tuple[int, int, int, int]]:\\n        \\\"\\\"\\\"Find all occurrences of code snippet in text, return positions as (start_line, start_col, end_line, end_col)\\\"\\\"\\\"\\n        snippet = snippet.strip()\\n        positions = []\\n\\n        # Search for all occurrences of snippet\\n        start_pos = 0\\n        while True:\\n            start_pos = text.find(snippet, start_pos)\\n            if start_pos == -1:\\n                break\\n\\n            # Convert character position to line/column\\n            lines = text[:start_pos].split(\\\"\\\\n\\\")\\n            start_line = len(lines) - 1\\n            start_col = len(lines[-1])\\n\\n            # Calculate end position\\n            snippet_lines = snippet.split(\\\"\\\\n\\\")\\n            if len(snippet_lines) == 1:\\n                end_line = start_line\\n                end_col = start_col + len(snippet)\\n            else:\\n                end_line = start_line + len(snippet_lines) - 1\\n                end_col = len(snippet_lines[-1])\\n\\n            positions.append((start_line, start_col, end_line, end_col))\\n            start_pos += 1  # Move past this occurrence\\n\\n        if not positions:\\n            logfire.warn(f\\\"Could not find snippet '{snippet}' in text\\\")\\n        else:\\n            logfire.debug(f\\\"Found {len(positions)} occurrences of '{snippet[:20]}...'\\\")\\n\\n        return positions\\n\\n    async def debounced_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Debounced analysis that cancels previous calls\\\"\\\"\\\"\\n        # Cancel any existing task for this URI\\n        if uri in self._pending_tasks:\\n            self._pending_tasks[uri].cancel()\\n            _ = self._pending_tasks.pop(uri, None)\\n\\n        # Create new task\\n        task: asyncio.Task[None] = asyncio.create_task(self._delayed_analyze(uri, text))\\n        self._pending_tasks[uri] = task\\n\\n        try:\\n            await task\\n        except asyncio.CancelledError:\\n            logfire.debug(f\\\"Analysis cancelled for {uri}\\\")\\n        finally:\\n            # Clean up completed task\\n            if uri in self._pending_tasks and self._pending_tasks[uri] == task:\\n                _ = self._pending_tasks.pop(uri)\\n\\n    async def _delayed_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Wait for debounce period then analyze\\\"\\\"\\\"\\n        await asyncio.sleep(settings.debounce_ms / 1000.0)\\n        diagnostics = await self.analyze_document(uri, text)\\n        # pyrefly: ignore [missing-attribute]\\n        self.publish_diagnostics(uri, diagnostics)\\n        logfire.debug(f\\\"Published {len(diagnostics)} diagnostics for {uri}\\\")\\n\\n    async def analyze_document(self, uri: str, text: str) -> list[Diagnostic]:\\n        # Ensure we have a lock for this URI\\n        lock = self._analysis_locks.setdefault(uri, asyncio.Lock())\\n        async with lock:\\n            with logfire.span(\\\"analyze_document\\\", uri=uri):\\n                logfire.info(f\\\"Starting AI analysis for {uri}\\\")\\n\\n                try:\\n                    file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n                    language = self._detect_language(file_path)\\n\\n                    prompt = f\\\"\\\"\\\"Analyze this {language} code for issues:\\n\\n```{language}\\n{text}\\n```\\n\\nFile: {file_path.name}\\\"\\\"\\\"\\n\\n                    result = await self.agent.run(prompt)\\n                    logfire.info(\\n                        f\\\"AI analysis completed, found {len(result.output.issues)} issues\\\"\\n                    )\\n\\n                    diagnostics = []\\n                    for issue in result.output.issues:\\n                        positions = self.find_snippet_in_text(text, issue.issue_snippet)\\n\\n                        if positions:\\n                            start_line, start_col, end_line, end_col = positions[0]\\n                            diagnostic = Diagnostic(\\n                                range=Range(\\n                                    start=Position(\\n                                        line=start_line, character=start_col\\n                                    ),\\n                                    end=Position(line=end_line, character=end_col),\\n                                ),\\n                                message=f\\\"AI LSP: {issue.message}\\\",\\n                                severity=self._get_diagnostic_severity(issue.severity),\\n                                source=\\\"ai-lsp\\\",\\n                                data={\\n                                    \\\"issue_snippet\\\": issue.issue_snippet,\\n                                    \\\"suggested_fixes\\\": [\\n                                        {\\n                                            \\\"title\\\": fix.title,\\n                                            \\\"target_snippet\\\": fix.target_snippet,\\n                                            \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                        }\\n                                        for fix in (issue.suggested_fixes or [])\\n                                    ],\\n                                },\\n                            )\\n                            diagnostics.append(diagnostic)\\n\\n                    return diagnostics\\n\\n                except Exception as e:\\n                    logfire.error(\\n                        f\\\"AI analysis failed for {uri}: {str(e)}\\\", _exc_info=True\\n                    )\\n                    return []\\n\\n    def _get_diagnostic_severity(self, severity: str) -> DiagnosticSeverity:\\n        match severity:\\n            case \\\"error\\\":\\n                return DiagnosticSeverity.Error\\n            case \\\"warning\\\":\\n                return DiagnosticSeverity.Warning\\n            case \\\"info\\\":\\n                return DiagnosticSeverity.Information\\n            case \\\"hint\\\":\\n                return DiagnosticSeverity.Hint\\n            case _:\\n                return DiagnosticSeverity.Information\\n\\n    def _detect_language(self, file_path: Path) -> str:\\n        match file_path.suffix:\\n            case \\\".py\\\":\\n                return \\\"python\\\"\\n            case \\\".js\\\":\\n                return \\\"javascript\\\"\\n            case \\\".ts\\\":\\n                return \\\"typescript\\\"\\n            case \\\".jsx\\\":\\n                return \\\"jsx\\\"\\n            case \\\".tsx\\\":\\n                return \\\"tsx\\\"\\n            case \\\".rs\\\":\\n                return \\\"rust\\\"\\n            case \\\".go\\\":\\n                return \\\"go\\\"\\n            case \\\".java\\\":\\n                return \\\"java\\\"\\n            case \\\".cpp\\\":\\n                return \\\"cpp\\\"\\n            case \\\".c\\\":\\n                return \\\"c\\\"\\n            case \\\".lua\\\":\\n                return \\\"lua\\\"\\n            case _:\\n                return \\\"text\\\"\\n\\n\\nserver = AILanguageServer()\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_OPEN)\\nasync def did_open(params: DidOpenTextDocumentParams):\\n    logfire.info(f\\\"Document opened: {params.text_document.uri}\\\")\\n    doc = params.text_document\\n    await server.debounced_analyze(doc.uri, doc.text)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_SAVE)\\nasync def did_save(params: DidSaveTextDocumentParams):\\n    logfire.info(f\\\"Document saved: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_CHANGE)\\nasync def did_change(params: DidChangeTextDocumentParams):\\n    logfire.debug(f\\\"Document changed: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    CodeActionOptions(code_action_kinds=[CodeActionKind.QuickFix]),\\n)\\nasync def code_actions(params: CodeActionParams) -> list[CodeAction]:\\n    with logfire.span(\\\"code_actions\\\", uri=params.text_document.uri):\\n        actions: list[CodeAction] = []\\n        uri = params.text_document.uri\\n        doc = server.workspace.get_text_document(uri)\\n\\n        for diagnostic in params.context.diagnostics:\\n            if diagnostic.source != \\\"ai-lsp\\\" or not diagnostic.data:\\n                continue\\n\\n            suggested_fixes = diagnostic.data.get(\\\"suggested_fixes\\\", [])\\n\\n            for fix_data in suggested_fixes:\\n                target_positions = server.find_snippet_in_text(\\n                    doc.source, fix_data[\\\"target_snippet\\\"]\\n                )\\n\\n                if target_positions:\\n                    with logfire.span(\\\"creating_quick_fix\\\", title=fix_data[\\\"title\\\"]):\\n                        start_line, start_col, end_line, end_col = target_positions[0]\\n                        fix_range = Range(\\n                            start=Position(line=start_line, character=start_col),\\n                            end=Position(line=end_line, character=end_col),\\n                        )\\n\\n                        edit = WorkspaceEdit(\\n                            changes={\\n                                uri: [\\n                                    TextEdit(\\n                                        range=fix_range,\\n                                        new_text=fix_data[\\\"replacement_snippet\\\"],\\n                                    )\\n                                ]\\n                            }\\n                        )\\n\\n                        action = CodeAction(\\n                            title=f\\\"Apply: {fix_data['title']}\\\",\\n                            kind=CodeActionKind.QuickFix,\\n                            edit=edit,\\n                            diagnostics=[diagnostic],\\n                            is_preferred=True,\\n                        )\\n                        actions.append(action)\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Regenerate AI fix\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Regenerate fix\\\",\\n                        command=\\\"ai-lsp.regenerateFix\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.data.get(\\\"issue_snippet\\\"),\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Dismiss AI suggestion\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Dismiss\\\",\\n                        command=\\\"ai-lsp.dismiss\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n        return actions\\n\\n\\n@server.command(\\\"ai-lsp.regenerateFix\\\")\\nasync def regenerate_fix(*args):\\n    if len(args) < 4:\\n        return\\n\\n    uri, issue_snippet, line, character = args[0], args[1], args[2], args[3]\\n\\n    with logfire.span(\\\"regenerate_fix\\\", uri=uri, issue_snippet=issue_snippet):\\n        logfire.info(\\n            f\\\"Regenerating fix for '{issue_snippet}' at {uri}:{line}:{character}\\\"\\n        )\\n\\n        doc = server.workspace.get_text_document(uri)\\n        file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n        language = server._detect_language(file_path)\\n\\n        prompt = f\\\"\\\"\\\"Analyze this specific code issue and provide NEW suggested fixes.\\n\\nIssue snippet: {issue_snippet}\\n\\nFull code context:\\n```{language}\\n{doc.source}\\n```\\n\\nFile: {file_path.name}\\n\\nFocus ONLY on the issue at the snippet shown. Provide fresh, alternative fixes if possible.\\\"\\\"\\\"\\n\\n        try:\\n            result = await server.agent.run(prompt)\\n\\n            if not result.output.issues:\\n                logfire.warn(\\\"No issues returned for regeneration\\\")\\n                return\\n\\n            regenerated_issue = result.output.issues[0]\\n\\n            current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n            updated_diags = []\\n\\n            for diag in current_diags:\\n                if (\\n                    diag.source == \\\"ai-lsp\\\"\\n                    and diag.range.start.line == line\\n                    and diag.range.start.character == character\\n                ):\\n                    positions = server.find_snippet_in_text(\\n                        doc.source, regenerated_issue.issue_snippet\\n                    )\\n                    if positions:\\n                        start_line, start_col, end_line, end_col = positions[0]\\n                        updated_diag = Diagnostic(\\n                            range=Range(\\n                                start=Position(line=start_line, character=start_col),\\n                                end=Position(line=end_line, character=end_col),\\n                            ),\\n                            message=f\\\"AI LSP: {regenerated_issue.message}\\\",\\n                            severity=server._get_diagnostic_severity(\\n                                regenerated_issue.severity\\n                            ),\\n                            source=\\\"ai-lsp\\\",\\n                            data={\\n                                \\\"issue_snippet\\\": regenerated_issue.issue_snippet,\\n                                \\\"suggested_fixes\\\": [\\n                                    {\\n                                        \\\"title\\\": fix.title,\\n                                        \\\"target_snippet\\\": fix.target_snippet,\\n                                        \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                    }\\n                                    for fix in (regenerated_issue.suggested_fixes or [])\\n                                ],\\n                            },\\n                        )\\n                        updated_diags.append(updated_diag)\\n                        logfire.info(\\n                            f\\\"Regenerated diagnostic with {len(regenerated_issue.suggested_fixes or [])} new fixes\\\"\\n                        )\\n                else:\\n                    updated_diags.append(diag)\\n\\n            server.publish_diagnostics(uri, updated_diags)\\n\\n        except Exception as e:\\n            logfire.error(f\\\"Failed to regenerate fix: {str(e)}\\\", _exc_info=True)\\n\\n\\n@server.command(\\\"ai-lsp.dismiss\\\")\\ndef dismiss_suggestion(*args):\\n    if len(args) < 3:\\n        return\\n\\n    uri, line, character = args[0], args[1], args[2]\\n\\n    with logfire.span(\\\"dismiss_suggestion\\\", uri=uri, line=line, character=character):\\n        logfire.info(f\\\"Dismissing suggestion at {uri}:{line}:{character}\\\")\\n\\n        doc = server.workspace.get_text_document(uri)\\n        diagnostics = []\\n\\n        current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n        for diag in current_diags:\\n            if (\\n                diag.source == \\\"ai-lsp\\\"\\n                and diag.range.start.line == line\\n                and diag.range.start.character == character\\n            ):\\n                continue\\n            diagnostics.append(diag)\\n\\n        server.publish_diagnostics(uri, diagnostics)\\n\\n\\n        \\n\\ndef app():\\n    server.start_io()\\n\\n\\nif __name__ == \\\"__main__\\\":\\n    app()\\n\\n```\\n\\nFile: main.py\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"4a41b40a96e5444ea105a5b04890e708"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"84068"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a79465c8e3b7b4f44a5b8eea497b3","spanId":"3ecfd3addd37fa9d","parentSpanId":"df6280551e39e8ba","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762971245711730000","endTimeUnixNano":"1762971266679019000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.usage.input_tokens","value":{"intValue":"4882"}},{"key":"gen_ai.usage.output_tokens","value":{"intValue":"347"}},{"key":"gen_ai.usage.details.thoughts_tokens","value":{"intValue":"3310"}},{"key":"gen_ai.usage.details.text_prompt_tokens","value":{"intValue":"4882"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.system\": \"google-gla\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this python code for issues:\\n\\n```python\\nimport asyncio\\nimport os\\nfrom pathlib import Path\\nfrom typing import Any, Literal\\nfrom importlib.metadata import version\\nimport logfire\\n\\n# pyrefly: ignore [missing-import]\\nfrom lsprotocol.types import (\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    TEXT_DOCUMENT_DID_CHANGE,\\n    TEXT_DOCUMENT_DID_OPEN,\\n    TEXT_DOCUMENT_DID_SAVE,\\n    CodeAction,\\n    CodeActionKind,\\n    CodeActionOptions,\\n    CodeActionParams,\\n    Command,\\n    Diagnostic,\\n    DiagnosticSeverity,\\n    DidChangeTextDocumentParams,\\n    DidOpenTextDocumentParams,\\n    DidSaveTextDocumentParams,\\n    Position,\\n    Range,\\n    TextEdit,\\n    WorkspaceEdit,\\n)\\nfrom pydantic import BaseModel, Field\\nfrom pydantic_ai import Agent\\nfrom pydantic_ai.models import KnownModelName\\nfrom pydantic_settings import BaseSettings\\n\\n# pyrefly: ignore [missing-import]\\nfrom pygls.server import LanguageServer\\n\\n\\nclass Settings(BaseSettings):\\n    ai_lsp_model: KnownModelName = Field(default=\\\"google-gla:gemini-2.5-flash\\\")\\n    debounce_ms: int = Field(default=1000)\\n    max_cache_size: int = Field(default=50)\\n    configure_logfire: bool = Field(default=True)\\n    otel_exporter_otlp_endpoint: str = Field(default=\\\"http://localhost:4318\\\")\\n\\n\\nsettings = Settings()\\n\\n\\nos.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\\n\\nif settings.configure_logfire:\\n    logfire.configure(send_to_logfire=False, service_name=\\\"ai-lsp\\\")\\n    logfire.instrument_pydantic_ai()\\n    logfire.instrument_httpx(capture_all=True)\\n\\n\\nclass SuggestedFix(BaseModel):\\n    title: str\\n    target_snippet: str\\n    replacement_snippet: str\\n\\n\\nclass CodeIssue(BaseModel):\\n    issue_snippet: str\\n    severity: Literal[\\\"error\\\", \\\"warning\\\", \\\"info\\\", \\\"hint\\\"]\\n    message: str\\n    suggested_fixes: list[SuggestedFix] | None = None\\n\\n\\nclass DiagnosticResult(BaseModel):\\n    issues: list[CodeIssue]\\n\\n\\nclass AILanguageServer(LanguageServer):\\n    def __init__(self):\\n        super().__init__(\\\"ai-lsp\\\", version(\\\"ai-lsp\\\"))\\n        logfire.info(\\\"Initializing AI Language Server\\\")\\n        self._pending_tasks: dict[str, asyncio.Task[Any]] = {}\\n        self._analysis_locks: dict[str, asyncio.Lock] = {}\\n\\n        self.agent: Agent[DiagnosticResult, Any] = Agent(\\n            model=settings.ai_lsp_model,\\n            output_type=DiagnosticResult,\\n            system_prompt=\\\"\\\"\\\"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\\\"\\\"\\\",\\n        )\\n        logfire.info(\\\"AI agent initialized successfully\\\")\\n\\n    def find_snippet_in_text(\\n        self, text: str, snippet: str\\n    ) -> list[tuple[int, int, int, int]]:\\n        \\\"\\\"\\\"Find all occurrences of code snippet in text, return positions as (start_line, start_col, end_line, end_col)\\\"\\\"\\\"\\n        snippet = snippet.strip()\\n        positions = []\\n\\n        # Search for all occurrences of snippet\\n        start_pos = 0\\n        while True:\\n            start_pos = text.find(snippet, start_pos)\\n            if start_pos == -1:\\n                break\\n\\n            # Convert character position to line/column\\n            lines = text[:start_pos].split(\\\"\\\\n\\\")\\n            start_line = len(lines) - 1\\n            start_col = len(lines[-1])\\n\\n            # Calculate end position\\n            snippet_lines = snippet.split(\\\"\\\\n\\\")\\n            if len(snippet_lines) == 1:\\n                end_line = start_line\\n                end_col = start_col + len(snippet)\\n            else:\\n                end_line = start_line + len(snippet_lines) - 1\\n                end_col = len(snippet_lines[-1])\\n\\n            positions.append((start_line, start_col, end_line, end_col))\\n            start_pos += 1  # Move past this occurrence\\n\\n        if not positions:\\n            logfire.warn(f\\\"Could not find snippet '{snippet}' in text\\\")\\n        else:\\n            logfire.debug(f\\\"Found {len(positions)} occurrences of '{snippet[:20]}...'\\\")\\n\\n        return positions\\n\\n    async def debounced_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Debounced analysis that cancels previous calls\\\"\\\"\\\"\\n        # Cancel any existing task for this URI\\n        if uri in self._pending_tasks:\\n            self._pending_tasks[uri].cancel()\\n            _ = self._pending_tasks.pop(uri, None)\\n\\n        # Create new task\\n        task: asyncio.Task[None] = asyncio.create_task(self._delayed_analyze(uri, text))\\n        self._pending_tasks[uri] = task\\n\\n        try:\\n            await task\\n        except asyncio.CancelledError:\\n            logfire.debug(f\\\"Analysis cancelled for {uri}\\\")\\n        finally:\\n            # Clean up completed task\\n            if uri in self._pending_tasks and self._pending_tasks[uri] == task:\\n                _ = self._pending_tasks.pop(uri)\\n\\n    async def _delayed_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Wait for debounce period then analyze\\\"\\\"\\\"\\n        await asyncio.sleep(settings.debounce_ms / 1000.0)\\n        diagnostics = await self.analyze_document(uri, text)\\n        # pyrefly: ignore [missing-attribute]\\n        self.publish_diagnostics(uri, diagnostics)\\n        logfire.debug(f\\\"Published {len(diagnostics)} diagnostics for {uri}\\\")\\n\\n    async def analyze_document(self, uri: str, text: str) -> list[Diagnostic]:\\n        # Ensure we have a lock for this URI\\n        lock = self._analysis_locks.setdefault(uri, asyncio.Lock())\\n        async with lock:\\n            with logfire.span(\\\"analyze_document\\\", uri=uri):\\n                logfire.info(f\\\"Starting AI analysis for {uri}\\\")\\n\\n                try:\\n                    file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n                    language = self._detect_language(file_path)\\n\\n                    prompt = f\\\"\\\"\\\"Analyze this {language} code for issues:\\n\\n```{language}\\n{text}\\n```\\n\\nFile: {file_path.name}\\\"\\\"\\\"\\n\\n                    result = await self.agent.run(prompt)\\n                    logfire.info(\\n                        f\\\"AI analysis completed, found {len(result.output.issues)} issues\\\"\\n                    )\\n\\n                    diagnostics = []\\n                    for issue in result.output.issues:\\n                        positions = self.find_snippet_in_text(text, issue.issue_snippet)\\n\\n                        if positions:\\n                            start_line, start_col, end_line, end_col = positions[0]\\n                            diagnostic = Diagnostic(\\n                                range=Range(\\n                                    start=Position(\\n                                        line=start_line, character=start_col\\n                                    ),\\n                                    end=Position(line=end_line, character=end_col),\\n                                ),\\n                                message=f\\\"AI LSP: {issue.message}\\\",\\n                                severity=self._get_diagnostic_severity(issue.severity),\\n                                source=\\\"ai-lsp\\\",\\n                                data={\\n                                    \\\"issue_snippet\\\": issue.issue_snippet,\\n                                    \\\"suggested_fixes\\\": [\\n                                        {\\n                                            \\\"title\\\": fix.title,\\n                                            \\\"target_snippet\\\": fix.target_snippet,\\n                                            \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                        }\\n                                        for fix in (issue.suggested_fixes or [])\\n                                    ],\\n                                },\\n                            )\\n                            diagnostics.append(diagnostic)\\n\\n                    return diagnostics\\n\\n                except Exception as e:\\n                    logfire.error(\\n                        f\\\"AI analysis failed for {uri}: {str(e)}\\\", _exc_info=True\\n                    )\\n                    return []\\n\\n    def _get_diagnostic_severity(self, severity: str) -> DiagnosticSeverity:\\n        match severity:\\n            case \\\"error\\\":\\n                return DiagnosticSeverity.Error\\n            case \\\"warning\\\":\\n                return DiagnosticSeverity.Warning\\n            case \\\"info\\\":\\n                return DiagnosticSeverity.Information\\n            case \\\"hint\\\":\\n                return DiagnosticSeverity.Hint\\n            case _:\\n                return DiagnosticSeverity.Information\\n\\n    def _detect_language(self, file_path: Path) -> str:\\n        match file_path.suffix:\\n            case \\\".py\\\":\\n                return \\\"python\\\"\\n            case \\\".js\\\":\\n                return \\\"javascript\\\"\\n            case \\\".ts\\\":\\n                return \\\"typescript\\\"\\n            case \\\".jsx\\\":\\n                return \\\"jsx\\\"\\n            case \\\".tsx\\\":\\n                return \\\"tsx\\\"\\n            case \\\".rs\\\":\\n                return \\\"rust\\\"\\n            case \\\".go\\\":\\n                return \\\"go\\\"\\n            case \\\".java\\\":\\n                return \\\"java\\\"\\n            case \\\".cpp\\\":\\n                return \\\"cpp\\\"\\n            case \\\".c\\\":\\n                return \\\"c\\\"\\n            case \\\".lua\\\":\\n                return \\\"lua\\\"\\n            case _:\\n                return \\\"text\\\"\\n\\n\\nserver = AILanguageServer()\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_OPEN)\\nasync def did_open(params: DidOpenTextDocumentParams):\\n    logfire.info(f\\\"Document opened: {params.text_document.uri}\\\")\\n    doc = params.text_document\\n    await server.debounced_analyze(doc.uri, doc.text)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_SAVE)\\nasync def did_save(params: DidSaveTextDocumentParams):\\n    logfire.info(f\\\"Document saved: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_CHANGE)\\nasync def did_change(params: DidChangeTextDocumentParams):\\n    logfire.debug(f\\\"Document changed: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    CodeActionOptions(code_action_kinds=[CodeActionKind.QuickFix]),\\n)\\nasync def code_actions(params: CodeActionParams) -> list[CodeAction]:\\n    with logfire.span(\\\"code_actions\\\", uri=params.text_document.uri):\\n        actions: list[CodeAction] = []\\n        uri = params.text_document.uri\\n        doc = server.workspace.get_text_document(uri)\\n\\n        for diagnostic in params.context.diagnostics:\\n            if diagnostic.source != \\\"ai-lsp\\\" or not diagnostic.data:\\n                continue\\n\\n            suggested_fixes = diagnostic.data.get(\\\"suggested_fixes\\\", [])\\n\\n            for fix_data in suggested_fixes:\\n                target_positions = server.find_snippet_in_text(\\n                    doc.source, fix_data[\\\"target_snippet\\\"]\\n                )\\n\\n                if target_positions:\\n                    with logfire.span(\\\"creating_quick_fix\\\", title=fix_data[\\\"title\\\"]):\\n                        start_line, start_col, end_line, end_col = target_positions[0]\\n                        fix_range = Range(\\n                            start=Position(line=start_line, character=start_col),\\n                            end=Position(line=end_line, character=end_col),\\n                        )\\n\\n                        edit = WorkspaceEdit(\\n                            changes={\\n                                uri: [\\n                                    TextEdit(\\n                                        range=fix_range,\\n                                        new_text=fix_data[\\\"replacement_snippet\\\"],\\n                                    )\\n                                ]\\n                            }\\n                        )\\n\\n                        action = CodeAction(\\n                            title=f\\\"Apply: {fix_data['title']}\\\",\\n                            kind=CodeActionKind.QuickFix,\\n                            edit=edit,\\n                            diagnostics=[diagnostic],\\n                            is_preferred=True,\\n                        )\\n                        actions.append(action)\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Regenerate AI fix\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Regenerate fix\\\",\\n                        command=\\\"ai-lsp.regenerateFix\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.data.get(\\\"issue_snippet\\\"),\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Dismiss AI suggestion\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Dismiss\\\",\\n                        command=\\\"ai-lsp.dismiss\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n        return actions\\n\\n\\n@server.command(\\\"ai-lsp.regenerateFix\\\")\\nasync def regenerate_fix(*args):\\n    if len(args) < 4:\\n        return\\n\\n    uri, issue_snippet, line, character = args[0], args[1], args[2], args[3]\\n\\n    with logfire.span(\\\"regenerate_fix\\\", uri=uri, issue_snippet=issue_snippet):\\n        logfire.info(\\n            f\\\"Regenerating fix for '{issue_snippet}' at {uri}:{line}:{character}\\\"\\n        )\\n\\n        doc = server.workspace.get_text_document(uri)\\n        file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n        language = server._detect_language(file_path)\\n\\n        prompt = f\\\"\\\"\\\"Analyze this specific code issue and provide NEW suggested fixes.\\n\\nIssue snippet: {issue_snippet}\\n\\nFull code context:\\n```{language}\\n{doc.source}\\n```\\n\\nFile: {file_path.name}\\n\\nFocus ONLY on the issue at the snippet shown. Provide fresh, alternative fixes if possible.\\\"\\\"\\\"\\n\\n        try:\\n            result = await server.agent.run(prompt)\\n\\n            if not result.output.issues:\\n                logfire.warn(\\\"No issues returned for regeneration\\\")\\n                return\\n\\n            regenerated_issue = result.output.issues[0]\\n\\n            current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n            updated_diags = []\\n\\n            for diag in current_diags:\\n                if (\\n                    diag.source == \\\"ai-lsp\\\"\\n                    and diag.range.start.line == line\\n                    and diag.range.start.character == character\\n                ):\\n                    positions = server.find_snippet_in_text(\\n                        doc.source, regenerated_issue.issue_snippet\\n                    )\\n                    if positions:\\n                        start_line, start_col, end_line, end_col = positions[0]\\n                        updated_diag = Diagnostic(\\n                            range=Range(\\n                                start=Position(line=start_line, character=start_col),\\n                                end=Position(line=end_line, character=end_col),\\n                            ),\\n                            message=f\\\"AI LSP: {regenerated_issue.message}\\\",\\n                            severity=server._get_diagnostic_severity(\\n                                regenerated_issue.severity\\n                            ),\\n                            source=\\\"ai-lsp\\\",\\n                            data={\\n                                \\\"issue_snippet\\\": regenerated_issue.issue_snippet,\\n                                \\\"suggested_fixes\\\": [\\n                                    {\\n                                        \\\"title\\\": fix.title,\\n                                        \\\"target_snippet\\\": fix.target_snippet,\\n                                        \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                    }\\n                                    for fix in (regenerated_issue.suggested_fixes or [])\\n                                ],\\n                            },\\n                        )\\n                        updated_diags.append(updated_diag)\\n                        logfire.info(\\n                            f\\\"Regenerated diagnostic with {len(regenerated_issue.suggested_fixes or [])} new fixes\\\"\\n                        )\\n                else:\\n                    updated_diags.append(diag)\\n\\n            server.publish_diagnostics(uri, updated_diags)\\n\\n        except Exception as e:\\n            logfire.error(f\\\"Failed to regenerate fix: {str(e)}\\\", _exc_info=True)\\n\\n\\n@server.command(\\\"ai-lsp.dismiss\\\")\\ndef dismiss_suggestion(*args):\\n    if len(args) < 3:\\n        return\\n\\n    uri, line, character = args[0], args[1], args[2]\\n\\n    with logfire.span(\\\"dismiss_suggestion\\\", uri=uri, line=line, character=character):\\n        logfire.info(f\\\"Dismissing suggestion at {uri}:{line}:{character}\\\")\\n\\n        doc = server.workspace.get_text_document(uri)\\n        diagnostics = []\\n\\n        current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n        for diag in current_diags:\\n            if (\\n                diag.source == \\\"ai-lsp\\\"\\n                and diag.range.start.line == line\\n                and diag.range.start.character == character\\n            ):\\n                continue\\n            diagnostics.append(diag)\\n\\n        server.publish_diagnostics(uri, diagnostics)\\n\\n\\ndef app():\\n    server.start_io()\\n\\n\\nif __name__ == \\\"__main__\\\":\\n    app()\\n\\n```\\n\\nFile: main.py\", \"role\": \"user\", \"gen_ai.system\": \"google-gla\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}, {\"index\": 0, \"message\": {\"role\": \"assistant\", \"tool_calls\": [{\"id\": \"pyd_ai_d6a1e992ee63478ba348e0003f75fb8b\", \"type\": \"function\", \"function\": {\"name\": \"final_result\", \"arguments\": {\"issues\": [{\"severity\": \"warning\", \"message\": \"Repeatedly calling `split('\\\\n')` on a growing string slice within a loop to calculate line and column numbers is inefficient for large documents or many snippet occurrences. This leads to quadratic time complexity in the worst case for text processing. Pre-calculating line start offsets or iterating line-by-line would be more performant to avoid redundant work.\", \"issue_snippet\": \"text[:start_pos].split(\\\"\\\\n\\\")\"}, {\"issue_snippet\": \"positions[0]\", \"severity\": \"info\", \"message\": \"The `find_snippet_in_text` method correctly identifies all occurrences of an `issue_snippet`, but only the first occurrence (`positions[0]`) is used to generate a diagnostic. If the same semantic issue appears multiple times in a document, only the first instance will be flagged by the AI LSP, potentially missing other relevant issues for the user. Consider iterating over all `positions` to generate diagnostics for every occurrence.\"}, {\"message\": \"Accessing `server.lsp.diagnostics` relies on an internal, potentially private, attribute of the `pygls` LanguageServer implementation. This approach is fragile and might break with future updates to `pygls`, coupling your code tightly to its internal structure. It's generally safer to interact with LSP features through documented public APIs or to manage diagnostic state more explicitly within `AILanguageServer` if direct access is unavoidable.\", \"issue_snippet\": \"getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\", \"severity\": \"warning\"}]}}}]}, \"gen_ai.system\": \"google-gla\", \"event.name\": \"gen_ai.choice\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"events\": {\"type\": \"array\"}, \"model_request_parameters\": {\"type\": \"object\"}}}"}}],"status":{}},{"traceId":"019a79465c8e3b7b4f44a5b8eea497b3","spanId":"df6280551e39e8ba","parentSpanId":"df05a48cf566b422","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762971245711310000","endTimeUnixNano":"1762971266689977000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"final_result","value":{"stringValue":"{\"issues\": [{\"issue_snippet\": \"text[:start_pos].split(\\\"\\\\n\\\")\", \"severity\": \"warning\", \"message\": \"Repeatedly calling `split('\\\\n')` on a growing string slice within a loop to calculate line and column numbers is inefficient for large documents or many snippet occurrences. This leads to quadratic time complexity in the worst case for text processing. Pre-calculating line start offsets or iterating line-by-line would be more performant to avoid redundant work.\", \"suggested_fixes\": null}, {\"issue_snippet\": \"positions[0]\", \"severity\": \"info\", \"message\": \"The `find_snippet_in_text` method correctly identifies all occurrences of an `issue_snippet`, but only the first occurrence (`positions[0]`) is used to generate a diagnostic. If the same semantic issue appears multiple times in a document, only the first instance will be flagged by the AI LSP, potentially missing other relevant issues for the user. Consider iterating over all `positions` to generate diagnostics for every occurrence.\", \"suggested_fixes\": null}, {\"issue_snippet\": \"getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\", \"severity\": \"warning\", \"message\": \"Accessing `server.lsp.diagnostics` relies on an internal, potentially private, attribute of the `pygls` LanguageServer implementation. This approach is fragile and might break with future updates to `pygls`, coupling your code tightly to its internal structure. It's generally safer to interact with LSP features through documented public APIs or to manage diagnostic state more explicitly within `AILanguageServer` if direct access is unavoidable.\", \"suggested_fixes\": null}]}"}},{"key":"gen_ai.usage.input_tokens","value":{"intValue":"4882"}},{"key":"gen_ai.usage.output_tokens","value":{"intValue":"347"}},{"key":"gen_ai.usage.details.thoughts_tokens","value":{"intValue":"3310"}},{"key":"gen_ai.usage.details.text_prompt_tokens","value":{"intValue":"4882"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this python code for issues:\\n\\n```python\\nimport asyncio\\nimport os\\nfrom pathlib import Path\\nfrom typing import Any, Literal\\nfrom importlib.metadata import version\\nimport logfire\\n\\n# pyrefly: ignore [missing-import]\\nfrom lsprotocol.types import (\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    TEXT_DOCUMENT_DID_CHANGE,\\n    TEXT_DOCUMENT_DID_OPEN,\\n    TEXT_DOCUMENT_DID_SAVE,\\n    CodeAction,\\n    CodeActionKind,\\n    CodeActionOptions,\\n    CodeActionParams,\\n    Command,\\n    Diagnostic,\\n    DiagnosticSeverity,\\n    DidChangeTextDocumentParams,\\n    DidOpenTextDocumentParams,\\n    DidSaveTextDocumentParams,\\n    Position,\\n    Range,\\n    TextEdit,\\n    WorkspaceEdit,\\n)\\nfrom pydantic import BaseModel, Field\\nfrom pydantic_ai import Agent\\nfrom pydantic_ai.models import KnownModelName\\nfrom pydantic_settings import BaseSettings\\n\\n# pyrefly: ignore [missing-import]\\nfrom pygls.server import LanguageServer\\n\\n\\nclass Settings(BaseSettings):\\n    ai_lsp_model: KnownModelName = Field(default=\\\"google-gla:gemini-2.5-flash\\\")\\n    debounce_ms: int = Field(default=1000)\\n    max_cache_size: int = Field(default=50)\\n    configure_logfire: bool = Field(default=True)\\n    otel_exporter_otlp_endpoint: str = Field(default=\\\"http://localhost:4318\\\")\\n\\n\\nsettings = Settings()\\n\\n\\nos.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\\n\\nif settings.configure_logfire:\\n    logfire.configure(send_to_logfire=False, service_name=\\\"ai-lsp\\\")\\n    logfire.instrument_pydantic_ai()\\n    logfire.instrument_httpx(capture_all=True)\\n\\n\\nclass SuggestedFix(BaseModel):\\n    title: str\\n    target_snippet: str\\n    replacement_snippet: str\\n\\n\\nclass CodeIssue(BaseModel):\\n    issue_snippet: str\\n    severity: Literal[\\\"error\\\", \\\"warning\\\", \\\"info\\\", \\\"hint\\\"]\\n    message: str\\n    suggested_fixes: list[SuggestedFix] | None = None\\n\\n\\nclass DiagnosticResult(BaseModel):\\n    issues: list[CodeIssue]\\n\\n\\nclass AILanguageServer(LanguageServer):\\n    def __init__(self):\\n        super().__init__(\\\"ai-lsp\\\", version(\\\"ai-lsp\\\"))\\n        logfire.info(\\\"Initializing AI Language Server\\\")\\n        self._pending_tasks: dict[str, asyncio.Task[Any]] = {}\\n        self._analysis_locks: dict[str, asyncio.Lock] = {}\\n\\n        self.agent: Agent[DiagnosticResult, Any] = Agent(\\n            model=settings.ai_lsp_model,\\n            output_type=DiagnosticResult,\\n            system_prompt=\\\"\\\"\\\"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\\\"\\\"\\\",\\n        )\\n        logfire.info(\\\"AI agent initialized successfully\\\")\\n\\n    def find_snippet_in_text(\\n        self, text: str, snippet: str\\n    ) -> list[tuple[int, int, int, int]]:\\n        \\\"\\\"\\\"Find all occurrences of code snippet in text, return positions as (start_line, start_col, end_line, end_col)\\\"\\\"\\\"\\n        snippet = snippet.strip()\\n        positions = []\\n\\n        # Search for all occurrences of snippet\\n        start_pos = 0\\n        while True:\\n            start_pos = text.find(snippet, start_pos)\\n            if start_pos == -1:\\n                break\\n\\n            # Convert character position to line/column\\n            lines = text[:start_pos].split(\\\"\\\\n\\\")\\n            start_line = len(lines) - 1\\n            start_col = len(lines[-1])\\n\\n            # Calculate end position\\n            snippet_lines = snippet.split(\\\"\\\\n\\\")\\n            if len(snippet_lines) == 1:\\n                end_line = start_line\\n                end_col = start_col + len(snippet)\\n            else:\\n                end_line = start_line + len(snippet_lines) - 1\\n                end_col = len(snippet_lines[-1])\\n\\n            positions.append((start_line, start_col, end_line, end_col))\\n            start_pos += 1  # Move past this occurrence\\n\\n        if not positions:\\n            logfire.warn(f\\\"Could not find snippet '{snippet}' in text\\\")\\n        else:\\n            logfire.debug(f\\\"Found {len(positions)} occurrences of '{snippet[:20]}...'\\\")\\n\\n        return positions\\n\\n    async def debounced_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Debounced analysis that cancels previous calls\\\"\\\"\\\"\\n        # Cancel any existing task for this URI\\n        if uri in self._pending_tasks:\\n            self._pending_tasks[uri].cancel()\\n            _ = self._pending_tasks.pop(uri, None)\\n\\n        # Create new task\\n        task: asyncio.Task[None] = asyncio.create_task(self._delayed_analyze(uri, text))\\n        self._pending_tasks[uri] = task\\n\\n        try:\\n            await task\\n        except asyncio.CancelledError:\\n            logfire.debug(f\\\"Analysis cancelled for {uri}\\\")\\n        finally:\\n            # Clean up completed task\\n            if uri in self._pending_tasks and self._pending_tasks[uri] == task:\\n                _ = self._pending_tasks.pop(uri)\\n\\n    async def _delayed_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Wait for debounce period then analyze\\\"\\\"\\\"\\n        await asyncio.sleep(settings.debounce_ms / 1000.0)\\n        diagnostics = await self.analyze_document(uri, text)\\n        # pyrefly: ignore [missing-attribute]\\n        self.publish_diagnostics(uri, diagnostics)\\n        logfire.debug(f\\\"Published {len(diagnostics)} diagnostics for {uri}\\\")\\n\\n    async def analyze_document(self, uri: str, text: str) -> list[Diagnostic]:\\n        # Ensure we have a lock for this URI\\n        lock = self._analysis_locks.setdefault(uri, asyncio.Lock())\\n        async with lock:\\n            with logfire.span(\\\"analyze_document\\\", uri=uri):\\n                logfire.info(f\\\"Starting AI analysis for {uri}\\\")\\n\\n                try:\\n                    file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n                    language = self._detect_language(file_path)\\n\\n                    prompt = f\\\"\\\"\\\"Analyze this {language} code for issues:\\n\\n```{language}\\n{text}\\n```\\n\\nFile: {file_path.name}\\\"\\\"\\\"\\n\\n                    result = await self.agent.run(prompt)\\n                    logfire.info(\\n                        f\\\"AI analysis completed, found {len(result.output.issues)} issues\\\"\\n                    )\\n\\n                    diagnostics = []\\n                    for issue in result.output.issues:\\n                        positions = self.find_snippet_in_text(text, issue.issue_snippet)\\n\\n                        if positions:\\n                            start_line, start_col, end_line, end_col = positions[0]\\n                            diagnostic = Diagnostic(\\n                                range=Range(\\n                                    start=Position(\\n                                        line=start_line, character=start_col\\n                                    ),\\n                                    end=Position(line=end_line, character=end_col),\\n                                ),\\n                                message=f\\\"AI LSP: {issue.message}\\\",\\n                                severity=self._get_diagnostic_severity(issue.severity),\\n                                source=\\\"ai-lsp\\\",\\n                                data={\\n                                    \\\"issue_snippet\\\": issue.issue_snippet,\\n                                    \\\"suggested_fixes\\\": [\\n                                        {\\n                                            \\\"title\\\": fix.title,\\n                                            \\\"target_snippet\\\": fix.target_snippet,\\n                                            \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                        }\\n                                        for fix in (issue.suggested_fixes or [])\\n                                    ],\\n                                },\\n                            )\\n                            diagnostics.append(diagnostic)\\n\\n                    return diagnostics\\n\\n                except Exception as e:\\n                    logfire.error(\\n                        f\\\"AI analysis failed for {uri}: {str(e)}\\\", _exc_info=True\\n                    )\\n                    return []\\n\\n    def _get_diagnostic_severity(self, severity: str) -> DiagnosticSeverity:\\n        match severity:\\n            case \\\"error\\\":\\n                return DiagnosticSeverity.Error\\n            case \\\"warning\\\":\\n                return DiagnosticSeverity.Warning\\n            case \\\"info\\\":\\n                return DiagnosticSeverity.Information\\n            case \\\"hint\\\":\\n                return DiagnosticSeverity.Hint\\n            case _:\\n                return DiagnosticSeverity.Information\\n\\n    def _detect_language(self, file_path: Path) -> str:\\n        match file_path.suffix:\\n            case \\\".py\\\":\\n                return \\\"python\\\"\\n            case \\\".js\\\":\\n                return \\\"javascript\\\"\\n            case \\\".ts\\\":\\n                return \\\"typescript\\\"\\n            case \\\".jsx\\\":\\n                return \\\"jsx\\\"\\n            case \\\".tsx\\\":\\n                return \\\"tsx\\\"\\n            case \\\".rs\\\":\\n                return \\\"rust\\\"\\n            case \\\".go\\\":\\n                return \\\"go\\\"\\n            case \\\".java\\\":\\n                return \\\"java\\\"\\n            case \\\".cpp\\\":\\n                return \\\"cpp\\\"\\n            case \\\".c\\\":\\n                return \\\"c\\\"\\n            case \\\".lua\\\":\\n                return \\\"lua\\\"\\n            case _:\\n                return \\\"text\\\"\\n\\n\\nserver = AILanguageServer()\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_OPEN)\\nasync def did_open(params: DidOpenTextDocumentParams):\\n    logfire.info(f\\\"Document opened: {params.text_document.uri}\\\")\\n    doc = params.text_document\\n    await server.debounced_analyze(doc.uri, doc.text)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_SAVE)\\nasync def did_save(params: DidSaveTextDocumentParams):\\n    logfire.info(f\\\"Document saved: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_CHANGE)\\nasync def did_change(params: DidChangeTextDocumentParams):\\n    logfire.debug(f\\\"Document changed: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    CodeActionOptions(code_action_kinds=[CodeActionKind.QuickFix]),\\n)\\nasync def code_actions(params: CodeActionParams) -> list[CodeAction]:\\n    with logfire.span(\\\"code_actions\\\", uri=params.text_document.uri):\\n        actions: list[CodeAction] = []\\n        uri = params.text_document.uri\\n        doc = server.workspace.get_text_document(uri)\\n\\n        for diagnostic in params.context.diagnostics:\\n            if diagnostic.source != \\\"ai-lsp\\\" or not diagnostic.data:\\n                continue\\n\\n            suggested_fixes = diagnostic.data.get(\\\"suggested_fixes\\\", [])\\n\\n            for fix_data in suggested_fixes:\\n                target_positions = server.find_snippet_in_text(\\n                    doc.source, fix_data[\\\"target_snippet\\\"]\\n                )\\n\\n                if target_positions:\\n                    with logfire.span(\\\"creating_quick_fix\\\", title=fix_data[\\\"title\\\"]):\\n                        start_line, start_col, end_line, end_col = target_positions[0]\\n                        fix_range = Range(\\n                            start=Position(line=start_line, character=start_col),\\n                            end=Position(line=end_line, character=end_col),\\n                        )\\n\\n                        edit = WorkspaceEdit(\\n                            changes={\\n                                uri: [\\n                                    TextEdit(\\n                                        range=fix_range,\\n                                        new_text=fix_data[\\\"replacement_snippet\\\"],\\n                                    )\\n                                ]\\n                            }\\n                        )\\n\\n                        action = CodeAction(\\n                            title=f\\\"Apply: {fix_data['title']}\\\",\\n                            kind=CodeActionKind.QuickFix,\\n                            edit=edit,\\n                            diagnostics=[diagnostic],\\n                            is_preferred=True,\\n                        )\\n                        actions.append(action)\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Regenerate AI fix\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Regenerate fix\\\",\\n                        command=\\\"ai-lsp.regenerateFix\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.data.get(\\\"issue_snippet\\\"),\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Dismiss AI suggestion\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Dismiss\\\",\\n                        command=\\\"ai-lsp.dismiss\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n        return actions\\n\\n\\n@server.command(\\\"ai-lsp.regenerateFix\\\")\\nasync def regenerate_fix(*args):\\n    if len(args) < 4:\\n        return\\n\\n    uri, issue_snippet, line, character = args[0], args[1], args[2], args[3]\\n\\n    with logfire.span(\\\"regenerate_fix\\\", uri=uri, issue_snippet=issue_snippet):\\n        logfire.info(\\n            f\\\"Regenerating fix for '{issue_snippet}' at {uri}:{line}:{character}\\\"\\n        )\\n\\n        doc = server.workspace.get_text_document(uri)\\n        file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n        language = server._detect_language(file_path)\\n\\n        prompt = f\\\"\\\"\\\"Analyze this specific code issue and provide NEW suggested fixes.\\n\\nIssue snippet: {issue_snippet}\\n\\nFull code context:\\n```{language}\\n{doc.source}\\n```\\n\\nFile: {file_path.name}\\n\\nFocus ONLY on the issue at the snippet shown. Provide fresh, alternative fixes if possible.\\\"\\\"\\\"\\n\\n        try:\\n            result = await server.agent.run(prompt)\\n\\n            if not result.output.issues:\\n                logfire.warn(\\\"No issues returned for regeneration\\\")\\n                return\\n\\n            regenerated_issue = result.output.issues[0]\\n\\n            current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n            updated_diags = []\\n\\n            for diag in current_diags:\\n                if (\\n                    diag.source == \\\"ai-lsp\\\"\\n                    and diag.range.start.line == line\\n                    and diag.range.start.character == character\\n                ):\\n                    positions = server.find_snippet_in_text(\\n                        doc.source, regenerated_issue.issue_snippet\\n                    )\\n                    if positions:\\n                        start_line, start_col, end_line, end_col = positions[0]\\n                        updated_diag = Diagnostic(\\n                            range=Range(\\n                                start=Position(line=start_line, character=start_col),\\n                                end=Position(line=end_line, character=end_col),\\n                            ),\\n                            message=f\\\"AI LSP: {regenerated_issue.message}\\\",\\n                            severity=server._get_diagnostic_severity(\\n                                regenerated_issue.severity\\n                            ),\\n                            source=\\\"ai-lsp\\\",\\n                            data={\\n                                \\\"issue_snippet\\\": regenerated_issue.issue_snippet,\\n                                \\\"suggested_fixes\\\": [\\n                                    {\\n                                        \\\"title\\\": fix.title,\\n                                        \\\"target_snippet\\\": fix.target_snippet,\\n                                        \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                    }\\n                                    for fix in (regenerated_issue.suggested_fixes or [])\\n                                ],\\n                            },\\n                        )\\n                        updated_diags.append(updated_diag)\\n                        logfire.info(\\n                            f\\\"Regenerated diagnostic with {len(regenerated_issue.suggested_fixes or [])} new fixes\\\"\\n                        )\\n                else:\\n                    updated_diags.append(diag)\\n\\n            server.publish_diagnostics(uri, updated_diags)\\n\\n        except Exception as e:\\n            logfire.error(f\\\"Failed to regenerate fix: {str(e)}\\\", _exc_info=True)\\n\\n\\n@server.command(\\\"ai-lsp.dismiss\\\")\\ndef dismiss_suggestion(*args):\\n    if len(args) < 3:\\n        return\\n\\n    uri, line, character = args[0], args[1], args[2]\\n\\n    with logfire.span(\\\"dismiss_suggestion\\\", uri=uri, line=line, character=character):\\n        logfire.info(f\\\"Dismissing suggestion at {uri}:{line}:{character}\\\")\\n\\n        doc = server.workspace.get_text_document(uri)\\n        diagnostics = []\\n\\n        current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n        for diag in current_diags:\\n            if (\\n                diag.source == \\\"ai-lsp\\\"\\n                and diag.range.start.line == line\\n                and diag.range.start.character == character\\n            ):\\n                continue\\n            diagnostics.append(diag)\\n\\n        server.publish_diagnostics(uri, diagnostics)\\n\\n\\ndef app():\\n    server.start_io()\\n\\n\\nif __name__ == \\\"__main__\\\":\\n    app()\\n\\n```\\n\\nFile: main.py\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}, {\"role\": \"assistant\", \"tool_calls\": [{\"id\": \"pyd_ai_d6a1e992ee63478ba348e0003f75fb8b\", \"type\": \"function\", \"function\": {\"name\": \"final_result\", \"arguments\": {\"issues\": [{\"severity\": \"warning\", \"message\": \"Repeatedly calling `split('\\\\n')` on a growing string slice within a loop to calculate line and column numbers is inefficient for large documents or many snippet occurrences. This leads to quadratic time complexity in the worst case for text processing. Pre-calculating line start offsets or iterating line-by-line would be more performant to avoid redundant work.\", \"issue_snippet\": \"text[:start_pos].split(\\\"\\\\n\\\")\"}, {\"issue_snippet\": \"positions[0]\", \"severity\": \"info\", \"message\": \"The `find_snippet_in_text` method correctly identifies all occurrences of an `issue_snippet`, but only the first occurrence (`positions[0]`) is used to generate a diagnostic. If the same semantic issue appears multiple times in a document, only the first instance will be flagged by the AI LSP, potentially missing other relevant issues for the user. Consider iterating over all `positions` to generate diagnostics for every occurrence.\"}, {\"message\": \"Accessing `server.lsp.diagnostics` relies on an internal, potentially private, attribute of the `pygls` LanguageServer implementation. This approach is fragile and might break with future updates to `pygls`, coupling your code tightly to its internal structure. It's generally safer to interact with LSP features through documented public APIs or to manage diagnostic state more explicitly within `AILanguageServer` if direct access is unavoidable.\", \"issue_snippet\": \"getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\", \"severity\": \"warning\"}]}}}], \"gen_ai.message.index\": 1, \"event.name\": \"gen_ai.assistant.message\"}, {\"content\": \"Final result processed.\", \"role\": \"tool\", \"id\": \"pyd_ai_d6a1e992ee63478ba348e0003f75fb8b\", \"name\": \"final_result\", \"gen_ai.message.index\": 2, \"event.name\": \"gen_ai.tool.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]},{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a79465c8e3b7b4f44a5b8eea497b3","spanId":"b4daeae84f4d507b","parentSpanId":"df05a48cf566b422","flags":256,"name":"AI analysis completed, found {len(result.output.issues)} issues","kind":1,"startTimeUnixNano":"1762971266699744000","endTimeUnixNano":"1762971266699744000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI analysis completed, found {len(result.output.issues)} issues"}},{"key":"logfire.msg","value":{"stringValue":"AI analysis completed, found 3 issues"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"203"}},{"key":"len(result.output.issues)","value":{"intValue":"3"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(result.output.issues)\":{}}}"}}],"status":{}},{"traceId":"019a79465c8e3b7b4f44a5b8eea497b3","spanId":"9ee1a4068ccd0e57","parentSpanId":"df05a48cf566b422","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762971266702317000","endTimeUnixNano":"1762971266702317000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of 'text[:start_pos].spl...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"text[:start_pos].spl"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a79465c8e3b7b4f44a5b8eea497b3","spanId":"bb78514918f1331a","parentSpanId":"df05a48cf566b422","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762971266702733000","endTimeUnixNano":"1762971266702733000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 3 occurrences of 'positions[0]...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"3"}},{"key":"snippet[:20]","value":{"stringValue":"positions[0]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a79465c8e3b7b4f44a5b8eea497b3","spanId":"1e84950b0fdf1ef1","parentSpanId":"df05a48cf566b422","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762971266703007000","endTimeUnixNano":"1762971266703007000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 2 occurrences of 'getattr(server.lsp, ...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"2"}},{"key":"snippet[:20]","value":{"stringValue":"getattr(server.lsp, "}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a79465c8e3b7b4f44a5b8eea497b3","spanId":"df05a48cf566b422","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762971245710588000","endTimeUnixNano":"1762971266703140000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a7946ae94206b44af565d03b4950e","spanId":"df0d27c80fc1fb4d","flags":256,"name":"Published {len(diagnostics)} diagnostics for {uri}","kind":1,"startTimeUnixNano":"1762971266708640000","endTimeUnixNano":"1762971266708640000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Published {len(diagnostics)} diagnostics for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Published 3 diagnostics for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer._delayed_analyze"}},{"key":"code.lineno","value":{"intValue":"181"}},{"key":"len(diagnostics)","value":{"intValue":"3"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(diagnostics)\":{},\"uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"035681d08ccb448eaf20f77e9e2c5347"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"93334"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a79772185e88760f062713e46e542","spanId":"20ba7a579ff6a901","flags":256,"name":"Initializing AI Language Server","kind":1,"startTimeUnixNano":"1762974441861141000","endTimeUnixNano":"1762974441861141000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Initializing AI Language Server"}},{"key":"logfire.msg","value":{"stringValue":"Initializing AI Language Server"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"77"}}],"status":{}},{"traceId":"019a797723b028de245ac511c4ba0c57","spanId":"c87c14fdbe684b56","flags":256,"name":"AI agent initialized successfully","kind":1,"startTimeUnixNano":"1762974442416087000","endTimeUnixNano":"1762974442416087000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI agent initialized successfully"}},{"key":"logfire.msg","value":{"stringValue":"AI agent initialized successfully"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"115"}}],"status":{}},{"traceId":"019a797723cf10607d61fef513d867a8","spanId":"98d6edb7c5c6452d","flags":256,"name":"Document opened: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762974442447358000","endTimeUnixNano":"1762974442447358000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document opened: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document opened: file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_open"}},{"key":"code.lineno","value":{"intValue":"291"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a797727bd9d53891d7c107f460c11","spanId":"fa442aab7daad255","parentSpanId":"8e94a4a11e08bb5f","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762974443454552000","endTimeUnixNano":"1762974443454552000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"035681d08ccb448eaf20f77e9e2c5347"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"93334"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a79778332f3f91449c56012ef21b7","spanId":"fba342a263955875","flags":256,"name":"Document saved: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762974466866727000","endTimeUnixNano":"1762974466866727000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document saved: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document saved: file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_save"}},{"key":"code.lineno","value":{"intValue":"298"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a797727bd9d53891d7c107f460c11","spanId":"8e94a4a11e08bb5f","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762974443453064000","endTimeUnixNano":"1762974466880992000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762974466871909000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a79778342b193ef49ea74de2ebf5a","spanId":"689ff3c34a381535","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762974466882024000","endTimeUnixNano":"1762974466882024000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7977871c9ed8dad684c699b0034a","spanId":"1c88cccf7321bbc8","parentSpanId":"417a54ffd0eeb365","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762974467869116000","endTimeUnixNano":"1762974467869116000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a797727bd9d53891d7c107f460c11","spanId":"21c909c119429a2c","parentSpanId":"96faf400c81a9d20","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762974443456842000","endTimeUnixNano":"1762974466867335000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a797727bd9d53891d7c107f460c11","spanId":"96faf400c81a9d20","parentSpanId":"8e94a4a11e08bb5f","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762974443455737000","endTimeUnixNano":"1762974466867577000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this python code for issues:\\n\\n```python\\nimport asyncio\\nimport os\\nfrom pathlib import Path\\nfrom typing import Any, Literal\\nfrom importlib.metadata import version\\nimport logfire\\n\\n# pyrefly: ignore [missing-import]\\nfrom lsprotocol.types import (\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    TEXT_DOCUMENT_DID_CHANGE,\\n    TEXT_DOCUMENT_DID_OPEN,\\n    TEXT_DOCUMENT_DID_SAVE,\\n    CodeAction,\\n    CodeActionKind,\\n    CodeActionOptions,\\n    CodeActionParams,\\n    Command,\\n    Diagnostic,\\n    DiagnosticSeverity,\\n    DidChangeTextDocumentParams,\\n    DidOpenTextDocumentParams,\\n    DidSaveTextDocumentParams,\\n    Position,\\n    Range,\\n    TextEdit,\\n    WorkspaceEdit,\\n)\\nfrom pydantic import BaseModel, Field\\nfrom pydantic_ai import Agent\\nfrom pydantic_ai.models import KnownModelName\\nfrom pydantic_settings import BaseSettings\\n\\n# pyrefly: ignore [missing-import]\\nfrom pygls.server import LanguageServer\\n\\n\\nclass Settings(BaseSettings):\\n    ai_lsp_model: KnownModelName = Field(default=\\\"google-gla:gemini-2.5-flash\\\")\\n    debounce_ms: int = Field(default=1000)\\n    max_cache_size: int = Field(default=50)\\n    configure_logfire: bool = Field(default=True)\\n    otel_exporter_otlp_endpoint: str = Field(default=\\\"http://localhost:4318\\\")\\n\\n\\nsettings = Settings()\\n\\n\\nos.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\\n\\nif settings.configure_logfire:\\n    logfire.configure(send_to_logfire=False, service_name=\\\"ai-lsp\\\")\\n    logfire.instrument_pydantic_ai()\\n    logfire.instrument_httpx(capture_all=True)\\n\\n\\nclass SuggestedFix(BaseModel):\\n    title: str\\n    target_snippet: str\\n    replacement_snippet: str\\n\\n\\nclass CodeIssue(BaseModel):\\n    issue_snippet: str\\n    severity: Literal[\\\"error\\\", \\\"warning\\\", \\\"info\\\", \\\"hint\\\"]\\n    message: str\\n    suggested_fixes: list[SuggestedFix] | None = None\\n\\n\\nclass DiagnosticResult(BaseModel):\\n    issues: list[CodeIssue]\\n\\n\\nclass AILanguageServer(LanguageServer):\\n    def __init__(self):\\n        super().__init__(\\\"ai-lsp\\\", version(\\\"ai-lsp\\\"))\\n        logfire.info(\\\"Initializing AI Language Server\\\")\\n        self._pending_tasks: dict[str, asyncio.Task[Any]] = {}\\n        self._analysis_locks: dict[str, asyncio.Lock] = {}\\n\\n        self.agent: Agent[DiagnosticResult, Any] = Agent(\\n            model=settings.ai_lsp_model,\\n            output_type=DiagnosticResult,\\n            system_prompt=\\\"\\\"\\\"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\\\"\\\"\\\",\\n        )\\n        logfire.info(\\\"AI agent initialized successfully\\\")\\n\\n    def find_snippet_in_text(\\n        self, text: str, snippet: str\\n    ) -> list[tuple[int, int, int, int]]:\\n        \\\"\\\"\\\"Find all occurrences of code snippet in text, return positions as (start_line, start_col, end_line, end_col)\\\"\\\"\\\"\\n        snippet = snippet.strip()\\n        positions = []\\n\\n        # Search for all occurrences of snippet\\n        start_pos = 0\\n        while True:\\n            start_pos = text.find(snippet, start_pos)\\n            if start_pos == -1:\\n                break\\n\\n            # Convert character position to line/column\\n            lines = text[:start_pos].split(\\\"\\\\n\\\")\\n            start_line = len(lines) - 1\\n            start_col = len(lines[-1])\\n\\n            # Calculate end position\\n            snippet_lines = snippet.split(\\\"\\\\n\\\")\\n            if len(snippet_lines) == 1:\\n                end_line = start_line\\n                end_col = start_col + len(snippet)\\n            else:\\n                end_line = start_line + len(snippet_lines) - 1\\n                end_col = len(snippet_lines[-1])\\n\\n            positions.append((start_line, start_col, end_line, end_col))\\n            start_pos += 1  # Move past this occurrence\\n\\n        if not positions:\\n            logfire.warn(f\\\"Could not find snippet '{snippet}' in text\\\")\\n        else:\\n            logfire.debug(f\\\"Found {len(positions)} occurrences of '{snippet[:20]}...'\\\")\\n\\n        return positions\\n\\n    async def debounced_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Debounced analysis that cancels previous calls\\\"\\\"\\\"\\n        # Cancel any existing task for this URI\\n        if uri in self._pending_tasks:\\n            self._pending_tasks[uri].cancel()\\n            _ = self._pending_tasks.pop(uri, None)\\n\\n        # Create new task\\n        task: asyncio.Task[None] = asyncio.create_task(self._delayed_analyze(uri, text))\\n        self._pending_tasks[uri] = task\\n\\n        try:\\n            await task\\n        except asyncio.CancelledError:\\n            logfire.debug(f\\\"Analysis cancelled for {uri}\\\")\\n        finally:\\n            # Clean up completed task\\n            if uri in self._pending_tasks and self._pending_tasks[uri] == task:\\n                _ = self._pending_tasks.pop(uri)\\n\\n    async def _delayed_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Wait for debounce period then analyze\\\"\\\"\\\"\\n        await asyncio.sleep(settings.debounce_ms / 1000.0)\\n        diagnostics = await self.analyze_document(uri, text)\\n        # pyrefly: ignore [missing-attribute]\\n        self.publish_diagnostics(uri, diagnostics)\\n        logfire.debug(f\\\"Published {len(diagnostics)} diagnostics for {uri}\\\")\\n\\n    async def analyze_document(self, uri: str, text: str) -> list[Diagnostic]:\\n        # Ensure we have a lock for this URI\\n        lock = self._analysis_locks.setdefault(uri, asyncio.Lock())\\n        async with lock:\\n            with logfire.span(\\\"analyze_document\\\", uri=uri):\\n                logfire.info(f\\\"Starting AI analysis for {uri}\\\")\\n\\n                try:\\n                    file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n                    language = self._detect_language(file_path)\\n\\n                    prompt = f\\\"\\\"\\\"Analyze this {language} code for issues:\\n\\n```{language}\\n{text}\\n```\\n\\nFile: {file_path.name}\\\"\\\"\\\"\\n\\n                    result = await self.agent.run(prompt)\\n                    logfire.info(\\n                        f\\\"AI analysis completed, found {len(result.output.issues)} issues\\\"\\n                    )\\n\\n                    diagnostics = []\\n                    for issue in result.output.issues:\\n                        positions = self.find_snippet_in_text(text, issue.issue_snippet)\\n\\n                        if positions:\\n                            start_line, start_col, end_line, end_col = positions[0]\\n                            diagnostic = Diagnostic(\\n                                range=Range(\\n                                    start=Position(\\n                                        line=start_line, character=start_col\\n                                    ),\\n                                    end=Position(line=end_line, character=end_col),\\n                                ),\\n                                message=f\\\"AI LSP: {issue.message}\\\",\\n                                severity=self._get_diagnostic_severity(issue.severity),\\n                                source=\\\"ai-lsp\\\",\\n                                data={\\n                                    \\\"issue_snippet\\\": issue.issue_snippet,\\n                                    \\\"suggested_fixes\\\": [\\n                                        {\\n                                            \\\"title\\\": fix.title,\\n                                            \\\"target_snippet\\\": fix.target_snippet,\\n                                            \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                        }\\n                                        for fix in (issue.suggested_fixes or [])\\n                                    ],\\n                                },\\n                            )\\n                            diagnostics.append(diagnostic)\\n\\n                    return diagnostics\\n\\n                except Exception as e:\\n                    logfire.error(\\n                        f\\\"AI analysis failed for {uri}: {str(e)}\\\", _exc_info=True\\n                    )\\n                    return []\\n\\n    def _get_diagnostic_severity(self, severity: str) -> DiagnosticSeverity:\\n        match severity:\\n            case \\\"error\\\":\\n                return DiagnosticSeverity.Error\\n            case \\\"warning\\\":\\n                return DiagnosticSeverity.Warning\\n            case \\\"info\\\":\\n                return DiagnosticSeverity.Information\\n            case \\\"hint\\\":\\n                return DiagnosticSeverity.Hint\\n            case _:\\n                return DiagnosticSeverity.Information\\n\\n    def _detect_language(self, file_path: Path) -> str:\\n        match file_path.suffix:\\n            case \\\".py\\\":\\n                return \\\"python\\\"\\n            case \\\".js\\\":\\n                return \\\"javascript\\\"\\n            case \\\".ts\\\":\\n                return \\\"typescript\\\"\\n            case \\\".jsx\\\":\\n                return \\\"jsx\\\"\\n            case \\\".tsx\\\":\\n                return \\\"tsx\\\"\\n            case \\\".rs\\\":\\n                return \\\"rust\\\"\\n            case \\\".go\\\":\\n                return \\\"go\\\"\\n            case \\\".java\\\":\\n                return \\\"java\\\"\\n            case \\\".cpp\\\":\\n                return \\\"cpp\\\"\\n            case \\\".c\\\":\\n                return \\\"c\\\"\\n            case \\\".lua\\\":\\n                return \\\"lua\\\"\\n            case _:\\n                return \\\"text\\\"\\n\\n\\nserver = AILanguageServer()\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_OPEN)\\nasync def did_open(params: DidOpenTextDocumentParams):\\n    logfire.info(f\\\"Document opened: {params.text_document.uri}\\\")\\n    doc = params.text_document\\n    await server.debounced_analyze(doc.uri, doc.text)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_SAVE)\\nasync def did_save(params: DidSaveTextDocumentParams):\\n    logfire.info(f\\\"Document saved: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_CHANGE)\\nasync def did_change(params: DidChangeTextDocumentParams):\\n    logfire.debug(f\\\"Document changed: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    CodeActionOptions(code_action_kinds=[CodeActionKind.QuickFix]),\\n)\\nasync def code_actions(params: CodeActionParams) -> list[CodeAction]:\\n    with logfire.span(\\\"code_actions\\\", uri=params.text_document.uri):\\n        actions: list[CodeAction] = []\\n        uri = params.text_document.uri\\n        doc = server.workspace.get_text_document(uri)\\n\\n        for diagnostic in params.context.diagnostics:\\n            if diagnostic.source != \\\"ai-lsp\\\" or not diagnostic.data:\\n                continue\\n\\n            suggested_fixes = diagnostic.data.get(\\\"suggested_fixes\\\", [])\\n\\n            for fix_data in suggested_fixes:\\n                target_positions = server.find_snippet_in_text(\\n                    doc.source, fix_data[\\\"target_snippet\\\"]\\n                )\\n\\n                if target_positions:\\n                    with logfire.span(\\\"creating_quick_fix\\\", title=fix_data[\\\"title\\\"]):\\n                        start_line, start_col, end_line, end_col = target_positions[0]\\n                        fix_range = Range(\\n                            start=Position(line=start_line, character=start_col),\\n                            end=Position(line=end_line, character=end_col),\\n                        )\\n\\n                        edit = WorkspaceEdit(\\n                            changes={\\n                                uri: [\\n                                    TextEdit(\\n                                        range=fix_range,\\n                                        new_text=fix_data[\\\"replacement_snippet\\\"],\\n                                    )\\n                                ]\\n                            }\\n                        )\\n\\n                        action = CodeAction(\\n                            title=f\\\"Apply: {fix_data['title']}\\\",\\n                            kind=CodeActionKind.QuickFix,\\n                            edit=edit,\\n                            diagnostics=[diagnostic],\\n                            is_preferred=True,\\n                        )\\n                        actions.append(action)\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Regenerate AI fix\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Regenerate fix\\\",\\n                        command=\\\"ai-lsp.regenerateFix\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.data.get(\\\"issue_snippet\\\"),\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Dismiss AI suggestion\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Dismiss\\\",\\n                        command=\\\"ai-lsp.dismiss\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n        return actions\\n\\n\\n@server.command(\\\"ai-lsp.regenerateFix\\\")\\nasync def regenerate_fix(*args):\\n    if len(args) < 4:\\n        return\\n\\n    uri, issue_snippet, line, character = args[0], args[1], args[2], args[3]\\n\\n    with logfire.span(\\\"regenerate_fix\\\", uri=uri, issue_snippet=issue_snippet):\\n        logfire.info(\\n            f\\\"Regenerating fix for '{issue_snippet}' at {uri}:{line}:{character}\\\"\\n        )\\n\\n        doc = server.workspace.get_text_document(uri)\\n        file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n        language = server._detect_language(file_path)\\n\\n        prompt = f\\\"\\\"\\\"Analyze this specific code issue and provide NEW suggested fixes.\\n\\nIssue snippet: {issue_snippet}\\n\\nFull code context:\\n```{language}\\n{doc.source}\\n```\\n\\nFile: {file_path.name}\\n\\nFocus ONLY on the issue at the snippet shown. Provide fresh, alternative fixes if possible.\\\"\\\"\\\"\\n\\n        try:\\n            result = await server.agent.run(prompt)\\n\\n            if not result.output.issues:\\n                logfire.warn(\\\"No issues returned for regeneration\\\")\\n                return\\n\\n            regenerated_issue = result.output.issues[0]\\n\\n            current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n            updated_diags = []\\n\\n            for diag in current_diags:\\n                if (\\n                    diag.source == \\\"ai-lsp\\\"\\n                    and diag.range.start.line == line\\n                    and diag.range.start.character == character\\n                ):\\n                    positions = server.find_snippet_in_text(\\n                        doc.source, regenerated_issue.issue_snippet\\n                    )\\n                    if positions:\\n                        start_line, start_col, end_line, end_col = positions[0]\\n                        updated_diag = Diagnostic(\\n                            range=Range(\\n                                start=Position(line=start_line, character=start_col),\\n                                end=Position(line=end_line, character=end_col),\\n                            ),\\n                            message=f\\\"AI LSP: {regenerated_issue.message}\\\",\\n                            severity=server._get_diagnostic_severity(\\n                                regenerated_issue.severity\\n                            ),\\n                            source=\\\"ai-lsp\\\",\\n                            data={\\n                                \\\"issue_snippet\\\": regenerated_issue.issue_snippet,\\n                                \\\"suggested_fixes\\\": [\\n                                    {\\n                                        \\\"title\\\": fix.title,\\n                                        \\\"target_snippet\\\": fix.target_snippet,\\n                                        \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                    }\\n                                    for fix in (regenerated_issue.suggested_fixes or [])\\n                                ],\\n                            },\\n                        )\\n                        updated_diags.append(updated_diag)\\n                        logfire.info(\\n                            f\\\"Regenerated diagnostic with {len(regenerated_issue.suggested_fixes or [])} new fixes\\\"\\n                        )\\n                else:\\n                    updated_diags.append(diag)\\n\\n            server.publish_diagnostics(uri, updated_diags)\\n\\n        except Exception as e:\\n            logfire.error(f\\\"Failed to regenerate fix: {str(e)}\\\", _exc_info=True)\\n\\n\\n@server.command(\\\"ai-lsp.dismiss\\\")\\ndef dismiss_suggestion(*args):\\n    if len(args) < 3:\\n        return\\n\\n    uri, line, character = args[0], args[1], args[2]\\n\\n    with logfire.span(\\\"dismiss_suggestion\\\", uri=uri, line=line, character=character):\\n        logfire.info(f\\\"Dismissing suggestion at {uri}:{line}:{character}\\\")\\n\\n        doc = server.workspace.get_text_document(uri)\\n        diagnostics = []\\n\\n        current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n        for diag in current_diags:\\n            if (\\n                diag.source == \\\"ai-lsp\\\"\\n                and diag.range.start.line == line\\n                and diag.range.start.character == character\\n            ):\\n                continue\\n            diagnostics.append(diag)\\n\\n        server.publish_diagnostics(uri, diagnostics)\\n\\n\\ndef app():\\n    server.start_io()\\n\\n\\nif __name__ == \\\"__main__\\\":\\n    app()\\n\\n```\\n\\nFile: main.py\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"035681d08ccb448eaf20f77e9e2c5347"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"93334"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a7977871c9ed8dad684c699b0034a","spanId":"417a54ffd0eeb365","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762974467868594000","endTimeUnixNano":"1762974481742128000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a7977871c9ed8dad684c699b0034a","spanId":"b387caade76856f7","parentSpanId":"417a54ffd0eeb365","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762974467870189000","endTimeUnixNano":"1762974481742352000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a7977871c9ed8dad684c699b0034a","spanId":"255d1fca2af65e18","parentSpanId":"b387caade76856f7","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762974467871170000","endTimeUnixNano":"1762974481742591000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"a410cd2d65084a57911648777d4de572"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"99136"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a7978be4ac12d8fe8b6defccb29c6","spanId":"f0ffe9e821d49ad4","flags":256,"name":"Initializing AI Language Server","kind":1,"startTimeUnixNano":"1762974547530171000","endTimeUnixNano":"1762974547530171000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Initializing AI Language Server"}},{"key":"logfire.msg","value":{"stringValue":"Initializing AI Language Server"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"77"}}],"status":{}},{"traceId":"019a7978bfda37cb406b0ebad9f96985","spanId":"9cfac55b83c6b307","flags":256,"name":"AI agent initialized successfully","kind":1,"startTimeUnixNano":"1762974547930556000","endTimeUnixNano":"1762974547930556000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI agent initialized successfully"}},{"key":"logfire.msg","value":{"stringValue":"AI agent initialized successfully"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"115"}}],"status":{}},{"traceId":"019a7978bfed956ea68ef96d865e51f0","spanId":"7bb7ee885ba817f3","flags":256,"name":"Document opened: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762974547949945000","endTimeUnixNano":"1762974547949945000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document opened: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document opened: file:///Users/benomahony/.config/nvim/lua/config/keymaps.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_open"}},{"key":"code.lineno","value":{"intValue":"291"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/config/keymaps.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7978c3d84001e3b0e570fb463448","spanId":"8557ed0a0b94a1e2","parentSpanId":"85d0ab07cab90a2d","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762974548952826000","endTimeUnixNano":"1762974548952826000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/config/keymaps.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/config/keymaps.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7978c3d84001e3b0e570fb463448","spanId":"85d0ab07cab90a2d","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762974548952401000","endTimeUnixNano":"1762974549254479000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/config/keymaps.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a7978c3d84001e3b0e570fb463448","spanId":"5b2d909f854e33f7","parentSpanId":"85d0ab07cab90a2d","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762974548953338000","endTimeUnixNano":"1762974549254561000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a7978c3d84001e3b0e570fb463448","spanId":"44b9a2f7b7d99527","parentSpanId":"5b2d909f854e33f7","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762974548953843000","endTimeUnixNano":"1762974549254593000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"a8808ef98af74577b449d2cb7ef32c77"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"5317"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a7978e18e84738aa00634db29cf53","spanId":"f44ae5c14f8d4d7d","flags":256,"name":"Initializing AI Language Server","kind":1,"startTimeUnixNano":"1762974556558930000","endTimeUnixNano":"1762974556558930000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Initializing AI Language Server"}},{"key":"logfire.msg","value":{"stringValue":"Initializing AI Language Server"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"77"}}],"status":{}},{"traceId":"019a7978e2e5975ce940737fad8dd13f","spanId":"c89cab7361d7e2f4","flags":256,"name":"AI agent initialized successfully","kind":1,"startTimeUnixNano":"1762974556901952000","endTimeUnixNano":"1762974556901952000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI agent initialized successfully"}},{"key":"logfire.msg","value":{"stringValue":"AI agent initialized successfully"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"115"}}],"status":{}},{"traceId":"019a7978e2f975b12a9d85a53c68a329","spanId":"45b37f07b396f283","flags":256,"name":"Document opened: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762974556921452000","endTimeUnixNano":"1762974556921452000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document opened: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document opened: file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_open"}},{"key":"code.lineno","value":{"intValue":"291"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"f6e71058edd527ca","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762974557924993000","endTimeUnixNano":"1762974557924993000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"a8808ef98af74577b449d2cb7ef32c77"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"5317"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"16342131937e7fa4","parentSpanId":"db5ae19c3fb9a61f","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762974557926430000","endTimeUnixNano":"1762974607190206000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.usage.input_tokens","value":{"intValue":"9365"}},{"key":"gen_ai.usage.output_tokens","value":{"intValue":"1854"}},{"key":"gen_ai.usage.details.thoughts_tokens","value":{"intValue":"7914"}},{"key":"gen_ai.usage.details.text_prompt_tokens","value":{"intValue":"9365"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.system\": \"google-gla\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\n-- uv.nvim - Neovim plugin for uv Python package management integration\\n-- Author: Ben O'Mahony\\n-- License: MIT\\n\\nlocal M = {}\\n\\n-- Default configuration\\nM.config = {\\n\\t-- Auto-activate virtual environments when found\\n\\tauto_activate_venv = true,\\n\\tnotify_activate_venv = true,\\n\\n\\t-- Auto commands for directory changes\\n\\tauto_commands = true,\\n\\n\\t-- Integration with picker (like Telescope or other UI components)\\n\\tpicker_integration = true,\\n\\n\\t-- Keymaps to register (set to false to disable)\\n\\tkeymaps = {\\n\\t\\tprefix = \\\"<leader>x\\\", -- Main prefix for UV commands\\n\\t\\tcommands = true, -- Show UV commands menu (<leader>x)\\n\\t\\trun_file = true, -- Run current file (<leader>xr)\\n\\t\\trun_selection = true, -- Run selection (<leader>xs)\\n\\t\\trun_function = true, -- Run function (<leader>xf)\\n\\t\\tvenv = true, -- Environment management (<leader>xe)\\n\\t\\tinit = true, -- Initialize UV project (<leader>xi)\\n\\t\\tadd = true, -- Add a package (<leader>xa)\\n\\t\\tremove = true, -- Remove a package (<leader>xd)\\n\\t\\tsync = true, -- Sync packages (<leader>xc)\\n\\t\\tsync_all = true, -- uv sync --all-extras --all-groups --all-packages (<leader>xC)\\n\\t},\\n\\n\\t-- Execution options\\n\\texecution = {\\n\\t\\t-- Python run command template\\n\\t\\trun_command = \\\"uv run python\\\",\\n\\n\\t\\t-- Show output in notifications\\n\\t\\tnotify_output = true,\\n\\n\\t\\t-- Notification timeout in ms\\n\\t\\tnotification_timeout = 10000,\\n\\t},\\n}\\n\\n-- Command runner - runs shell commands and captures output\\nfunction M.run_command(cmd)\\n\\t-- Run command in background and capture output\\n\\tvim.fn.jobstart(cmd, {\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Command completed successfully: \\\" .. cmd, vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Command failed: \\\" .. cmd, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Only show meaningful output (not empty lines)\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Show errors\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.WARN)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Virtual environment activation\\nfunction M.activate_venv(venv_path)\\n\\t-- For Mac, run the source command to apply to the current shell\\n\\tlocal command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n\\t-- Set environment variables for the current Neovim instance\\n\\tvim.env.VIRTUAL_ENV = venv_path\\n\\tvim.env.PATH = venv_path .. \\\"/bin:\\\" .. vim.env.PATH\\n\\t-- Notify user\\n\\tif M.config.notify_activate_venv then\\n\\t\\tvim.notify(\\\"Activated virtual environment: \\\" .. venv_path, vim.log.levels.INFO)\\n\\tend\\nend\\n\\n-- Auto-activate the .venv if it exists at the project root\\nfunction M.auto_activate_venv()\\n\\tlocal venv_path = vim.fn.getcwd() .. \\\"/.venv\\\"\\n\\tif vim.fn.isdirectory(venv_path) == 1 then\\n\\t\\tM.activate_venv(venv_path)\\n\\t\\treturn true\\n\\tend\\n\\treturn false\\nend\\n\\n-- Function to create a temporary file with the necessary context and selected code\\nfunction M.run_python_selection()\\n\\t-- Get visual selection\\n\\tlocal get_visual_selection = function()\\n\\t\\tlocal start_pos = vim.fn.getpos(\\\"'<\\\")\\n\\t\\tlocal end_pos = vim.fn.getpos(\\\"'>\\\")\\n\\t\\tlocal lines = vim.fn.getline(start_pos[2], end_pos[2])\\n\\n\\t\\tif #lines == 0 then\\n\\t\\t\\treturn \\\"\\\"\\n\\t\\tend\\n\\n\\t\\t-- Adjust last line to end at the column position of end_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[#lines] = lines[#lines]:sub(1, end_pos[3])\\n\\t\\tend\\n\\n\\t\\t-- Adjust first line to start at the column position of start_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[1] = lines[1]:sub(start_pos[3])\\n\\t\\tend\\n\\n\\t\\treturn table.concat(lines, \\\"\\\\n\\\")\\n\\tend\\n\\n\\t-- Get current buffer content to extract imports and global variables\\n\\tlocal get_buffer_globals = function()\\n\\t\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\t\\tlocal imports = {}\\n\\t\\tlocal globals = {}\\n\\t\\tlocal in_class = false\\n\\t\\tlocal class_indent = 0\\n\\n\\t\\tfor _, line in ipairs(lines) do\\n\\t\\t\\t-- Detect imports\\n\\t\\t\\tif line:match(\\\"^%s*import \\\") or line:match(\\\"^%s*from .+ import\\\") then\\n\\t\\t\\t\\ttable.insert(imports, line)\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect class definitions to skip class variables\\n\\t\\t\\tif line:match(\\\"^%s*class \\\") then\\n\\t\\t\\t\\tin_class = true\\n\\t\\t\\t\\tclass_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Check if we're exiting a class block\\n\\t\\t\\tif in_class and line:match(\\\"^%s*[^%s#]\\\") then\\n\\t\\t\\t\\tlocal current_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\t\\tif current_indent <= class_indent then\\n\\t\\t\\t\\t\\tin_class = false\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect global variable assignments (not in class, not inside functions)\\n\\t\\t\\tif not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\\n\\t\\t\\t\\t-- Check if it's not indented (global scope)\\n\\t\\t\\t\\tif not line:match(\\\"^%s%s+\\\") then\\n\\t\\t\\t\\t\\ttable.insert(globals, line)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend\\n\\n\\t\\treturn imports, globals\\n\\tend\\n\\n\\t-- Get selected code\\n\\tlocal selection = get_visual_selection()\\n\\tif selection == \\\"\\\" then\\n\\t\\tvim.notify(\\\"No code selected\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Get imports and globals\\n\\tlocal imports, globals = get_buffer_globals()\\n\\n\\t-- Create temp file\\n\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\tlocal temp_file = temp_dir .. \\\"/run_selection.py\\\"\\n\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\tif not file then\\n\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Write imports\\n\\tfor _, imp in ipairs(imports) do\\n\\t\\tfile:write(imp .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write globals\\n\\tfor _, glob in ipairs(globals) do\\n\\t\\tfile:write(glob .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write selected code\\n\\tfile:write(\\\"# SELECTED CODE\\\\n\\\")\\n\\n\\t-- Check if the selection is all indented (which would cause syntax errors)\\n\\tlocal is_all_indented = true\\n\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tif not line:match(\\\"^%s+\\\") and line ~= \\\"\\\" then\\n\\t\\t\\tis_all_indented = false\\n\\t\\t\\tbreak\\n\\t\\tend\\n\\tend\\n\\n\\t-- Process the selection to determine what type of code it is\\n\\tlocal is_function_def = selection:match(\\\"^%s*def%s+[%w_]+%s*%(\\\")\\n\\tlocal is_class_def = selection:match(\\\"^%s*class%s+[%w_]+\\\")\\n\\tlocal has_print = selection:match(\\\"print%s*%(\\\")\\n\\tlocal is_expression = not is_function_def\\n\\t\\tand not is_class_def\\n\\t\\tand not selection:match(\\\"=\\\")\\n\\t\\tand not selection:match(\\\"%s*for%s+\\\")\\n\\t\\tand not selection:match(\\\"%s*if%s+\\\")\\n\\t\\tand not has_print\\n\\n\\t-- If the selection is all indented, we need to dedent it or wrap it in a function\\n\\tif is_all_indented then\\n\\t\\tfile:write(\\\"def run_selection():\\\\n\\\")\\n\\t\\t-- Write the selection with original indentation\\n\\t\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\t\\tfile:write(\\\"    \\\" .. line .. \\\"\\\\n\\\")\\n\\t\\tend\\n\\t\\tfile:write(\\\"\\\\n# Auto-call the wrapper function\\\\n\\\")\\n\\t\\tfile:write(\\\"run_selection()\\\\n\\\")\\n\\telse\\n\\t\\t-- Write the original selection\\n\\t\\tfile:write(selection .. \\\"\\\\n\\\")\\n\\n\\t\\t-- For expressions, we'll add a print statement to see the result\\n\\t\\tif is_expression then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added print for expression\\\\n\\\")\\n\\t\\t\\tfile:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\\n\\t\\t-- For function definitions without calls, we'll add a call\\n\\t\\telseif is_function_def then\\n\\t\\t\\tlocal function_name = selection:match(\\\"def%s+([%w_]+)%s*%(\\\")\\n\\t\\t\\t-- Check if the function is already called in the selection\\n\\t\\t\\tif function_name and not selection:match(function_name .. \\\"%s*%(.-%)\\\") then\\n\\t\\t\\t\\tfile:write(\\\"\\\\n# Auto-added function call\\\\n\\\")\\n\\t\\t\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\t\\t\\tfile:write('    print(f\\\"Auto-executing function: ' .. function_name .. '\\\")\\\\n')\\n\\t\\t\\t\\tfile:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\\n\\t\\t\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\t\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\t\\tend\\n\\t\\t-- If there's no print statement in the code, add an output marker\\n\\t\\telseif not has_print and not selection:match(\\\"^%s*#\\\") then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added execution marker\\\\n\\\")\\n\\t\\t\\tfile:write('print(\\\"Code executed successfully.\\\")\\\\n')\\n\\t\\tend\\n\\tend\\n\\n\\tfile:close()\\n\\n\\t-- Run the temp file\\n\\tvim.notify(\\\"Running selected code...\\\", vim.log.levels.INFO)\\n\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Selected code executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Selected code execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Function to run a specific Python function\\nfunction M.run_python_function()\\n\\t-- Get current buffer content\\n\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\tlocal buffer_content = table.concat(lines, \\\"\\\\n\\\")\\n\\n\\t-- Find all function definitions\\n\\tlocal functions = {}\\n\\tfor line in buffer_content:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tlocal func_name = line:match(\\\"^def%s+([%w_]+)%s*%(\\\")\\n\\t\\tif func_name then\\n\\t\\t\\ttable.insert(functions, func_name)\\n\\t\\tend\\n\\tend\\n\\n\\tif #functions == 0 then\\n\\t\\tvim.notify(\\\"No functions found in current file\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Create temp file for function selection picker\\n\\tlocal run_function = function(func_name)\\n\\t\\t-- Create a temporary file with a main block to call the function\\n\\t\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\t\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\t\\tlocal temp_file = temp_dir .. \\\"/run_function.py\\\"\\n\\t\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\n\\t\\t-- Create a wrapper script that imports the current file and calls the function\\n\\t\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\t\\tif not file then\\n\\t\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\t\\treturn\\n\\t\\tend\\n\\n\\t\\t-- Get the module name (file name without .py)\\n\\t\\tlocal module_name = vim.fn.fnamemodify(current_file, \\\":t:r\\\")\\n\\t\\tlocal module_dir = vim.fn.fnamemodify(current_file, \\\":h\\\")\\n\\n\\t\\t-- Write imports\\n\\t\\tfile:write(\\\"import sys\\\\n\\\")\\n\\t\\tfile:write(\\\"sys.path.insert(0, \\\" .. vim.inspect(module_dir) .. \\\")\\\\n\\\")\\n\\t\\tfile:write(\\\"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\")\\n\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\tfile:write('    print(f\\\"Running function: ' .. func_name .. '\\\")\\\\n')\\n\\t\\tfile:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\\n\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\tfile:close()\\n\\n\\t\\t-- Run the temp file\\n\\t\\tvim.notify(\\\"Running function: \\\" .. func_name, vim.log.levels.INFO)\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\tend\\n\\n\\t-- If there's only one function, run it directly\\n\\tif #functions == 1 then\\n\\t\\trun_function(functions[1])\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Otherwise, show a picker to select the function\\n\\tvim.ui.select(functions, {\\n\\t\\tprompt = \\\"Select function to run:\\\",\\n\\t\\tformat_item = function(item)\\n\\t\\t\\treturn \\\"def \\\" .. item .. \\\"()\\\"\\n\\t\\tend,\\n\\t}, function(choice)\\n\\t\\tif choice then\\n\\t\\t\\trun_function(choice)\\n\\t\\tend\\n\\tend)\\nend\\n\\n-- Run current file\\nfunction M.run_file()\\n\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\tif current_file and current_file ~= \\\"\\\" then\\n\\t\\tvim.notify(\\\"Running: \\\" .. vim.fn.expand(\\\"%:t\\\"), vim.log.levels.INFO)\\n\\t\\t-- Run python on the current file and capture output to notifications\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(current_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution completed successfully\\\", vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\telse\\n\\t\\tvim.notify(\\\"No file is open\\\", vim.log.levels.WARN)\\n\\tend\\nend\\n\\n-- Set up command pickers for integration with UI plugins\\nfunction M.setup_pickers()\\n\\t-- Check if Snacks is available\\n\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t-- Register UV command source\\n\\t\\tSnacks.picker.sources.uv_commands = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t{ text = \\\"Run current file\\\", desc = \\\"Run current file with Python\\\", is_run_current = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run selection\\\", desc = \\\"Run selected Python code\\\", is_run_selection = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run function\\\", desc = \\\"Run specific Python function\\\", is_run_function = true },\\n\\t\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", desc = \\\"Install a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv sync\\\", desc = \\\"Sync packages from lockfile\\\" },\\n\\t\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\t\\tdesc = \\\"Sync all extras, groups and packages\\\",\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", desc = \\\"Remove a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv init\\\", desc = \\\"Initialize a new project\\\" },\\n\\t\\t\\t\\t}\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\treturn { { item.text .. \\\" - \\\" .. item.desc } }\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\t\\tif item.is_run_current then\\n\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_selection then\\n\\t\\t\\t\\t\\t\\t-- Check if there's a visual selection\\n\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\n\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\") -- Exit visual mode\\n\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t-- If not in visual mode, prompt the user to select text\\n\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t-- After notification, we'll set up a one-time autocmd to catch when visual mode is exited\\n\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\", -- When changing from any visual mode to normal mode\\n\\t\\t\\t\\t\\t\\t\\t\\tcallback = function(ev)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true -- Delete the autocmd after it's been triggered\\n\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_function then\\n\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\tlocal cmd = item.text\\n\\t\\t\\t\\t\\t-- Check if command needs input\\n\\t\\t\\t\\t\\tif cmd:match(\\\"%[(.-)%]\\\") then\\n\\t\\t\\t\\t\\t\\tlocal param_name = cmd:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\tvim.ui.input({ prompt = \\\"Enter \\\" .. param_name .. \\\": \\\" }, function(input)\\n\\t\\t\\t\\t\\t\\t\\tif not input or input == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t-- Replace the placeholder with actual input\\n\\t\\t\\t\\t\\t\\t\\tlocal actual_cmd = cmd:gsub(\\\"%[\\\" .. param_name .. \\\"%]\\\", input)\\n\\t\\t\\t\\t\\t\\t\\tM.run_command(actual_cmd)\\n\\t\\t\\t\\t\\t\\tend)\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t-- Run the command directly\\n\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\n\\t\\t-- Register UV venv source\\n\\t\\tSnacks.picker.sources.uv_venv = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\tlocal venvs = {}\\n\\t\\t\\t\\t-- Check for .venv directory (uv's default)\\n\\t\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\tif #venvs == 0 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\"Create new virtual environment (uv venv)\\\",\\n\\t\\t\\t\\t\\t\\tis_create = true,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\treturn venvs\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\treturn { { \\\"+ \\\" .. item.text } }\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tlocal icon = item.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\"\\n\\t\\t\\t\\t\\treturn { { icon .. item.text .. \\\" (Activate)\\\" } }\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\tM.activate_venv(item.path)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\tend\\n\\n\\t-- Check if Telescope is available\\n\\tlocal has_telescope, telescope = pcall(require, \\\"telescope\\\")\\n\\tif has_telescope then\\n\\t\\tlocal pickers = require(\\\"telescope.pickers\\\")\\n\\t\\tlocal finders = require(\\\"telescope.finders\\\")\\n\\t\\tlocal sorters = require(\\\"telescope.sorters\\\")\\n\\t\\tlocal actions = require(\\\"telescope.actions\\\")\\n\\t\\tlocal action_state = require(\\\"telescope.actions.state\\\")\\n\\n\\t\\t-- UV Commands picker for Telescope\\n\\t\\tM.pick_uv_commands = function()\\n\\t\\t\\tlocal items = {\\n\\t\\t\\t\\t{ text = \\\"Run current file\\\", is_run_current = true },\\n\\t\\t\\t\\t{ text = \\\"Run selection\\\", is_run_selection = true },\\n\\t\\t\\t\\t{ text = \\\"Run function\\\", is_run_function = true },\\n\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", cmd = \\\"uv add \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv sync\\\", cmd = \\\"uv sync\\\" },\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\tcmd = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", cmd = \\\"uv remove \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv init\\\", cmd = \\\"uv init\\\" },\\n\\t\\t\\t}\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Commands\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_run_current then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_selection then\\n\\t\\t\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\t\\t\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_function then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tif selection.needs_input then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal placeholder = selection.text:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.ui.input(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t{ prompt = \\\"Enter \\\" .. (placeholder or \\\"value\\\") .. \\\": \\\" },\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfunction(input)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tif input and input ~= \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal cmd = selection.cmd .. input\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(selection.cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\n\\t\\t-- UV venv picker for Telescope\\n\\t\\tM.pick_uv_venv = function()\\n\\t\\t\\tlocal items = {}\\n\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\ttable.insert(items, {\\n\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t})\\n\\t\\t\\tend\\n\\t\\t\\tif #items == 0 then\\n\\t\\t\\t\\ttable.insert(items, { text = \\\"Create new virtual environment (uv venv)\\\", is_create = true })\\n\\t\\t\\tend\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Virtual Environments\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\tlocal display = entry.is_create and \\\"+ \\\" .. entry.text\\n\\t\\t\\t\\t\\t\\t\\t\\tor ((entry.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\") .. entry.text .. \\\" (Activate)\\\")\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = display,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = display,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_create then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tM.activate_venv(selection.path)\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Set up user commands\\nfunction M.setup_commands()\\n\\t-- Set up UV commands\\n\\tvim.api.nvim_create_user_command(\\\"UVInit\\\", function()\\n\\t\\tM.run_command(\\\"uv init\\\")\\n\\tend, {})\\n\\n\\t-- Command to run selected code\\n\\tvim.api.nvim_create_user_command(\\\"UVRunSelection\\\", function()\\n\\t\\tM.run_python_selection()\\n\\tend, { range = true })\\n\\n\\t-- Command to run a specific function\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFunction\\\", function()\\n\\t\\tM.run_python_function()\\n\\tend, {})\\n\\n\\t-- Command to run the current file\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFile\\\", function()\\n\\t\\tM.run_file()\\n\\tend, {})\\n\\n\\t-- Command to add a package\\n\\tvim.api.nvim_create_user_command(\\\"UVAddPackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv add \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\n\\n\\t-- Command to remove a package\\n\\tvim.api.nvim_create_user_command(\\\"UVRemovePackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv remove \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\nend\\n\\n-- Set up keymaps\\nfunction M.setup_keymaps()\\n\\tlocal keymaps = M.config.keymaps\\n\\tlocal prefix = keymaps.prefix or \\\"<leader>x\\\"\\n\\n\\t-- Main UV command menu\\n\\tif keymaps.commands then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Run current file\\n\\tif keymaps.run_file then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"r\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFile<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Current File\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run selection\\n\\tif keymaps.run_selection then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"v\\\",\\n\\t\\t\\tprefix .. \\\"s\\\",\\n\\t\\t\\t\\\":<C-u>UVRunSelection<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Selection\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run function\\n\\tif keymaps.run_function then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"f\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFunction<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Function\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Environment management\\n\\tif keymaps.venv then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_venv')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope_venv = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope_venv then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_venv()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Initialize UV project\\n\\tif keymaps.init then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"i\\\",\\n\\t\\t\\t\\\"<cmd>UVInit<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Init\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Add a package\\n\\tif keymaps.add then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"a\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv add ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Add Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Remove a package\\n\\tif keymaps.remove then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"d\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv remove ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Remove Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Sync packages\\n\\tif keymaps.sync then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"c\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync Packages\\\" }\\n\\t\\t)\\n\\tend\\n\\tif keymaps.sync_all then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"C\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync --all-extras --all-packages --all-groups')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync All Extras, Groups and Packages\\\" }\\n\\t\\t)\\n\\tend\\nend\\n\\n-- Set up auto commands\\nfunction M.setup_autocommands()\\n\\tif M.config.auto_commands then\\n\\t\\t-- Auto-activate .venv if it exists\\n\\t\\tif M.config.auto_activate_venv then\\n\\t\\t\\tM.auto_activate_venv()\\n\\n\\t\\t\\t-- Also set up auto-command to check when entering a directory\\n\\t\\t\\tvim.api.nvim_create_autocmd({ \\\"DirChanged\\\" }, {\\n\\t\\t\\t\\tpattern = { \\\"global\\\" },\\n\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\tM.auto_activate_venv()\\n\\t\\t\\t\\tend,\\n\\t\\t\\t})\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Main setup function\\nfunction M.setup(opts)\\n\\t-- Merge user configuration with defaults\\n\\tM.config = vim.tbl_deep_extend(\\\"force\\\", M.config, opts or {})\\n\\n\\t-- Set up commands\\n\\tM.setup_commands()\\n\\n\\t-- Set up keymaps if enabled\\n\\tif M.config.keymaps ~= false then\\n\\t\\tM.setup_keymaps()\\n\\tend\\n\\n\\t-- Set up autocommands if enabled\\n\\tif M.config.auto_commands ~= false then\\n\\t\\tM.setup_autocommands()\\n\\tend\\n\\n\\t-- Set up pickers if integration is enabled\\n\\tif M.config.picker_integration then\\n\\t\\tM.setup_pickers()\\n\\tend\\n\\n\\t-- Make run_command globally accessible (can be removed if not needed)\\n\\t_G.run_command = M.run_command\\nend\\n\\nreturn M\\n\\n```\\n\\nFile: init.lua\", \"role\": \"user\", \"gen_ai.system\": \"google-gla\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}, {\"index\": 0, \"message\": {\"role\": \"assistant\", \"tool_calls\": [{\"id\": \"pyd_ai_a076092a98f949a7a3fdf876818b46b9\", \"type\": \"function\", \"function\": {\"name\": \"final_result\", \"arguments\": {\"issues\": [{\"suggested_fixes\": [{\"title\": \"Escape user command arguments for 'UVAddPackage'.\", \"target_snippet\": \"opts.args\", \"replacement_snippet\": \"vim.fn.shellescape(opts.args)\"}, {\"replacement_snippet\": \"vim.fn.shellescape(opts.args)\", \"target_snippet\": \"opts.args\", \"title\": \"Escape user command arguments for 'UVRemovePackage'.\"}], \"message\": \"User input from `opts.args` in user commands (`UVAddPackage`, `UVRemovePackage`) is directly concatenated into shell commands without being escaped. A malicious user could inject arbitrary shell commands (e.g., `my_package; rm -rf /`), leading to a critical remote code execution vulnerability.\", \"severity\": \"error\", \"issue_snippet\": \"opts.args\"}, {\"suggested_fixes\": [{\"replacement_snippet\": \"local actual_cmd = cmd:gsub(\\\"%[(.-)%]\\\", vim.fn.shellescape(input))\", \"title\": \"Escape user input for Snacks picker commands.\", \"target_snippet\": \"local actual_cmd = cmd:gsub(\\\"%[(.-)%]\\\", input)\"}, {\"title\": \"Escape user input for Telescope picker commands.\", \"target_snippet\": \"local cmd = selection.cmd .. input\", \"replacement_snippet\": \"local cmd = selection.cmd .. vim.fn.shellescape(input)\"}, {\"replacement_snippet\": \"require('uv').run_command('uv add ' .. vim.fn.shellescape(input))\", \"title\": \"Escape user input for 'add package' keymap.\", \"target_snippet\": \"require('uv').run_command('uv add ' .. input)\"}, {\"title\": \"Escape user input for 'remove package' keymap.\", \"target_snippet\": \"require('uv').run_command('uv remove ' .. input)\", \"replacement_snippet\": \"require('uv').run_command('uv remove ' .. vim.fn.shellescape(input))\"}], \"severity\": \"error\", \"issue_snippet\": \"input\", \"message\": \"User input obtained via `vim.ui.input` (e.g., for adding/removing packages from pickers or keymaps) is directly concatenated into shell commands without being escaped. This is a critical remote code execution vulnerability, as an attacker can inject malicious shell commands (e.g., `my_package; rm -rf /`). This pattern is repeated in Snacks picker, Telescope picker, and direct keymaps for `uv add` and `uv remove`.\"}, {\"message\": \"The `source` command is executed in a subshell via `vim.fn.jobstart`. The `source` command is a shell built-in that modifies the *current* shell's environment. Running it in a subshell means its effects on environment variables are confined to that subshell and do not propagate back to the Neovim process. While `vim.env.VIRTUAL_ENV` and `vim.env.PATH` are manually updated, this might not fully replicate all environment changes typically made by a complete virtual environment activation script, potentially leading to an incomplete setup for subsequent Python commands.\", \"severity\": \"warning\", \"issue_snippet\": \"local command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\", \"suggested_fixes\": null}, {\"message\": \"The logic to extract global variables (`get_buffer_globals`) relies on simplistic regex matching and indentation checks. It might inaccurately classify local variables within top-level functions or complex assignments as globals, especially in non-trivial Python codebases. This can lead to `NameError` or unexpected behavior when the selected Python code is executed in isolation, as its dependencies might not be correctly provided. A more robust solution would involve proper Python AST parsing.\", \"issue_snippet\": \"if not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\", \"suggested_fixes\": null, \"severity\": \"warning\"}, {\"issue_snippet\": \"print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\", \"severity\": \"warning\", \"message\": \"When automatically wrapping selected expressions for printing, inserting the expression directly into an f-string can lead to `SyntaxError` if the expression itself contains f-string syntax (e.g., `{}`) or unescaped quotes. A safer approach is to assign the expression to a temporary variable and then print its `str()` representation.\", \"suggested_fixes\": [{\"replacement_snippet\": \"local cleaned_selection = selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\")\\nfile:write(\\\"_uv_expr_result = (\\\" .. cleaned_selection .. \\\")\\\\n\\\")\\nfile:write('print(\\\"Expression result: \\\" + str(_uv_expr_result))\\\\n')\", \"target_snippet\": \"file:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\", \"title\": \"Use a temporary variable and `str()` for safer expression printing.\"}]}, {\"severity\": \"warning\", \"message\": \"The logic for `M.run_python_selection` wraps all indented selected code in a new function (`def run_selection():`). However, if the selected code itself is an indented function or class definition (e.g., a method inside a class), this wrapping will result in a `SyntaxError` (e.g., `def` nested at the same level) or incorrect execution context. The checks for `is_function_def` and `is_class_def` should explicitly prevent this wrapping.\", \"suggested_fixes\": [{\"target_snippet\": \"if is_all_indented then\", \"title\": \"Avoid redundant function wrapping for indented function/class definitions.\", \"replacement_snippet\": \"if is_all_indented and not is_function_def and not is_class_def then\"}], \"issue_snippet\": \"if is_all_indented then\"}, {\"message\": \"The plugin creates temporary Python files for executing selections and functions in `~/.cache/nvim/uv_run`. There is no explicit mechanism to clean up these temporary files after execution, which can lead to accumulation and unnecessary disk space usage over time.\", \"suggested_fixes\": null, \"issue_snippet\": \"local temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\", \"severity\": \"info\"}, {\"severity\": \"info\", \"issue_snippet\": \"_G.run_command = M.run_command\", \"message\": \"Exposing `M.run_command` globally as `_G.run_command` pollutes the global namespace. While the comment suggests it 'can be removed if not needed', its presence can lead to naming conflicts with other plugins or scripts and makes the module less encapsulated. It is generally better to explicitly require the module to access its functions.\", \"suggested_fixes\": [{\"replacement_snippet\": \"-- _G.run_command = M.run_command -- Removed global exposure to prevent namespace pollution\", \"title\": \"Remove global exposure if not strictly necessary.\", \"target_snippet\": \"_G.run_command = M.run_command\"}]}, {\"issue_snippet\": \"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\"\", \"severity\": \"info\", \"message\": \"When running a specific Python function (`M.run_python_function`), the temporary script imports the entire current Python file as a module. This means all top-level code in that module will be executed upon import, including `if __name__ == \\\"__main__\\\":` blocks, global variable assignments, and any other statements outside of function definitions. This can lead to unintended side effects, inefficient execution, or incorrect behavior if the module's top-level code relies on a specific execution context.\", \"suggested_fixes\": null}, {\"message\": \"The logic for integrating with `Snacks` and `Telescope` pickers contains significant duplication in defining command items and the `on_select`/`confirm` logic. This violates the DRY (Don't Repeat Yourself) principle, making the code harder to maintain and update. Refactoring into shared data structures and helper functions would improve maintainability.\", \"severity\": \"info\", \"issue_snippet\": \"finder = function()\", \"suggested_fixes\": null}]}}}]}, \"gen_ai.system\": \"google-gla\", \"event.name\": \"gen_ai.choice\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"events\": {\"type\": \"array\"}, \"model_request_parameters\": {\"type\": \"object\"}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"db5ae19c3fb9a61f","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762974557925728000","endTimeUnixNano":"1762974607207268000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"final_result","value":{"stringValue":"{\"issues\": [{\"issue_snippet\": \"opts.args\", \"severity\": \"error\", \"message\": \"User input from `opts.args` in user commands (`UVAddPackage`, `UVRemovePackage`) is directly concatenated into shell commands without being escaped. A malicious user could inject arbitrary shell commands (e.g., `my_package; rm -rf /`), leading to a critical remote code execution vulnerability.\", \"suggested_fixes\": [{\"title\": \"Escape user command arguments for 'UVAddPackage'.\", \"target_snippet\": \"opts.args\", \"replacement_snippet\": \"vim.fn.shellescape(opts.args)\"}, {\"title\": \"Escape user command arguments for 'UVRemovePackage'.\", \"target_snippet\": \"opts.args\", \"replacement_snippet\": \"vim.fn.shellescape(opts.args)\"}]}, {\"issue_snippet\": \"input\", \"severity\": \"error\", \"message\": \"User input obtained via `vim.ui.input` (e.g., for adding/removing packages from pickers or keymaps) is directly concatenated into shell commands without being escaped. This is a critical remote code execution vulnerability, as an attacker can inject malicious shell commands (e.g., `my_package; rm -rf /`). This pattern is repeated in Snacks picker, Telescope picker, and direct keymaps for `uv add` and `uv remove`.\", \"suggested_fixes\": [{\"title\": \"Escape user input for Snacks picker commands.\", \"target_snippet\": \"local actual_cmd = cmd:gsub(\\\"%[(.-)%]\\\", input)\", \"replacement_snippet\": \"local actual_cmd = cmd:gsub(\\\"%[(.-)%]\\\", vim.fn.shellescape(input))\"}, {\"title\": \"Escape user input for Telescope picker commands.\", \"target_snippet\": \"local cmd = selection.cmd .. input\", \"replacement_snippet\": \"local cmd = selection.cmd .. vim.fn.shellescape(input)\"}, {\"title\": \"Escape user input for 'add package' keymap.\", \"target_snippet\": \"require('uv').run_command('uv add ' .. input)\", \"replacement_snippet\": \"require('uv').run_command('uv add ' .. vim.fn.shellescape(input))\"}, {\"title\": \"Escape user input for 'remove package' keymap.\", \"target_snippet\": \"require('uv').run_command('uv remove ' .. input)\", \"replacement_snippet\": \"require('uv').run_command('uv remove ' .. vim.fn.shellescape(input))\"}]}, {\"issue_snippet\": \"local command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\", \"severity\": \"warning\", \"message\": \"The `source` command is executed in a subshell via `vim.fn.jobstart`. The `source` command is a shell built-in that modifies the *current* shell's environment. Running it in a subshell means its effects on environment variables are confined to that subshell and do not propagate back to the Neovim process. While `vim.env.VIRTUAL_ENV` and `vim.env.PATH` are manually updated, this might not fully replicate all environment changes typically made by a complete virtual environment activation script, potentially leading to an incomplete setup for subsequent Python commands.\", \"suggested_fixes\": null}, {\"issue_snippet\": \"if not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\", \"severity\": \"warning\", \"message\": \"The logic to extract global variables (`get_buffer_globals`) relies on simplistic regex matching and indentation checks. It might inaccurately classify local variables within top-level functions or complex assignments as globals, especially in non-trivial Python codebases. This can lead to `NameError` or unexpected behavior when the selected Python code is executed in isolation, as its dependencies might not be correctly provided. A more robust solution would involve proper Python AST parsing.\", \"suggested_fixes\": null}, {\"issue_snippet\": \"print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\", \"severity\": \"warning\", \"message\": \"When automatically wrapping selected expressions for printing, inserting the expression directly into an f-string can lead to `SyntaxError` if the expression itself contains f-string syntax (e.g., `{}`) or unescaped quotes. A safer approach is to assign the expression to a temporary variable and then print its `str()` representation.\", \"suggested_fixes\": [{\"title\": \"Use a temporary variable and `str()` for safer expression printing.\", \"target_snippet\": \"file:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\", \"replacement_snippet\": \"local cleaned_selection = selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\")\\nfile:write(\\\"_uv_expr_result = (\\\" .. cleaned_selection .. \\\")\\\\n\\\")\\nfile:write('print(\\\"Expression result: \\\" + str(_uv_expr_result))\\\\n')\"}]}, {\"issue_snippet\": \"if is_all_indented then\", \"severity\": \"warning\", \"message\": \"The logic for `M.run_python_selection` wraps all indented selected code in a new function (`def run_selection():`). However, if the selected code itself is an indented function or class definition (e.g., a method inside a class), this wrapping will result in a `SyntaxError` (e.g., `def` nested at the same level) or incorrect execution context. The checks for `is_function_def` and `is_class_def` should explicitly prevent this wrapping.\", \"suggested_fixes\": [{\"title\": \"Avoid redundant function wrapping for indented function/class definitions.\", \"target_snippet\": \"if is_all_indented then\", \"replacement_snippet\": \"if is_all_indented and not is_function_def and not is_class_def then\"}]}, {\"issue_snippet\": \"local temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\", \"severity\": \"info\", \"message\": \"The plugin creates temporary Python files for executing selections and functions in `~/.cache/nvim/uv_run`. There is no explicit mechanism to clean up these temporary files after execution, which can lead to accumulation and unnecessary disk space usage over time.\", \"suggested_fixes\": null}, {\"issue_snippet\": \"_G.run_command = M.run_command\", \"severity\": \"info\", \"message\": \"Exposing `M.run_command` globally as `_G.run_command` pollutes the global namespace. While the comment suggests it 'can be removed if not needed', its presence can lead to naming conflicts with other plugins or scripts and makes the module less encapsulated. It is generally better to explicitly require the module to access its functions.\", \"suggested_fixes\": [{\"title\": \"Remove global exposure if not strictly necessary.\", \"target_snippet\": \"_G.run_command = M.run_command\", \"replacement_snippet\": \"-- _G.run_command = M.run_command -- Removed global exposure to prevent namespace pollution\"}]}, {\"issue_snippet\": \"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\"\", \"severity\": \"info\", \"message\": \"When running a specific Python function (`M.run_python_function`), the temporary script imports the entire current Python file as a module. This means all top-level code in that module will be executed upon import, including `if __name__ == \\\"__main__\\\":` blocks, global variable assignments, and any other statements outside of function definitions. This can lead to unintended side effects, inefficient execution, or incorrect behavior if the module's top-level code relies on a specific execution context.\", \"suggested_fixes\": null}, {\"issue_snippet\": \"finder = function()\", \"severity\": \"info\", \"message\": \"The logic for integrating with `Snacks` and `Telescope` pickers contains significant duplication in defining command items and the `on_select`/`confirm` logic. This violates the DRY (Don't Repeat Yourself) principle, making the code harder to maintain and update. Refactoring into shared data structures and helper functions would improve maintainability.\", \"suggested_fixes\": null}]}"}},{"key":"gen_ai.usage.input_tokens","value":{"intValue":"9365"}},{"key":"gen_ai.usage.output_tokens","value":{"intValue":"1854"}},{"key":"gen_ai.usage.details.thoughts_tokens","value":{"intValue":"7914"}},{"key":"gen_ai.usage.details.text_prompt_tokens","value":{"intValue":"9365"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\n-- uv.nvim - Neovim plugin for uv Python package management integration\\n-- Author: Ben O'Mahony\\n-- License: MIT\\n\\nlocal M = {}\\n\\n-- Default configuration\\nM.config = {\\n\\t-- Auto-activate virtual environments when found\\n\\tauto_activate_venv = true,\\n\\tnotify_activate_venv = true,\\n\\n\\t-- Auto commands for directory changes\\n\\tauto_commands = true,\\n\\n\\t-- Integration with picker (like Telescope or other UI components)\\n\\tpicker_integration = true,\\n\\n\\t-- Keymaps to register (set to false to disable)\\n\\tkeymaps = {\\n\\t\\tprefix = \\\"<leader>x\\\", -- Main prefix for UV commands\\n\\t\\tcommands = true, -- Show UV commands menu (<leader>x)\\n\\t\\trun_file = true, -- Run current file (<leader>xr)\\n\\t\\trun_selection = true, -- Run selection (<leader>xs)\\n\\t\\trun_function = true, -- Run function (<leader>xf)\\n\\t\\tvenv = true, -- Environment management (<leader>xe)\\n\\t\\tinit = true, -- Initialize UV project (<leader>xi)\\n\\t\\tadd = true, -- Add a package (<leader>xa)\\n\\t\\tremove = true, -- Remove a package (<leader>xd)\\n\\t\\tsync = true, -- Sync packages (<leader>xc)\\n\\t\\tsync_all = true, -- uv sync --all-extras --all-groups --all-packages (<leader>xC)\\n\\t},\\n\\n\\t-- Execution options\\n\\texecution = {\\n\\t\\t-- Python run command template\\n\\t\\trun_command = \\\"uv run python\\\",\\n\\n\\t\\t-- Show output in notifications\\n\\t\\tnotify_output = true,\\n\\n\\t\\t-- Notification timeout in ms\\n\\t\\tnotification_timeout = 10000,\\n\\t},\\n}\\n\\n-- Command runner - runs shell commands and captures output\\nfunction M.run_command(cmd)\\n\\t-- Run command in background and capture output\\n\\tvim.fn.jobstart(cmd, {\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Command completed successfully: \\\" .. cmd, vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Command failed: \\\" .. cmd, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Only show meaningful output (not empty lines)\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Show errors\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.WARN)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Virtual environment activation\\nfunction M.activate_venv(venv_path)\\n\\t-- For Mac, run the source command to apply to the current shell\\n\\tlocal command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n\\t-- Set environment variables for the current Neovim instance\\n\\tvim.env.VIRTUAL_ENV = venv_path\\n\\tvim.env.PATH = venv_path .. \\\"/bin:\\\" .. vim.env.PATH\\n\\t-- Notify user\\n\\tif M.config.notify_activate_venv then\\n\\t\\tvim.notify(\\\"Activated virtual environment: \\\" .. venv_path, vim.log.levels.INFO)\\n\\tend\\nend\\n\\n-- Auto-activate the .venv if it exists at the project root\\nfunction M.auto_activate_venv()\\n\\tlocal venv_path = vim.fn.getcwd() .. \\\"/.venv\\\"\\n\\tif vim.fn.isdirectory(venv_path) == 1 then\\n\\t\\tM.activate_venv(venv_path)\\n\\t\\treturn true\\n\\tend\\n\\treturn false\\nend\\n\\n-- Function to create a temporary file with the necessary context and selected code\\nfunction M.run_python_selection()\\n\\t-- Get visual selection\\n\\tlocal get_visual_selection = function()\\n\\t\\tlocal start_pos = vim.fn.getpos(\\\"'<\\\")\\n\\t\\tlocal end_pos = vim.fn.getpos(\\\"'>\\\")\\n\\t\\tlocal lines = vim.fn.getline(start_pos[2], end_pos[2])\\n\\n\\t\\tif #lines == 0 then\\n\\t\\t\\treturn \\\"\\\"\\n\\t\\tend\\n\\n\\t\\t-- Adjust last line to end at the column position of end_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[#lines] = lines[#lines]:sub(1, end_pos[3])\\n\\t\\tend\\n\\n\\t\\t-- Adjust first line to start at the column position of start_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[1] = lines[1]:sub(start_pos[3])\\n\\t\\tend\\n\\n\\t\\treturn table.concat(lines, \\\"\\\\n\\\")\\n\\tend\\n\\n\\t-- Get current buffer content to extract imports and global variables\\n\\tlocal get_buffer_globals = function()\\n\\t\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\t\\tlocal imports = {}\\n\\t\\tlocal globals = {}\\n\\t\\tlocal in_class = false\\n\\t\\tlocal class_indent = 0\\n\\n\\t\\tfor _, line in ipairs(lines) do\\n\\t\\t\\t-- Detect imports\\n\\t\\t\\tif line:match(\\\"^%s*import \\\") or line:match(\\\"^%s*from .+ import\\\") then\\n\\t\\t\\t\\ttable.insert(imports, line)\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect class definitions to skip class variables\\n\\t\\t\\tif line:match(\\\"^%s*class \\\") then\\n\\t\\t\\t\\tin_class = true\\n\\t\\t\\t\\tclass_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Check if we're exiting a class block\\n\\t\\t\\tif in_class and line:match(\\\"^%s*[^%s#]\\\") then\\n\\t\\t\\t\\tlocal current_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\t\\tif current_indent <= class_indent then\\n\\t\\t\\t\\t\\tin_class = false\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect global variable assignments (not in class, not inside functions)\\n\\t\\t\\tif not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\\n\\t\\t\\t\\t-- Check if it's not indented (global scope)\\n\\t\\t\\t\\tif not line:match(\\\"^%s%s+\\\") then\\n\\t\\t\\t\\t\\ttable.insert(globals, line)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend\\n\\n\\t\\treturn imports, globals\\n\\tend\\n\\n\\t-- Get selected code\\n\\tlocal selection = get_visual_selection()\\n\\tif selection == \\\"\\\" then\\n\\t\\tvim.notify(\\\"No code selected\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Get imports and globals\\n\\tlocal imports, globals = get_buffer_globals()\\n\\n\\t-- Create temp file\\n\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\tlocal temp_file = temp_dir .. \\\"/run_selection.py\\\"\\n\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\tif not file then\\n\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Write imports\\n\\tfor _, imp in ipairs(imports) do\\n\\t\\tfile:write(imp .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write globals\\n\\tfor _, glob in ipairs(globals) do\\n\\t\\tfile:write(glob .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write selected code\\n\\tfile:write(\\\"# SELECTED CODE\\\\n\\\")\\n\\n\\t-- Check if the selection is all indented (which would cause syntax errors)\\n\\tlocal is_all_indented = true\\n\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tif not line:match(\\\"^%s+\\\") and line ~= \\\"\\\" then\\n\\t\\t\\tis_all_indented = false\\n\\t\\t\\tbreak\\n\\t\\tend\\n\\tend\\n\\n\\t-- Process the selection to determine what type of code it is\\n\\tlocal is_function_def = selection:match(\\\"^%s*def%s+[%w_]+%s*%(\\\")\\n\\tlocal is_class_def = selection:match(\\\"^%s*class%s+[%w_]+\\\")\\n\\tlocal has_print = selection:match(\\\"print%s*%(\\\")\\n\\tlocal is_expression = not is_function_def\\n\\t\\tand not is_class_def\\n\\t\\tand not selection:match(\\\"=\\\")\\n\\t\\tand not selection:match(\\\"%s*for%s+\\\")\\n\\t\\tand not selection:match(\\\"%s*if%s+\\\")\\n\\t\\tand not has_print\\n\\n\\t-- If the selection is all indented, we need to dedent it or wrap it in a function\\n\\tif is_all_indented then\\n\\t\\tfile:write(\\\"def run_selection():\\\\n\\\")\\n\\t\\t-- Write the selection with original indentation\\n\\t\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\t\\tfile:write(\\\"    \\\" .. line .. \\\"\\\\n\\\")\\n\\t\\tend\\n\\t\\tfile:write(\\\"\\\\n# Auto-call the wrapper function\\\\n\\\")\\n\\t\\tfile:write(\\\"run_selection()\\\\n\\\")\\n\\telse\\n\\t\\t-- Write the original selection\\n\\t\\tfile:write(selection .. \\\"\\\\n\\\")\\n\\n\\t\\t-- For expressions, we'll add a print statement to see the result\\n\\t\\tif is_expression then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added print for expression\\\\n\\\")\\n\\t\\t\\tfile:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\\n\\t\\t-- For function definitions without calls, we'll add a call\\n\\t\\telseif is_function_def then\\n\\t\\t\\tlocal function_name = selection:match(\\\"def%s+([%w_]+)%s*%(\\\")\\n\\t\\t\\t-- Check if the function is already called in the selection\\n\\t\\t\\tif function_name and not selection:match(function_name .. \\\"%s*%(.-%)\\\") then\\n\\t\\t\\t\\tfile:write(\\\"\\\\n# Auto-added function call\\\\n\\\")\\n\\t\\t\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\t\\t\\tfile:write('    print(f\\\"Auto-executing function: ' .. function_name .. '\\\")\\\\n')\\n\\t\\t\\t\\tfile:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\\n\\t\\t\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\t\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\t\\tend\\n\\t\\t-- If there's no print statement in the code, add an output marker\\n\\t\\telseif not has_print and not selection:match(\\\"^%s*#\\\") then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added execution marker\\\\n\\\")\\n\\t\\t\\tfile:write('print(\\\"Code executed successfully.\\\")\\\\n')\\n\\t\\tend\\n\\tend\\n\\n\\tfile:close()\\n\\n\\t-- Run the temp file\\n\\tvim.notify(\\\"Running selected code...\\\", vim.log.levels.INFO)\\n\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Selected code executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Selected code execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Function to run a specific Python function\\nfunction M.run_python_function()\\n\\t-- Get current buffer content\\n\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\tlocal buffer_content = table.concat(lines, \\\"\\\\n\\\")\\n\\n\\t-- Find all function definitions\\n\\tlocal functions = {}\\n\\tfor line in buffer_content:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tlocal func_name = line:match(\\\"^def%s+([%w_]+)%s*%(\\\")\\n\\t\\tif func_name then\\n\\t\\t\\ttable.insert(functions, func_name)\\n\\t\\tend\\n\\tend\\n\\n\\tif #functions == 0 then\\n\\t\\tvim.notify(\\\"No functions found in current file\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Create temp file for function selection picker\\n\\tlocal run_function = function(func_name)\\n\\t\\t-- Create a temporary file with a main block to call the function\\n\\t\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\t\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\t\\tlocal temp_file = temp_dir .. \\\"/run_function.py\\\"\\n\\t\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\n\\t\\t-- Create a wrapper script that imports the current file and calls the function\\n\\t\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\t\\tif not file then\\n\\t\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\t\\treturn\\n\\t\\tend\\n\\n\\t\\t-- Get the module name (file name without .py)\\n\\t\\tlocal module_name = vim.fn.fnamemodify(current_file, \\\":t:r\\\")\\n\\t\\tlocal module_dir = vim.fn.fnamemodify(current_file, \\\":h\\\")\\n\\n\\t\\t-- Write imports\\n\\t\\tfile:write(\\\"import sys\\\\n\\\")\\n\\t\\tfile:write(\\\"sys.path.insert(0, \\\" .. vim.inspect(module_dir) .. \\\")\\\\n\\\")\\n\\t\\tfile:write(\\\"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\")\\n\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\tfile:write('    print(f\\\"Running function: ' .. func_name .. '\\\")\\\\n')\\n\\t\\tfile:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\\n\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\tfile:close()\\n\\n\\t\\t-- Run the temp file\\n\\t\\tvim.notify(\\\"Running function: \\\" .. func_name, vim.log.levels.INFO)\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\tend\\n\\n\\t-- If there's only one function, run it directly\\n\\tif #functions == 1 then\\n\\t\\trun_function(functions[1])\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Otherwise, show a picker to select the function\\n\\tvim.ui.select(functions, {\\n\\t\\tprompt = \\\"Select function to run:\\\",\\n\\t\\tformat_item = function(item)\\n\\t\\t\\treturn \\\"def \\\" .. item .. \\\"()\\\"\\n\\t\\tend,\\n\\t}, function(choice)\\n\\t\\tif choice then\\n\\t\\t\\trun_function(choice)\\n\\t\\tend\\n\\tend)\\nend\\n\\n-- Run current file\\nfunction M.run_file()\\n\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\tif current_file and current_file ~= \\\"\\\" then\\n\\t\\tvim.notify(\\\"Running: \\\" .. vim.fn.expand(\\\"%:t\\\"), vim.log.levels.INFO)\\n\\t\\t-- Run python on the current file and capture output to notifications\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(current_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution completed successfully\\\", vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\telse\\n\\t\\tvim.notify(\\\"No file is open\\\", vim.log.levels.WARN)\\n\\tend\\nend\\n\\n-- Set up command pickers for integration with UI plugins\\nfunction M.setup_pickers()\\n\\t-- Check if Snacks is available\\n\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t-- Register UV command source\\n\\t\\tSnacks.picker.sources.uv_commands = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t{ text = \\\"Run current file\\\", desc = \\\"Run current file with Python\\\", is_run_current = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run selection\\\", desc = \\\"Run selected Python code\\\", is_run_selection = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run function\\\", desc = \\\"Run specific Python function\\\", is_run_function = true },\\n\\t\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", desc = \\\"Install a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv sync\\\", desc = \\\"Sync packages from lockfile\\\" },\\n\\t\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\t\\tdesc = \\\"Sync all extras, groups and packages\\\",\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", desc = \\\"Remove a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv init\\\", desc = \\\"Initialize a new project\\\" },\\n\\t\\t\\t\\t}\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\treturn { { item.text .. \\\" - \\\" .. item.desc } }\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\t\\tif item.is_run_current then\\n\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_selection then\\n\\t\\t\\t\\t\\t\\t-- Check if there's a visual selection\\n\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\n\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\") -- Exit visual mode\\n\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t-- If not in visual mode, prompt the user to select text\\n\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t-- After notification, we'll set up a one-time autocmd to catch when visual mode is exited\\n\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\", -- When changing from any visual mode to normal mode\\n\\t\\t\\t\\t\\t\\t\\t\\tcallback = function(ev)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true -- Delete the autocmd after it's been triggered\\n\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_function then\\n\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\tlocal cmd = item.text\\n\\t\\t\\t\\t\\t-- Check if command needs input\\n\\t\\t\\t\\t\\tif cmd:match(\\\"%[(.-)%]\\\") then\\n\\t\\t\\t\\t\\t\\tlocal param_name = cmd:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\tvim.ui.input({ prompt = \\\"Enter \\\" .. param_name .. \\\": \\\" }, function(input)\\n\\t\\t\\t\\t\\t\\t\\tif not input or input == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t-- Replace the placeholder with actual input\\n\\t\\t\\t\\t\\t\\t\\tlocal actual_cmd = cmd:gsub(\\\"%[\\\" .. param_name .. \\\"%]\\\", input)\\n\\t\\t\\t\\t\\t\\t\\tM.run_command(actual_cmd)\\n\\t\\t\\t\\t\\t\\tend)\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t-- Run the command directly\\n\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\n\\t\\t-- Register UV venv source\\n\\t\\tSnacks.picker.sources.uv_venv = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\tlocal venvs = {}\\n\\t\\t\\t\\t-- Check for .venv directory (uv's default)\\n\\t\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\tif #venvs == 0 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\"Create new virtual environment (uv venv)\\\",\\n\\t\\t\\t\\t\\t\\tis_create = true,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\treturn venvs\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\treturn { { \\\"+ \\\" .. item.text } }\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tlocal icon = item.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\"\\n\\t\\t\\t\\t\\treturn { { icon .. item.text .. \\\" (Activate)\\\" } }\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\tM.activate_venv(item.path)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\tend\\n\\n\\t-- Check if Telescope is available\\n\\tlocal has_telescope, telescope = pcall(require, \\\"telescope\\\")\\n\\tif has_telescope then\\n\\t\\tlocal pickers = require(\\\"telescope.pickers\\\")\\n\\t\\tlocal finders = require(\\\"telescope.finders\\\")\\n\\t\\tlocal sorters = require(\\\"telescope.sorters\\\")\\n\\t\\tlocal actions = require(\\\"telescope.actions\\\")\\n\\t\\tlocal action_state = require(\\\"telescope.actions.state\\\")\\n\\n\\t\\t-- UV Commands picker for Telescope\\n\\t\\tM.pick_uv_commands = function()\\n\\t\\t\\tlocal items = {\\n\\t\\t\\t\\t{ text = \\\"Run current file\\\", is_run_current = true },\\n\\t\\t\\t\\t{ text = \\\"Run selection\\\", is_run_selection = true },\\n\\t\\t\\t\\t{ text = \\\"Run function\\\", is_run_function = true },\\n\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", cmd = \\\"uv add \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv sync\\\", cmd = \\\"uv sync\\\" },\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\tcmd = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", cmd = \\\"uv remove \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv init\\\", cmd = \\\"uv init\\\" },\\n\\t\\t\\t}\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Commands\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_run_current then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_selection then\\n\\t\\t\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\t\\t\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_function then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tif selection.needs_input then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal placeholder = selection.text:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.ui.input(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t{ prompt = \\\"Enter \\\" .. (placeholder or \\\"value\\\") .. \\\": \\\" },\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfunction(input)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tif input and input ~= \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal cmd = selection.cmd .. input\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(selection.cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\n\\t\\t-- UV venv picker for Telescope\\n\\t\\tM.pick_uv_venv = function()\\n\\t\\t\\tlocal items = {}\\n\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\ttable.insert(items, {\\n\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t})\\n\\t\\t\\tend\\n\\t\\t\\tif #items == 0 then\\n\\t\\t\\t\\ttable.insert(items, { text = \\\"Create new virtual environment (uv venv)\\\", is_create = true })\\n\\t\\t\\tend\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Virtual Environments\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\tlocal display = entry.is_create and \\\"+ \\\" .. entry.text\\n\\t\\t\\t\\t\\t\\t\\t\\tor ((entry.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\") .. entry.text .. \\\" (Activate)\\\")\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = display,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = display,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_create then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tM.activate_venv(selection.path)\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Set up user commands\\nfunction M.setup_commands()\\n\\t-- Set up UV commands\\n\\tvim.api.nvim_create_user_command(\\\"UVInit\\\", function()\\n\\t\\tM.run_command(\\\"uv init\\\")\\n\\tend, {})\\n\\n\\t-- Command to run selected code\\n\\tvim.api.nvim_create_user_command(\\\"UVRunSelection\\\", function()\\n\\t\\tM.run_python_selection()\\n\\tend, { range = true })\\n\\n\\t-- Command to run a specific function\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFunction\\\", function()\\n\\t\\tM.run_python_function()\\n\\tend, {})\\n\\n\\t-- Command to run the current file\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFile\\\", function()\\n\\t\\tM.run_file()\\n\\tend, {})\\n\\n\\t-- Command to add a package\\n\\tvim.api.nvim_create_user_command(\\\"UVAddPackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv add \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\n\\n\\t-- Command to remove a package\\n\\tvim.api.nvim_create_user_command(\\\"UVRemovePackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv remove \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\nend\\n\\n-- Set up keymaps\\nfunction M.setup_keymaps()\\n\\tlocal keymaps = M.config.keymaps\\n\\tlocal prefix = keymaps.prefix or \\\"<leader>x\\\"\\n\\n\\t-- Main UV command menu\\n\\tif keymaps.commands then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Run current file\\n\\tif keymaps.run_file then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"r\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFile<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Current File\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run selection\\n\\tif keymaps.run_selection then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"v\\\",\\n\\t\\t\\tprefix .. \\\"s\\\",\\n\\t\\t\\t\\\":<C-u>UVRunSelection<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Selection\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run function\\n\\tif keymaps.run_function then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"f\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFunction<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Function\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Environment management\\n\\tif keymaps.venv then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_venv')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope_venv = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope_venv then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_venv()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Initialize UV project\\n\\tif keymaps.init then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"i\\\",\\n\\t\\t\\t\\\"<cmd>UVInit<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Init\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Add a package\\n\\tif keymaps.add then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"a\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv add ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Add Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Remove a package\\n\\tif keymaps.remove then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"d\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv remove ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Remove Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Sync packages\\n\\tif keymaps.sync then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"c\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync Packages\\\" }\\n\\t\\t)\\n\\tend\\n\\tif keymaps.sync_all then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"C\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync --all-extras --all-packages --all-groups')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync All Extras, Groups and Packages\\\" }\\n\\t\\t)\\n\\tend\\nend\\n\\n-- Set up auto commands\\nfunction M.setup_autocommands()\\n\\tif M.config.auto_commands then\\n\\t\\t-- Auto-activate .venv if it exists\\n\\t\\tif M.config.auto_activate_venv then\\n\\t\\t\\tM.auto_activate_venv()\\n\\n\\t\\t\\t-- Also set up auto-command to check when entering a directory\\n\\t\\t\\tvim.api.nvim_create_autocmd({ \\\"DirChanged\\\" }, {\\n\\t\\t\\t\\tpattern = { \\\"global\\\" },\\n\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\tM.auto_activate_venv()\\n\\t\\t\\t\\tend,\\n\\t\\t\\t})\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Main setup function\\nfunction M.setup(opts)\\n\\t-- Merge user configuration with defaults\\n\\tM.config = vim.tbl_deep_extend(\\\"force\\\", M.config, opts or {})\\n\\n\\t-- Set up commands\\n\\tM.setup_commands()\\n\\n\\t-- Set up keymaps if enabled\\n\\tif M.config.keymaps ~= false then\\n\\t\\tM.setup_keymaps()\\n\\tend\\n\\n\\t-- Set up autocommands if enabled\\n\\tif M.config.auto_commands ~= false then\\n\\t\\tM.setup_autocommands()\\n\\tend\\n\\n\\t-- Set up pickers if integration is enabled\\n\\tif M.config.picker_integration then\\n\\t\\tM.setup_pickers()\\n\\tend\\n\\n\\t-- Make run_command globally accessible (can be removed if not needed)\\n\\t_G.run_command = M.run_command\\nend\\n\\nreturn M\\n\\n```\\n\\nFile: init.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}, {\"role\": \"assistant\", \"tool_calls\": [{\"id\": \"pyd_ai_a076092a98f949a7a3fdf876818b46b9\", \"type\": \"function\", \"function\": {\"name\": \"final_result\", \"arguments\": {\"issues\": [{\"suggested_fixes\": [{\"title\": \"Escape user command arguments for 'UVAddPackage'.\", \"target_snippet\": \"opts.args\", \"replacement_snippet\": \"vim.fn.shellescape(opts.args)\"}, {\"replacement_snippet\": \"vim.fn.shellescape(opts.args)\", \"target_snippet\": \"opts.args\", \"title\": \"Escape user command arguments for 'UVRemovePackage'.\"}], \"message\": \"User input from `opts.args` in user commands (`UVAddPackage`, `UVRemovePackage`) is directly concatenated into shell commands without being escaped. A malicious user could inject arbitrary shell commands (e.g., `my_package; rm -rf /`), leading to a critical remote code execution vulnerability.\", \"severity\": \"error\", \"issue_snippet\": \"opts.args\"}, {\"suggested_fixes\": [{\"replacement_snippet\": \"local actual_cmd = cmd:gsub(\\\"%[(.-)%]\\\", vim.fn.shellescape(input))\", \"title\": \"Escape user input for Snacks picker commands.\", \"target_snippet\": \"local actual_cmd = cmd:gsub(\\\"%[(.-)%]\\\", input)\"}, {\"title\": \"Escape user input for Telescope picker commands.\", \"target_snippet\": \"local cmd = selection.cmd .. input\", \"replacement_snippet\": \"local cmd = selection.cmd .. vim.fn.shellescape(input)\"}, {\"replacement_snippet\": \"require('uv').run_command('uv add ' .. vim.fn.shellescape(input))\", \"title\": \"Escape user input for 'add package' keymap.\", \"target_snippet\": \"require('uv').run_command('uv add ' .. input)\"}, {\"title\": \"Escape user input for 'remove package' keymap.\", \"target_snippet\": \"require('uv').run_command('uv remove ' .. input)\", \"replacement_snippet\": \"require('uv').run_command('uv remove ' .. vim.fn.shellescape(input))\"}], \"severity\": \"error\", \"issue_snippet\": \"input\", \"message\": \"User input obtained via `vim.ui.input` (e.g., for adding/removing packages from pickers or keymaps) is directly concatenated into shell commands without being escaped. This is a critical remote code execution vulnerability, as an attacker can inject malicious shell commands (e.g., `my_package; rm -rf /`). This pattern is repeated in Snacks picker, Telescope picker, and direct keymaps for `uv add` and `uv remove`.\"}, {\"message\": \"The `source` command is executed in a subshell via `vim.fn.jobstart`. The `source` command is a shell built-in that modifies the *current* shell's environment. Running it in a subshell means its effects on environment variables are confined to that subshell and do not propagate back to the Neovim process. While `vim.env.VIRTUAL_ENV` and `vim.env.PATH` are manually updated, this might not fully replicate all environment changes typically made by a complete virtual environment activation script, potentially leading to an incomplete setup for subsequent Python commands.\", \"severity\": \"warning\", \"issue_snippet\": \"local command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\", \"suggested_fixes\": null}, {\"message\": \"The logic to extract global variables (`get_buffer_globals`) relies on simplistic regex matching and indentation checks. It might inaccurately classify local variables within top-level functions or complex assignments as globals, especially in non-trivial Python codebases. This can lead to `NameError` or unexpected behavior when the selected Python code is executed in isolation, as its dependencies might not be correctly provided. A more robust solution would involve proper Python AST parsing.\", \"issue_snippet\": \"if not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\", \"suggested_fixes\": null, \"severity\": \"warning\"}, {\"issue_snippet\": \"print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\", \"severity\": \"warning\", \"message\": \"When automatically wrapping selected expressions for printing, inserting the expression directly into an f-string can lead to `SyntaxError` if the expression itself contains f-string syntax (e.g., `{}`) or unescaped quotes. A safer approach is to assign the expression to a temporary variable and then print its `str()` representation.\", \"suggested_fixes\": [{\"replacement_snippet\": \"local cleaned_selection = selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\")\\nfile:write(\\\"_uv_expr_result = (\\\" .. cleaned_selection .. \\\")\\\\n\\\")\\nfile:write('print(\\\"Expression result: \\\" + str(_uv_expr_result))\\\\n')\", \"target_snippet\": \"file:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\", \"title\": \"Use a temporary variable and `str()` for safer expression printing.\"}]}, {\"severity\": \"warning\", \"message\": \"The logic for `M.run_python_selection` wraps all indented selected code in a new function (`def run_selection():`). However, if the selected code itself is an indented function or class definition (e.g., a method inside a class), this wrapping will result in a `SyntaxError` (e.g., `def` nested at the same level) or incorrect execution context. The checks for `is_function_def` and `is_class_def` should explicitly prevent this wrapping.\", \"suggested_fixes\": [{\"target_snippet\": \"if is_all_indented then\", \"title\": \"Avoid redundant function wrapping for indented function/class definitions.\", \"replacement_snippet\": \"if is_all_indented and not is_function_def and not is_class_def then\"}], \"issue_snippet\": \"if is_all_indented then\"}, {\"message\": \"The plugin creates temporary Python files for executing selections and functions in `~/.cache/nvim/uv_run`. There is no explicit mechanism to clean up these temporary files after execution, which can lead to accumulation and unnecessary disk space usage over time.\", \"suggested_fixes\": null, \"issue_snippet\": \"local temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\", \"severity\": \"info\"}, {\"severity\": \"info\", \"issue_snippet\": \"_G.run_command = M.run_command\", \"message\": \"Exposing `M.run_command` globally as `_G.run_command` pollutes the global namespace. While the comment suggests it 'can be removed if not needed', its presence can lead to naming conflicts with other plugins or scripts and makes the module less encapsulated. It is generally better to explicitly require the module to access its functions.\", \"suggested_fixes\": [{\"replacement_snippet\": \"-- _G.run_command = M.run_command -- Removed global exposure to prevent namespace pollution\", \"title\": \"Remove global exposure if not strictly necessary.\", \"target_snippet\": \"_G.run_command = M.run_command\"}]}, {\"issue_snippet\": \"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\"\", \"severity\": \"info\", \"message\": \"When running a specific Python function (`M.run_python_function`), the temporary script imports the entire current Python file as a module. This means all top-level code in that module will be executed upon import, including `if __name__ == \\\"__main__\\\":` blocks, global variable assignments, and any other statements outside of function definitions. This can lead to unintended side effects, inefficient execution, or incorrect behavior if the module's top-level code relies on a specific execution context.\", \"suggested_fixes\": null}, {\"message\": \"The logic for integrating with `Snacks` and `Telescope` pickers contains significant duplication in defining command items and the `on_select`/`confirm` logic. This violates the DRY (Don't Repeat Yourself) principle, making the code harder to maintain and update. Refactoring into shared data structures and helper functions would improve maintainability.\", \"severity\": \"info\", \"issue_snippet\": \"finder = function()\", \"suggested_fixes\": null}]}}}], \"gen_ai.message.index\": 1, \"event.name\": \"gen_ai.assistant.message\"}, {\"content\": \"Final result processed.\", \"role\": \"tool\", \"id\": \"pyd_ai_a076092a98f949a7a3fdf876818b46b9\", \"name\": \"final_result\", \"gen_ai.message.index\": 2, \"event.name\": \"gen_ai.tool.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]},{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"7d64967998c02b81","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"AI analysis completed, found {len(result.output.issues)} issues","kind":1,"startTimeUnixNano":"1762974607222742000","endTimeUnixNano":"1762974607222742000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI analysis completed, found {len(result.output.issues)} issues"}},{"key":"logfire.msg","value":{"stringValue":"AI analysis completed, found 10 issues"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"203"}},{"key":"len(result.output.issues)","value":{"intValue":"10"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(result.output.issues)\":{}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"6c15f6e4e58c2125","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762974607224363000","endTimeUnixNano":"1762974607224363000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 2 occurrences of 'opts.args...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"2"}},{"key":"snippet[:20]","value":{"stringValue":"opts.args"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"0a4c20342a6db280","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762974607225697000","endTimeUnixNano":"1762974607225697000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 25 occurrences of 'input...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"25"}},{"key":"snippet[:20]","value":{"stringValue":"input"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"ad00c7a4e7ebd986","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762974607225880000","endTimeUnixNano":"1762974607225880000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of 'local command = \"sou...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"local command = \"sou"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"dcd05fe146e58015","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762974607226212000","endTimeUnixNano":"1762974607226212000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of 'if not in_class and ...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"if not in_class and "}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"0e2e7f97a9e0eb71","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762974607226426000","endTimeUnixNano":"1762974607226426000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of 'print(f\"Expression r...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"print(f\"Expression r"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"14697f8f658516d7","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762974607226578000","endTimeUnixNano":"1762974607226578000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of 'if is_all_indented t...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"if is_all_indented t"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"edda00f471a66c76","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762974607226741000","endTimeUnixNano":"1762974607226741000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 2 occurrences of 'local temp_dir = vim...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"2"}},{"key":"snippet[:20]","value":{"stringValue":"local temp_dir = vim"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"a0edc121765b4210","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762974607226965000","endTimeUnixNano":"1762974607226965000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of '_G.run_command = M.r...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"_G.run_command = M.r"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"a6f613b9567885bd","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762974607227112000","endTimeUnixNano":"1762974607227112000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of 'import \" .. module_n...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"import \" .. module_n"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"e5e7c0fe7a462a88","parentSpanId":"3c8ba40f54e1ba14","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762974607227300000","endTimeUnixNano":"1762974607227300000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 2 occurrences of 'finder = function()...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"2"}},{"key":"snippet[:20]","value":{"stringValue":"finder = function()"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7978e6e42cc65aa1d08c679faa3e","spanId":"3c8ba40f54e1ba14","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762974557924410000","endTimeUnixNano":"1762974607227383000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a7979a77d0bd13c375c94921b6e7b","spanId":"ad617b71d6622037","flags":256,"name":"Published {len(diagnostics)} diagnostics for {uri}","kind":1,"startTimeUnixNano":"1762974607229951000","endTimeUnixNano":"1762974607229951000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Published {len(diagnostics)} diagnostics for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Published 10 diagnostics for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer._delayed_analyze"}},{"key":"code.lineno","value":{"intValue":"181"}},{"key":"len(diagnostics)","value":{"intValue":"10"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(diagnostics)\":{},\"uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"4d3973eb13704a2baf171123e754ae3a"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"24647"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a798fbb88a919f3c3089dd7054411","spanId":"cc8952aad35fcdad","flags":256,"name":"Initializing AI Language Server","kind":1,"startTimeUnixNano":"1762976054152599000","endTimeUnixNano":"1762976054152599000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Initializing AI Language Server"}},{"key":"logfire.msg","value":{"stringValue":"Initializing AI Language Server"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"77"}}],"status":{}},{"traceId":"019a798fbcf8b1dec00ea004921eaf27","spanId":"16d14c44624b5b49","flags":256,"name":"AI agent initialized successfully","kind":1,"startTimeUnixNano":"1762976054520151000","endTimeUnixNano":"1762976054520151000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI agent initialized successfully"}},{"key":"logfire.msg","value":{"stringValue":"AI agent initialized successfully"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"115"}}],"status":{}},{"traceId":"019a798fbd0a0143db8850d67863507b","spanId":"675822e2b6da6784","flags":256,"name":"Document opened: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976054538883000","endTimeUnixNano":"1762976054538883000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document opened: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document opened: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_open"}},{"key":"code.lineno","value":{"intValue":"291"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fc0f880203d2d4989e0101174","spanId":"a96a94121f8a5038","parentSpanId":"5a33357839670ef0","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976055545406000","endTimeUnixNano":"1762976055545406000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fccbe2b9fe52196124bd4b5a0","spanId":"2603b72a484626a2","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976058558112000","endTimeUnixNano":"1762976058558112000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fc0f880203d2d4989e0101174","spanId":"5a33357839670ef0","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976055544357000","endTimeUnixNano":"1762976058569515000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976058559371000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a798fcccaa4d53359fc9b729b4d67","spanId":"90b28ce48e90eae1","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976058570770000","endTimeUnixNano":"1762976058570770000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a798fc0f880203d2d4989e0101174","spanId":"5c6c0503ff8bbf21","parentSpanId":"4766ebe448fad6b3","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976055548181000","endTimeUnixNano":"1762976058558667000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a798fc0f880203d2d4989e0101174","spanId":"4766ebe448fad6b3","parentSpanId":"5a33357839670ef0","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976055546978000","endTimeUnixNano":"1762976058558865000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\nreturn {\\n  \\\"benomahony/uv.nvim\\\",\\n  opts = {\\n    notify_activate_venv = false,\\n    picker_integration = true,\\n  },\\n}\\n\\n```\\n\\nFile: uv.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"4d3973eb13704a2baf171123e754ae3a"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"24647"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a798fd0a8a932ea7506f47147665a","spanId":"bca6d947cd1c383e","parentSpanId":"6b0c20c5df58703c","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976059561015000","endTimeUnixNano":"1762976059561015000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fd2d631cda1157eebb9c34281","spanId":"a784effe909048f7","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976060118570000","endTimeUnixNano":"1762976060118570000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fd0a8a932ea7506f47147665a","spanId":"6b0c20c5df58703c","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976059560138000","endTimeUnixNano":"1762976060124691000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976060120649000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a798fd2ddf1e284bf0f4be8642089","spanId":"a98ac155251a4189","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976060125059000","endTimeUnixNano":"1762976060125059000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fd58def7d92f476dfbd3d1a4f","spanId":"37ae63d1818a3928","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976060813543000","endTimeUnixNano":"1762976060813543000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fd58ecaf2beaef50659c0b61e","spanId":"21be526ba5ee44e5","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976060814326000","endTimeUnixNano":"1762976060814326000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fd66ad84406768f8362d41143","spanId":"70c1139f0d603f1a","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976061034036000","endTimeUnixNano":"1762976061034036000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fd66ba112d08eee30832767a1","spanId":"7e30570810a26f0a","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976061035170000","endTimeUnixNano":"1762976061035170000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fd80b7742a565a6aa4a300660","spanId":"1e4855c890d4a55d","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976061451403000","endTimeUnixNano":"1762976061451403000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fd80c063e001c1fd77db428fa","spanId":"38e43655650eda6e","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976061452047000","endTimeUnixNano":"1762976061452047000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fd989f8fd57681ecb569ae338","spanId":"57d61bd28608a50a","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976061833354000","endTimeUnixNano":"1762976061833354000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fd9891034d5c50fba50b3f190","spanId":"5d6c553efeb4e0fb","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976061833906000","endTimeUnixNano":"1762976061833906000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fda1de7e2fdb73a9e630d455b","spanId":"7e8b063cc61e983b","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976061981944000","endTimeUnixNano":"1762976061981944000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fda1e26b7035f70ff87589fd9","spanId":"131d8d75ff04c3c0","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976061982664000","endTimeUnixNano":"1762976061982664000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fdcfc7af0d68fe660c154b51f","spanId":"386f44f96a874b7f","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976062716974000","endTimeUnixNano":"1762976062716974000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fdcfee8f1278b00c8d15f622c","spanId":"b9135c38f6b4222e","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976062718054000","endTimeUnixNano":"1762976062718054000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe0e7d4b04b18fa2b1294b9f0","spanId":"7c11dfc6942747fe","parentSpanId":"7c37360b41df4da0","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976063719471000","endTimeUnixNano":"1762976063719471000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe255b4c79734e17af22c65f6","spanId":"765ccd3fdc5fc4d0","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976064085721000","endTimeUnixNano":"1762976064085721000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe0e7d4b04b18fa2b1294b9f0","spanId":"7c37360b41df4da0","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976063719071000","endTimeUnixNano":"1762976064092026000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976064088187000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a798fe25cbd575eb2eceb94827df8","spanId":"225488ba5af78b09","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976064092498000","endTimeUnixNano":"1762976064092498000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a798fd0a8a932ea7506f47147665a","spanId":"c807657b4b699072","parentSpanId":"730ce59b483b492f","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976059564917000","endTimeUnixNano":"1762976060119568000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a798fd0a8a932ea7506f47147665a","spanId":"730ce59b483b492f","parentSpanId":"6b0c20c5df58703c","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976059562973000","endTimeUnixNano":"1762976060119938000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\nreturn {\\n  -- \\\"benomahony/uv.nvim\\\",\\n  opts = {\\n    notify_activate_venv = false,\\n    picker_integration = true,\\n  },\\n}\\n\\n```\\n\\nFile: uv.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}},{"traceId":"019a798fe0e7d4b04b18fa2b1294b9f0","spanId":"54d563795d7a86c2","parentSpanId":"5d322cec96197368","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976063720977000","endTimeUnixNano":"1762976064087290000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a798fe0e7d4b04b18fa2b1294b9f0","spanId":"5d322cec96197368","parentSpanId":"7c37360b41df4da0","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976063720284000","endTimeUnixNano":"1762976064087558000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\nreturn {\\n  -- \\\"benomahony/uv.nvim\\\",\\n  dir\\n  opts = {\\n    notify_activate_venv = false,\\n    picker_integration = true,\\n  },\\n}\\n\\n```\\n\\nFile: uv.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"4d3973eb13704a2baf171123e754ae3a"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"24647"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a798fe28c70ff2197c6407e3e8f84","spanId":"3416ef332b64a31e","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976064140555000","endTimeUnixNano":"1762976064140555000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe28d14fe52f7a51278087421","spanId":"d7857fabb0b21d3b","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976064141109000","endTimeUnixNano":"1762976064141109000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe44b3e66e00bc786ec11972e","spanId":"1280fb44d2c0e6c2","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976064587768000","endTimeUnixNano":"1762976064587768000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe44cb40199afa79a157d193a","spanId":"fa2d06b4e81cd971","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976064588780000","endTimeUnixNano":"1762976064588780000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe54907789c904b12afb1d38c","spanId":"9330af3c56c3b3c5","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976064841804000","endTimeUnixNano":"1762976064841804000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe54a139f6ad16db0c0467eb2","spanId":"aca16ab696362fc3","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976064842574000","endTimeUnixNano":"1762976064842574000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe5db7690a54e425bfd41ff0d","spanId":"a96977d2f2d36edd","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976064987301000","endTimeUnixNano":"1762976064987301000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe5db5619f802b9b106a75a4f","spanId":"51399f8e53011263","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976064987768000","endTimeUnixNano":"1762976064987768000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe670efcbd5106ee7b17fc4ec","spanId":"a7891408d0082b35","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976065136857000","endTimeUnixNano":"1762976065136857000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe671e2c9ecb89678d7a9c52f","spanId":"9cac1e43ad0a5eb0","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976065137295000","endTimeUnixNano":"1762976065137295000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe707c61c9a499a6dd35b1f2e","spanId":"a0e8f27e8edcc37a","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976065287525000","endTimeUnixNano":"1762976065287525000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe7079c37f2280672c50e9ba6","spanId":"3cb428db0a187448","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976065287962000","endTimeUnixNano":"1762976065287962000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe79c5d4efb77182ff7bbf96e","spanId":"3fa5f82eb9e9b56f","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976065436767000","endTimeUnixNano":"1762976065436767000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe79e9559413817b18dfd28f5","spanId":"3e6254ec82a695d0","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976065438129000","endTimeUnixNano":"1762976065438129000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe83135add8e3d77561658267","spanId":"90b7f89bbcb934d0","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976065585366000","endTimeUnixNano":"1762976065585366000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe8312bc5c7bcd9c656686168","spanId":"851de2e070fb345b","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976065585634000","endTimeUnixNano":"1762976065585634000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe92519325af9f1f0c02558ec","spanId":"87feedc9b1401f00","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976065829767000","endTimeUnixNano":"1762976065829767000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe92731666e2120dd1ff035f3","spanId":"1d16c86ca35f0d86","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976065831809000","endTimeUnixNano":"1762976065831809000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe9b842d7414382d70c663e57","spanId":"00ed1aa7ed557276","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976065976019000","endTimeUnixNano":"1762976065976019000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fe9b82e8e4e1074cabf08dfba","spanId":"aae56c5af0c78c88","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976065976441000","endTimeUnixNano":"1762976065976441000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fea4eecfc984844b2882c01a9","spanId":"99fc210ef7c7174c","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976066126216000","endTimeUnixNano":"1762976066126216000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fea4e31a912fce1ee4f52c675","spanId":"1b93819c1d1cbbc5","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976066126677000","endTimeUnixNano":"1762976066126677000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798feae4436d56931b08eb684fa7","spanId":"097f9142da8cf191","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976066276590000","endTimeUnixNano":"1762976066276590000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798feae58b51485d2cfcd73df3f3","spanId":"b22870aa7f1153b6","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976066277247000","endTimeUnixNano":"1762976066277247000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798febd8c32a2f3877e00bd10ae7","spanId":"2ed443538ad654fc","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976066520665000","endTimeUnixNano":"1762976066520665000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798febda34a52cb5f0fb3e8aa503","spanId":"adb2e95416bcbba3","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976066522102000","endTimeUnixNano":"1762976066522102000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798fec79edc404be95c64591e41e","spanId":"8a3484f2438809c4","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976066681640000","endTimeUnixNano":"1762976066681640000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798fec7a2ef3990f46fab0fa768a","spanId":"b7b6ea915ff49bb0","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976066682352000","endTimeUnixNano":"1762976066682352000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff063602e40eeaa87802334bb","spanId":"f47ae77956b450c9","parentSpanId":"773a6774f66afe69","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976067683946000","endTimeUnixNano":"1762976067683946000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff3105bf99f747998271afd69","spanId":"bb94aeddc3ba18a9","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976068368185000","endTimeUnixNano":"1762976068368185000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff063602e40eeaa87802334bb","spanId":"773a6774f66afe69","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976067683516000","endTimeUnixNano":"1762976068374964000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976068370945000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a798ff317f18c1c64c40b98c3495e","spanId":"ecdb1f8d911861e8","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976068375322000","endTimeUnixNano":"1762976068375322000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff3a04dc9eded013f6bba751b","spanId":"cceec2f73579d1e9","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976068512680000","endTimeUnixNano":"1762976068512680000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff3a1a2e0037c896b89f986f1","spanId":"40944217b636c9b9","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976068513062000","endTimeUnixNano":"1762976068513062000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff43987f8f50ba1d9c36e5cbb","spanId":"2281fb2e4194c2e9","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976068665130000","endTimeUnixNano":"1762976068665130000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff439a24d4288fc115dc033f7","spanId":"1bc7d9b062f246e2","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976068665545000","endTimeUnixNano":"1762976068665545000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a798ff063602e40eeaa87802334bb","spanId":"079a218309378731","parentSpanId":"d3e646baf3088e5c","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976067685614000","endTimeUnixNano":"1762976068369656000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a798ff063602e40eeaa87802334bb","spanId":"d3e646baf3088e5c","parentSpanId":"773a6774f66afe69","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976067684813000","endTimeUnixNano":"1762976068370096000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\nreturn {\\n  -- \\\"benomahony/uv.nvim\\\",\\n  dir = \\\"/Users/benomahony/\\n  opts = {\\n    notify_activate_venv = false,\\n    picker_integration = true,\\n  },\\n}\\n\\n```\\n\\nFile: uv.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"4d3973eb13704a2baf171123e754ae3a"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"24647"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a798ff75257574c8b238dca80f7ac","spanId":"4f7377b96beef469","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976069458070000","endTimeUnixNano":"1762976069458070000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff7538977dc56ac5f5be490d4","spanId":"b13ac29dcbdb285f","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976069459150000","endTimeUnixNano":"1762976069459150000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff8035992067203c4693262ef","spanId":"77d660c1db6fb2b1","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976069635328000","endTimeUnixNano":"1762976069635328000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff803f0e1382e701d1d2d6134","spanId":"5ad59130508da1bd","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976069635955000","endTimeUnixNano":"1762976069635955000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff8b31e3f62af0c39318f2c12","spanId":"e4c318cfc076e506","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976069811874000","endTimeUnixNano":"1762976069811874000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff8b48e45573c8a0f278e2223","spanId":"e5dfbd2edfc163b5","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976069812637000","endTimeUnixNano":"1762976069812637000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff9810e591bc359e9ff571c4a","spanId":"560dc8aa485a4f52","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976070017162000","endTimeUnixNano":"1762976070017162000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798ff98217de8500711ebcf5a521","spanId":"e0696b1473797ae5","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976070017996000","endTimeUnixNano":"1762976070017996000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798ffa1bfb7cbc24248d22e276ee","spanId":"7d9ba012e7f1b991","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976070171788000","endTimeUnixNano":"1762976070171788000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798ffa1c10071be4aa01755d4711","spanId":"f0bb88083578331b","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976070172165000","endTimeUnixNano":"1762976070172165000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798ffdc52cdc6739c32eee2b665e","spanId":"03c43f8f3392364f","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976071109850000","endTimeUnixNano":"1762976071109850000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798ffdc6deaa4cbf50214fcb48a6","spanId":"32e1b4ed2885ebd1","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976071110844000","endTimeUnixNano":"1762976071110844000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a798ffdf96cb0d3571611181aea57","spanId":"588e9813395f338b","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976071161562000","endTimeUnixNano":"1762976071161562000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a798ffdfafa11bdd87d7d34bfb7f5","spanId":"a1985028bd1de283","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976071162269000","endTimeUnixNano":"1762976071162269000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7990010b2c5686c59afad5d457d6","spanId":"c088de08c07e6af7","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976071947484000","endTimeUnixNano":"1762976071947484000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7990010d3e3f0fe42943429861fc","spanId":"4da26c3568e016b3","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976071949053000","endTimeUnixNano":"1762976071949053000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79900204828fe5b6579091f51581","spanId":"dd41f151c10c01d3","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976072196482000","endTimeUnixNano":"1762976072196482000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79900206ed38e69f6a90eefc84ef","spanId":"c0dc07321e32fea6","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976072198076000","endTimeUnixNano":"1762976072198076000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7990029614d06aa2347388230947","spanId":"b75177335e1e20f2","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976072342874000","endTimeUnixNano":"1762976072342874000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79900297627ae25c651199aa768a","spanId":"775f8afee1345b58","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976072343366000","endTimeUnixNano":"1762976072343366000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799002c9fc68d4143a6a26a5b09c","spanId":"36052dc78ec8f2c2","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976072393463000","endTimeUnixNano":"1762976072393463000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a799002c95db1f6517e7625182a72","spanId":"100aa1f35d246cef","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976072393915000","endTimeUnixNano":"1762976072393915000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7990035e183e4e7c54a8e37a8751","spanId":"3343ae8b59ad91a0","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976072542784000","endTimeUnixNano":"1762976072542784000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7990035f2999b2afde9276510286","spanId":"2b5446fa87939caa","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976072543241000","endTimeUnixNano":"1762976072543241000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799003f6e3d89239fe90ad05374d","spanId":"f0f79106e2401288","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976072694768000","endTimeUnixNano":"1762976072694768000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a799003f7a870bf6e18b45760045c","spanId":"44d78df68d94d277","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976072695356000","endTimeUnixNano":"1762976072695356000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7990049dbf3e4d2bc758d3cdf850","spanId":"67c39afc0f747adf","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976072861297000","endTimeUnixNano":"1762976072861297000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7990049d378a59a60336247171b2","spanId":"bf46b2f0c3168fdd","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976072861917000","endTimeUnixNano":"1762976072861917000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79900564ea6cf8b213c6821644b8","spanId":"6903a1c64511435c","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976073060096000","endTimeUnixNano":"1762976073060096000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a799005640a34ec8090177ea2fede","spanId":"f5960c4988d23a20","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976073060704000","endTimeUnixNano":"1762976073060704000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7990069ff05caa7f1d87c83de702","spanId":"0d44ab8f7efc1d6b","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976073375368000","endTimeUnixNano":"1762976073375368000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a799006a08e20c2331ccf6505a90b","spanId":"db9c2eb5b99491ed","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976073376034000","endTimeUnixNano":"1762976073376034000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"4d3973eb13704a2baf171123e754ae3a"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"24647"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a79900a89d20be36f64ba22a2347f","spanId":"0adaa57a9c3eaef1","parentSpanId":"1b6f4215df5e4743","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976074377475000","endTimeUnixNano":"1762976074377475000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79900c35f29b0b2629f62bb01edc","spanId":"fc0350a4e04bceec","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976074805260000","endTimeUnixNano":"1762976074805260000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79900a89d20be36f64ba22a2347f","spanId":"1b6f4215df5e4743","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976074377080000","endTimeUnixNano":"1762976074809566000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976074806750000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a79900c3989c74729917d5053f89f","spanId":"7c3569c1f99d5498","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976074809919000","endTimeUnixNano":"1762976074809919000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79900d4f95265da3b7d8fec630f5","spanId":"a226d0878e4bbc28","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976075087665000","endTimeUnixNano":"1762976075087665000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79900d50ce2651545d5185c1c3c4","spanId":"8136c6aed3633b4a","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976075088203000","endTimeUnixNano":"1762976075088203000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79900d50884ea9a5693c21877543","spanId":"55aceacd56c533ef","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976075088960000","endTimeUnixNano":"1762976075088960000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79900d51651e19d456e96c2c25a8","spanId":"e7bfc17f7dda18ee","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976075089267000","endTimeUnixNano":"1762976075089267000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7990113a7bf526364a82a8dfc154","spanId":"691ab79bdadeea06","parentSpanId":"db0b158b28f31437","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976076091212000","endTimeUnixNano":"1762976076091212000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799014251e5b3c391451d4813b51","spanId":"f961241ecbc765ab","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976076837365000","endTimeUnixNano":"1762976076837365000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7990113a7bf526364a82a8dfc154","spanId":"db0b158b28f31437","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976076090616000","endTimeUnixNano":"1762976076842456000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976076839336000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a7990142ac2223fa336e92dddf333","spanId":"0f93d5f4aacc5b7f","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976076842690000","endTimeUnixNano":"1762976076842690000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79901639d7ffd33d61cce8198d77","spanId":"7c2f4f0781276130","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976077369219000","endTimeUnixNano":"1762976077369219000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79901639c686d75890963a93b7e4","spanId":"50aae9d0d6360434","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976077369726000","endTimeUnixNano":"1762976077369726000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79901723af233c3c65afee5d59ab","spanId":"6ed22b6594ecb90f","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976077603867000","endTimeUnixNano":"1762976077603867000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79901724f533e5de22b3c4333570","spanId":"344be0621ab14a59","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976077604355000","endTimeUnixNano":"1762976077604355000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79901af6a6fdbdba86184272cada","spanId":"d33b5c1e2e369ce5","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976078581989000","endTimeUnixNano":"1762976078581989000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79901af633e32cf381c14071a592","spanId":"21ad5dbdac853bfe","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976078582846000","endTimeUnixNano":"1762976078582846000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a79900a89d20be36f64ba22a2347f","spanId":"e3a12c5eccac886f","parentSpanId":"601e4fe2f6068d76","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976074379140000","endTimeUnixNano":"1762976074806019000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a79900a89d20be36f64ba22a2347f","spanId":"601e4fe2f6068d76","parentSpanId":"1b6f4215df5e4743","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976074378310000","endTimeUnixNano":"1762976074806246000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\nreturn {\\n  -- \\\"benomahony/uv.nvim\\\",\\n  dir = \\\"/Users/benomahony/C\\n  opts = {\\n    notify_activate_venv = false,\\n    picker_integration = true,\\n  },\\n}\\n\\n```\\n\\nFile: uv.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}},{"traceId":"019a7990113a7bf526364a82a8dfc154","spanId":"25843594e156870e","parentSpanId":"7b864760a8cc067c","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976076093490000","endTimeUnixNano":"1762976076838340000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a7990113a7bf526364a82a8dfc154","spanId":"7b864760a8cc067c","parentSpanId":"db0b158b28f31437","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976076092485000","endTimeUnixNano":"1762976076838645000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\nreturn {\\n  -- \\\"benomahony/uv.nvim\\\",\\n  dir = \\\"/Users/benomahony/Code/\\n  opts = {\\n    notify_activate_venv = false,\\n    picker_integration = true,\\n  },\\n}\\n\\n```\\n\\nFile: uv.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"4d3973eb13704a2baf171123e754ae3a"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"24647"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a79901ee0216e8d0ffac72c7f898a","spanId":"1e6b88a7f8509730","parentSpanId":"960921be3af247c5","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976079585054000","endTimeUnixNano":"1762976079585054000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79901fa200ee34dc04762fbc97e7","spanId":"1110c8646d51bab9","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976079778298000","endTimeUnixNano":"1762976079778298000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79901ee0216e8d0ffac72c7f898a","spanId":"960921be3af247c5","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976079584152000","endTimeUnixNano":"1762976079785922000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976079781761000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a79901faa2511bece1087ad802fbf","spanId":"f43b4a6a24693dbb","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976079786284000","endTimeUnixNano":"1762976079786284000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7990203ba56b147cdd37af5f9bfd","spanId":"168c5596b4b206f5","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976079931022000","endTimeUnixNano":"1762976079931022000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7990203ca649bcc41c06caf90c58","spanId":"428905a14f6d02f0","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976079932480000","endTimeUnixNano":"1762976079932480000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799023234ff31c26fc774992536a","spanId":"3a6b870677447f13","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976080675321000","endTimeUnixNano":"1762976080675321000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79902324c4bb3e1ce274bebdcc4f","spanId":"2098220a44226f88","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976080676052000","endTimeUnixNano":"1762976080676052000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7990244a8cfe382b97b0f575c954","spanId":"cf62092274e3b94c","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976080970901000","endTimeUnixNano":"1762976080970901000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7990244b362f9dd6f49a4f07d311","spanId":"247d2b884d32c07f","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976080971394000","endTimeUnixNano":"1762976080971394000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7990244c7ceb94543d792f923567","spanId":"f7f0059c29d19003","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976080972036000","endTimeUnixNano":"1762976080972036000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7990244c1c9302603c7cf40563e2","spanId":"406aa3ddb5f0de43","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976080972345000","endTimeUnixNano":"1762976080972345000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79902835b85f1137da9ce192ddf2","spanId":"15692968c0edc38b","parentSpanId":"fd80ad927fb2f2fc","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976081974683000","endTimeUnixNano":"1762976081974683000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a79901ee0216e8d0ffac72c7f898a","spanId":"ff5f658eaa87c31c","parentSpanId":"f0987ce8e3cc5199","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976079588674000","endTimeUnixNano":"1762976079780295000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a79901ee0216e8d0ffac72c7f898a","spanId":"f0987ce8e3cc5199","parentSpanId":"960921be3af247c5","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976079586904000","endTimeUnixNano":"1762976079780883000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\nreturn {\\n  -- \\\"benomahony/uv.nvim\\\",\\n  dir = \\\"/Users/benomahony/Code/open_source/\\n  opts = {\\n    notify_activate_venv = false,\\n    picker_integration = true,\\n  },\\n}\\n\\n```\\n\\nFile: uv.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"4d3973eb13704a2baf171123e754ae3a"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"24647"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a79902835b85f1137da9ce192ddf2","spanId":"bbd8c8c3e30aa768","parentSpanId":"c417802df7d9eda3","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976081977849000","endTimeUnixNano":"1762976084454227000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.usage.input_tokens","value":{"intValue":"595"}},{"key":"gen_ai.usage.output_tokens","value":{"intValue":"14"}},{"key":"gen_ai.usage.details.thoughts_tokens","value":{"intValue":"413"}},{"key":"gen_ai.usage.details.text_prompt_tokens","value":{"intValue":"595"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.system\": \"google-gla\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\nreturn {\\n  -- \\\"benomahony/uv.nvim\\\",\\n  dir = \\\"/Users/benomahony/Code/open_source/uv.nvim-amirreza/\\n  opts = {\\n    notify_activate_venv = false,\\n    picker_integration = true,\\n  },\\n}\\n\\n```\\n\\nFile: uv.lua\", \"role\": \"user\", \"gen_ai.system\": \"google-gla\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}, {\"index\": 0, \"message\": {\"role\": \"assistant\", \"tool_calls\": [{\"id\": \"pyd_ai_24909437135a417fa363a62cd7e6f305\", \"type\": \"function\", \"function\": {\"name\": \"final_result\", \"arguments\": {\"issues\": []}}}]}, \"gen_ai.system\": \"google-gla\", \"event.name\": \"gen_ai.choice\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"events\": {\"type\": \"array\"}, \"model_request_parameters\": {\"type\": \"object\"}}}"}}],"status":{}},{"traceId":"019a79902835b85f1137da9ce192ddf2","spanId":"c417802df7d9eda3","parentSpanId":"fd80ad927fb2f2fc","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976081976469000","endTimeUnixNano":"1762976084456151000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"final_result","value":{"stringValue":"{\"issues\": []}"}},{"key":"gen_ai.usage.input_tokens","value":{"intValue":"595"}},{"key":"gen_ai.usage.output_tokens","value":{"intValue":"14"}},{"key":"gen_ai.usage.details.thoughts_tokens","value":{"intValue":"413"}},{"key":"gen_ai.usage.details.text_prompt_tokens","value":{"intValue":"595"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\nreturn {\\n  -- \\\"benomahony/uv.nvim\\\",\\n  dir = \\\"/Users/benomahony/Code/open_source/uv.nvim-amirreza/\\n  opts = {\\n    notify_activate_venv = false,\\n    picker_integration = true,\\n  },\\n}\\n\\n```\\n\\nFile: uv.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}, {\"role\": \"assistant\", \"tool_calls\": [{\"id\": \"pyd_ai_24909437135a417fa363a62cd7e6f305\", \"type\": \"function\", \"function\": {\"name\": \"final_result\", \"arguments\": {\"issues\": []}}}], \"gen_ai.message.index\": 1, \"event.name\": \"gen_ai.assistant.message\"}, {\"content\": \"Final result processed.\", \"role\": \"tool\", \"id\": \"pyd_ai_24909437135a417fa363a62cd7e6f305\", \"name\": \"final_result\", \"gen_ai.message.index\": 2, \"event.name\": \"gen_ai.tool.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]},{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a79902835b85f1137da9ce192ddf2","spanId":"544e1089f913fc01","parentSpanId":"fd80ad927fb2f2fc","flags":256,"name":"AI analysis completed, found {len(result.output.issues)} issues","kind":1,"startTimeUnixNano":"1762976084457981000","endTimeUnixNano":"1762976084457981000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI analysis completed, found {len(result.output.issues)} issues"}},{"key":"logfire.msg","value":{"stringValue":"AI analysis completed, found 0 issues"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"203"}},{"key":"len(result.output.issues)","value":{"intValue":"0"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(result.output.issues)\":{}}}"}}],"status":{}},{"traceId":"019a79902835b85f1137da9ce192ddf2","spanId":"fd80ad927fb2f2fc","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976081973825000","endTimeUnixNano":"1762976084458241000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a799031ee05f874f3f054dcf5f9dd","spanId":"a966555585f0f8c7","flags":256,"name":"Published {len(diagnostics)} diagnostics for {uri}","kind":1,"startTimeUnixNano":"1762976084462583000","endTimeUnixNano":"1762976084462583000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Published {len(diagnostics)} diagnostics for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Published 0 diagnostics for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer._delayed_analyze"}},{"key":"code.lineno","value":{"intValue":"181"}},{"key":"len(diagnostics)","value":{"intValue":"0"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(diagnostics)\":{},\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799037eb864289db6729ebc77abc","spanId":"58bc571ab3f001a5","flags":256,"name":"Document saved: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976085995495000","endTimeUnixNano":"1762976085995495000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document saved: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document saved: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_save"}},{"key":"code.lineno","value":{"intValue":"298"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c133a345f3d34040b8bd471efc181fca"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"28607"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a79904bf04c98a7e80367c5131fbd","spanId":"43fdb8b4a8c85e7b","flags":256,"name":"Initializing AI Language Server","kind":1,"startTimeUnixNano":"1762976091120959000","endTimeUnixNano":"1762976091120959000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Initializing AI Language Server"}},{"key":"logfire.msg","value":{"stringValue":"Initializing AI Language Server"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"77"}}],"status":{}},{"traceId":"019a79904d4373b40862f24d992c8553","spanId":"a7acbc5ff12244c5","flags":256,"name":"AI agent initialized successfully","kind":1,"startTimeUnixNano":"1762976091459171000","endTimeUnixNano":"1762976091459171000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI agent initialized successfully"}},{"key":"logfire.msg","value":{"stringValue":"AI agent initialized successfully"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"115"}}],"status":{}},{"traceId":"019a79904d558847e7af6e0000ab738f","spanId":"86f00e2e7293d99e","flags":256,"name":"Document opened: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976091477611000","endTimeUnixNano":"1762976091477611000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document opened: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document opened: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_open"}},{"key":"code.lineno","value":{"intValue":"291"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7990514001c12bb5993693dea18a","spanId":"5f2ad7d852719f77","parentSpanId":"ad09dfeb68d9e71e","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976092481532000","endTimeUnixNano":"1762976092481532000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799051a752ea28362b19d46e330c","spanId":"edac784cd4c5f51e","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976092583278000","endTimeUnixNano":"1762976092583278000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7990514001c12bb5993693dea18a","spanId":"ad09dfeb68d9e71e","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976092480880000","endTimeUnixNano":"1762976092589714000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976092584508000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a799051af29439499967bfd8ac0be","spanId":"4cce3f51994529bd","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976092591171000","endTimeUnixNano":"1762976092591171000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7990559127dbc2467ebd779a9796","spanId":"f7753cefebc876ce","parentSpanId":"d3c9f7d0558695e2","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976093586444000","endTimeUnixNano":"1762976093586444000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7990569e4596606dce6b19bcade0","spanId":"c6eaf60af8be380c","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976093854056000","endTimeUnixNano":"1762976093854056000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7990559127dbc2467ebd779a9796","spanId":"d3c9f7d0558695e2","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976093585387000","endTimeUnixNano":"1762976093861789000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976093857971000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a799056a634863a9d812b56872e30","spanId":"2c97c1e61c706b2f","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976093862150000","endTimeUnixNano":"1762976093862150000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799058751028f71fb8e9c8ff6acc","spanId":"5bc2e0293facc81d","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976094325138000","endTimeUnixNano":"1762976094325138000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a799058767730d3745f8c8c976fbc","spanId":"f6af6f7f602c1aef","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976094326277000","endTimeUnixNano":"1762976094326277000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799059a3dcefec5581bb86883872","spanId":"dd8c223326c36425","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976094627887000","endTimeUnixNano":"1762976094627887000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a799059a4108dce375e06289380cf","spanId":"e5dd44a3ad60a519","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976094628405000","endTimeUnixNano":"1762976094628405000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79905bebe8da5b7429acbe52d235","spanId":"7201410cb408d827","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976095211040000","endTimeUnixNano":"1762976095211040000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79905bebe5ae3a00f09f4805f9f5","spanId":"ac2b3c73872ece75","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976095211484000","endTimeUnixNano":"1762976095211484000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79905d18e1768af63f1ec6d592d7","spanId":"e4d8672166882e7e","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976095512594000","endTimeUnixNano":"1762976095512594000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79905d19c5b734c1a2415e3ccc3e","spanId":"a99d144fed7252f1","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976095513556000","endTimeUnixNano":"1762976095513556000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a7990514001c12bb5993693dea18a","spanId":"878179223c0255b0","parentSpanId":"a32dcc1ab9ad2944","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976092483052000","endTimeUnixNano":"1762976092583787000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a7990514001c12bb5993693dea18a","spanId":"a32dcc1ab9ad2944","parentSpanId":"ad09dfeb68d9e71e","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976092482348000","endTimeUnixNano":"1762976092583985000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\nreturn {\\n  -- \\\"benomahony/uv.nvim\\\",\\n  dir = \\\"/Users/benomahony/Code/open_source/uv.nvim-amirreza/\\n  opts = {\\n    notify_activate_venv = false,\\n    picker_integration = true,\\n  },\\n}\\n\\n```\\n\\nFile: uv.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}},{"traceId":"019a7990559127dbc2467ebd779a9796","spanId":"cb11a012f9bc2b17","parentSpanId":"fd4e78281a6dc2e1","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976093589633000","endTimeUnixNano":"1762976093856622000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a7990559127dbc2467ebd779a9796","spanId":"fd4e78281a6dc2e1","parentSpanId":"d3c9f7d0558695e2","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976093588185000","endTimeUnixNano":"1762976093857189000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\nreturn {\\n  -- \\\"benomahony/uv.nvim\\\",\\n  dir = \\\"/Users/benomahony/Code/open_source/uv.nvim-amirreza/\\\"\\n  opts = {\\n    notify_activate_venv = false,\\n    picker_integration = true,\\n  },\\n}\\n\\n```\\n\\nFile: uv.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c133a345f3d34040b8bd471efc181fca"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"28607"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a7990610143f2e5cb4bddf2157c4f","spanId":"9840c83e4feac870","parentSpanId":"2c9b139d19643b80","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976096514545000","endTimeUnixNano":"1762976096514545000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799066451d0a1b72eaf908379a65","spanId":"1baea8779b1ee103","flags":256,"name":"Document saved: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976097861613000","endTimeUnixNano":"1762976097861613000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document saved: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document saved: file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_save"}},{"key":"code.lineno","value":{"intValue":"298"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7990610143f2e5cb4bddf2157c4f","spanId":"2c9b139d19643b80","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976096513857000","endTimeUnixNano":"1762976097865058000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976097862885000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a79906649a5fb89d65ddb993b8f13","spanId":"2c98d30fce82dd6b","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976097865276000","endTimeUnixNano":"1762976097865276000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/uv.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a7990610143f2e5cb4bddf2157c4f","spanId":"d13ccc3bc4dc315f","parentSpanId":"c79c29a22aa154e1","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976096517105000","endTimeUnixNano":"1762976097862204000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a7990610143f2e5cb4bddf2157c4f","spanId":"c79c29a22aa154e1","parentSpanId":"2c9b139d19643b80","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976096515981000","endTimeUnixNano":"1762976097862428000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\nreturn {\\n  -- \\\"benomahony/uv.nvim\\\",\\n  dir = \\\"/Users/benomahony/Code/open_source/uv.nvim-amirreza/\\\",\\n  opts = {\\n    notify_activate_venv = false,\\n    picker_integration = true,\\n  },\\n}\\n\\n```\\n\\nFile: uv.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"5562677e4a744d0e9658b60527233708"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"44772"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a7990af2470dae68c9de0c0d10ce8","spanId":"b317c953660d696b","flags":256,"name":"Initializing AI Language Server","kind":1,"startTimeUnixNano":"1762976116516564000","endTimeUnixNano":"1762976116516564000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Initializing AI Language Server"}},{"key":"logfire.msg","value":{"stringValue":"Initializing AI Language Server"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"77"}}],"status":{}},{"traceId":"019a7990b08bb4932eebfacf9e48d7fb","spanId":"5bb3348a307813af","flags":256,"name":"AI agent initialized successfully","kind":1,"startTimeUnixNano":"1762976116875605000","endTimeUnixNano":"1762976116875605000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI agent initialized successfully"}},{"key":"logfire.msg","value":{"stringValue":"AI agent initialized successfully"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"115"}}],"status":{}},{"traceId":"019a7990b09d0051eae307e33aabba68","spanId":"9b357a72cbc6387c","flags":256,"name":"Document opened: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976116893853000","endTimeUnixNano":"1762976116893853000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document opened: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document opened: file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_open"}},{"key":"code.lineno","value":{"intValue":"291"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7990b4887589dc76e2c292c3a523","spanId":"9b371776a940a093","parentSpanId":"a267ec6c991a8868","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976117897181000","endTimeUnixNano":"1762976117897181000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"17d077fec1c94224ab0750c330085ee7"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"45173"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a79917e6424dc0de3f40b8b8531b7","spanId":"1fead71c49f03d4b","flags":256,"name":"Initializing AI Language Server","kind":1,"startTimeUnixNano":"1762976169572395000","endTimeUnixNano":"1762976169572395000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Initializing AI Language Server"}},{"key":"logfire.msg","value":{"stringValue":"Initializing AI Language Server"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"77"}}],"status":{}},{"traceId":"019a79917fde0d6797a41e5e4de09ded","spanId":"516afb77c1b9c250","flags":256,"name":"AI agent initialized successfully","kind":1,"startTimeUnixNano":"1762976169950593000","endTimeUnixNano":"1762976169950593000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI agent initialized successfully"}},{"key":"logfire.msg","value":{"stringValue":"AI agent initialized successfully"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"115"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"5562677e4a744d0e9658b60527233708"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"44772"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a7990b4887589dc76e2c292c3a523","spanId":"a0e771158faf4c54","parentSpanId":"ddad674d7fe40f25","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976117898906000","endTimeUnixNano":"1762976182600193000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.usage.input_tokens","value":{"intValue":"4882"}},{"key":"gen_ai.usage.output_tokens","value":{"intValue":"895"}},{"key":"gen_ai.usage.details.thoughts_tokens","value":{"intValue":"11613"}},{"key":"gen_ai.usage.details.text_prompt_tokens","value":{"intValue":"4882"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.system\": \"google-gla\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this python code for issues:\\n\\n```python\\nimport asyncio\\nimport os\\nfrom pathlib import Path\\nfrom typing import Any, Literal\\nfrom importlib.metadata import version\\nimport logfire\\n\\n# pyrefly: ignore [missing-import]\\nfrom lsprotocol.types import (\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    TEXT_DOCUMENT_DID_CHANGE,\\n    TEXT_DOCUMENT_DID_OPEN,\\n    TEXT_DOCUMENT_DID_SAVE,\\n    CodeAction,\\n    CodeActionKind,\\n    CodeActionOptions,\\n    CodeActionParams,\\n    Command,\\n    Diagnostic,\\n    DiagnosticSeverity,\\n    DidChangeTextDocumentParams,\\n    DidOpenTextDocumentParams,\\n    DidSaveTextDocumentParams,\\n    Position,\\n    Range,\\n    TextEdit,\\n    WorkspaceEdit,\\n)\\nfrom pydantic import BaseModel, Field\\nfrom pydantic_ai import Agent\\nfrom pydantic_ai.models import KnownModelName\\nfrom pydantic_settings import BaseSettings\\n\\n# pyrefly: ignore [missing-import]\\nfrom pygls.server import LanguageServer\\n\\n\\nclass Settings(BaseSettings):\\n    ai_lsp_model: KnownModelName = Field(default=\\\"google-gla:gemini-2.5-flash\\\")\\n    debounce_ms: int = Field(default=1000)\\n    max_cache_size: int = Field(default=50)\\n    configure_logfire: bool = Field(default=True)\\n    otel_exporter_otlp_endpoint: str = Field(default=\\\"http://localhost:4318\\\")\\n\\n\\nsettings = Settings()\\n\\n\\nos.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\\n\\nif settings.configure_logfire:\\n    logfire.configure(send_to_logfire=False, service_name=\\\"ai-lsp\\\")\\n    logfire.instrument_pydantic_ai()\\n    logfire.instrument_httpx(capture_all=True)\\n\\n\\nclass SuggestedFix(BaseModel):\\n    title: str\\n    target_snippet: str\\n    replacement_snippet: str\\n\\n\\nclass CodeIssue(BaseModel):\\n    issue_snippet: str\\n    severity: Literal[\\\"error\\\", \\\"warning\\\", \\\"info\\\", \\\"hint\\\"]\\n    message: str\\n    suggested_fixes: list[SuggestedFix] | None = None\\n\\n\\nclass DiagnosticResult(BaseModel):\\n    issues: list[CodeIssue]\\n\\n\\nclass AILanguageServer(LanguageServer):\\n    def __init__(self):\\n        super().__init__(\\\"ai-lsp\\\", version(\\\"ai-lsp\\\"))\\n        logfire.info(\\\"Initializing AI Language Server\\\")\\n        self._pending_tasks: dict[str, asyncio.Task[Any]] = {}\\n        self._analysis_locks: dict[str, asyncio.Lock] = {}\\n\\n        self.agent: Agent[DiagnosticResult, Any] = Agent(\\n            model=settings.ai_lsp_model,\\n            output_type=DiagnosticResult,\\n            system_prompt=\\\"\\\"\\\"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\\\"\\\"\\\",\\n        )\\n        logfire.info(\\\"AI agent initialized successfully\\\")\\n\\n    def find_snippet_in_text(\\n        self, text: str, snippet: str\\n    ) -> list[tuple[int, int, int, int]]:\\n        \\\"\\\"\\\"Find all occurrences of code snippet in text, return positions as (start_line, start_col, end_line, end_col)\\\"\\\"\\\"\\n        snippet = snippet.strip()\\n        positions = []\\n\\n        # Search for all occurrences of snippet\\n        start_pos = 0\\n        while True:\\n            start_pos = text.find(snippet, start_pos)\\n            if start_pos == -1:\\n                break\\n\\n            # Convert character position to line/column\\n            lines = text[:start_pos].split(\\\"\\\\n\\\")\\n            start_line = len(lines) - 1\\n            start_col = len(lines[-1])\\n\\n            # Calculate end position\\n            snippet_lines = snippet.split(\\\"\\\\n\\\")\\n            if len(snippet_lines) == 1:\\n                end_line = start_line\\n                end_col = start_col + len(snippet)\\n            else:\\n                end_line = start_line + len(snippet_lines) - 1\\n                end_col = len(snippet_lines[-1])\\n\\n            positions.append((start_line, start_col, end_line, end_col))\\n            start_pos += 1  # Move past this occurrence\\n\\n        if not positions:\\n            logfire.warn(f\\\"Could not find snippet '{snippet}' in text\\\")\\n        else:\\n            logfire.debug(f\\\"Found {len(positions)} occurrences of '{snippet[:20]}...'\\\")\\n\\n        return positions\\n\\n    async def debounced_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Debounced analysis that cancels previous calls\\\"\\\"\\\"\\n        # Cancel any existing task for this URI\\n        if uri in self._pending_tasks:\\n            self._pending_tasks[uri].cancel()\\n            _ = self._pending_tasks.pop(uri, None)\\n\\n        # Create new task\\n        task: asyncio.Task[None] = asyncio.create_task(self._delayed_analyze(uri, text))\\n        self._pending_tasks[uri] = task\\n\\n        try:\\n            await task\\n        except asyncio.CancelledError:\\n            logfire.debug(f\\\"Analysis cancelled for {uri}\\\")\\n        finally:\\n            # Clean up completed task\\n            if uri in self._pending_tasks and self._pending_tasks[uri] == task:\\n                _ = self._pending_tasks.pop(uri)\\n\\n    async def _delayed_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Wait for debounce period then analyze\\\"\\\"\\\"\\n        await asyncio.sleep(settings.debounce_ms / 1000.0)\\n        diagnostics = await self.analyze_document(uri, text)\\n        # pyrefly: ignore [missing-attribute]\\n        self.publish_diagnostics(uri, diagnostics)\\n        logfire.debug(f\\\"Published {len(diagnostics)} diagnostics for {uri}\\\")\\n\\n    async def analyze_document(self, uri: str, text: str) -> list[Diagnostic]:\\n        # Ensure we have a lock for this URI\\n        lock = self._analysis_locks.setdefault(uri, asyncio.Lock())\\n        async with lock:\\n            with logfire.span(\\\"analyze_document\\\", uri=uri):\\n                logfire.info(f\\\"Starting AI analysis for {uri}\\\")\\n\\n                try:\\n                    file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n                    language = self._detect_language(file_path)\\n\\n                    prompt = f\\\"\\\"\\\"Analyze this {language} code for issues:\\n\\n```{language}\\n{text}\\n```\\n\\nFile: {file_path.name}\\\"\\\"\\\"\\n\\n                    result = await self.agent.run(prompt)\\n                    logfire.info(\\n                        f\\\"AI analysis completed, found {len(result.output.issues)} issues\\\"\\n                    )\\n\\n                    diagnostics = []\\n                    for issue in result.output.issues:\\n                        positions = self.find_snippet_in_text(text, issue.issue_snippet)\\n\\n                        if positions:\\n                            start_line, start_col, end_line, end_col = positions[0]\\n                            diagnostic = Diagnostic(\\n                                range=Range(\\n                                    start=Position(\\n                                        line=start_line, character=start_col\\n                                    ),\\n                                    end=Position(line=end_line, character=end_col),\\n                                ),\\n                                message=f\\\"AI LSP: {issue.message}\\\",\\n                                severity=self._get_diagnostic_severity(issue.severity),\\n                                source=\\\"ai-lsp\\\",\\n                                data={\\n                                    \\\"issue_snippet\\\": issue.issue_snippet,\\n                                    \\\"suggested_fixes\\\": [\\n                                        {\\n                                            \\\"title\\\": fix.title,\\n                                            \\\"target_snippet\\\": fix.target_snippet,\\n                                            \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                        }\\n                                        for fix in (issue.suggested_fixes or [])\\n                                    ],\\n                                },\\n                            )\\n                            diagnostics.append(diagnostic)\\n\\n                    return diagnostics\\n\\n                except Exception as e:\\n                    logfire.error(\\n                        f\\\"AI analysis failed for {uri}: {str(e)}\\\", _exc_info=True\\n                    )\\n                    return []\\n\\n    def _get_diagnostic_severity(self, severity: str) -> DiagnosticSeverity:\\n        match severity:\\n            case \\\"error\\\":\\n                return DiagnosticSeverity.Error\\n            case \\\"warning\\\":\\n                return DiagnosticSeverity.Warning\\n            case \\\"info\\\":\\n                return DiagnosticSeverity.Information\\n            case \\\"hint\\\":\\n                return DiagnosticSeverity.Hint\\n            case _:\\n                return DiagnosticSeverity.Information\\n\\n    def _detect_language(self, file_path: Path) -> str:\\n        match file_path.suffix:\\n            case \\\".py\\\":\\n                return \\\"python\\\"\\n            case \\\".js\\\":\\n                return \\\"javascript\\\"\\n            case \\\".ts\\\":\\n                return \\\"typescript\\\"\\n            case \\\".jsx\\\":\\n                return \\\"jsx\\\"\\n            case \\\".tsx\\\":\\n                return \\\"tsx\\\"\\n            case \\\".rs\\\":\\n                return \\\"rust\\\"\\n            case \\\".go\\\":\\n                return \\\"go\\\"\\n            case \\\".java\\\":\\n                return \\\"java\\\"\\n            case \\\".cpp\\\":\\n                return \\\"cpp\\\"\\n            case \\\".c\\\":\\n                return \\\"c\\\"\\n            case \\\".lua\\\":\\n                return \\\"lua\\\"\\n            case _:\\n                return \\\"text\\\"\\n\\n\\nserver = AILanguageServer()\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_OPEN)\\nasync def did_open(params: DidOpenTextDocumentParams):\\n    logfire.info(f\\\"Document opened: {params.text_document.uri}\\\")\\n    doc = params.text_document\\n    await server.debounced_analyze(doc.uri, doc.text)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_SAVE)\\nasync def did_save(params: DidSaveTextDocumentParams):\\n    logfire.info(f\\\"Document saved: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_CHANGE)\\nasync def did_change(params: DidChangeTextDocumentParams):\\n    logfire.debug(f\\\"Document changed: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    CodeActionOptions(code_action_kinds=[CodeActionKind.QuickFix]),\\n)\\nasync def code_actions(params: CodeActionParams) -> list[CodeAction]:\\n    with logfire.span(\\\"code_actions\\\", uri=params.text_document.uri):\\n        actions: list[CodeAction] = []\\n        uri = params.text_document.uri\\n        doc = server.workspace.get_text_document(uri)\\n\\n        for diagnostic in params.context.diagnostics:\\n            if diagnostic.source != \\\"ai-lsp\\\" or not diagnostic.data:\\n                continue\\n\\n            suggested_fixes = diagnostic.data.get(\\\"suggested_fixes\\\", [])\\n\\n            for fix_data in suggested_fixes:\\n                target_positions = server.find_snippet_in_text(\\n                    doc.source, fix_data[\\\"target_snippet\\\"]\\n                )\\n\\n                if target_positions:\\n                    with logfire.span(\\\"creating_quick_fix\\\", title=fix_data[\\\"title\\\"]):\\n                        start_line, start_col, end_line, end_col = target_positions[0]\\n                        fix_range = Range(\\n                            start=Position(line=start_line, character=start_col),\\n                            end=Position(line=end_line, character=end_col),\\n                        )\\n\\n                        edit = WorkspaceEdit(\\n                            changes={\\n                                uri: [\\n                                    TextEdit(\\n                                        range=fix_range,\\n                                        new_text=fix_data[\\\"replacement_snippet\\\"],\\n                                    )\\n                                ]\\n                            }\\n                        )\\n\\n                        action = CodeAction(\\n                            title=f\\\"Apply: {fix_data['title']}\\\",\\n                            kind=CodeActionKind.QuickFix,\\n                            edit=edit,\\n                            diagnostics=[diagnostic],\\n                            is_preferred=True,\\n                        )\\n                        actions.append(action)\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Regenerate AI fix\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Regenerate fix\\\",\\n                        command=\\\"ai-lsp.regenerateFix\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.data.get(\\\"issue_snippet\\\"),\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Dismiss AI suggestion\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Dismiss\\\",\\n                        command=\\\"ai-lsp.dismiss\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n        return actions\\n\\n\\n@server.command(\\\"ai-lsp.regenerateFix\\\")\\nasync def regenerate_fix(*args):\\n    if len(args) < 4:\\n        return\\n\\n    uri, issue_snippet, line, character = args[0], args[1], args[2], args[3]\\n\\n    with logfire.span(\\\"regenerate_fix\\\", uri=uri, issue_snippet=issue_snippet):\\n        logfire.info(\\n            f\\\"Regenerating fix for '{issue_snippet}' at {uri}:{line}:{character}\\\"\\n        )\\n\\n        doc = server.workspace.get_text_document(uri)\\n        file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n        language = server._detect_language(file_path)\\n\\n        prompt = f\\\"\\\"\\\"Analyze this specific code issue and provide NEW suggested fixes.\\n\\nIssue snippet: {issue_snippet}\\n\\nFull code context:\\n```{language}\\n{doc.source}\\n```\\n\\nFile: {file_path.name}\\n\\nFocus ONLY on the issue at the snippet shown. Provide fresh, alternative fixes if possible.\\\"\\\"\\\"\\n\\n        try:\\n            result = await server.agent.run(prompt)\\n\\n            if not result.output.issues:\\n                logfire.warn(\\\"No issues returned for regeneration\\\")\\n                return\\n\\n            regenerated_issue = result.output.issues[0]\\n\\n            current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n            updated_diags = []\\n\\n            for diag in current_diags:\\n                if (\\n                    diag.source == \\\"ai-lsp\\\"\\n                    and diag.range.start.line == line\\n                    and diag.range.start.character == character\\n                ):\\n                    positions = server.find_snippet_in_text(\\n                        doc.source, regenerated_issue.issue_snippet\\n                    )\\n                    if positions:\\n                        start_line, start_col, end_line, end_col = positions[0]\\n                        updated_diag = Diagnostic(\\n                            range=Range(\\n                                start=Position(line=start_line, character=start_col),\\n                                end=Position(line=end_line, character=end_col),\\n                            ),\\n                            message=f\\\"AI LSP: {regenerated_issue.message}\\\",\\n                            severity=server._get_diagnostic_severity(\\n                                regenerated_issue.severity\\n                            ),\\n                            source=\\\"ai-lsp\\\",\\n                            data={\\n                                \\\"issue_snippet\\\": regenerated_issue.issue_snippet,\\n                                \\\"suggested_fixes\\\": [\\n                                    {\\n                                        \\\"title\\\": fix.title,\\n                                        \\\"target_snippet\\\": fix.target_snippet,\\n                                        \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                    }\\n                                    for fix in (regenerated_issue.suggested_fixes or [])\\n                                ],\\n                            },\\n                        )\\n                        updated_diags.append(updated_diag)\\n                        logfire.info(\\n                            f\\\"Regenerated diagnostic with {len(regenerated_issue.suggested_fixes or [])} new fixes\\\"\\n                        )\\n                else:\\n                    updated_diags.append(diag)\\n\\n            server.publish_diagnostics(uri, updated_diags)\\n\\n        except Exception as e:\\n            logfire.error(f\\\"Failed to regenerate fix: {str(e)}\\\", _exc_info=True)\\n\\n\\n@server.command(\\\"ai-lsp.dismiss\\\")\\ndef dismiss_suggestion(*args):\\n    if len(args) < 3:\\n        return\\n\\n    uri, line, character = args[0], args[1], args[2]\\n\\n    with logfire.span(\\\"dismiss_suggestion\\\", uri=uri, line=line, character=character):\\n        logfire.info(f\\\"Dismissing suggestion at {uri}:{line}:{character}\\\")\\n\\n        doc = server.workspace.get_text_document(uri)\\n        diagnostics = []\\n\\n        current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n        for diag in current_diags:\\n            if (\\n                diag.source == \\\"ai-lsp\\\"\\n                and diag.range.start.line == line\\n                and diag.range.start.character == character\\n            ):\\n                continue\\n            diagnostics.append(diag)\\n\\n        server.publish_diagnostics(uri, diagnostics)\\n\\n\\ndef app():\\n    server.start_io()\\n\\n\\nif __name__ == \\\"__main__\\\":\\n    app()\\n\\n```\\n\\nFile: main.py\", \"role\": \"user\", \"gen_ai.system\": \"google-gla\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}, {\"index\": 0, \"message\": {\"role\": \"assistant\", \"tool_calls\": [{\"id\": \"pyd_ai_5e40d40a737047b5a62b48ad02faf511\", \"type\": \"function\", \"function\": {\"name\": \"final_result\", \"arguments\": {\"issues\": [{\"severity\": \"warning\", \"message\": \"The `find_snippet_in_text` function strips leading and trailing whitespace from the provided snippet before searching. If the AI provides an `issue_snippet` or `target_snippet` that intentionally includes specific whitespace (e.g., indentation or leading/trailing spaces as part of the match), this stripping could lead to a failure to locate the snippet or an incorrect match. This may result in diagnostics or code actions not being applied as intended. It's generally safer to search for the exact snippet provided by the AI without modification.\", \"suggested_fixes\": [{\"target_snippet\": \"snippet.strip()\", \"replacement_snippet\": \"snippet\", \"title\": \"Remove snippet stripping\"}], \"issue_snippet\": \"snippet.strip()\"}, {\"message\": \"The `analyze_document`, `code_actions`, and `regenerate_fix` functions consistently use `positions[0]` from `find_snippet_in_text`. This means that if an `issue_snippet` or `target_snippet` (as provided by the AI) appears multiple times in the document, diagnostics and code actions will always be applied to the *first* occurrence found. This is an architectural limitation because the AI's current output format lacks the explicit range information needed to pinpoint a specific instance of a repeated code pattern, potentially leading to confusing diagnostics and incorrect application of fixes.\", \"severity\": \"error\", \"issue_snippet\": \"positions[0]\"}, {\"message\": \"The `max_cache_size` setting is defined in the `Settings` class but is not referenced or utilized anywhere within the provided `AILanguageServer` implementation. This indicates a potentially unimplemented feature, a forgotten setting, or dead code. It's good practice to either implement the associated caching logic (e.g., for `_pending_tasks` or `analyze_document` results) or remove the setting to avoid confusion and maintain a clean configuration.\", \"suggested_fixes\": [{\"replacement_snippet\": \"# max_cache_size: int = Field(default=50) # Setting currently unused.\", \"target_snippet\": \"max_cache_size: int = Field(default=50)\", \"title\": \"Remove unused setting\"}], \"severity\": \"info\", \"issue_snippet\": \"max_cache_size\"}, {\"message\": \"When regenerating a fix, the `regenerate_fix` command sends the entire document's content (`doc.source`) to the AI for analysis. While providing full context can be beneficial, for a focused regeneration of a specific snippet, sending the full file can be inefficient (higher token usage, slower response) and raises data privacy concerns if the code contains sensitive information. It would be more efficient and privacy-preserving to send only a contextual window of code around the problematic snippet instead of the entire document.\", \"issue_snippet\": \"doc.source\", \"severity\": \"warning\"}, {\"suggested_fixes\": [{\"replacement_snippet\": \"# To ensure OpenTelemetry components pick up the endpoint consistently,\\n# this line should ideally be moved to the very top of the file,\\n# before any imports that initialize tracing or logging libraries.\\nos.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\", \"title\": \"Suggest moving environment variable setting for early initialization\", \"target_snippet\": \"os.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\"}], \"issue_snippet\": \"os.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\", \"message\": \"The environment variable `OTEL_EXPORTER_OTLP_ENDPOINT` is set using `os.environ` after `logfire` has already been imported. While `logfire.configure` is called later, some underlying OpenTelemetry components might read environment variables during initial import. To guarantee that all parts of the tracing system correctly pick up the endpoint, it is best practice to set this environment variable at the very top of the script or externally, before any modules that rely on it are imported or initialized.\", \"severity\": \"warning\"}]}}}]}, \"gen_ai.system\": \"google-gla\", \"event.name\": \"gen_ai.choice\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"events\": {\"type\": \"array\"}, \"model_request_parameters\": {\"type\": \"object\"}}}"}}],"status":{}},{"traceId":"019a7990b4887589dc76e2c292c3a523","spanId":"ddad674d7fe40f25","parentSpanId":"a267ec6c991a8868","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976117897890000","endTimeUnixNano":"1762976182609243000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"final_result","value":{"stringValue":"{\"issues\": [{\"issue_snippet\": \"snippet.strip()\", \"severity\": \"warning\", \"message\": \"The `find_snippet_in_text` function strips leading and trailing whitespace from the provided snippet before searching. If the AI provides an `issue_snippet` or `target_snippet` that intentionally includes specific whitespace (e.g., indentation or leading/trailing spaces as part of the match), this stripping could lead to a failure to locate the snippet or an incorrect match. This may result in diagnostics or code actions not being applied as intended. It's generally safer to search for the exact snippet provided by the AI without modification.\", \"suggested_fixes\": [{\"title\": \"Remove snippet stripping\", \"target_snippet\": \"snippet.strip()\", \"replacement_snippet\": \"snippet\"}]}, {\"issue_snippet\": \"positions[0]\", \"severity\": \"error\", \"message\": \"The `analyze_document`, `code_actions`, and `regenerate_fix` functions consistently use `positions[0]` from `find_snippet_in_text`. This means that if an `issue_snippet` or `target_snippet` (as provided by the AI) appears multiple times in the document, diagnostics and code actions will always be applied to the *first* occurrence found. This is an architectural limitation because the AI's current output format lacks the explicit range information needed to pinpoint a specific instance of a repeated code pattern, potentially leading to confusing diagnostics and incorrect application of fixes.\", \"suggested_fixes\": null}, {\"issue_snippet\": \"max_cache_size\", \"severity\": \"info\", \"message\": \"The `max_cache_size` setting is defined in the `Settings` class but is not referenced or utilized anywhere within the provided `AILanguageServer` implementation. This indicates a potentially unimplemented feature, a forgotten setting, or dead code. It's good practice to either implement the associated caching logic (e.g., for `_pending_tasks` or `analyze_document` results) or remove the setting to avoid confusion and maintain a clean configuration.\", \"suggested_fixes\": [{\"title\": \"Remove unused setting\", \"target_snippet\": \"max_cache_size: int = Field(default=50)\", \"replacement_snippet\": \"# max_cache_size: int = Field(default=50) # Setting currently unused.\"}]}, {\"issue_snippet\": \"doc.source\", \"severity\": \"warning\", \"message\": \"When regenerating a fix, the `regenerate_fix` command sends the entire document's content (`doc.source`) to the AI for analysis. While providing full context can be beneficial, for a focused regeneration of a specific snippet, sending the full file can be inefficient (higher token usage, slower response) and raises data privacy concerns if the code contains sensitive information. It would be more efficient and privacy-preserving to send only a contextual window of code around the problematic snippet instead of the entire document.\", \"suggested_fixes\": null}, {\"issue_snippet\": \"os.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\", \"severity\": \"warning\", \"message\": \"The environment variable `OTEL_EXPORTER_OTLP_ENDPOINT` is set using `os.environ` after `logfire` has already been imported. While `logfire.configure` is called later, some underlying OpenTelemetry components might read environment variables during initial import. To guarantee that all parts of the tracing system correctly pick up the endpoint, it is best practice to set this environment variable at the very top of the script or externally, before any modules that rely on it are imported or initialized.\", \"suggested_fixes\": [{\"title\": \"Suggest moving environment variable setting for early initialization\", \"target_snippet\": \"os.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\", \"replacement_snippet\": \"# To ensure OpenTelemetry components pick up the endpoint consistently,\\n# this line should ideally be moved to the very top of the file,\\n# before any imports that initialize tracing or logging libraries.\\nos.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\"}]}]}"}},{"key":"gen_ai.usage.input_tokens","value":{"intValue":"4882"}},{"key":"gen_ai.usage.output_tokens","value":{"intValue":"895"}},{"key":"gen_ai.usage.details.thoughts_tokens","value":{"intValue":"11613"}},{"key":"gen_ai.usage.details.text_prompt_tokens","value":{"intValue":"4882"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this python code for issues:\\n\\n```python\\nimport asyncio\\nimport os\\nfrom pathlib import Path\\nfrom typing import Any, Literal\\nfrom importlib.metadata import version\\nimport logfire\\n\\n# pyrefly: ignore [missing-import]\\nfrom lsprotocol.types import (\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    TEXT_DOCUMENT_DID_CHANGE,\\n    TEXT_DOCUMENT_DID_OPEN,\\n    TEXT_DOCUMENT_DID_SAVE,\\n    CodeAction,\\n    CodeActionKind,\\n    CodeActionOptions,\\n    CodeActionParams,\\n    Command,\\n    Diagnostic,\\n    DiagnosticSeverity,\\n    DidChangeTextDocumentParams,\\n    DidOpenTextDocumentParams,\\n    DidSaveTextDocumentParams,\\n    Position,\\n    Range,\\n    TextEdit,\\n    WorkspaceEdit,\\n)\\nfrom pydantic import BaseModel, Field\\nfrom pydantic_ai import Agent\\nfrom pydantic_ai.models import KnownModelName\\nfrom pydantic_settings import BaseSettings\\n\\n# pyrefly: ignore [missing-import]\\nfrom pygls.server import LanguageServer\\n\\n\\nclass Settings(BaseSettings):\\n    ai_lsp_model: KnownModelName = Field(default=\\\"google-gla:gemini-2.5-flash\\\")\\n    debounce_ms: int = Field(default=1000)\\n    max_cache_size: int = Field(default=50)\\n    configure_logfire: bool = Field(default=True)\\n    otel_exporter_otlp_endpoint: str = Field(default=\\\"http://localhost:4318\\\")\\n\\n\\nsettings = Settings()\\n\\n\\nos.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\\n\\nif settings.configure_logfire:\\n    logfire.configure(send_to_logfire=False, service_name=\\\"ai-lsp\\\")\\n    logfire.instrument_pydantic_ai()\\n    logfire.instrument_httpx(capture_all=True)\\n\\n\\nclass SuggestedFix(BaseModel):\\n    title: str\\n    target_snippet: str\\n    replacement_snippet: str\\n\\n\\nclass CodeIssue(BaseModel):\\n    issue_snippet: str\\n    severity: Literal[\\\"error\\\", \\\"warning\\\", \\\"info\\\", \\\"hint\\\"]\\n    message: str\\n    suggested_fixes: list[SuggestedFix] | None = None\\n\\n\\nclass DiagnosticResult(BaseModel):\\n    issues: list[CodeIssue]\\n\\n\\nclass AILanguageServer(LanguageServer):\\n    def __init__(self):\\n        super().__init__(\\\"ai-lsp\\\", version(\\\"ai-lsp\\\"))\\n        logfire.info(\\\"Initializing AI Language Server\\\")\\n        self._pending_tasks: dict[str, asyncio.Task[Any]] = {}\\n        self._analysis_locks: dict[str, asyncio.Lock] = {}\\n\\n        self.agent: Agent[DiagnosticResult, Any] = Agent(\\n            model=settings.ai_lsp_model,\\n            output_type=DiagnosticResult,\\n            system_prompt=\\\"\\\"\\\"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\\\"\\\"\\\",\\n        )\\n        logfire.info(\\\"AI agent initialized successfully\\\")\\n\\n    def find_snippet_in_text(\\n        self, text: str, snippet: str\\n    ) -> list[tuple[int, int, int, int]]:\\n        \\\"\\\"\\\"Find all occurrences of code snippet in text, return positions as (start_line, start_col, end_line, end_col)\\\"\\\"\\\"\\n        snippet = snippet.strip()\\n        positions = []\\n\\n        # Search for all occurrences of snippet\\n        start_pos = 0\\n        while True:\\n            start_pos = text.find(snippet, start_pos)\\n            if start_pos == -1:\\n                break\\n\\n            # Convert character position to line/column\\n            lines = text[:start_pos].split(\\\"\\\\n\\\")\\n            start_line = len(lines) - 1\\n            start_col = len(lines[-1])\\n\\n            # Calculate end position\\n            snippet_lines = snippet.split(\\\"\\\\n\\\")\\n            if len(snippet_lines) == 1:\\n                end_line = start_line\\n                end_col = start_col + len(snippet)\\n            else:\\n                end_line = start_line + len(snippet_lines) - 1\\n                end_col = len(snippet_lines[-1])\\n\\n            positions.append((start_line, start_col, end_line, end_col))\\n            start_pos += 1  # Move past this occurrence\\n\\n        if not positions:\\n            logfire.warn(f\\\"Could not find snippet '{snippet}' in text\\\")\\n        else:\\n            logfire.debug(f\\\"Found {len(positions)} occurrences of '{snippet[:20]}...'\\\")\\n\\n        return positions\\n\\n    async def debounced_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Debounced analysis that cancels previous calls\\\"\\\"\\\"\\n        # Cancel any existing task for this URI\\n        if uri in self._pending_tasks:\\n            self._pending_tasks[uri].cancel()\\n            _ = self._pending_tasks.pop(uri, None)\\n\\n        # Create new task\\n        task: asyncio.Task[None] = asyncio.create_task(self._delayed_analyze(uri, text))\\n        self._pending_tasks[uri] = task\\n\\n        try:\\n            await task\\n        except asyncio.CancelledError:\\n            logfire.debug(f\\\"Analysis cancelled for {uri}\\\")\\n        finally:\\n            # Clean up completed task\\n            if uri in self._pending_tasks and self._pending_tasks[uri] == task:\\n                _ = self._pending_tasks.pop(uri)\\n\\n    async def _delayed_analyze(self, uri: str, text: str):\\n        \\\"\\\"\\\"Wait for debounce period then analyze\\\"\\\"\\\"\\n        await asyncio.sleep(settings.debounce_ms / 1000.0)\\n        diagnostics = await self.analyze_document(uri, text)\\n        # pyrefly: ignore [missing-attribute]\\n        self.publish_diagnostics(uri, diagnostics)\\n        logfire.debug(f\\\"Published {len(diagnostics)} diagnostics for {uri}\\\")\\n\\n    async def analyze_document(self, uri: str, text: str) -> list[Diagnostic]:\\n        # Ensure we have a lock for this URI\\n        lock = self._analysis_locks.setdefault(uri, asyncio.Lock())\\n        async with lock:\\n            with logfire.span(\\\"analyze_document\\\", uri=uri):\\n                logfire.info(f\\\"Starting AI analysis for {uri}\\\")\\n\\n                try:\\n                    file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n                    language = self._detect_language(file_path)\\n\\n                    prompt = f\\\"\\\"\\\"Analyze this {language} code for issues:\\n\\n```{language}\\n{text}\\n```\\n\\nFile: {file_path.name}\\\"\\\"\\\"\\n\\n                    result = await self.agent.run(prompt)\\n                    logfire.info(\\n                        f\\\"AI analysis completed, found {len(result.output.issues)} issues\\\"\\n                    )\\n\\n                    diagnostics = []\\n                    for issue in result.output.issues:\\n                        positions = self.find_snippet_in_text(text, issue.issue_snippet)\\n\\n                        if positions:\\n                            start_line, start_col, end_line, end_col = positions[0]\\n                            diagnostic = Diagnostic(\\n                                range=Range(\\n                                    start=Position(\\n                                        line=start_line, character=start_col\\n                                    ),\\n                                    end=Position(line=end_line, character=end_col),\\n                                ),\\n                                message=f\\\"AI LSP: {issue.message}\\\",\\n                                severity=self._get_diagnostic_severity(issue.severity),\\n                                source=\\\"ai-lsp\\\",\\n                                data={\\n                                    \\\"issue_snippet\\\": issue.issue_snippet,\\n                                    \\\"suggested_fixes\\\": [\\n                                        {\\n                                            \\\"title\\\": fix.title,\\n                                            \\\"target_snippet\\\": fix.target_snippet,\\n                                            \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                        }\\n                                        for fix in (issue.suggested_fixes or [])\\n                                    ],\\n                                },\\n                            )\\n                            diagnostics.append(diagnostic)\\n\\n                    return diagnostics\\n\\n                except Exception as e:\\n                    logfire.error(\\n                        f\\\"AI analysis failed for {uri}: {str(e)}\\\", _exc_info=True\\n                    )\\n                    return []\\n\\n    def _get_diagnostic_severity(self, severity: str) -> DiagnosticSeverity:\\n        match severity:\\n            case \\\"error\\\":\\n                return DiagnosticSeverity.Error\\n            case \\\"warning\\\":\\n                return DiagnosticSeverity.Warning\\n            case \\\"info\\\":\\n                return DiagnosticSeverity.Information\\n            case \\\"hint\\\":\\n                return DiagnosticSeverity.Hint\\n            case _:\\n                return DiagnosticSeverity.Information\\n\\n    def _detect_language(self, file_path: Path) -> str:\\n        match file_path.suffix:\\n            case \\\".py\\\":\\n                return \\\"python\\\"\\n            case \\\".js\\\":\\n                return \\\"javascript\\\"\\n            case \\\".ts\\\":\\n                return \\\"typescript\\\"\\n            case \\\".jsx\\\":\\n                return \\\"jsx\\\"\\n            case \\\".tsx\\\":\\n                return \\\"tsx\\\"\\n            case \\\".rs\\\":\\n                return \\\"rust\\\"\\n            case \\\".go\\\":\\n                return \\\"go\\\"\\n            case \\\".java\\\":\\n                return \\\"java\\\"\\n            case \\\".cpp\\\":\\n                return \\\"cpp\\\"\\n            case \\\".c\\\":\\n                return \\\"c\\\"\\n            case \\\".lua\\\":\\n                return \\\"lua\\\"\\n            case _:\\n                return \\\"text\\\"\\n\\n\\nserver = AILanguageServer()\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_OPEN)\\nasync def did_open(params: DidOpenTextDocumentParams):\\n    logfire.info(f\\\"Document opened: {params.text_document.uri}\\\")\\n    doc = params.text_document\\n    await server.debounced_analyze(doc.uri, doc.text)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_SAVE)\\nasync def did_save(params: DidSaveTextDocumentParams):\\n    logfire.info(f\\\"Document saved: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(TEXT_DOCUMENT_DID_CHANGE)\\nasync def did_change(params: DidChangeTextDocumentParams):\\n    logfire.debug(f\\\"Document changed: {params.text_document.uri}\\\")\\n    doc = server.workspace.get_text_document(params.text_document.uri)\\n    await server.debounced_analyze(doc.uri, doc.source)\\n\\n\\n@server.feature(\\n    TEXT_DOCUMENT_CODE_ACTION,\\n    CodeActionOptions(code_action_kinds=[CodeActionKind.QuickFix]),\\n)\\nasync def code_actions(params: CodeActionParams) -> list[CodeAction]:\\n    with logfire.span(\\\"code_actions\\\", uri=params.text_document.uri):\\n        actions: list[CodeAction] = []\\n        uri = params.text_document.uri\\n        doc = server.workspace.get_text_document(uri)\\n\\n        for diagnostic in params.context.diagnostics:\\n            if diagnostic.source != \\\"ai-lsp\\\" or not diagnostic.data:\\n                continue\\n\\n            suggested_fixes = diagnostic.data.get(\\\"suggested_fixes\\\", [])\\n\\n            for fix_data in suggested_fixes:\\n                target_positions = server.find_snippet_in_text(\\n                    doc.source, fix_data[\\\"target_snippet\\\"]\\n                )\\n\\n                if target_positions:\\n                    with logfire.span(\\\"creating_quick_fix\\\", title=fix_data[\\\"title\\\"]):\\n                        start_line, start_col, end_line, end_col = target_positions[0]\\n                        fix_range = Range(\\n                            start=Position(line=start_line, character=start_col),\\n                            end=Position(line=end_line, character=end_col),\\n                        )\\n\\n                        edit = WorkspaceEdit(\\n                            changes={\\n                                uri: [\\n                                    TextEdit(\\n                                        range=fix_range,\\n                                        new_text=fix_data[\\\"replacement_snippet\\\"],\\n                                    )\\n                                ]\\n                            }\\n                        )\\n\\n                        action = CodeAction(\\n                            title=f\\\"Apply: {fix_data['title']}\\\",\\n                            kind=CodeActionKind.QuickFix,\\n                            edit=edit,\\n                            diagnostics=[diagnostic],\\n                            is_preferred=True,\\n                        )\\n                        actions.append(action)\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Regenerate AI fix\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Regenerate fix\\\",\\n                        command=\\\"ai-lsp.regenerateFix\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.data.get(\\\"issue_snippet\\\"),\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n            actions.append(\\n                CodeAction(\\n                    title=\\\"Dismiss AI suggestion\\\",\\n                    kind=CodeActionKind.QuickFix,\\n                    command=Command(\\n                        title=\\\"Dismiss\\\",\\n                        command=\\\"ai-lsp.dismiss\\\",\\n                        arguments=[\\n                            uri,\\n                            diagnostic.range.start.line,\\n                            diagnostic.range.start.character,\\n                        ],\\n                    ),\\n                    diagnostics=[diagnostic],\\n                )\\n            )\\n\\n        return actions\\n\\n\\n@server.command(\\\"ai-lsp.regenerateFix\\\")\\nasync def regenerate_fix(*args):\\n    if len(args) < 4:\\n        return\\n\\n    uri, issue_snippet, line, character = args[0], args[1], args[2], args[3]\\n\\n    with logfire.span(\\\"regenerate_fix\\\", uri=uri, issue_snippet=issue_snippet):\\n        logfire.info(\\n            f\\\"Regenerating fix for '{issue_snippet}' at {uri}:{line}:{character}\\\"\\n        )\\n\\n        doc = server.workspace.get_text_document(uri)\\n        file_path = Path(uri.replace(\\\"file://\\\", \\\"\\\"))\\n        language = server._detect_language(file_path)\\n\\n        prompt = f\\\"\\\"\\\"Analyze this specific code issue and provide NEW suggested fixes.\\n\\nIssue snippet: {issue_snippet}\\n\\nFull code context:\\n```{language}\\n{doc.source}\\n```\\n\\nFile: {file_path.name}\\n\\nFocus ONLY on the issue at the snippet shown. Provide fresh, alternative fixes if possible.\\\"\\\"\\\"\\n\\n        try:\\n            result = await server.agent.run(prompt)\\n\\n            if not result.output.issues:\\n                logfire.warn(\\\"No issues returned for regeneration\\\")\\n                return\\n\\n            regenerated_issue = result.output.issues[0]\\n\\n            current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n            updated_diags = []\\n\\n            for diag in current_diags:\\n                if (\\n                    diag.source == \\\"ai-lsp\\\"\\n                    and diag.range.start.line == line\\n                    and diag.range.start.character == character\\n                ):\\n                    positions = server.find_snippet_in_text(\\n                        doc.source, regenerated_issue.issue_snippet\\n                    )\\n                    if positions:\\n                        start_line, start_col, end_line, end_col = positions[0]\\n                        updated_diag = Diagnostic(\\n                            range=Range(\\n                                start=Position(line=start_line, character=start_col),\\n                                end=Position(line=end_line, character=end_col),\\n                            ),\\n                            message=f\\\"AI LSP: {regenerated_issue.message}\\\",\\n                            severity=server._get_diagnostic_severity(\\n                                regenerated_issue.severity\\n                            ),\\n                            source=\\\"ai-lsp\\\",\\n                            data={\\n                                \\\"issue_snippet\\\": regenerated_issue.issue_snippet,\\n                                \\\"suggested_fixes\\\": [\\n                                    {\\n                                        \\\"title\\\": fix.title,\\n                                        \\\"target_snippet\\\": fix.target_snippet,\\n                                        \\\"replacement_snippet\\\": fix.replacement_snippet,\\n                                    }\\n                                    for fix in (regenerated_issue.suggested_fixes or [])\\n                                ],\\n                            },\\n                        )\\n                        updated_diags.append(updated_diag)\\n                        logfire.info(\\n                            f\\\"Regenerated diagnostic with {len(regenerated_issue.suggested_fixes or [])} new fixes\\\"\\n                        )\\n                else:\\n                    updated_diags.append(diag)\\n\\n            server.publish_diagnostics(uri, updated_diags)\\n\\n        except Exception as e:\\n            logfire.error(f\\\"Failed to regenerate fix: {str(e)}\\\", _exc_info=True)\\n\\n\\n@server.command(\\\"ai-lsp.dismiss\\\")\\ndef dismiss_suggestion(*args):\\n    if len(args) < 3:\\n        return\\n\\n    uri, line, character = args[0], args[1], args[2]\\n\\n    with logfire.span(\\\"dismiss_suggestion\\\", uri=uri, line=line, character=character):\\n        logfire.info(f\\\"Dismissing suggestion at {uri}:{line}:{character}\\\")\\n\\n        doc = server.workspace.get_text_document(uri)\\n        diagnostics = []\\n\\n        current_diags = getattr(server.lsp, \\\"diagnostics\\\", {}).get(uri, [])\\n        for diag in current_diags:\\n            if (\\n                diag.source == \\\"ai-lsp\\\"\\n                and diag.range.start.line == line\\n                and diag.range.start.character == character\\n            ):\\n                continue\\n            diagnostics.append(diag)\\n\\n        server.publish_diagnostics(uri, diagnostics)\\n\\n\\ndef app():\\n    server.start_io()\\n\\n\\nif __name__ == \\\"__main__\\\":\\n    app()\\n\\n```\\n\\nFile: main.py\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}, {\"role\": \"assistant\", \"tool_calls\": [{\"id\": \"pyd_ai_5e40d40a737047b5a62b48ad02faf511\", \"type\": \"function\", \"function\": {\"name\": \"final_result\", \"arguments\": {\"issues\": [{\"severity\": \"warning\", \"message\": \"The `find_snippet_in_text` function strips leading and trailing whitespace from the provided snippet before searching. If the AI provides an `issue_snippet` or `target_snippet` that intentionally includes specific whitespace (e.g., indentation or leading/trailing spaces as part of the match), this stripping could lead to a failure to locate the snippet or an incorrect match. This may result in diagnostics or code actions not being applied as intended. It's generally safer to search for the exact snippet provided by the AI without modification.\", \"suggested_fixes\": [{\"target_snippet\": \"snippet.strip()\", \"replacement_snippet\": \"snippet\", \"title\": \"Remove snippet stripping\"}], \"issue_snippet\": \"snippet.strip()\"}, {\"message\": \"The `analyze_document`, `code_actions`, and `regenerate_fix` functions consistently use `positions[0]` from `find_snippet_in_text`. This means that if an `issue_snippet` or `target_snippet` (as provided by the AI) appears multiple times in the document, diagnostics and code actions will always be applied to the *first* occurrence found. This is an architectural limitation because the AI's current output format lacks the explicit range information needed to pinpoint a specific instance of a repeated code pattern, potentially leading to confusing diagnostics and incorrect application of fixes.\", \"severity\": \"error\", \"issue_snippet\": \"positions[0]\"}, {\"message\": \"The `max_cache_size` setting is defined in the `Settings` class but is not referenced or utilized anywhere within the provided `AILanguageServer` implementation. This indicates a potentially unimplemented feature, a forgotten setting, or dead code. It's good practice to either implement the associated caching logic (e.g., for `_pending_tasks` or `analyze_document` results) or remove the setting to avoid confusion and maintain a clean configuration.\", \"suggested_fixes\": [{\"replacement_snippet\": \"# max_cache_size: int = Field(default=50) # Setting currently unused.\", \"target_snippet\": \"max_cache_size: int = Field(default=50)\", \"title\": \"Remove unused setting\"}], \"severity\": \"info\", \"issue_snippet\": \"max_cache_size\"}, {\"message\": \"When regenerating a fix, the `regenerate_fix` command sends the entire document's content (`doc.source`) to the AI for analysis. While providing full context can be beneficial, for a focused regeneration of a specific snippet, sending the full file can be inefficient (higher token usage, slower response) and raises data privacy concerns if the code contains sensitive information. It would be more efficient and privacy-preserving to send only a contextual window of code around the problematic snippet instead of the entire document.\", \"issue_snippet\": \"doc.source\", \"severity\": \"warning\"}, {\"suggested_fixes\": [{\"replacement_snippet\": \"# To ensure OpenTelemetry components pick up the endpoint consistently,\\n# this line should ideally be moved to the very top of the file,\\n# before any imports that initialize tracing or logging libraries.\\nos.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\", \"title\": \"Suggest moving environment variable setting for early initialization\", \"target_snippet\": \"os.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\"}], \"issue_snippet\": \"os.environ[\\\"OTEL_EXPORTER_OTLP_ENDPOINT\\\"] = settings.otel_exporter_otlp_endpoint\", \"message\": \"The environment variable `OTEL_EXPORTER_OTLP_ENDPOINT` is set using `os.environ` after `logfire` has already been imported. While `logfire.configure` is called later, some underlying OpenTelemetry components might read environment variables during initial import. To guarantee that all parts of the tracing system correctly pick up the endpoint, it is best practice to set this environment variable at the very top of the script or externally, before any modules that rely on it are imported or initialized.\", \"severity\": \"warning\"}]}}}], \"gen_ai.message.index\": 1, \"event.name\": \"gen_ai.assistant.message\"}, {\"content\": \"Final result processed.\", \"role\": \"tool\", \"id\": \"pyd_ai_5e40d40a737047b5a62b48ad02faf511\", \"name\": \"final_result\", \"gen_ai.message.index\": 2, \"event.name\": \"gen_ai.tool.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]},{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a7990b4887589dc76e2c292c3a523","spanId":"96d9f6b0f21f29c0","parentSpanId":"a267ec6c991a8868","flags":256,"name":"AI analysis completed, found {len(result.output.issues)} issues","kind":1,"startTimeUnixNano":"1762976182617855000","endTimeUnixNano":"1762976182617855000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI analysis completed, found {len(result.output.issues)} issues"}},{"key":"logfire.msg","value":{"stringValue":"AI analysis completed, found 5 issues"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"203"}},{"key":"len(result.output.issues)","value":{"intValue":"5"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(result.output.issues)\":{}}}"}}],"status":{}},{"traceId":"019a7990b4887589dc76e2c292c3a523","spanId":"979e46ec775c8caf","parentSpanId":"a267ec6c991a8868","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762976182619675000","endTimeUnixNano":"1762976182619675000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of 'snippet.strip()...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"snippet.strip()"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7990b4887589dc76e2c292c3a523","spanId":"00baa4605b96f951","parentSpanId":"a267ec6c991a8868","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762976182620085000","endTimeUnixNano":"1762976182620085000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 3 occurrences of 'positions[0]...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"3"}},{"key":"snippet[:20]","value":{"stringValue":"positions[0]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7990b4887589dc76e2c292c3a523","spanId":"a98fcfdb500e6e6d","parentSpanId":"a267ec6c991a8868","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762976182620267000","endTimeUnixNano":"1762976182620267000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of 'max_cache_size...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"max_cache_size"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7990b4887589dc76e2c292c3a523","spanId":"848050cc160ef8e1","parentSpanId":"a267ec6c991a8868","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762976182620543000","endTimeUnixNano":"1762976182620543000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 5 occurrences of 'doc.source...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"5"}},{"key":"snippet[:20]","value":{"stringValue":"doc.source"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7990b4887589dc76e2c292c3a523","spanId":"6b4331aed5f31833","parentSpanId":"a267ec6c991a8868","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762976182620696000","endTimeUnixNano":"1762976182620696000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of 'os.environ[\"OTEL_EXP...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"os.environ[\"OTEL_EXP"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7990b4887589dc76e2c292c3a523","spanId":"a267ec6c991a8868","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976117896709000","endTimeUnixNano":"1762976182620803000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a7991b1605d965ac3adc536fde864","spanId":"85a94b70ec8a3b14","flags":256,"name":"Published {len(diagnostics)} diagnostics for {uri}","kind":1,"startTimeUnixNano":"1762976182624050000","endTimeUnixNano":"1762976182624050000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Published {len(diagnostics)} diagnostics for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Published 5 diagnostics for file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer._delayed_analyze"}},{"key":"code.lineno","value":{"intValue":"181"}},{"key":"len(diagnostics)","value":{"intValue":"5"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(diagnostics)\":{},\"uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c511d8c928e741c8b6e3305bc85905a5"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"61044"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a7991e5f35cc72273ee833946fdee","spanId":"19c3fdc57ea64486","flags":256,"name":"Initializing AI Language Server","kind":1,"startTimeUnixNano":"1762976196083865000","endTimeUnixNano":"1762976196083865000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Initializing AI Language Server"}},{"key":"logfire.msg","value":{"stringValue":"Initializing AI Language Server"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"77"}}],"status":{}},{"traceId":"019a7991e743dc406d3686c905500a24","spanId":"f3267dd98b43704a","flags":256,"name":"AI agent initialized successfully","kind":1,"startTimeUnixNano":"1762976196419340000","endTimeUnixNano":"1762976196419340000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI agent initialized successfully"}},{"key":"logfire.msg","value":{"stringValue":"AI agent initialized successfully"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"115"}}],"status":{}},{"traceId":"019a7991e75518fdc0297dd24a4a0f6d","spanId":"9204c95404044369","flags":256,"name":"Document opened: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976196437950000","endTimeUnixNano":"1762976196437950000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document opened: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document opened: file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_open"}},{"key":"code.lineno","value":{"intValue":"291"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7991eb4061f8488d91e4acf1acb5","spanId":"deaeae4cb2af0f72","parentSpanId":"1a19f18d8cf91da9","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976197440799000","endTimeUnixNano":"1762976197440799000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c511d8c928e741c8b6e3305bc85905a5"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"61044"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a7991eb4061f8488d91e4acf1acb5","spanId":"7a88a484e66142da","parentSpanId":"49d5ac67b955f87b","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976197441761000","endTimeUnixNano":"1762976218607678000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.usage.input_tokens","value":{"intValue":"9365"}},{"key":"gen_ai.usage.output_tokens","value":{"intValue":"1148"}},{"key":"gen_ai.usage.details.thoughts_tokens","value":{"intValue":"2348"}},{"key":"gen_ai.usage.details.text_prompt_tokens","value":{"intValue":"9365"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.system\": \"google-gla\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\n-- uv.nvim - Neovim plugin for uv Python package management integration\\n-- Author: Ben O'Mahony\\n-- License: MIT\\n\\nlocal M = {}\\n\\n-- Default configuration\\nM.config = {\\n\\t-- Auto-activate virtual environments when found\\n\\tauto_activate_venv = true,\\n\\tnotify_activate_venv = true,\\n\\n\\t-- Auto commands for directory changes\\n\\tauto_commands = true,\\n\\n\\t-- Integration with picker (like Telescope or other UI components)\\n\\tpicker_integration = true,\\n\\n\\t-- Keymaps to register (set to false to disable)\\n\\tkeymaps = {\\n\\t\\tprefix = \\\"<leader>x\\\", -- Main prefix for UV commands\\n\\t\\tcommands = true, -- Show UV commands menu (<leader>x)\\n\\t\\trun_file = true, -- Run current file (<leader>xr)\\n\\t\\trun_selection = true, -- Run selection (<leader>xs)\\n\\t\\trun_function = true, -- Run function (<leader>xf)\\n\\t\\tvenv = true, -- Environment management (<leader>xe)\\n\\t\\tinit = true, -- Initialize UV project (<leader>xi)\\n\\t\\tadd = true, -- Add a package (<leader>xa)\\n\\t\\tremove = true, -- Remove a package (<leader>xd)\\n\\t\\tsync = true, -- Sync packages (<leader>xc)\\n\\t\\tsync_all = true, -- uv sync --all-extras --all-groups --all-packages (<leader>xC)\\n\\t},\\n\\n\\t-- Execution options\\n\\texecution = {\\n\\t\\t-- Python run command template\\n\\t\\trun_command = \\\"uv run python\\\",\\n\\n\\t\\t-- Show output in notifications\\n\\t\\tnotify_output = true,\\n\\n\\t\\t-- Notification timeout in ms\\n\\t\\tnotification_timeout = 10000,\\n\\t},\\n}\\n\\n-- Command runner - runs shell commands and captures output\\nfunction M.run_command(cmd)\\n\\t-- Run command in background and capture output\\n\\tvim.fn.jobstart(cmd, {\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Command completed successfully: \\\" .. cmd, vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Command failed: \\\" .. cmd, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Only show meaningful output (not empty lines)\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Show errors\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.WARN)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Virtual environment activation\\nfunction M.activate_venv(venv_path)\\n\\t-- For Mac, run the source command to apply to the current shell\\n\\tlocal command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n\\t-- Set environment variables for the current Neovim instance\\n\\tvim.env.VIRTUAL_ENV = venv_path\\n\\tvim.env.PATH = venv_path .. \\\"/bin:\\\" .. vim.env.PATH\\n\\t-- Notify user\\n\\tif M.config.notify_activate_venv then\\n\\t\\tvim.notify(\\\"Activated virtual environment: \\\" .. venv_path, vim.log.levels.INFO)\\n\\tend\\nend\\n\\n-- Auto-activate the .venv if it exists at the project root\\nfunction M.auto_activate_venv()\\n\\tlocal venv_path = vim.fn.getcwd() .. \\\"/.venv\\\"\\n\\tif vim.fn.isdirectory(venv_path) == 1 then\\n\\t\\tM.activate_venv(venv_path)\\n\\t\\treturn true\\n\\tend\\n\\treturn false\\nend\\n\\n-- Function to create a temporary file with the necessary context and selected code\\nfunction M.run_python_selection()\\n\\t-- Get visual selection\\n\\tlocal get_visual_selection = function()\\n\\t\\tlocal start_pos = vim.fn.getpos(\\\"'<\\\")\\n\\t\\tlocal end_pos = vim.fn.getpos(\\\"'>\\\")\\n\\t\\tlocal lines = vim.fn.getline(start_pos[2], end_pos[2])\\n\\n\\t\\tif #lines == 0 then\\n\\t\\t\\treturn \\\"\\\"\\n\\t\\tend\\n\\n\\t\\t-- Adjust last line to end at the column position of end_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[#lines] = lines[#lines]:sub(1, end_pos[3])\\n\\t\\tend\\n\\n\\t\\t-- Adjust first line to start at the column position of start_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[1] = lines[1]:sub(start_pos[3])\\n\\t\\tend\\n\\n\\t\\treturn table.concat(lines, \\\"\\\\n\\\")\\n\\tend\\n\\n\\t-- Get current buffer content to extract imports and global variables\\n\\tlocal get_buffer_globals = function()\\n\\t\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\t\\tlocal imports = {}\\n\\t\\tlocal globals = {}\\n\\t\\tlocal in_class = false\\n\\t\\tlocal class_indent = 0\\n\\n\\t\\tfor _, line in ipairs(lines) do\\n\\t\\t\\t-- Detect imports\\n\\t\\t\\tif line:match(\\\"^%s*import \\\") or line:match(\\\"^%s*from .+ import\\\") then\\n\\t\\t\\t\\ttable.insert(imports, line)\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect class definitions to skip class variables\\n\\t\\t\\tif line:match(\\\"^%s*class \\\") then\\n\\t\\t\\t\\tin_class = true\\n\\t\\t\\t\\tclass_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Check if we're exiting a class block\\n\\t\\t\\tif in_class and line:match(\\\"^%s*[^%s#]\\\") then\\n\\t\\t\\t\\tlocal current_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\t\\tif current_indent <= class_indent then\\n\\t\\t\\t\\t\\tin_class = false\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect global variable assignments (not in class, not inside functions)\\n\\t\\t\\tif not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\\n\\t\\t\\t\\t-- Check if it's not indented (global scope)\\n\\t\\t\\t\\tif not line:match(\\\"^%s%s+\\\") then\\n\\t\\t\\t\\t\\ttable.insert(globals, line)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend\\n\\n\\t\\treturn imports, globals\\n\\tend\\n\\n\\t-- Get selected code\\n\\tlocal selection = get_visual_selection()\\n\\tif selection == \\\"\\\" then\\n\\t\\tvim.notify(\\\"No code selected\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Get imports and globals\\n\\tlocal imports, globals = get_buffer_globals()\\n\\n\\t-- Create temp file\\n\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\tlocal temp_file = temp_dir .. \\\"/run_selection.py\\\"\\n\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\tif not file then\\n\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Write imports\\n\\tfor _, imp in ipairs(imports) do\\n\\t\\tfile:write(imp .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write globals\\n\\tfor _, glob in ipairs(globals) do\\n\\t\\tfile:write(glob .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write selected code\\n\\tfile:write(\\\"# SELECTED CODE\\\\n\\\")\\n\\n\\t-- Check if the selection is all indented (which would cause syntax errors)\\n\\tlocal is_all_indented = true\\n\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tif not line:match(\\\"^%s+\\\") and line ~= \\\"\\\" then\\n\\t\\t\\tis_all_indented = false\\n\\t\\t\\tbreak\\n\\t\\tend\\n\\tend\\n\\n\\t-- Process the selection to determine what type of code it is\\n\\tlocal is_function_def = selection:match(\\\"^%s*def%s+[%w_]+%s*%(\\\")\\n\\tlocal is_class_def = selection:match(\\\"^%s*class%s+[%w_]+\\\")\\n\\tlocal has_print = selection:match(\\\"print%s*%(\\\")\\n\\tlocal is_expression = not is_function_def\\n\\t\\tand not is_class_def\\n\\t\\tand not selection:match(\\\"=\\\")\\n\\t\\tand not selection:match(\\\"%s*for%s+\\\")\\n\\t\\tand not selection:match(\\\"%s*if%s+\\\")\\n\\t\\tand not has_print\\n\\n\\t-- If the selection is all indented, we need to dedent it or wrap it in a function\\n\\tif is_all_indented then\\n\\t\\tfile:write(\\\"def run_selection():\\\\n\\\")\\n\\t\\t-- Write the selection with original indentation\\n\\t\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\t\\tfile:write(\\\"    \\\" .. line .. \\\"\\\\n\\\")\\n\\t\\tend\\n\\t\\tfile:write(\\\"\\\\n# Auto-call the wrapper function\\\\n\\\")\\n\\t\\tfile:write(\\\"run_selection()\\\\n\\\")\\n\\telse\\n\\t\\t-- Write the original selection\\n\\t\\tfile:write(selection .. \\\"\\\\n\\\")\\n\\n\\t\\t-- For expressions, we'll add a print statement to see the result\\n\\t\\tif is_expression then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added print for expression\\\\n\\\")\\n\\t\\t\\tfile:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\\n\\t\\t-- For function definitions without calls, we'll add a call\\n\\t\\telseif is_function_def then\\n\\t\\t\\tlocal function_name = selection:match(\\\"def%s+([%w_]+)%s*%(\\\")\\n\\t\\t\\t-- Check if the function is already called in the selection\\n\\t\\t\\tif function_name and not selection:match(function_name .. \\\"%s*%(.-%)\\\") then\\n\\t\\t\\t\\tfile:write(\\\"\\\\n# Auto-added function call\\\\n\\\")\\n\\t\\t\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\t\\t\\tfile:write('    print(f\\\"Auto-executing function: ' .. function_name .. '\\\")\\\\n')\\n\\t\\t\\t\\tfile:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\\n\\t\\t\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\t\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\t\\tend\\n\\t\\t-- If there's no print statement in the code, add an output marker\\n\\t\\telseif not has_print and not selection:match(\\\"^%s*#\\\") then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added execution marker\\\\n\\\")\\n\\t\\t\\tfile:write('print(\\\"Code executed successfully.\\\")\\\\n')\\n\\t\\tend\\n\\tend\\n\\n\\tfile:close()\\n\\n\\t-- Run the temp file\\n\\tvim.notify(\\\"Running selected code...\\\", vim.log.levels.INFO)\\n\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Selected code executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Selected code execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Function to run a specific Python function\\nfunction M.run_python_function()\\n\\t-- Get current buffer content\\n\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\tlocal buffer_content = table.concat(lines, \\\"\\\\n\\\")\\n\\n\\t-- Find all function definitions\\n\\tlocal functions = {}\\n\\tfor line in buffer_content:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tlocal func_name = line:match(\\\"^def%s+([%w_]+)%s*%(\\\")\\n\\t\\tif func_name then\\n\\t\\t\\ttable.insert(functions, func_name)\\n\\t\\tend\\n\\tend\\n\\n\\tif #functions == 0 then\\n\\t\\tvim.notify(\\\"No functions found in current file\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Create temp file for function selection picker\\n\\tlocal run_function = function(func_name)\\n\\t\\t-- Create a temporary file with a main block to call the function\\n\\t\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\t\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\t\\tlocal temp_file = temp_dir .. \\\"/run_function.py\\\"\\n\\t\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\n\\t\\t-- Create a wrapper script that imports the current file and calls the function\\n\\t\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\t\\tif not file then\\n\\t\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\t\\treturn\\n\\t\\tend\\n\\n\\t\\t-- Get the module name (file name without .py)\\n\\t\\tlocal module_name = vim.fn.fnamemodify(current_file, \\\":t:r\\\")\\n\\t\\tlocal module_dir = vim.fn.fnamemodify(current_file, \\\":h\\\")\\n\\n\\t\\t-- Write imports\\n\\t\\tfile:write(\\\"import sys\\\\n\\\")\\n\\t\\tfile:write(\\\"sys.path.insert(0, \\\" .. vim.inspect(module_dir) .. \\\")\\\\n\\\")\\n\\t\\tfile:write(\\\"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\")\\n\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\tfile:write('    print(f\\\"Running function: ' .. func_name .. '\\\")\\\\n')\\n\\t\\tfile:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\\n\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\tfile:close()\\n\\n\\t\\t-- Run the temp file\\n\\t\\tvim.notify(\\\"Running function: \\\" .. func_name, vim.log.levels.INFO)\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\tend\\n\\n\\t-- If there's only one function, run it directly\\n\\tif #functions == 1 then\\n\\t\\trun_function(functions[1])\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Otherwise, show a picker to select the function\\n\\tvim.ui.select(functions, {\\n\\t\\tprompt = \\\"Select function to run:\\\",\\n\\t\\tformat_item = function(item)\\n\\t\\t\\treturn \\\"def \\\" .. item .. \\\"()\\\"\\n\\t\\tend,\\n\\t}, function(choice)\\n\\t\\tif choice then\\n\\t\\t\\trun_function(choice)\\n\\t\\tend\\n\\tend)\\nend\\n\\n-- Run current file\\nfunction M.run_file()\\n\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\tif current_file and current_file ~= \\\"\\\" then\\n\\t\\tvim.notify(\\\"Running: \\\" .. vim.fn.expand(\\\"%:t\\\"), vim.log.levels.INFO)\\n\\t\\t-- Run python on the current file and capture output to notifications\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(current_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution completed successfully\\\", vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\telse\\n\\t\\tvim.notify(\\\"No file is open\\\", vim.log.levels.WARN)\\n\\tend\\nend\\n\\n-- Set up command pickers for integration with UI plugins\\nfunction M.setup_pickers()\\n\\t-- Check if Snacks is available\\n\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t-- Register UV command source\\n\\t\\tSnacks.picker.sources.uv_commands = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t{ text = \\\"Run current file\\\", desc = \\\"Run current file with Python\\\", is_run_current = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run selection\\\", desc = \\\"Run selected Python code\\\", is_run_selection = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run function\\\", desc = \\\"Run specific Python function\\\", is_run_function = true },\\n\\t\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", desc = \\\"Install a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv sync\\\", desc = \\\"Sync packages from lockfile\\\" },\\n\\t\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\t\\tdesc = \\\"Sync all extras, groups and packages\\\",\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", desc = \\\"Remove a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv init\\\", desc = \\\"Initialize a new project\\\" },\\n\\t\\t\\t\\t}\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\treturn { { item.text .. \\\" - \\\" .. item.desc } }\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\t\\tif item.is_run_current then\\n\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_selection then\\n\\t\\t\\t\\t\\t\\t-- Check if there's a visual selection\\n\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\n\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\") -- Exit visual mode\\n\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t-- If not in visual mode, prompt the user to select text\\n\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t-- After notification, we'll set up a one-time autocmd to catch when visual mode is exited\\n\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\", -- When changing from any visual mode to normal mode\\n\\t\\t\\t\\t\\t\\t\\t\\tcallback = function(ev)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true -- Delete the autocmd after it's been triggered\\n\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_function then\\n\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\tlocal cmd = item.text\\n\\t\\t\\t\\t\\t-- Check if command needs input\\n\\t\\t\\t\\t\\tif cmd:match(\\\"%[(.-)%]\\\") then\\n\\t\\t\\t\\t\\t\\tlocal param_name = cmd:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\tvim.ui.input({ prompt = \\\"Enter \\\" .. param_name .. \\\": \\\" }, function(input)\\n\\t\\t\\t\\t\\t\\t\\tif not input or input == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t-- Replace the placeholder with actual input\\n\\t\\t\\t\\t\\t\\t\\tlocal actual_cmd = cmd:gsub(\\\"%[\\\" .. param_name .. \\\"%]\\\", input)\\n\\t\\t\\t\\t\\t\\t\\tM.run_command(actual_cmd)\\n\\t\\t\\t\\t\\t\\tend)\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t-- Run the command directly\\n\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\n\\t\\t-- Register UV venv source\\n\\t\\tSnacks.picker.sources.uv_venv = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\tlocal venvs = {}\\n\\t\\t\\t\\t-- Check for .venv directory (uv's default)\\n\\t\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\tif #venvs == 0 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\"Create new virtual environment (uv venv)\\\",\\n\\t\\t\\t\\t\\t\\tis_create = true,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\treturn venvs\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\treturn { { \\\"+ \\\" .. item.text } }\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tlocal icon = item.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\"\\n\\t\\t\\t\\t\\treturn { { icon .. item.text .. \\\" (Activate)\\\" } }\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\tM.activate_venv(item.path)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\tend\\n\\n\\t-- Check if Telescope is available\\n\\tlocal has_telescope, telescope = pcall(require, \\\"telescope\\\")\\n\\tif has_telescope then\\n\\t\\tlocal pickers = require(\\\"telescope.pickers\\\")\\n\\t\\tlocal finders = require(\\\"telescope.finders\\\")\\n\\t\\tlocal sorters = require(\\\"telescope.sorters\\\")\\n\\t\\tlocal actions = require(\\\"telescope.actions\\\")\\n\\t\\tlocal action_state = require(\\\"telescope.actions.state\\\")\\n\\n\\t\\t-- UV Commands picker for Telescope\\n\\t\\tM.pick_uv_commands = function()\\n\\t\\t\\tlocal items = {\\n\\t\\t\\t\\t{ text = \\\"Run current file\\\", is_run_current = true },\\n\\t\\t\\t\\t{ text = \\\"Run selection\\\", is_run_selection = true },\\n\\t\\t\\t\\t{ text = \\\"Run function\\\", is_run_function = true },\\n\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", cmd = \\\"uv add \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv sync\\\", cmd = \\\"uv sync\\\" },\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\tcmd = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", cmd = \\\"uv remove \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv init\\\", cmd = \\\"uv init\\\" },\\n\\t\\t\\t}\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Commands\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_run_current then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_selection then\\n\\t\\t\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\t\\t\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_function then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tif selection.needs_input then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal placeholder = selection.text:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.ui.input(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t{ prompt = \\\"Enter \\\" .. (placeholder or \\\"value\\\") .. \\\": \\\" },\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfunction(input)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tif input and input ~= \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal cmd = selection.cmd .. input\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(selection.cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\n\\t\\t-- UV venv picker for Telescope\\n\\t\\tM.pick_uv_venv = function()\\n\\t\\t\\tlocal items = {}\\n\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\ttable.insert(items, {\\n\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t})\\n\\t\\t\\tend\\n\\t\\t\\tif #items == 0 then\\n\\t\\t\\t\\ttable.insert(items, { text = \\\"Create new virtual environment (uv venv)\\\", is_create = true })\\n\\t\\t\\tend\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Virtual Environments\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\tlocal display = entry.is_create and \\\"+ \\\" .. entry.text\\n\\t\\t\\t\\t\\t\\t\\t\\tor ((entry.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\") .. entry.text .. \\\" (Activate)\\\")\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = display,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = display,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_create then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tM.activate_venv(selection.path)\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Set up user commands\\nfunction M.setup_commands()\\n\\t-- Set up UV commands\\n\\tvim.api.nvim_create_user_command(\\\"UVInit\\\", function()\\n\\t\\tM.run_command(\\\"uv init\\\")\\n\\tend, {})\\n\\n\\t-- Command to run selected code\\n\\tvim.api.nvim_create_user_command(\\\"UVRunSelection\\\", function()\\n\\t\\tM.run_python_selection()\\n\\tend, { range = true })\\n\\n\\t-- Command to run a specific function\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFunction\\\", function()\\n\\t\\tM.run_python_function()\\n\\tend, {})\\n\\n\\t-- Command to run the current file\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFile\\\", function()\\n\\t\\tM.run_file()\\n\\tend, {})\\n\\n\\t-- Command to add a package\\n\\tvim.api.nvim_create_user_command(\\\"UVAddPackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv add \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\n\\n\\t-- Command to remove a package\\n\\tvim.api.nvim_create_user_command(\\\"UVRemovePackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv remove \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\nend\\n\\n-- Set up keymaps\\nfunction M.setup_keymaps()\\n\\tlocal keymaps = M.config.keymaps\\n\\tlocal prefix = keymaps.prefix or \\\"<leader>x\\\"\\n\\n\\t-- Main UV command menu\\n\\tif keymaps.commands then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Run current file\\n\\tif keymaps.run_file then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"r\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFile<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Current File\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run selection\\n\\tif keymaps.run_selection then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"v\\\",\\n\\t\\t\\tprefix .. \\\"s\\\",\\n\\t\\t\\t\\\":<C-u>UVRunSelection<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Selection\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run function\\n\\tif keymaps.run_function then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"f\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFunction<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Function\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Environment management\\n\\tif keymaps.venv then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_venv')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope_venv = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope_venv then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_venv()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Initialize UV project\\n\\tif keymaps.init then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"i\\\",\\n\\t\\t\\t\\\"<cmd>UVInit<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Init\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Add a package\\n\\tif keymaps.add then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"a\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv add ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Add Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Remove a package\\n\\tif keymaps.remove then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"d\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv remove ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Remove Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Sync packages\\n\\tif keymaps.sync then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"c\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync Packages\\\" }\\n\\t\\t)\\n\\tend\\n\\tif keymaps.sync_all then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"C\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync --all-extras --all-packages --all-groups')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync All Extras, Groups and Packages\\\" }\\n\\t\\t)\\n\\tend\\nend\\n\\n-- Set up auto commands\\nfunction M.setup_autocommands()\\n\\tif M.config.auto_commands then\\n\\t\\t-- Auto-activate .venv if it exists\\n\\t\\tif M.config.auto_activate_venv then\\n\\t\\t\\tM.auto_activate_venv()\\n\\n\\t\\t\\t-- Also set up auto-command to check when entering a directory\\n\\t\\t\\tvim.api.nvim_create_autocmd({ \\\"DirChanged\\\" }, {\\n\\t\\t\\t\\tpattern = { \\\"global\\\" },\\n\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\tM.auto_activate_venv()\\n\\t\\t\\t\\tend,\\n\\t\\t\\t})\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Main setup function\\nfunction M.setup(opts)\\n\\t-- Merge user configuration with defaults\\n\\tM.config = vim.tbl_deep_extend(\\\"force\\\", M.config, opts or {})\\n\\n\\t-- Set up commands\\n\\tM.setup_commands()\\n\\n\\t-- Set up keymaps if enabled\\n\\tif M.config.keymaps ~= false then\\n\\t\\tM.setup_keymaps()\\n\\tend\\n\\n\\t-- Set up autocommands if enabled\\n\\tif M.config.auto_commands ~= false then\\n\\t\\tM.setup_autocommands()\\n\\tend\\n\\n\\t-- Set up pickers if integration is enabled\\n\\tif M.config.picker_integration then\\n\\t\\tM.setup_pickers()\\n\\tend\\n\\n\\t-- Make run_command globally accessible (can be removed if not needed)\\n\\t_G.run_command = M.run_command\\nend\\n\\nreturn M\\n\\n```\\n\\nFile: init.lua\", \"role\": \"user\", \"gen_ai.system\": \"google-gla\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}, {\"index\": 0, \"message\": {\"role\": \"assistant\", \"tool_calls\": [{\"id\": \"pyd_ai_ad5034e3dc664109be4eaa9fffbcf8d3\", \"type\": \"function\", \"function\": {\"name\": \"final_result\", \"arguments\": {\"issues\": [{\"severity\": \"error\", \"message\": \"The 'source' command for activating the virtual environment is constructed but never actually executed. Manually setting VIRTUAL_ENV and PATH is an incomplete activation and will miss other environment variables or shell functions that the 'activate' script typically sets. This can lead to unexpected behavior or Python not finding correctly configured packages.\", \"suggested_fixes\": [{\"replacement_snippet\": \"local command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n-- This command needs to be run in the shell that Neovim itself runs in,\\n-- or its direct child process, which is complex. For Neovim's internal\\n-- environment, setting vim.env variables is the primary mechanism.\\n-- Consider if the 'source' command is truly necessary or achievable\\n-- given Neovim's job control model. If a full shell environment is needed,\\n-- it might require restarting Neovim within the activated shell or more advanced setup.\\n-- For most cases, setting VIRTUAL_ENV and PATH in vim.env is sufficient for Neovim's internal Python provider.\", \"target_snippet\": \"local command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\", \"title\": \"Execute the source command via a shell, if Neovim's environment can be directly influenced.\"}], \"issue_snippet\": \"source\"}, {\"issue_snippet\": \"get_buffer_globals\", \"suggested_fixes\": [{\"replacement_snippet\": \"get_buffer_globals = function() -- Consider using a more robust Python parser (if available via external tool) or adding a disclaimer about limitations.\", \"target_snippet\": \"get_buffer_globals = function()\", \"title\": \"Improve global variable detection or provide a disclaimer.\"}], \"message\": \"The `get_buffer_globals` function uses fragile heuristics (indentation-based string matching) to identify imports and global variables. This method may incorrectly classify or miss context (e.g., variables defined within top-level if/try blocks, or complex module structures), leading to runtime errors when the extracted selection is run in a temporary file without its full lexical scope.\", \"severity\": \"warning\"}, {\"issue_snippet\": \"function_name .. \\\"()\\\"\", \"severity\": \"warning\", \"message\": \"In `M.run_python_selection`, when auto-calling a detected function, it is invoked without any arguments (e.g., `my_function()`). This will cause a runtime error if the function requires mandatory arguments.\", \"suggested_fixes\": [{\"target_snippet\": \"file:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\", \"title\": \"Add a comment about the limitation or provide a mechanism for argument input.\", \"replacement_snippet\": \"file:write(\\\"    result = \\\" .. function_name .. \\\"() -- NOTE: Assumes no arguments or all arguments have defaults. May fail if mandatory args are missing.\\\\n\\\")\"}]}, {\"suggested_fixes\": [{\"replacement_snippet\": \"file:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"() -- This call assumes the function takes no arguments or all arguments have defaults. Consider adding a mechanism for user input for function arguments.\\\\n\\\")\", \"title\": \"Provide a mechanism to input function arguments.\", \"target_snippet\": \"file:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\"}], \"message\": \"In `M.run_python_function`, when calling a selected function, it is explicitly invoked without any arguments (e.g., `module.my_function()`). This is a critical limitation; if the Python function requires mandatory arguments, this will result in a runtime error, severely limiting the utility of running functions that aren't self-contained or have defaults.\", \"issue_snippet\": \"func_name .. \\\"()\\\"\", \"severity\": \"error\"}, {\"issue_snippet\": \"vim.api.nvim_set_keymap\", \"severity\": \"info\", \"message\": \"For the main UV command menu (`prefix`) and environment management (`prefix .. \\\"e\\\"`) keymaps, the code defines mappings for both Snacks and Telescope pickers if both are detected. The keymap defined last will always overwrite the previous one. This creates a 'last writer wins' scenario without explicit user preference, potentially leading to inconsistent behavior or a picker being unexpectedly overridden.\", \"suggested_fixes\": [{\"title\": \"Prioritize picker integration or allow user configuration.\", \"target_snippet\": \"if _G.Snacks and _G.Snacks.picker then\", \"replacement_snippet\": \"-- if M.config.use_snacks_picker and _G.Snacks and _G.Snacks.picker then\\nif _G.Snacks and _G.Snacks.picker then\"}, {\"target_snippet\": \"if has_telescope then\", \"replacement_snippet\": \"-- elseif M.config.use_telescope_picker and has_telescope then\\n-- Or: if not (_G.Snacks and _G.Snacks.picker) and has_telescope then (prioritize Snacks if both are present)\\nif has_telescope then\", \"title\": \"Prioritize picker integration or allow user configuration (example for Telescope).\"}]}]}}}]}, \"gen_ai.system\": \"google-gla\", \"event.name\": \"gen_ai.choice\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"events\": {\"type\": \"array\"}, \"model_request_parameters\": {\"type\": \"object\"}}}"}}],"status":{}},{"traceId":"019a7991eb4061f8488d91e4acf1acb5","spanId":"49d5ac67b955f87b","parentSpanId":"1a19f18d8cf91da9","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976197441303000","endTimeUnixNano":"1762976218627590000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"final_result","value":{"stringValue":"{\"issues\": [{\"issue_snippet\": \"source\", \"severity\": \"error\", \"message\": \"The 'source' command for activating the virtual environment is constructed but never actually executed. Manually setting VIRTUAL_ENV and PATH is an incomplete activation and will miss other environment variables or shell functions that the 'activate' script typically sets. This can lead to unexpected behavior or Python not finding correctly configured packages.\", \"suggested_fixes\": [{\"title\": \"Execute the source command via a shell, if Neovim's environment can be directly influenced.\", \"target_snippet\": \"local command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\", \"replacement_snippet\": \"local command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n-- This command needs to be run in the shell that Neovim itself runs in,\\n-- or its direct child process, which is complex. For Neovim's internal\\n-- environment, setting vim.env variables is the primary mechanism.\\n-- Consider if the 'source' command is truly necessary or achievable\\n-- given Neovim's job control model. If a full shell environment is needed,\\n-- it might require restarting Neovim within the activated shell or more advanced setup.\\n-- For most cases, setting VIRTUAL_ENV and PATH in vim.env is sufficient for Neovim's internal Python provider.\"}]}, {\"issue_snippet\": \"get_buffer_globals\", \"severity\": \"warning\", \"message\": \"The `get_buffer_globals` function uses fragile heuristics (indentation-based string matching) to identify imports and global variables. This method may incorrectly classify or miss context (e.g., variables defined within top-level if/try blocks, or complex module structures), leading to runtime errors when the extracted selection is run in a temporary file without its full lexical scope.\", \"suggested_fixes\": [{\"title\": \"Improve global variable detection or provide a disclaimer.\", \"target_snippet\": \"get_buffer_globals = function()\", \"replacement_snippet\": \"get_buffer_globals = function() -- Consider using a more robust Python parser (if available via external tool) or adding a disclaimer about limitations.\"}]}, {\"issue_snippet\": \"function_name .. \\\"()\\\"\", \"severity\": \"warning\", \"message\": \"In `M.run_python_selection`, when auto-calling a detected function, it is invoked without any arguments (e.g., `my_function()`). This will cause a runtime error if the function requires mandatory arguments.\", \"suggested_fixes\": [{\"title\": \"Add a comment about the limitation or provide a mechanism for argument input.\", \"target_snippet\": \"file:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\", \"replacement_snippet\": \"file:write(\\\"    result = \\\" .. function_name .. \\\"() -- NOTE: Assumes no arguments or all arguments have defaults. May fail if mandatory args are missing.\\\\n\\\")\"}]}, {\"issue_snippet\": \"func_name .. \\\"()\\\"\", \"severity\": \"error\", \"message\": \"In `M.run_python_function`, when calling a selected function, it is explicitly invoked without any arguments (e.g., `module.my_function()`). This is a critical limitation; if the Python function requires mandatory arguments, this will result in a runtime error, severely limiting the utility of running functions that aren't self-contained or have defaults.\", \"suggested_fixes\": [{\"title\": \"Provide a mechanism to input function arguments.\", \"target_snippet\": \"file:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\", \"replacement_snippet\": \"file:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"() -- This call assumes the function takes no arguments or all arguments have defaults. Consider adding a mechanism for user input for function arguments.\\\\n\\\")\"}]}, {\"issue_snippet\": \"vim.api.nvim_set_keymap\", \"severity\": \"info\", \"message\": \"For the main UV command menu (`prefix`) and environment management (`prefix .. \\\"e\\\"`) keymaps, the code defines mappings for both Snacks and Telescope pickers if both are detected. The keymap defined last will always overwrite the previous one. This creates a 'last writer wins' scenario without explicit user preference, potentially leading to inconsistent behavior or a picker being unexpectedly overridden.\", \"suggested_fixes\": [{\"title\": \"Prioritize picker integration or allow user configuration.\", \"target_snippet\": \"if _G.Snacks and _G.Snacks.picker then\", \"replacement_snippet\": \"-- if M.config.use_snacks_picker and _G.Snacks and _G.Snacks.picker then\\nif _G.Snacks and _G.Snacks.picker then\"}, {\"title\": \"Prioritize picker integration or allow user configuration (example for Telescope).\", \"target_snippet\": \"if has_telescope then\", \"replacement_snippet\": \"-- elseif M.config.use_telescope_picker and has_telescope then\\n-- Or: if not (_G.Snacks and _G.Snacks.picker) and has_telescope then (prioritize Snacks if both are present)\\nif has_telescope then\"}]}]}"}},{"key":"gen_ai.usage.input_tokens","value":{"intValue":"9365"}},{"key":"gen_ai.usage.output_tokens","value":{"intValue":"1148"}},{"key":"gen_ai.usage.details.thoughts_tokens","value":{"intValue":"2348"}},{"key":"gen_ai.usage.details.text_prompt_tokens","value":{"intValue":"9365"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\n-- uv.nvim - Neovim plugin for uv Python package management integration\\n-- Author: Ben O'Mahony\\n-- License: MIT\\n\\nlocal M = {}\\n\\n-- Default configuration\\nM.config = {\\n\\t-- Auto-activate virtual environments when found\\n\\tauto_activate_venv = true,\\n\\tnotify_activate_venv = true,\\n\\n\\t-- Auto commands for directory changes\\n\\tauto_commands = true,\\n\\n\\t-- Integration with picker (like Telescope or other UI components)\\n\\tpicker_integration = true,\\n\\n\\t-- Keymaps to register (set to false to disable)\\n\\tkeymaps = {\\n\\t\\tprefix = \\\"<leader>x\\\", -- Main prefix for UV commands\\n\\t\\tcommands = true, -- Show UV commands menu (<leader>x)\\n\\t\\trun_file = true, -- Run current file (<leader>xr)\\n\\t\\trun_selection = true, -- Run selection (<leader>xs)\\n\\t\\trun_function = true, -- Run function (<leader>xf)\\n\\t\\tvenv = true, -- Environment management (<leader>xe)\\n\\t\\tinit = true, -- Initialize UV project (<leader>xi)\\n\\t\\tadd = true, -- Add a package (<leader>xa)\\n\\t\\tremove = true, -- Remove a package (<leader>xd)\\n\\t\\tsync = true, -- Sync packages (<leader>xc)\\n\\t\\tsync_all = true, -- uv sync --all-extras --all-groups --all-packages (<leader>xC)\\n\\t},\\n\\n\\t-- Execution options\\n\\texecution = {\\n\\t\\t-- Python run command template\\n\\t\\trun_command = \\\"uv run python\\\",\\n\\n\\t\\t-- Show output in notifications\\n\\t\\tnotify_output = true,\\n\\n\\t\\t-- Notification timeout in ms\\n\\t\\tnotification_timeout = 10000,\\n\\t},\\n}\\n\\n-- Command runner - runs shell commands and captures output\\nfunction M.run_command(cmd)\\n\\t-- Run command in background and capture output\\n\\tvim.fn.jobstart(cmd, {\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Command completed successfully: \\\" .. cmd, vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Command failed: \\\" .. cmd, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Only show meaningful output (not empty lines)\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Show errors\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.WARN)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Virtual environment activation\\nfunction M.activate_venv(venv_path)\\n\\t-- For Mac, run the source command to apply to the current shell\\n\\tlocal command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n\\t-- Set environment variables for the current Neovim instance\\n\\tvim.env.VIRTUAL_ENV = venv_path\\n\\tvim.env.PATH = venv_path .. \\\"/bin:\\\" .. vim.env.PATH\\n\\t-- Notify user\\n\\tif M.config.notify_activate_venv then\\n\\t\\tvim.notify(\\\"Activated virtual environment: \\\" .. venv_path, vim.log.levels.INFO)\\n\\tend\\nend\\n\\n-- Auto-activate the .venv if it exists at the project root\\nfunction M.auto_activate_venv()\\n\\tlocal venv_path = vim.fn.getcwd() .. \\\"/.venv\\\"\\n\\tif vim.fn.isdirectory(venv_path) == 1 then\\n\\t\\tM.activate_venv(venv_path)\\n\\t\\treturn true\\n\\tend\\n\\treturn false\\nend\\n\\n-- Function to create a temporary file with the necessary context and selected code\\nfunction M.run_python_selection()\\n\\t-- Get visual selection\\n\\tlocal get_visual_selection = function()\\n\\t\\tlocal start_pos = vim.fn.getpos(\\\"'<\\\")\\n\\t\\tlocal end_pos = vim.fn.getpos(\\\"'>\\\")\\n\\t\\tlocal lines = vim.fn.getline(start_pos[2], end_pos[2])\\n\\n\\t\\tif #lines == 0 then\\n\\t\\t\\treturn \\\"\\\"\\n\\t\\tend\\n\\n\\t\\t-- Adjust last line to end at the column position of end_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[#lines] = lines[#lines]:sub(1, end_pos[3])\\n\\t\\tend\\n\\n\\t\\t-- Adjust first line to start at the column position of start_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[1] = lines[1]:sub(start_pos[3])\\n\\t\\tend\\n\\n\\t\\treturn table.concat(lines, \\\"\\\\n\\\")\\n\\tend\\n\\n\\t-- Get current buffer content to extract imports and global variables\\n\\tlocal get_buffer_globals = function()\\n\\t\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\t\\tlocal imports = {}\\n\\t\\tlocal globals = {}\\n\\t\\tlocal in_class = false\\n\\t\\tlocal class_indent = 0\\n\\n\\t\\tfor _, line in ipairs(lines) do\\n\\t\\t\\t-- Detect imports\\n\\t\\t\\tif line:match(\\\"^%s*import \\\") or line:match(\\\"^%s*from .+ import\\\") then\\n\\t\\t\\t\\ttable.insert(imports, line)\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect class definitions to skip class variables\\n\\t\\t\\tif line:match(\\\"^%s*class \\\") then\\n\\t\\t\\t\\tin_class = true\\n\\t\\t\\t\\tclass_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Check if we're exiting a class block\\n\\t\\t\\tif in_class and line:match(\\\"^%s*[^%s#]\\\") then\\n\\t\\t\\t\\tlocal current_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\t\\tif current_indent <= class_indent then\\n\\t\\t\\t\\t\\tin_class = false\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect global variable assignments (not in class, not inside functions)\\n\\t\\t\\tif not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\\n\\t\\t\\t\\t-- Check if it's not indented (global scope)\\n\\t\\t\\t\\tif not line:match(\\\"^%s%s+\\\") then\\n\\t\\t\\t\\t\\ttable.insert(globals, line)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend\\n\\n\\t\\treturn imports, globals\\n\\tend\\n\\n\\t-- Get selected code\\n\\tlocal selection = get_visual_selection()\\n\\tif selection == \\\"\\\" then\\n\\t\\tvim.notify(\\\"No code selected\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Get imports and globals\\n\\tlocal imports, globals = get_buffer_globals()\\n\\n\\t-- Create temp file\\n\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\tlocal temp_file = temp_dir .. \\\"/run_selection.py\\\"\\n\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\tif not file then\\n\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Write imports\\n\\tfor _, imp in ipairs(imports) do\\n\\t\\tfile:write(imp .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write globals\\n\\tfor _, glob in ipairs(globals) do\\n\\t\\tfile:write(glob .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write selected code\\n\\tfile:write(\\\"# SELECTED CODE\\\\n\\\")\\n\\n\\t-- Check if the selection is all indented (which would cause syntax errors)\\n\\tlocal is_all_indented = true\\n\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tif not line:match(\\\"^%s+\\\") and line ~= \\\"\\\" then\\n\\t\\t\\tis_all_indented = false\\n\\t\\t\\tbreak\\n\\t\\tend\\n\\tend\\n\\n\\t-- Process the selection to determine what type of code it is\\n\\tlocal is_function_def = selection:match(\\\"^%s*def%s+[%w_]+%s*%(\\\")\\n\\tlocal is_class_def = selection:match(\\\"^%s*class%s+[%w_]+\\\")\\n\\tlocal has_print = selection:match(\\\"print%s*%(\\\")\\n\\tlocal is_expression = not is_function_def\\n\\t\\tand not is_class_def\\n\\t\\tand not selection:match(\\\"=\\\")\\n\\t\\tand not selection:match(\\\"%s*for%s+\\\")\\n\\t\\tand not selection:match(\\\"%s*if%s+\\\")\\n\\t\\tand not has_print\\n\\n\\t-- If the selection is all indented, we need to dedent it or wrap it in a function\\n\\tif is_all_indented then\\n\\t\\tfile:write(\\\"def run_selection():\\\\n\\\")\\n\\t\\t-- Write the selection with original indentation\\n\\t\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\t\\tfile:write(\\\"    \\\" .. line .. \\\"\\\\n\\\")\\n\\t\\tend\\n\\t\\tfile:write(\\\"\\\\n# Auto-call the wrapper function\\\\n\\\")\\n\\t\\tfile:write(\\\"run_selection()\\\\n\\\")\\n\\telse\\n\\t\\t-- Write the original selection\\n\\t\\tfile:write(selection .. \\\"\\\\n\\\")\\n\\n\\t\\t-- For expressions, we'll add a print statement to see the result\\n\\t\\tif is_expression then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added print for expression\\\\n\\\")\\n\\t\\t\\tfile:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\\n\\t\\t-- For function definitions without calls, we'll add a call\\n\\t\\telseif is_function_def then\\n\\t\\t\\tlocal function_name = selection:match(\\\"def%s+([%w_]+)%s*%(\\\")\\n\\t\\t\\t-- Check if the function is already called in the selection\\n\\t\\t\\tif function_name and not selection:match(function_name .. \\\"%s*%(.-%)\\\") then\\n\\t\\t\\t\\tfile:write(\\\"\\\\n# Auto-added function call\\\\n\\\")\\n\\t\\t\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\t\\t\\tfile:write('    print(f\\\"Auto-executing function: ' .. function_name .. '\\\")\\\\n')\\n\\t\\t\\t\\tfile:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\\n\\t\\t\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\t\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\t\\tend\\n\\t\\t-- If there's no print statement in the code, add an output marker\\n\\t\\telseif not has_print and not selection:match(\\\"^%s*#\\\") then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added execution marker\\\\n\\\")\\n\\t\\t\\tfile:write('print(\\\"Code executed successfully.\\\")\\\\n')\\n\\t\\tend\\n\\tend\\n\\n\\tfile:close()\\n\\n\\t-- Run the temp file\\n\\tvim.notify(\\\"Running selected code...\\\", vim.log.levels.INFO)\\n\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Selected code executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Selected code execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Function to run a specific Python function\\nfunction M.run_python_function()\\n\\t-- Get current buffer content\\n\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\tlocal buffer_content = table.concat(lines, \\\"\\\\n\\\")\\n\\n\\t-- Find all function definitions\\n\\tlocal functions = {}\\n\\tfor line in buffer_content:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tlocal func_name = line:match(\\\"^def%s+([%w_]+)%s*%(\\\")\\n\\t\\tif func_name then\\n\\t\\t\\ttable.insert(functions, func_name)\\n\\t\\tend\\n\\tend\\n\\n\\tif #functions == 0 then\\n\\t\\tvim.notify(\\\"No functions found in current file\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Create temp file for function selection picker\\n\\tlocal run_function = function(func_name)\\n\\t\\t-- Create a temporary file with a main block to call the function\\n\\t\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\t\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\t\\tlocal temp_file = temp_dir .. \\\"/run_function.py\\\"\\n\\t\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\n\\t\\t-- Create a wrapper script that imports the current file and calls the function\\n\\t\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\t\\tif not file then\\n\\t\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\t\\treturn\\n\\t\\tend\\n\\n\\t\\t-- Get the module name (file name without .py)\\n\\t\\tlocal module_name = vim.fn.fnamemodify(current_file, \\\":t:r\\\")\\n\\t\\tlocal module_dir = vim.fn.fnamemodify(current_file, \\\":h\\\")\\n\\n\\t\\t-- Write imports\\n\\t\\tfile:write(\\\"import sys\\\\n\\\")\\n\\t\\tfile:write(\\\"sys.path.insert(0, \\\" .. vim.inspect(module_dir) .. \\\")\\\\n\\\")\\n\\t\\tfile:write(\\\"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\")\\n\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\tfile:write('    print(f\\\"Running function: ' .. func_name .. '\\\")\\\\n')\\n\\t\\tfile:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\\n\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\tfile:close()\\n\\n\\t\\t-- Run the temp file\\n\\t\\tvim.notify(\\\"Running function: \\\" .. func_name, vim.log.levels.INFO)\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\tend\\n\\n\\t-- If there's only one function, run it directly\\n\\tif #functions == 1 then\\n\\t\\trun_function(functions[1])\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Otherwise, show a picker to select the function\\n\\tvim.ui.select(functions, {\\n\\t\\tprompt = \\\"Select function to run:\\\",\\n\\t\\tformat_item = function(item)\\n\\t\\t\\treturn \\\"def \\\" .. item .. \\\"()\\\"\\n\\t\\tend,\\n\\t}, function(choice)\\n\\t\\tif choice then\\n\\t\\t\\trun_function(choice)\\n\\t\\tend\\n\\tend)\\nend\\n\\n-- Run current file\\nfunction M.run_file()\\n\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\tif current_file and current_file ~= \\\"\\\" then\\n\\t\\tvim.notify(\\\"Running: \\\" .. vim.fn.expand(\\\"%:t\\\"), vim.log.levels.INFO)\\n\\t\\t-- Run python on the current file and capture output to notifications\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(current_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution completed successfully\\\", vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\telse\\n\\t\\tvim.notify(\\\"No file is open\\\", vim.log.levels.WARN)\\n\\tend\\nend\\n\\n-- Set up command pickers for integration with UI plugins\\nfunction M.setup_pickers()\\n\\t-- Check if Snacks is available\\n\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t-- Register UV command source\\n\\t\\tSnacks.picker.sources.uv_commands = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t{ text = \\\"Run current file\\\", desc = \\\"Run current file with Python\\\", is_run_current = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run selection\\\", desc = \\\"Run selected Python code\\\", is_run_selection = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run function\\\", desc = \\\"Run specific Python function\\\", is_run_function = true },\\n\\t\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", desc = \\\"Install a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv sync\\\", desc = \\\"Sync packages from lockfile\\\" },\\n\\t\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\t\\tdesc = \\\"Sync all extras, groups and packages\\\",\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", desc = \\\"Remove a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv init\\\", desc = \\\"Initialize a new project\\\" },\\n\\t\\t\\t\\t}\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\treturn { { item.text .. \\\" - \\\" .. item.desc } }\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\t\\tif item.is_run_current then\\n\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_selection then\\n\\t\\t\\t\\t\\t\\t-- Check if there's a visual selection\\n\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\n\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\") -- Exit visual mode\\n\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t-- If not in visual mode, prompt the user to select text\\n\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t-- After notification, we'll set up a one-time autocmd to catch when visual mode is exited\\n\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\", -- When changing from any visual mode to normal mode\\n\\t\\t\\t\\t\\t\\t\\t\\tcallback = function(ev)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true -- Delete the autocmd after it's been triggered\\n\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_function then\\n\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\tlocal cmd = item.text\\n\\t\\t\\t\\t\\t-- Check if command needs input\\n\\t\\t\\t\\t\\tif cmd:match(\\\"%[(.-)%]\\\") then\\n\\t\\t\\t\\t\\t\\tlocal param_name = cmd:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\tvim.ui.input({ prompt = \\\"Enter \\\" .. param_name .. \\\": \\\" }, function(input)\\n\\t\\t\\t\\t\\t\\t\\tif not input or input == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t-- Replace the placeholder with actual input\\n\\t\\t\\t\\t\\t\\t\\tlocal actual_cmd = cmd:gsub(\\\"%[\\\" .. param_name .. \\\"%]\\\", input)\\n\\t\\t\\t\\t\\t\\t\\tM.run_command(actual_cmd)\\n\\t\\t\\t\\t\\t\\tend)\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t-- Run the command directly\\n\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\n\\t\\t-- Register UV venv source\\n\\t\\tSnacks.picker.sources.uv_venv = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\tlocal venvs = {}\\n\\t\\t\\t\\t-- Check for .venv directory (uv's default)\\n\\t\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\tif #venvs == 0 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\"Create new virtual environment (uv venv)\\\",\\n\\t\\t\\t\\t\\t\\tis_create = true,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\treturn venvs\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\treturn { { \\\"+ \\\" .. item.text } }\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tlocal icon = item.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\"\\n\\t\\t\\t\\t\\treturn { { icon .. item.text .. \\\" (Activate)\\\" } }\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\tM.activate_venv(item.path)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\tend\\n\\n\\t-- Check if Telescope is available\\n\\tlocal has_telescope, telescope = pcall(require, \\\"telescope\\\")\\n\\tif has_telescope then\\n\\t\\tlocal pickers = require(\\\"telescope.pickers\\\")\\n\\t\\tlocal finders = require(\\\"telescope.finders\\\")\\n\\t\\tlocal sorters = require(\\\"telescope.sorters\\\")\\n\\t\\tlocal actions = require(\\\"telescope.actions\\\")\\n\\t\\tlocal action_state = require(\\\"telescope.actions.state\\\")\\n\\n\\t\\t-- UV Commands picker for Telescope\\n\\t\\tM.pick_uv_commands = function()\\n\\t\\t\\tlocal items = {\\n\\t\\t\\t\\t{ text = \\\"Run current file\\\", is_run_current = true },\\n\\t\\t\\t\\t{ text = \\\"Run selection\\\", is_run_selection = true },\\n\\t\\t\\t\\t{ text = \\\"Run function\\\", is_run_function = true },\\n\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", cmd = \\\"uv add \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv sync\\\", cmd = \\\"uv sync\\\" },\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\tcmd = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", cmd = \\\"uv remove \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv init\\\", cmd = \\\"uv init\\\" },\\n\\t\\t\\t}\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Commands\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_run_current then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_selection then\\n\\t\\t\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\t\\t\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_function then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tif selection.needs_input then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal placeholder = selection.text:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.ui.input(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t{ prompt = \\\"Enter \\\" .. (placeholder or \\\"value\\\") .. \\\": \\\" },\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfunction(input)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tif input and input ~= \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal cmd = selection.cmd .. input\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(selection.cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\n\\t\\t-- UV venv picker for Telescope\\n\\t\\tM.pick_uv_venv = function()\\n\\t\\t\\tlocal items = {}\\n\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\ttable.insert(items, {\\n\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t})\\n\\t\\t\\tend\\n\\t\\t\\tif #items == 0 then\\n\\t\\t\\t\\ttable.insert(items, { text = \\\"Create new virtual environment (uv venv)\\\", is_create = true })\\n\\t\\t\\tend\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Virtual Environments\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\tlocal display = entry.is_create and \\\"+ \\\" .. entry.text\\n\\t\\t\\t\\t\\t\\t\\t\\tor ((entry.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\") .. entry.text .. \\\" (Activate)\\\")\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = display,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = display,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_create then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tM.activate_venv(selection.path)\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Set up user commands\\nfunction M.setup_commands()\\n\\t-- Set up UV commands\\n\\tvim.api.nvim_create_user_command(\\\"UVInit\\\", function()\\n\\t\\tM.run_command(\\\"uv init\\\")\\n\\tend, {})\\n\\n\\t-- Command to run selected code\\n\\tvim.api.nvim_create_user_command(\\\"UVRunSelection\\\", function()\\n\\t\\tM.run_python_selection()\\n\\tend, { range = true })\\n\\n\\t-- Command to run a specific function\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFunction\\\", function()\\n\\t\\tM.run_python_function()\\n\\tend, {})\\n\\n\\t-- Command to run the current file\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFile\\\", function()\\n\\t\\tM.run_file()\\n\\tend, {})\\n\\n\\t-- Command to add a package\\n\\tvim.api.nvim_create_user_command(\\\"UVAddPackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv add \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\n\\n\\t-- Command to remove a package\\n\\tvim.api.nvim_create_user_command(\\\"UVRemovePackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv remove \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\nend\\n\\n-- Set up keymaps\\nfunction M.setup_keymaps()\\n\\tlocal keymaps = M.config.keymaps\\n\\tlocal prefix = keymaps.prefix or \\\"<leader>x\\\"\\n\\n\\t-- Main UV command menu\\n\\tif keymaps.commands then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Run current file\\n\\tif keymaps.run_file then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"r\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFile<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Current File\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run selection\\n\\tif keymaps.run_selection then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"v\\\",\\n\\t\\t\\tprefix .. \\\"s\\\",\\n\\t\\t\\t\\\":<C-u>UVRunSelection<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Selection\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run function\\n\\tif keymaps.run_function then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"f\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFunction<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Function\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Environment management\\n\\tif keymaps.venv then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_venv')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope_venv = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope_venv then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_venv()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Initialize UV project\\n\\tif keymaps.init then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"i\\\",\\n\\t\\t\\t\\\"<cmd>UVInit<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Init\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Add a package\\n\\tif keymaps.add then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"a\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv add ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Add Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Remove a package\\n\\tif keymaps.remove then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"d\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv remove ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Remove Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Sync packages\\n\\tif keymaps.sync then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"c\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync Packages\\\" }\\n\\t\\t)\\n\\tend\\n\\tif keymaps.sync_all then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"C\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync --all-extras --all-packages --all-groups')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync All Extras, Groups and Packages\\\" }\\n\\t\\t)\\n\\tend\\nend\\n\\n-- Set up auto commands\\nfunction M.setup_autocommands()\\n\\tif M.config.auto_commands then\\n\\t\\t-- Auto-activate .venv if it exists\\n\\t\\tif M.config.auto_activate_venv then\\n\\t\\t\\tM.auto_activate_venv()\\n\\n\\t\\t\\t-- Also set up auto-command to check when entering a directory\\n\\t\\t\\tvim.api.nvim_create_autocmd({ \\\"DirChanged\\\" }, {\\n\\t\\t\\t\\tpattern = { \\\"global\\\" },\\n\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\tM.auto_activate_venv()\\n\\t\\t\\t\\tend,\\n\\t\\t\\t})\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Main setup function\\nfunction M.setup(opts)\\n\\t-- Merge user configuration with defaults\\n\\tM.config = vim.tbl_deep_extend(\\\"force\\\", M.config, opts or {})\\n\\n\\t-- Set up commands\\n\\tM.setup_commands()\\n\\n\\t-- Set up keymaps if enabled\\n\\tif M.config.keymaps ~= false then\\n\\t\\tM.setup_keymaps()\\n\\tend\\n\\n\\t-- Set up autocommands if enabled\\n\\tif M.config.auto_commands ~= false then\\n\\t\\tM.setup_autocommands()\\n\\tend\\n\\n\\t-- Set up pickers if integration is enabled\\n\\tif M.config.picker_integration then\\n\\t\\tM.setup_pickers()\\n\\tend\\n\\n\\t-- Make run_command globally accessible (can be removed if not needed)\\n\\t_G.run_command = M.run_command\\nend\\n\\nreturn M\\n\\n```\\n\\nFile: init.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}, {\"role\": \"assistant\", \"tool_calls\": [{\"id\": \"pyd_ai_ad5034e3dc664109be4eaa9fffbcf8d3\", \"type\": \"function\", \"function\": {\"name\": \"final_result\", \"arguments\": {\"issues\": [{\"severity\": \"error\", \"message\": \"The 'source' command for activating the virtual environment is constructed but never actually executed. Manually setting VIRTUAL_ENV and PATH is an incomplete activation and will miss other environment variables or shell functions that the 'activate' script typically sets. This can lead to unexpected behavior or Python not finding correctly configured packages.\", \"suggested_fixes\": [{\"replacement_snippet\": \"local command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n-- This command needs to be run in the shell that Neovim itself runs in,\\n-- or its direct child process, which is complex. For Neovim's internal\\n-- environment, setting vim.env variables is the primary mechanism.\\n-- Consider if the 'source' command is truly necessary or achievable\\n-- given Neovim's job control model. If a full shell environment is needed,\\n-- it might require restarting Neovim within the activated shell or more advanced setup.\\n-- For most cases, setting VIRTUAL_ENV and PATH in vim.env is sufficient for Neovim's internal Python provider.\", \"target_snippet\": \"local command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\", \"title\": \"Execute the source command via a shell, if Neovim's environment can be directly influenced.\"}], \"issue_snippet\": \"source\"}, {\"issue_snippet\": \"get_buffer_globals\", \"suggested_fixes\": [{\"replacement_snippet\": \"get_buffer_globals = function() -- Consider using a more robust Python parser (if available via external tool) or adding a disclaimer about limitations.\", \"target_snippet\": \"get_buffer_globals = function()\", \"title\": \"Improve global variable detection or provide a disclaimer.\"}], \"message\": \"The `get_buffer_globals` function uses fragile heuristics (indentation-based string matching) to identify imports and global variables. This method may incorrectly classify or miss context (e.g., variables defined within top-level if/try blocks, or complex module structures), leading to runtime errors when the extracted selection is run in a temporary file without its full lexical scope.\", \"severity\": \"warning\"}, {\"issue_snippet\": \"function_name .. \\\"()\\\"\", \"severity\": \"warning\", \"message\": \"In `M.run_python_selection`, when auto-calling a detected function, it is invoked without any arguments (e.g., `my_function()`). This will cause a runtime error if the function requires mandatory arguments.\", \"suggested_fixes\": [{\"target_snippet\": \"file:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\", \"title\": \"Add a comment about the limitation or provide a mechanism for argument input.\", \"replacement_snippet\": \"file:write(\\\"    result = \\\" .. function_name .. \\\"() -- NOTE: Assumes no arguments or all arguments have defaults. May fail if mandatory args are missing.\\\\n\\\")\"}]}, {\"suggested_fixes\": [{\"replacement_snippet\": \"file:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"() -- This call assumes the function takes no arguments or all arguments have defaults. Consider adding a mechanism for user input for function arguments.\\\\n\\\")\", \"title\": \"Provide a mechanism to input function arguments.\", \"target_snippet\": \"file:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\"}], \"message\": \"In `M.run_python_function`, when calling a selected function, it is explicitly invoked without any arguments (e.g., `module.my_function()`). This is a critical limitation; if the Python function requires mandatory arguments, this will result in a runtime error, severely limiting the utility of running functions that aren't self-contained or have defaults.\", \"issue_snippet\": \"func_name .. \\\"()\\\"\", \"severity\": \"error\"}, {\"issue_snippet\": \"vim.api.nvim_set_keymap\", \"severity\": \"info\", \"message\": \"For the main UV command menu (`prefix`) and environment management (`prefix .. \\\"e\\\"`) keymaps, the code defines mappings for both Snacks and Telescope pickers if both are detected. The keymap defined last will always overwrite the previous one. This creates a 'last writer wins' scenario without explicit user preference, potentially leading to inconsistent behavior or a picker being unexpectedly overridden.\", \"suggested_fixes\": [{\"title\": \"Prioritize picker integration or allow user configuration.\", \"target_snippet\": \"if _G.Snacks and _G.Snacks.picker then\", \"replacement_snippet\": \"-- if M.config.use_snacks_picker and _G.Snacks and _G.Snacks.picker then\\nif _G.Snacks and _G.Snacks.picker then\"}, {\"target_snippet\": \"if has_telescope then\", \"replacement_snippet\": \"-- elseif M.config.use_telescope_picker and has_telescope then\\n-- Or: if not (_G.Snacks and _G.Snacks.picker) and has_telescope then (prioritize Snacks if both are present)\\nif has_telescope then\", \"title\": \"Prioritize picker integration or allow user configuration (example for Telescope).\"}]}]}}}], \"gen_ai.message.index\": 1, \"event.name\": \"gen_ai.assistant.message\"}, {\"content\": \"Final result processed.\", \"role\": \"tool\", \"id\": \"pyd_ai_ad5034e3dc664109be4eaa9fffbcf8d3\", \"name\": \"final_result\", \"gen_ai.message.index\": 2, \"event.name\": \"gen_ai.tool.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]},{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a7991eb4061f8488d91e4acf1acb5","spanId":"4342464001f486c7","parentSpanId":"1a19f18d8cf91da9","flags":256,"name":"AI analysis completed, found {len(result.output.issues)} issues","kind":1,"startTimeUnixNano":"1762976218643886000","endTimeUnixNano":"1762976218643886000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI analysis completed, found {len(result.output.issues)} issues"}},{"key":"logfire.msg","value":{"stringValue":"AI analysis completed, found 5 issues"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"203"}},{"key":"len(result.output.issues)","value":{"intValue":"5"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(result.output.issues)\":{}}}"}}],"status":{}},{"traceId":"019a7991eb4061f8488d91e4acf1acb5","spanId":"5b92e028af31af4d","parentSpanId":"1a19f18d8cf91da9","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762976218646388000","endTimeUnixNano":"1762976218646388000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 6 occurrences of 'source...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"6"}},{"key":"snippet[:20]","value":{"stringValue":"source"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7991eb4061f8488d91e4acf1acb5","spanId":"80acd8aa47e3c0be","parentSpanId":"1a19f18d8cf91da9","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762976218646800000","endTimeUnixNano":"1762976218646800000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 2 occurrences of 'get_buffer_globals...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"2"}},{"key":"snippet[:20]","value":{"stringValue":"get_buffer_globals"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7991eb4061f8488d91e4acf1acb5","spanId":"0214eb00e06f6424","parentSpanId":"1a19f18d8cf91da9","flags":256,"name":"Could not find snippet '{snippet}' in text","kind":1,"startTimeUnixNano":"1762976218647310000","endTimeUnixNano":"1762976218647310000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"13"}},{"key":"logfire.msg_template","value":{"stringValue":"Could not find snippet '{snippet}' in text"}},{"key":"logfire.msg","value":{"stringValue":"Could not find snippet 'function_name .. \"()\"' in text"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"149"}},{"key":"snippet","value":{"stringValue":"function_name .. \"()\""}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"snippet\":{}}}"}}],"status":{}},{"traceId":"019a7991eb4061f8488d91e4acf1acb5","spanId":"e9b12896196e9a4b","parentSpanId":"1a19f18d8cf91da9","flags":256,"name":"Could not find snippet '{snippet}' in text","kind":1,"startTimeUnixNano":"1762976218647483000","endTimeUnixNano":"1762976218647483000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"13"}},{"key":"logfire.msg_template","value":{"stringValue":"Could not find snippet '{snippet}' in text"}},{"key":"logfire.msg","value":{"stringValue":"Could not find snippet 'func_name .. \"()\"' in text"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"149"}},{"key":"snippet","value":{"stringValue":"func_name .. \"()\""}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"snippet\":{}}}"}}],"status":{}},{"traceId":"019a7991eb4061f8488d91e4acf1acb5","spanId":"cf9571a860f86d60","parentSpanId":"1a19f18d8cf91da9","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762976218648663000","endTimeUnixNano":"1762976218648663000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 14 occurrences of 'vim.api.nvim_set_key...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"14"}},{"key":"snippet[:20]","value":{"stringValue":"vim.api.nvim_set_key"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7991eb4061f8488d91e4acf1acb5","spanId":"1a19f18d8cf91da9","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976197440411000","endTimeUnixNano":"1762976218648794000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a79923e1cd85890ad533a96a10360","spanId":"06731a2daf54a341","flags":256,"name":"Published {len(diagnostics)} diagnostics for {uri}","kind":1,"startTimeUnixNano":"1762976218652323000","endTimeUnixNano":"1762976218652323000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Published {len(diagnostics)} diagnostics for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Published 3 diagnostics for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer._delayed_analyze"}},{"key":"code.lineno","value":{"intValue":"181"}},{"key":"len(diagnostics)","value":{"intValue":"3"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(diagnostics)\":{},\"uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c511d8c928e741c8b6e3305bc85905a5"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"61044"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a7992bff8125e022f0d3b2b075d6b","spanId":"f0c21c17de54fce0","parentSpanId":"d4f960a2f69b7237","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762976251896888000","endTimeUnixNano":"1762976251896888000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of 'local command = \"sou...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"local command = \"sou"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a7992bff8125e022f0d3b2b075d6b","spanId":"9125c2cc09559270","parentSpanId":"d4f960a2f69b7237","flags":256,"name":"creating_quick_fix","kind":1,"startTimeUnixNano":"1762976251897190000","endTimeUnixNano":"1762976251897379000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"code_actions"}},{"key":"code.lineno","value":{"intValue":"332"}},{"key":"title","value":{"stringValue":"Execute the source command via a shell, if Neovim's environment can be directly influenced."}},{"key":"logfire.msg_template","value":{"stringValue":"creating_quick_fix"}},{"key":"logfire.msg","value":{"stringValue":"creating_quick_fix"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"title\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a7992bff8125e022f0d3b2b075d6b","spanId":"d4f960a2f69b7237","flags":256,"name":"code_actions","kind":1,"startTimeUnixNano":"1762976251896509000","endTimeUnixNano":"1762976251897472000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"code_actions"}},{"key":"code.lineno","value":{"intValue":"315"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"code_actions"}},{"key":"logfire.msg","value":{"stringValue":"code_actions"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a7992cd4df6752e7bb8df8b03878e","spanId":"90d7a3e8cc0a480f","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976255309712000","endTimeUnixNano":"1762976255309712000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c511d8c928e741c8b6e3305bc85905a5"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"61044"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a7992d137adeb26806e54d71d5a20","spanId":"0b34e805d7176b65","parentSpanId":"85379cb0c6d7fbda","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976256312535000","endTimeUnixNano":"1762976256312535000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7992d5e76fdc8d03ce9ea29953ff","spanId":"b724c5cc968eb90e","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976257511135000","endTimeUnixNano":"1762976257511135000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7992d137adeb26806e54d71d5a20","spanId":"85379cb0c6d7fbda","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976256311561000","endTimeUnixNano":"1762976257534131000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976257522179000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a7992d5fff4b3e43b6b3a5085cffa","spanId":"d1a8444086d43fcd","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976257535372000","endTimeUnixNano":"1762976257535372000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7992d9d0c22ac6a3e062c1a002a9","spanId":"e0861a2cef113088","parentSpanId":"7de2285dd99fc87a","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976258513305000","endTimeUnixNano":"1762976258513305000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a7992d137adeb26806e54d71d5a20","spanId":"7130a120b52ed69d","parentSpanId":"bb5562151f69f024","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976256317374000","endTimeUnixNano":"1762976257511907000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a7992d137adeb26806e54d71d5a20","spanId":"bb5562151f69f024","parentSpanId":"85379cb0c6d7fbda","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976256315640000","endTimeUnixNano":"1762976257512476000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\n-- uv.nvim - Neovim plugin for uv Python package management integration\\n-- Author: Ben O'Mahony\\n-- License: MIT\\n\\nlocal M = {}\\n\\n-- Default configuration\\nM.config = {\\n\\t-- Auto-activate virtual environments when found\\n\\tauto_activate_venv = true,\\n\\tnotify_activate_venv = true,\\n\\n\\t-- Auto commands for directory changes\\n\\tauto_commands = true,\\n\\n\\t-- Integration with picker (like Telescope or other UI components)\\n\\tpicker_integration = true,\\n\\n\\t-- Keymaps to register (set to false to disable)\\n\\tkeymaps = {\\n\\t\\tprefix = \\\"<leader>x\\\", -- Main prefix for UV commands\\n\\t\\tcommands = true, -- Show UV commands menu (<leader>x)\\n\\t\\trun_file = true, -- Run current file (<leader>xr)\\n\\t\\trun_selection = true, -- Run selection (<leader>xs)\\n\\t\\trun_function = true, -- Run function (<leader>xf)\\n\\t\\tvenv = true, -- Environment management (<leader>xe)\\n\\t\\tinit = true, -- Initialize UV project (<leader>xi)\\n\\t\\tadd = true, -- Add a package (<leader>xa)\\n\\t\\tremove = true, -- Remove a package (<leader>xd)\\n\\t\\tsync = true, -- Sync packages (<leader>xc)\\n\\t\\tsync_all = true, -- uv sync --all-extras --all-groups --all-packages (<leader>xC)\\n\\t},\\n\\n\\t-- Execution options\\n\\texecution = {\\n\\t\\t-- Python run command template\\n\\t\\trun_command = \\\"uv run python\\\",\\n\\n\\t\\t-- Show output in notifications\\n\\t\\tnotify_output = true,\\n\\n\\t\\t-- Notification timeout in ms\\n\\t\\tnotification_timeout = 10000,\\n\\t},\\n}\\n\\n-- Command runner - runs shell commands and captures output\\nfunction M.run_command(cmd)\\n\\t-- Run command in background and capture output\\n\\tvim.fn.jobstart(cmd, {\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Command completed successfully: \\\" .. cmd, vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Command failed: \\\" .. cmd, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Only show meaningful output (not empty lines)\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Show errors\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.WARN)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Virtual environment activation\\nfunction M.activate_venv(venv_path)\\n\\t-- For Mac, run the source command to apply to the current shell\\n\\tlocal command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n-- This command needs to be run in the shell that Neovim itself runs in,\\n-- or its direct child process, which is complex. For Neovim's internal\\n-- environment, setting vim.env variables is the primary mechanism.\\n-- Consider if the 'source' command is truly necessary or achievable\\n-- given Neovim's job control model. If a full shell environment is needed,\\n-- it might require restarting Neovim within the activated shell or more advanced setup.\\n-- For most cases, setting VIRTUAL_ENV and PATH in vim.env is sufficient for Neovim's internal Python provider.\\n\\t-- Set environment variables for the current Neovim instance\\n\\tvim.env.VIRTUAL_ENV = venv_path\\n\\tvim.env.PATH = venv_path .. \\\"/bin:\\\" .. vim.env.PATH\\n\\t-- Notify user\\n\\tif M.config.notify_activate_venv then\\n\\t\\tvim.notify(\\\"Activated virtual environment: \\\" .. venv_path, vim.log.levels.INFO)\\n\\tend\\nend\\n\\n-- Auto-activate the .venv if it exists at the project root\\nfunction M.auto_activate_venv()\\n\\tlocal venv_path = vim.fn.getcwd() .. \\\"/.venv\\\"\\n\\tif vim.fn.isdirectory(venv_path) == 1 then\\n\\t\\tM.activate_venv(venv_path)\\n\\t\\treturn true\\n\\tend\\n\\treturn false\\nend\\n\\n-- Function to create a temporary file with the necessary context and selected code\\nfunction M.run_python_selection()\\n\\t-- Get visual selection\\n\\tlocal get_visual_selection = function()\\n\\t\\tlocal start_pos = vim.fn.getpos(\\\"'<\\\")\\n\\t\\tlocal end_pos = vim.fn.getpos(\\\"'>\\\")\\n\\t\\tlocal lines = vim.fn.getline(start_pos[2], end_pos[2])\\n\\n\\t\\tif #lines == 0 then\\n\\t\\t\\treturn \\\"\\\"\\n\\t\\tend\\n\\n\\t\\t-- Adjust last line to end at the column position of end_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[#lines] = lines[#lines]:sub(1, end_pos[3])\\n\\t\\tend\\n\\n\\t\\t-- Adjust first line to start at the column position of start_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[1] = lines[1]:sub(start_pos[3])\\n\\t\\tend\\n\\n\\t\\treturn table.concat(lines, \\\"\\\\n\\\")\\n\\tend\\n\\n\\t-- Get current buffer content to extract imports and global variables\\n\\tlocal get_buffer_globals = function()\\n\\t\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\t\\tlocal imports = {}\\n\\t\\tlocal globals = {}\\n\\t\\tlocal in_class = false\\n\\t\\tlocal class_indent = 0\\n\\n\\t\\tfor _, line in ipairs(lines) do\\n\\t\\t\\t-- Detect imports\\n\\t\\t\\tif line:match(\\\"^%s*import \\\") or line:match(\\\"^%s*from .+ import\\\") then\\n\\t\\t\\t\\ttable.insert(imports, line)\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect class definitions to skip class variables\\n\\t\\t\\tif line:match(\\\"^%s*class \\\") then\\n\\t\\t\\t\\tin_class = true\\n\\t\\t\\t\\tclass_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Check if we're exiting a class block\\n\\t\\t\\tif in_class and line:match(\\\"^%s*[^%s#]\\\") then\\n\\t\\t\\t\\tlocal current_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\t\\tif current_indent <= class_indent then\\n\\t\\t\\t\\t\\tin_class = false\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect global variable assignments (not in class, not inside functions)\\n\\t\\t\\tif not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\\n\\t\\t\\t\\t-- Check if it's not indented (global scope)\\n\\t\\t\\t\\tif not line:match(\\\"^%s%s+\\\") then\\n\\t\\t\\t\\t\\ttable.insert(globals, line)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend\\n\\n\\t\\treturn imports, globals\\n\\tend\\n\\n\\t-- Get selected code\\n\\tlocal selection = get_visual_selection()\\n\\tif selection == \\\"\\\" then\\n\\t\\tvim.notify(\\\"No code selected\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Get imports and globals\\n\\tlocal imports, globals = get_buffer_globals()\\n\\n\\t-- Create temp file\\n\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\tlocal temp_file = temp_dir .. \\\"/run_selection.py\\\"\\n\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\tif not file then\\n\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Write imports\\n\\tfor _, imp in ipairs(imports) do\\n\\t\\tfile:write(imp .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write globals\\n\\tfor _, glob in ipairs(globals) do\\n\\t\\tfile:write(glob .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write selected code\\n\\tfile:write(\\\"# SELECTED CODE\\\\n\\\")\\n\\n\\t-- Check if the selection is all indented (which would cause syntax errors)\\n\\tlocal is_all_indented = true\\n\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tif not line:match(\\\"^%s+\\\") and line ~= \\\"\\\" then\\n\\t\\t\\tis_all_indented = false\\n\\t\\t\\tbreak\\n\\t\\tend\\n\\tend\\n\\n\\t-- Process the selection to determine what type of code it is\\n\\tlocal is_function_def = selection:match(\\\"^%s*def%s+[%w_]+%s*%(\\\")\\n\\tlocal is_class_def = selection:match(\\\"^%s*class%s+[%w_]+\\\")\\n\\tlocal has_print = selection:match(\\\"print%s*%(\\\")\\n\\tlocal is_expression = not is_function_def\\n\\t\\tand not is_class_def\\n\\t\\tand not selection:match(\\\"=\\\")\\n\\t\\tand not selection:match(\\\"%s*for%s+\\\")\\n\\t\\tand not selection:match(\\\"%s*if%s+\\\")\\n\\t\\tand not has_print\\n\\n\\t-- If the selection is all indented, we need to dedent it or wrap it in a function\\n\\tif is_all_indented then\\n\\t\\tfile:write(\\\"def run_selection():\\\\n\\\")\\n\\t\\t-- Write the selection with original indentation\\n\\t\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\t\\tfile:write(\\\"    \\\" .. line .. \\\"\\\\n\\\")\\n\\t\\tend\\n\\t\\tfile:write(\\\"\\\\n# Auto-call the wrapper function\\\\n\\\")\\n\\t\\tfile:write(\\\"run_selection()\\\\n\\\")\\n\\telse\\n\\t\\t-- Write the original selection\\n\\t\\tfile:write(selection .. \\\"\\\\n\\\")\\n\\n\\t\\t-- For expressions, we'll add a print statement to see the result\\n\\t\\tif is_expression then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added print for expression\\\\n\\\")\\n\\t\\t\\tfile:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\\n\\t\\t-- For function definitions without calls, we'll add a call\\n\\t\\telseif is_function_def then\\n\\t\\t\\tlocal function_name = selection:match(\\\"def%s+([%w_]+)%s*%(\\\")\\n\\t\\t\\t-- Check if the function is already called in the selection\\n\\t\\t\\tif function_name and not selection:match(function_name .. \\\"%s*%(.-%)\\\") then\\n\\t\\t\\t\\tfile:write(\\\"\\\\n# Auto-added function call\\\\n\\\")\\n\\t\\t\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\t\\t\\tfile:write('    print(f\\\"Auto-executing function: ' .. function_name .. '\\\")\\\\n')\\n\\t\\t\\t\\tfile:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\\n\\t\\t\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\t\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\t\\tend\\n\\t\\t-- If there's no print statement in the code, add an output marker\\n\\t\\telseif not has_print and not selection:match(\\\"^%s*#\\\") then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added execution marker\\\\n\\\")\\n\\t\\t\\tfile:write('print(\\\"Code executed successfully.\\\")\\\\n')\\n\\t\\tend\\n\\tend\\n\\n\\tfile:close()\\n\\n\\t-- Run the temp file\\n\\tvim.notify(\\\"Running selected code...\\\", vim.log.levels.INFO)\\n\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Selected code executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Selected code execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Function to run a specific Python function\\nfunction M.run_python_function()\\n\\t-- Get current buffer content\\n\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\tlocal buffer_content = table.concat(lines, \\\"\\\\n\\\")\\n\\n\\t-- Find all function definitions\\n\\tlocal functions = {}\\n\\tfor line in buffer_content:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tlocal func_name = line:match(\\\"^def%s+([%w_]+)%s*%(\\\")\\n\\t\\tif func_name then\\n\\t\\t\\ttable.insert(functions, func_name)\\n\\t\\tend\\n\\tend\\n\\n\\tif #functions == 0 then\\n\\t\\tvim.notify(\\\"No functions found in current file\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Create temp file for function selection picker\\n\\tlocal run_function = function(func_name)\\n\\t\\t-- Create a temporary file with a main block to call the function\\n\\t\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\t\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\t\\tlocal temp_file = temp_dir .. \\\"/run_function.py\\\"\\n\\t\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\n\\t\\t-- Create a wrapper script that imports the current file and calls the function\\n\\t\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\t\\tif not file then\\n\\t\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\t\\treturn\\n\\t\\tend\\n\\n\\t\\t-- Get the module name (file name without .py)\\n\\t\\tlocal module_name = vim.fn.fnamemodify(current_file, \\\":t:r\\\")\\n\\t\\tlocal module_dir = vim.fn.fnamemodify(current_file, \\\":h\\\")\\n\\n\\t\\t-- Write imports\\n\\t\\tfile:write(\\\"import sys\\\\n\\\")\\n\\t\\tfile:write(\\\"sys.path.insert(0, \\\" .. vim.inspect(module_dir) .. \\\")\\\\n\\\")\\n\\t\\tfile:write(\\\"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\")\\n\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\tfile:write('    print(f\\\"Running function: ' .. func_name .. '\\\")\\\\n')\\n\\t\\tfile:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\\n\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\tfile:close()\\n\\n\\t\\t-- Run the temp file\\n\\t\\tvim.notify(\\\"Running function: \\\" .. func_name, vim.log.levels.INFO)\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\tend\\n\\n\\t-- If there's only one function, run it directly\\n\\tif #functions == 1 then\\n\\t\\trun_function(functions[1])\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Otherwise, show a picker to select the function\\n\\tvim.ui.select(functions, {\\n\\t\\tprompt = \\\"Select function to run:\\\",\\n\\t\\tformat_item = function(item)\\n\\t\\t\\treturn \\\"def \\\" .. item .. \\\"()\\\"\\n\\t\\tend,\\n\\t}, function(choice)\\n\\t\\tif choice then\\n\\t\\t\\trun_function(choice)\\n\\t\\tend\\n\\tend)\\nend\\n\\n-- Run current file\\nfunction M.run_file()\\n\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\tif current_file and current_file ~= \\\"\\\" then\\n\\t\\tvim.notify(\\\"Running: \\\" .. vim.fn.expand(\\\"%:t\\\"), vim.log.levels.INFO)\\n\\t\\t-- Run python on the current file and capture output to notifications\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(current_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution completed successfully\\\", vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\telse\\n\\t\\tvim.notify(\\\"No file is open\\\", vim.log.levels.WARN)\\n\\tend\\nend\\n\\n-- Set up command pickers for integration with UI plugins\\nfunction M.setup_pickers()\\n\\t-- Check if Snacks is available\\n\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t-- Register UV command source\\n\\t\\tSnacks.picker.sources.uv_commands = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t{ text = \\\"Run current file\\\", desc = \\\"Run current file with Python\\\", is_run_current = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run selection\\\", desc = \\\"Run selected Python code\\\", is_run_selection = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run function\\\", desc = \\\"Run specific Python function\\\", is_run_function = true },\\n\\t\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", desc = \\\"Install a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv sync\\\", desc = \\\"Sync packages from lockfile\\\" },\\n\\t\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\t\\tdesc = \\\"Sync all extras, groups and packages\\\",\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", desc = \\\"Remove a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv init\\\", desc = \\\"Initialize a new project\\\" },\\n\\t\\t\\t\\t}\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\treturn { { item.text .. \\\" - \\\" .. item.desc } }\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\t\\tif item.is_run_current then\\n\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_selection then\\n\\t\\t\\t\\t\\t\\t-- Check if there's a visual selection\\n\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\n\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\") -- Exit visual mode\\n\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t-- If not in visual mode, prompt the user to select text\\n\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t-- After notification, we'll set up a one-time autocmd to catch when visual mode is exited\\n\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\", -- When changing from any visual mode to normal mode\\n\\t\\t\\t\\t\\t\\t\\t\\tcallback = function(ev)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true -- Delete the autocmd after it's been triggered\\n\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_function then\\n\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\tlocal cmd = item.text\\n\\t\\t\\t\\t\\t-- Check if command needs input\\n\\t\\t\\t\\t\\tif cmd:match(\\\"%[(.-)%]\\\") then\\n\\t\\t\\t\\t\\t\\tlocal param_name = cmd:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\tvim.ui.input({ prompt = \\\"Enter \\\" .. param_name .. \\\": \\\" }, function(input)\\n\\t\\t\\t\\t\\t\\t\\tif not input or input == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t-- Replace the placeholder with actual input\\n\\t\\t\\t\\t\\t\\t\\tlocal actual_cmd = cmd:gsub(\\\"%[\\\" .. param_name .. \\\"%]\\\", input)\\n\\t\\t\\t\\t\\t\\t\\tM.run_command(actual_cmd)\\n\\t\\t\\t\\t\\t\\tend)\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t-- Run the command directly\\n\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\n\\t\\t-- Register UV venv source\\n\\t\\tSnacks.picker.sources.uv_venv = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\tlocal venvs = {}\\n\\t\\t\\t\\t-- Check for .venv directory (uv's default)\\n\\t\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\tif #venvs == 0 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\"Create new virtual environment (uv venv)\\\",\\n\\t\\t\\t\\t\\t\\tis_create = true,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\treturn venvs\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\treturn { { \\\"+ \\\" .. item.text } }\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tlocal icon = item.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\"\\n\\t\\t\\t\\t\\treturn { { icon .. item.text .. \\\" (Activate)\\\" } }\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\tM.activate_venv(item.path)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\tend\\n\\n\\t-- Check if Telescope is available\\n\\tlocal has_telescope, telescope = pcall(require, \\\"telescope\\\")\\n\\tif has_telescope then\\n\\t\\tlocal pickers = require(\\\"telescope.pickers\\\")\\n\\t\\tlocal finders = require(\\\"telescope.finders\\\")\\n\\t\\tlocal sorters = require(\\\"telescope.sorters\\\")\\n\\t\\tlocal actions = require(\\\"telescope.actions\\\")\\n\\t\\tlocal action_state = require(\\\"telescope.actions.state\\\")\\n\\n\\t\\t-- UV Commands picker for Telescope\\n\\t\\tM.pick_uv_commands = function()\\n\\t\\t\\tlocal items = {\\n\\t\\t\\t\\t{ text = \\\"Run current file\\\", is_run_current = true },\\n\\t\\t\\t\\t{ text = \\\"Run selection\\\", is_run_selection = true },\\n\\t\\t\\t\\t{ text = \\\"Run function\\\", is_run_function = true },\\n\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", cmd = \\\"uv add \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv sync\\\", cmd = \\\"uv sync\\\" },\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\tcmd = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", cmd = \\\"uv remove \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv init\\\", cmd = \\\"uv init\\\" },\\n\\t\\t\\t}\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Commands\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_run_current then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_selection then\\n\\t\\t\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\t\\t\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_function then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tif selection.needs_input then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal placeholder = selection.text:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.ui.input(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t{ prompt = \\\"Enter \\\" .. (placeholder or \\\"value\\\") .. \\\": \\\" },\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfunction(input)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tif input and input ~= \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal cmd = selection.cmd .. input\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(selection.cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\n\\t\\t-- UV venv picker for Telescope\\n\\t\\tM.pick_uv_venv = function()\\n\\t\\t\\tlocal items = {}\\n\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\ttable.insert(items, {\\n\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t})\\n\\t\\t\\tend\\n\\t\\t\\tif #items == 0 then\\n\\t\\t\\t\\ttable.insert(items, { text = \\\"Create new virtual environment (uv venv)\\\", is_create = true })\\n\\t\\t\\tend\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Virtual Environments\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\tlocal display = entry.is_create and \\\"+ \\\" .. entry.text\\n\\t\\t\\t\\t\\t\\t\\t\\tor ((entry.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\") .. entry.text .. \\\" (Activate)\\\")\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = display,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = display,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_create then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tM.activate_venv(selection.path)\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Set up user commands\\nfunction M.setup_commands()\\n\\t-- Set up UV commands\\n\\tvim.api.nvim_create_user_command(\\\"UVInit\\\", function()\\n\\t\\tM.run_command(\\\"uv init\\\")\\n\\tend, {})\\n\\n\\t-- Command to run selected code\\n\\tvim.api.nvim_create_user_command(\\\"UVRunSelection\\\", function()\\n\\t\\tM.run_python_selection()\\n\\tend, { range = true })\\n\\n\\t-- Command to run a specific function\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFunction\\\", function()\\n\\t\\tM.run_python_function()\\n\\tend, {})\\n\\n\\t-- Command to run the current file\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFile\\\", function()\\n\\t\\tM.run_file()\\n\\tend, {})\\n\\n\\t-- Command to add a package\\n\\tvim.api.nvim_create_user_command(\\\"UVAddPackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv add \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\n\\n\\t-- Command to remove a package\\n\\tvim.api.nvim_create_user_command(\\\"UVRemovePackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv remove \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\nend\\n\\n-- Set up keymaps\\nfunction M.setup_keymaps()\\n\\tlocal keymaps = M.config.keymaps\\n\\tlocal prefix = keymaps.prefix or \\\"<leader>x\\\"\\n\\n\\t-- Main UV command menu\\n\\tif keymaps.commands then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Run current file\\n\\tif keymaps.run_file then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"r\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFile<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Current File\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run selection\\n\\tif keymaps.run_selection then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"v\\\",\\n\\t\\t\\tprefix .. \\\"s\\\",\\n\\t\\t\\t\\\":<C-u>UVRunSelection<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Selection\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run function\\n\\tif keymaps.run_function then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"f\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFunction<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Function\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Environment management\\n\\tif keymaps.venv then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_venv')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope_venv = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope_venv then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_venv()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Initialize UV project\\n\\tif keymaps.init then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"i\\\",\\n\\t\\t\\t\\\"<cmd>UVInit<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Init\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Add a package\\n\\tif keymaps.add then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"a\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv add ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Add Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Remove a package\\n\\tif keymaps.remove then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"d\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv remove ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Remove Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Sync packages\\n\\tif keymaps.sync then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"c\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync Packages\\\" }\\n\\t\\t)\\n\\tend\\n\\tif keymaps.sync_all then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"C\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync --all-extras --all-packages --all-groups')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync All Extras, Groups and Packages\\\" }\\n\\t\\t)\\n\\tend\\nend\\n\\n-- Set up auto commands\\nfunction M.setup_autocommands()\\n\\tif M.config.auto_commands then\\n\\t\\t-- Auto-activate .venv if it exists\\n\\t\\tif M.config.auto_activate_venv then\\n\\t\\t\\tM.auto_activate_venv()\\n\\n\\t\\t\\t-- Also set up auto-command to check when entering a directory\\n\\t\\t\\tvim.api.nvim_create_autocmd({ \\\"DirChanged\\\" }, {\\n\\t\\t\\t\\tpattern = { \\\"global\\\" },\\n\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\tM.auto_activate_venv()\\n\\t\\t\\t\\tend,\\n\\t\\t\\t})\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Main setup function\\nfunction M.setup(opts)\\n\\t-- Merge user configuration with defaults\\n\\tM.config = vim.tbl_deep_extend(\\\"force\\\", M.config, opts or {})\\n\\n\\t-- Set up commands\\n\\tM.setup_commands()\\n\\n\\t-- Set up keymaps if enabled\\n\\tif M.config.keymaps ~= false then\\n\\t\\tM.setup_keymaps()\\n\\tend\\n\\n\\t-- Set up autocommands if enabled\\n\\tif M.config.auto_commands ~= false then\\n\\t\\tM.setup_autocommands()\\n\\tend\\n\\n\\t-- Set up pickers if integration is enabled\\n\\tif M.config.picker_integration then\\n\\t\\tM.setup_pickers()\\n\\tend\\n\\n\\t-- Make run_command globally accessible (can be removed if not needed)\\n\\t_G.run_command = M.run_command\\nend\\n\\nreturn M\\n\\n```\\n\\nFile: init.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c511d8c928e741c8b6e3305bc85905a5"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"61044"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a79930cddb12af4b4bafdf3d6828b","spanId":"6ca03034e847f807","parentSpanId":"dc877c673c09ac94","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762976271581475000","endTimeUnixNano":"1762976271581475000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of 'get_buffer_globals =...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"get_buffer_globals ="}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a79930cddb12af4b4bafdf3d6828b","spanId":"39b04fa7221c2d5e","parentSpanId":"dc877c673c09ac94","flags":256,"name":"creating_quick_fix","kind":1,"startTimeUnixNano":"1762976271581639000","endTimeUnixNano":"1762976271581770000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"code_actions"}},{"key":"code.lineno","value":{"intValue":"332"}},{"key":"title","value":{"stringValue":"Improve global variable detection or provide a disclaimer."}},{"key":"logfire.msg_template","value":{"stringValue":"creating_quick_fix"}},{"key":"logfire.msg","value":{"stringValue":"creating_quick_fix"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"title\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a79930cddb12af4b4bafdf3d6828b","spanId":"dc877c673c09ac94","flags":256,"name":"code_actions","kind":1,"startTimeUnixNano":"1762976271581146000","endTimeUnixNano":"1762976271581834000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"code_actions"}},{"key":"code.lineno","value":{"intValue":"315"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"code_actions"}},{"key":"logfire.msg","value":{"stringValue":"code_actions"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a79931260f548a70bb5c3b3fcaee4","spanId":"edd119acacb4c933","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976272992562000","endTimeUnixNano":"1762976272992562000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7992d9d0c22ac6a3e062c1a002a9","spanId":"7de2285dd99fc87a","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976258512963000","endTimeUnixNano":"1762976273001315000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976272999414000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a79931269327c5bc4d68a0276044b","spanId":"2959c41df28221e7","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976273001495000","endTimeUnixNano":"1762976273001495000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7993164ad975275850b2f5a9db23","spanId":"69fd3ddad1dfde00","parentSpanId":"33719589e5eeb918","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976273994671000","endTimeUnixNano":"1762976273994671000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a7992d9d0c22ac6a3e062c1a002a9","spanId":"119ddc265c31f69b","parentSpanId":"aea5bc6b185b8639","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976258514466000","endTimeUnixNano":"1762976272992993000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a7992d9d0c22ac6a3e062c1a002a9","spanId":"aea5bc6b185b8639","parentSpanId":"7de2285dd99fc87a","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976258513940000","endTimeUnixNano":"1762976272993223000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\n-- uv.nvim - Neovim plugin for uv Python package management integration\\n-- Author: Ben O'Mahony\\n-- License: MIT\\n\\nlocal M = {}\\n\\n-- Default configuration\\nM.config = {\\n\\t-- Auto-activate virtual environments when found\\n\\tauto_activate_venv = true,\\n\\tnotify_activate_venv = true,\\n\\n\\t-- Auto commands for directory changes\\n\\tauto_commands = true,\\n\\n\\t-- Integration with picker (like Telescope or other UI components)\\n\\tpicker_integration = true,\\n\\n\\t-- Keymaps to register (set to false to disable)\\n\\tkeymaps = {\\n\\t\\tprefix = \\\"<leader>x\\\", -- Main prefix for UV commands\\n\\t\\tcommands = true, -- Show UV commands menu (<leader>x)\\n\\t\\trun_file = true, -- Run current file (<leader>xr)\\n\\t\\trun_selection = true, -- Run selection (<leader>xs)\\n\\t\\trun_function = true, -- Run function (<leader>xf)\\n\\t\\tvenv = true, -- Environment management (<leader>xe)\\n\\t\\tinit = true, -- Initialize UV project (<leader>xi)\\n\\t\\tadd = true, -- Add a package (<leader>xa)\\n\\t\\tremove = true, -- Remove a package (<leader>xd)\\n\\t\\tsync = true, -- Sync packages (<leader>xc)\\n\\t\\tsync_all = true, -- uv sync --all-extras --all-groups --all-packages (<leader>xC)\\n\\t},\\n\\n\\t-- Execution options\\n\\texecution = {\\n\\t\\t-- Python run command template\\n\\t\\trun_command = \\\"uv run python\\\",\\n\\n\\t\\t-- Show output in notifications\\n\\t\\tnotify_output = true,\\n\\n\\t\\t-- Notification timeout in ms\\n\\t\\tnotification_timeout = 10000,\\n\\t},\\n}\\n\\n-- Command runner - runs shell commands and captures output\\nfunction M.run_command(cmd)\\n\\t-- Run command in background and capture output\\n\\tvim.fn.jobstart(cmd, {\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Command completed successfully: \\\" .. cmd, vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Command failed: \\\" .. cmd, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Only show meaningful output (not empty lines)\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Show errors\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.WARN)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Virtual environment activation\\nfunction M.activate_venv(venv_path)\\n\\t-- For Mac, run the source command to apply to the current shell\\n\\tlocal command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n\\t-- Set environment variables for the current Neovim instance\\n\\tvim.env.VIRTUAL_ENV = venv_path\\n\\tvim.env.PATH = venv_path .. \\\"/bin:\\\" .. vim.env.PATH\\n\\t-- Notify user\\n\\tif M.config.notify_activate_venv then\\n\\t\\tvim.notify(\\\"Activated virtual environment: \\\" .. venv_path, vim.log.levels.INFO)\\n\\tend\\nend\\n\\n-- Auto-activate the .venv if it exists at the project root\\nfunction M.auto_activate_venv()\\n\\tlocal venv_path = vim.fn.getcwd() .. \\\"/.venv\\\"\\n\\tif vim.fn.isdirectory(venv_path) == 1 then\\n\\t\\tM.activate_venv(venv_path)\\n\\t\\treturn true\\n\\tend\\n\\treturn false\\nend\\n\\n-- Function to create a temporary file with the necessary context and selected code\\nfunction M.run_python_selection()\\n\\t-- Get visual selection\\n\\tlocal get_visual_selection = function()\\n\\t\\tlocal start_pos = vim.fn.getpos(\\\"'<\\\")\\n\\t\\tlocal end_pos = vim.fn.getpos(\\\"'>\\\")\\n\\t\\tlocal lines = vim.fn.getline(start_pos[2], end_pos[2])\\n\\n\\t\\tif #lines == 0 then\\n\\t\\t\\treturn \\\"\\\"\\n\\t\\tend\\n\\n\\t\\t-- Adjust last line to end at the column position of end_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[#lines] = lines[#lines]:sub(1, end_pos[3])\\n\\t\\tend\\n\\n\\t\\t-- Adjust first line to start at the column position of start_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[1] = lines[1]:sub(start_pos[3])\\n\\t\\tend\\n\\n\\t\\treturn table.concat(lines, \\\"\\\\n\\\")\\n\\tend\\n\\n\\t-- Get current buffer content to extract imports and global variables\\n\\tlocal get_buffer_globals = function()\\n\\t\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\t\\tlocal imports = {}\\n\\t\\tlocal globals = {}\\n\\t\\tlocal in_class = false\\n\\t\\tlocal class_indent = 0\\n\\n\\t\\tfor _, line in ipairs(lines) do\\n\\t\\t\\t-- Detect imports\\n\\t\\t\\tif line:match(\\\"^%s*import \\\") or line:match(\\\"^%s*from .+ import\\\") then\\n\\t\\t\\t\\ttable.insert(imports, line)\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect class definitions to skip class variables\\n\\t\\t\\tif line:match(\\\"^%s*class \\\") then\\n\\t\\t\\t\\tin_class = true\\n\\t\\t\\t\\tclass_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Check if we're exiting a class block\\n\\t\\t\\tif in_class and line:match(\\\"^%s*[^%s#]\\\") then\\n\\t\\t\\t\\tlocal current_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\t\\tif current_indent <= class_indent then\\n\\t\\t\\t\\t\\tin_class = false\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect global variable assignments (not in class, not inside functions)\\n\\t\\t\\tif not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\\n\\t\\t\\t\\t-- Check if it's not indented (global scope)\\n\\t\\t\\t\\tif not line:match(\\\"^%s%s+\\\") then\\n\\t\\t\\t\\t\\ttable.insert(globals, line)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend\\n\\n\\t\\treturn imports, globals\\n\\tend\\n\\n\\t-- Get selected code\\n\\tlocal selection = get_visual_selection()\\n\\tif selection == \\\"\\\" then\\n\\t\\tvim.notify(\\\"No code selected\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Get imports and globals\\n\\tlocal imports, globals = get_buffer_globals()\\n\\n\\t-- Create temp file\\n\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\tlocal temp_file = temp_dir .. \\\"/run_selection.py\\\"\\n\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\tif not file then\\n\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Write imports\\n\\tfor _, imp in ipairs(imports) do\\n\\t\\tfile:write(imp .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write globals\\n\\tfor _, glob in ipairs(globals) do\\n\\t\\tfile:write(glob .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write selected code\\n\\tfile:write(\\\"# SELECTED CODE\\\\n\\\")\\n\\n\\t-- Check if the selection is all indented (which would cause syntax errors)\\n\\tlocal is_all_indented = true\\n\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tif not line:match(\\\"^%s+\\\") and line ~= \\\"\\\" then\\n\\t\\t\\tis_all_indented = false\\n\\t\\t\\tbreak\\n\\t\\tend\\n\\tend\\n\\n\\t-- Process the selection to determine what type of code it is\\n\\tlocal is_function_def = selection:match(\\\"^%s*def%s+[%w_]+%s*%(\\\")\\n\\tlocal is_class_def = selection:match(\\\"^%s*class%s+[%w_]+\\\")\\n\\tlocal has_print = selection:match(\\\"print%s*%(\\\")\\n\\tlocal is_expression = not is_function_def\\n\\t\\tand not is_class_def\\n\\t\\tand not selection:match(\\\"=\\\")\\n\\t\\tand not selection:match(\\\"%s*for%s+\\\")\\n\\t\\tand not selection:match(\\\"%s*if%s+\\\")\\n\\t\\tand not has_print\\n\\n\\t-- If the selection is all indented, we need to dedent it or wrap it in a function\\n\\tif is_all_indented then\\n\\t\\tfile:write(\\\"def run_selection():\\\\n\\\")\\n\\t\\t-- Write the selection with original indentation\\n\\t\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\t\\tfile:write(\\\"    \\\" .. line .. \\\"\\\\n\\\")\\n\\t\\tend\\n\\t\\tfile:write(\\\"\\\\n# Auto-call the wrapper function\\\\n\\\")\\n\\t\\tfile:write(\\\"run_selection()\\\\n\\\")\\n\\telse\\n\\t\\t-- Write the original selection\\n\\t\\tfile:write(selection .. \\\"\\\\n\\\")\\n\\n\\t\\t-- For expressions, we'll add a print statement to see the result\\n\\t\\tif is_expression then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added print for expression\\\\n\\\")\\n\\t\\t\\tfile:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\\n\\t\\t-- For function definitions without calls, we'll add a call\\n\\t\\telseif is_function_def then\\n\\t\\t\\tlocal function_name = selection:match(\\\"def%s+([%w_]+)%s*%(\\\")\\n\\t\\t\\t-- Check if the function is already called in the selection\\n\\t\\t\\tif function_name and not selection:match(function_name .. \\\"%s*%(.-%)\\\") then\\n\\t\\t\\t\\tfile:write(\\\"\\\\n# Auto-added function call\\\\n\\\")\\n\\t\\t\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\t\\t\\tfile:write('    print(f\\\"Auto-executing function: ' .. function_name .. '\\\")\\\\n')\\n\\t\\t\\t\\tfile:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\\n\\t\\t\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\t\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\t\\tend\\n\\t\\t-- If there's no print statement in the code, add an output marker\\n\\t\\telseif not has_print and not selection:match(\\\"^%s*#\\\") then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added execution marker\\\\n\\\")\\n\\t\\t\\tfile:write('print(\\\"Code executed successfully.\\\")\\\\n')\\n\\t\\tend\\n\\tend\\n\\n\\tfile:close()\\n\\n\\t-- Run the temp file\\n\\tvim.notify(\\\"Running selected code...\\\", vim.log.levels.INFO)\\n\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Selected code executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Selected code execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Function to run a specific Python function\\nfunction M.run_python_function()\\n\\t-- Get current buffer content\\n\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\tlocal buffer_content = table.concat(lines, \\\"\\\\n\\\")\\n\\n\\t-- Find all function definitions\\n\\tlocal functions = {}\\n\\tfor line in buffer_content:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tlocal func_name = line:match(\\\"^def%s+([%w_]+)%s*%(\\\")\\n\\t\\tif func_name then\\n\\t\\t\\ttable.insert(functions, func_name)\\n\\t\\tend\\n\\tend\\n\\n\\tif #functions == 0 then\\n\\t\\tvim.notify(\\\"No functions found in current file\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Create temp file for function selection picker\\n\\tlocal run_function = function(func_name)\\n\\t\\t-- Create a temporary file with a main block to call the function\\n\\t\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\t\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\t\\tlocal temp_file = temp_dir .. \\\"/run_function.py\\\"\\n\\t\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\n\\t\\t-- Create a wrapper script that imports the current file and calls the function\\n\\t\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\t\\tif not file then\\n\\t\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\t\\treturn\\n\\t\\tend\\n\\n\\t\\t-- Get the module name (file name without .py)\\n\\t\\tlocal module_name = vim.fn.fnamemodify(current_file, \\\":t:r\\\")\\n\\t\\tlocal module_dir = vim.fn.fnamemodify(current_file, \\\":h\\\")\\n\\n\\t\\t-- Write imports\\n\\t\\tfile:write(\\\"import sys\\\\n\\\")\\n\\t\\tfile:write(\\\"sys.path.insert(0, \\\" .. vim.inspect(module_dir) .. \\\")\\\\n\\\")\\n\\t\\tfile:write(\\\"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\")\\n\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\tfile:write('    print(f\\\"Running function: ' .. func_name .. '\\\")\\\\n')\\n\\t\\tfile:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\\n\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\tfile:close()\\n\\n\\t\\t-- Run the temp file\\n\\t\\tvim.notify(\\\"Running function: \\\" .. func_name, vim.log.levels.INFO)\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\tend\\n\\n\\t-- If there's only one function, run it directly\\n\\tif #functions == 1 then\\n\\t\\trun_function(functions[1])\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Otherwise, show a picker to select the function\\n\\tvim.ui.select(functions, {\\n\\t\\tprompt = \\\"Select function to run:\\\",\\n\\t\\tformat_item = function(item)\\n\\t\\t\\treturn \\\"def \\\" .. item .. \\\"()\\\"\\n\\t\\tend,\\n\\t}, function(choice)\\n\\t\\tif choice then\\n\\t\\t\\trun_function(choice)\\n\\t\\tend\\n\\tend)\\nend\\n\\n-- Run current file\\nfunction M.run_file()\\n\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\tif current_file and current_file ~= \\\"\\\" then\\n\\t\\tvim.notify(\\\"Running: \\\" .. vim.fn.expand(\\\"%:t\\\"), vim.log.levels.INFO)\\n\\t\\t-- Run python on the current file and capture output to notifications\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(current_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution completed successfully\\\", vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\telse\\n\\t\\tvim.notify(\\\"No file is open\\\", vim.log.levels.WARN)\\n\\tend\\nend\\n\\n-- Set up command pickers for integration with UI plugins\\nfunction M.setup_pickers()\\n\\t-- Check if Snacks is available\\n\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t-- Register UV command source\\n\\t\\tSnacks.picker.sources.uv_commands = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t{ text = \\\"Run current file\\\", desc = \\\"Run current file with Python\\\", is_run_current = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run selection\\\", desc = \\\"Run selected Python code\\\", is_run_selection = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run function\\\", desc = \\\"Run specific Python function\\\", is_run_function = true },\\n\\t\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", desc = \\\"Install a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv sync\\\", desc = \\\"Sync packages from lockfile\\\" },\\n\\t\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\t\\tdesc = \\\"Sync all extras, groups and packages\\\",\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", desc = \\\"Remove a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv init\\\", desc = \\\"Initialize a new project\\\" },\\n\\t\\t\\t\\t}\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\treturn { { item.text .. \\\" - \\\" .. item.desc } }\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\t\\tif item.is_run_current then\\n\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_selection then\\n\\t\\t\\t\\t\\t\\t-- Check if there's a visual selection\\n\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\n\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\") -- Exit visual mode\\n\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t-- If not in visual mode, prompt the user to select text\\n\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t-- After notification, we'll set up a one-time autocmd to catch when visual mode is exited\\n\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\", -- When changing from any visual mode to normal mode\\n\\t\\t\\t\\t\\t\\t\\t\\tcallback = function(ev)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true -- Delete the autocmd after it's been triggered\\n\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_function then\\n\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\tlocal cmd = item.text\\n\\t\\t\\t\\t\\t-- Check if command needs input\\n\\t\\t\\t\\t\\tif cmd:match(\\\"%[(.-)%]\\\") then\\n\\t\\t\\t\\t\\t\\tlocal param_name = cmd:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\tvim.ui.input({ prompt = \\\"Enter \\\" .. param_name .. \\\": \\\" }, function(input)\\n\\t\\t\\t\\t\\t\\t\\tif not input or input == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t-- Replace the placeholder with actual input\\n\\t\\t\\t\\t\\t\\t\\tlocal actual_cmd = cmd:gsub(\\\"%[\\\" .. param_name .. \\\"%]\\\", input)\\n\\t\\t\\t\\t\\t\\t\\tM.run_command(actual_cmd)\\n\\t\\t\\t\\t\\t\\tend)\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t-- Run the command directly\\n\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\n\\t\\t-- Register UV venv source\\n\\t\\tSnacks.picker.sources.uv_venv = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\tlocal venvs = {}\\n\\t\\t\\t\\t-- Check for .venv directory (uv's default)\\n\\t\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\tif #venvs == 0 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\"Create new virtual environment (uv venv)\\\",\\n\\t\\t\\t\\t\\t\\tis_create = true,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\treturn venvs\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\treturn { { \\\"+ \\\" .. item.text } }\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tlocal icon = item.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\"\\n\\t\\t\\t\\t\\treturn { { icon .. item.text .. \\\" (Activate)\\\" } }\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\tM.activate_venv(item.path)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\tend\\n\\n\\t-- Check if Telescope is available\\n\\tlocal has_telescope, telescope = pcall(require, \\\"telescope\\\")\\n\\tif has_telescope then\\n\\t\\tlocal pickers = require(\\\"telescope.pickers\\\")\\n\\t\\tlocal finders = require(\\\"telescope.finders\\\")\\n\\t\\tlocal sorters = require(\\\"telescope.sorters\\\")\\n\\t\\tlocal actions = require(\\\"telescope.actions\\\")\\n\\t\\tlocal action_state = require(\\\"telescope.actions.state\\\")\\n\\n\\t\\t-- UV Commands picker for Telescope\\n\\t\\tM.pick_uv_commands = function()\\n\\t\\t\\tlocal items = {\\n\\t\\t\\t\\t{ text = \\\"Run current file\\\", is_run_current = true },\\n\\t\\t\\t\\t{ text = \\\"Run selection\\\", is_run_selection = true },\\n\\t\\t\\t\\t{ text = \\\"Run function\\\", is_run_function = true },\\n\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", cmd = \\\"uv add \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv sync\\\", cmd = \\\"uv sync\\\" },\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\tcmd = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", cmd = \\\"uv remove \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv init\\\", cmd = \\\"uv init\\\" },\\n\\t\\t\\t}\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Commands\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_run_current then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_selection then\\n\\t\\t\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\t\\t\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_function then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tif selection.needs_input then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal placeholder = selection.text:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.ui.input(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t{ prompt = \\\"Enter \\\" .. (placeholder or \\\"value\\\") .. \\\": \\\" },\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfunction(input)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tif input and input ~= \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal cmd = selection.cmd .. input\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(selection.cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\n\\t\\t-- UV venv picker for Telescope\\n\\t\\tM.pick_uv_venv = function()\\n\\t\\t\\tlocal items = {}\\n\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\ttable.insert(items, {\\n\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t})\\n\\t\\t\\tend\\n\\t\\t\\tif #items == 0 then\\n\\t\\t\\t\\ttable.insert(items, { text = \\\"Create new virtual environment (uv venv)\\\", is_create = true })\\n\\t\\t\\tend\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Virtual Environments\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\tlocal display = entry.is_create and \\\"+ \\\" .. entry.text\\n\\t\\t\\t\\t\\t\\t\\t\\tor ((entry.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\") .. entry.text .. \\\" (Activate)\\\")\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = display,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = display,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_create then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tM.activate_venv(selection.path)\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Set up user commands\\nfunction M.setup_commands()\\n\\t-- Set up UV commands\\n\\tvim.api.nvim_create_user_command(\\\"UVInit\\\", function()\\n\\t\\tM.run_command(\\\"uv init\\\")\\n\\tend, {})\\n\\n\\t-- Command to run selected code\\n\\tvim.api.nvim_create_user_command(\\\"UVRunSelection\\\", function()\\n\\t\\tM.run_python_selection()\\n\\tend, { range = true })\\n\\n\\t-- Command to run a specific function\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFunction\\\", function()\\n\\t\\tM.run_python_function()\\n\\tend, {})\\n\\n\\t-- Command to run the current file\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFile\\\", function()\\n\\t\\tM.run_file()\\n\\tend, {})\\n\\n\\t-- Command to add a package\\n\\tvim.api.nvim_create_user_command(\\\"UVAddPackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv add \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\n\\n\\t-- Command to remove a package\\n\\tvim.api.nvim_create_user_command(\\\"UVRemovePackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv remove \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\nend\\n\\n-- Set up keymaps\\nfunction M.setup_keymaps()\\n\\tlocal keymaps = M.config.keymaps\\n\\tlocal prefix = keymaps.prefix or \\\"<leader>x\\\"\\n\\n\\t-- Main UV command menu\\n\\tif keymaps.commands then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Run current file\\n\\tif keymaps.run_file then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"r\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFile<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Current File\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run selection\\n\\tif keymaps.run_selection then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"v\\\",\\n\\t\\t\\tprefix .. \\\"s\\\",\\n\\t\\t\\t\\\":<C-u>UVRunSelection<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Selection\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run function\\n\\tif keymaps.run_function then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"f\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFunction<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Function\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Environment management\\n\\tif keymaps.venv then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_venv')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope_venv = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope_venv then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_venv()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Initialize UV project\\n\\tif keymaps.init then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"i\\\",\\n\\t\\t\\t\\\"<cmd>UVInit<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Init\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Add a package\\n\\tif keymaps.add then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"a\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv add ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Add Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Remove a package\\n\\tif keymaps.remove then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"d\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv remove ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Remove Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Sync packages\\n\\tif keymaps.sync then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"c\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync Packages\\\" }\\n\\t\\t)\\n\\tend\\n\\tif keymaps.sync_all then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"C\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync --all-extras --all-packages --all-groups')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync All Extras, Groups and Packages\\\" }\\n\\t\\t)\\n\\tend\\nend\\n\\n-- Set up auto commands\\nfunction M.setup_autocommands()\\n\\tif M.config.auto_commands then\\n\\t\\t-- Auto-activate .venv if it exists\\n\\t\\tif M.config.auto_activate_venv then\\n\\t\\t\\tM.auto_activate_venv()\\n\\n\\t\\t\\t-- Also set up auto-command to check when entering a directory\\n\\t\\t\\tvim.api.nvim_create_autocmd({ \\\"DirChanged\\\" }, {\\n\\t\\t\\t\\tpattern = { \\\"global\\\" },\\n\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\tM.auto_activate_venv()\\n\\t\\t\\t\\tend,\\n\\t\\t\\t})\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Main setup function\\nfunction M.setup(opts)\\n\\t-- Merge user configuration with defaults\\n\\tM.config = vim.tbl_deep_extend(\\\"force\\\", M.config, opts or {})\\n\\n\\t-- Set up commands\\n\\tM.setup_commands()\\n\\n\\t-- Set up keymaps if enabled\\n\\tif M.config.keymaps ~= false then\\n\\t\\tM.setup_keymaps()\\n\\tend\\n\\n\\t-- Set up autocommands if enabled\\n\\tif M.config.auto_commands ~= false then\\n\\t\\tM.setup_autocommands()\\n\\tend\\n\\n\\t-- Set up pickers if integration is enabled\\n\\tif M.config.picker_integration then\\n\\t\\tM.setup_pickers()\\n\\tend\\n\\n\\t-- Make run_command globally accessible (can be removed if not needed)\\n\\t_G.run_command = M.run_command\\nend\\n\\nreturn M\\n\\n```\\n\\nFile: init.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c511d8c928e741c8b6e3305bc85905a5"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"61044"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a79932d7150b56cac11e2b16e3243","spanId":"59d563c10b5ceef8","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976279921809000","endTimeUnixNano":"1762976279921809000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7993164ad975275850b2f5a9db23","spanId":"33719589e5eeb918","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976273994236000","endTimeUnixNano":"1762976279936189000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976279933701000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a79932d800821e0683961141a925f","spanId":"9316692a72454748","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976279936408000","endTimeUnixNano":"1762976279936408000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7993315c9c41b736ecbc6b2ccb44","spanId":"25438de0bcfa6761","parentSpanId":"550e2de3540266d9","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976280926015000","endTimeUnixNano":"1762976280926015000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a7993164ad975275850b2f5a9db23","spanId":"7466ae4623eaed17","parentSpanId":"e3c93283bc84b8af","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976273996070000","endTimeUnixNano":"1762976279923407000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a7993164ad975275850b2f5a9db23","spanId":"e3c93283bc84b8af","parentSpanId":"33719589e5eeb918","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976273995462000","endTimeUnixNano":"1762976279923907000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\n-- uv.nvim - Neovim plugin for uv Python package management integration\\n-- Author: Ben O'Mahony\\n-- License: MIT\\n\\nlocal M = {}\\n\\n-- Default configuration\\nM.config = {\\n\\t-- Auto-activate virtual environments when found\\n\\tauto_activate_venv = true,\\n\\tnotify_activate_venv = true,\\n\\n\\t-- Auto commands for directory changes\\n\\tauto_commands = true,\\n\\n\\t-- Integration with picker (like Telescope or other UI components)\\n\\tpicker_integration = true,\\n\\n\\t-- Keymaps to register (set to false to disable)\\n\\tkeymaps = {\\n\\t\\tprefix = \\\"<leader>x\\\", -- Main prefix for UV commands\\n\\t\\tcommands = true, -- Show UV commands menu (<leader>x)\\n\\t\\trun_file = true, -- Run current file (<leader>xr)\\n\\t\\trun_selection = true, -- Run selection (<leader>xs)\\n\\t\\trun_function = true, -- Run function (<leader>xf)\\n\\t\\tvenv = true, -- Environment management (<leader>xe)\\n\\t\\tinit = true, -- Initialize UV project (<leader>xi)\\n\\t\\tadd = true, -- Add a package (<leader>xa)\\n\\t\\tremove = true, -- Remove a package (<leader>xd)\\n\\t\\tsync = true, -- Sync packages (<leader>xc)\\n\\t\\tsync_all = true, -- uv sync --all-extras --all-groups --all-packages (<leader>xC)\\n\\t},\\n\\n\\t-- Execution options\\n\\texecution = {\\n\\t\\t-- Python run command template\\n\\t\\trun_command = \\\"uv run python\\\",\\n\\n\\t\\t-- Show output in notifications\\n\\t\\tnotify_output = true,\\n\\n\\t\\t-- Notification timeout in ms\\n\\t\\tnotification_timeout = 10000,\\n\\t},\\n}\\n\\n-- Command runner - runs shell commands and captures output\\nfunction M.run_command(cmd)\\n\\t-- Run command in background and capture output\\n\\tvim.fn.jobstart(cmd, {\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Command completed successfully: \\\" .. cmd, vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Command failed: \\\" .. cmd, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Only show meaningful output (not empty lines)\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Show errors\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.WARN)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Virtual environment activation\\nfunction M.activate_venv(venv_path)\\n\\t-- For Mac, run the source command to apply to the current shell\\n\\tlocal command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n\\t-- Set environment variables for the current Neovim instance\\n\\tvim.env.VIRTUAL_ENV = venv_path\\n\\tvim.env.PATH = venv_path .. \\\"/bin:\\\" .. vim.env.PATH\\n\\t-- Notify user\\n\\tif M.config.notify_activate_venv then\\n\\t\\tvim.notify(\\\"Activated virtual environment: \\\" .. venv_path, vim.log.levels.INFO)\\n\\tend\\nend\\n\\n-- Auto-activate the .venv if it exists at the project root\\nfunction M.auto_activate_venv()\\n\\tlocal venv_path = vim.fn.getcwd() .. \\\"/.venv\\\"\\n\\tif vim.fn.isdirectory(venv_path) == 1 then\\n\\t\\tM.activate_venv(venv_path)\\n\\t\\treturn true\\n\\tend\\n\\treturn false\\nend\\n\\n-- Function to create a temporary file with the necessary context and selected code\\nfunction M.run_python_selection()\\n\\t-- Get visual selection\\n\\tlocal get_visual_selection = function()\\n\\t\\tlocal start_pos = vim.fn.getpos(\\\"'<\\\")\\n\\t\\tlocal end_pos = vim.fn.getpos(\\\"'>\\\")\\n\\t\\tlocal lines = vim.fn.getline(start_pos[2], end_pos[2])\\n\\n\\t\\tif #lines == 0 then\\n\\t\\t\\treturn \\\"\\\"\\n\\t\\tend\\n\\n\\t\\t-- Adjust last line to end at the column position of end_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[#lines] = lines[#lines]:sub(1, end_pos[3])\\n\\t\\tend\\n\\n\\t\\t-- Adjust first line to start at the column position of start_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[1] = lines[1]:sub(start_pos[3])\\n\\t\\tend\\n\\n\\t\\treturn table.concat(lines, \\\"\\\\n\\\")\\n\\tend\\n\\n\\t-- Get current buffer content to extract imports and global variables\\n\\tlocal get_buffer_globals = function() -- Consider using a more robust Python parser (if available via external tool) or adding a disclaimer about limitations.\\n\\t\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\t\\tlocal imports = {}\\n\\t\\tlocal globals = {}\\n\\t\\tlocal in_class = false\\n\\t\\tlocal class_indent = 0\\n\\n\\t\\tfor _, line in ipairs(lines) do\\n\\t\\t\\t-- Detect imports\\n\\t\\t\\tif line:match(\\\"^%s*import \\\") or line:match(\\\"^%s*from .+ import\\\") then\\n\\t\\t\\t\\ttable.insert(imports, line)\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect class definitions to skip class variables\\n\\t\\t\\tif line:match(\\\"^%s*class \\\") then\\n\\t\\t\\t\\tin_class = true\\n\\t\\t\\t\\tclass_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Check if we're exiting a class block\\n\\t\\t\\tif in_class and line:match(\\\"^%s*[^%s#]\\\") then\\n\\t\\t\\t\\tlocal current_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\t\\tif current_indent <= class_indent then\\n\\t\\t\\t\\t\\tin_class = false\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect global variable assignments (not in class, not inside functions)\\n\\t\\t\\tif not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\\n\\t\\t\\t\\t-- Check if it's not indented (global scope)\\n\\t\\t\\t\\tif not line:match(\\\"^%s%s+\\\") then\\n\\t\\t\\t\\t\\ttable.insert(globals, line)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend\\n\\n\\t\\treturn imports, globals\\n\\tend\\n\\n\\t-- Get selected code\\n\\tlocal selection = get_visual_selection()\\n\\tif selection == \\\"\\\" then\\n\\t\\tvim.notify(\\\"No code selected\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Get imports and globals\\n\\tlocal imports, globals = get_buffer_globals()\\n\\n\\t-- Create temp file\\n\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\tlocal temp_file = temp_dir .. \\\"/run_selection.py\\\"\\n\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\tif not file then\\n\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Write imports\\n\\tfor _, imp in ipairs(imports) do\\n\\t\\tfile:write(imp .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write globals\\n\\tfor _, glob in ipairs(globals) do\\n\\t\\tfile:write(glob .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write selected code\\n\\tfile:write(\\\"# SELECTED CODE\\\\n\\\")\\n\\n\\t-- Check if the selection is all indented (which would cause syntax errors)\\n\\tlocal is_all_indented = true\\n\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tif not line:match(\\\"^%s+\\\") and line ~= \\\"\\\" then\\n\\t\\t\\tis_all_indented = false\\n\\t\\t\\tbreak\\n\\t\\tend\\n\\tend\\n\\n\\t-- Process the selection to determine what type of code it is\\n\\tlocal is_function_def = selection:match(\\\"^%s*def%s+[%w_]+%s*%(\\\")\\n\\tlocal is_class_def = selection:match(\\\"^%s*class%s+[%w_]+\\\")\\n\\tlocal has_print = selection:match(\\\"print%s*%(\\\")\\n\\tlocal is_expression = not is_function_def\\n\\t\\tand not is_class_def\\n\\t\\tand not selection:match(\\\"=\\\")\\n\\t\\tand not selection:match(\\\"%s*for%s+\\\")\\n\\t\\tand not selection:match(\\\"%s*if%s+\\\")\\n\\t\\tand not has_print\\n\\n\\t-- If the selection is all indented, we need to dedent it or wrap it in a function\\n\\tif is_all_indented then\\n\\t\\tfile:write(\\\"def run_selection():\\\\n\\\")\\n\\t\\t-- Write the selection with original indentation\\n\\t\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\t\\tfile:write(\\\"    \\\" .. line .. \\\"\\\\n\\\")\\n\\t\\tend\\n\\t\\tfile:write(\\\"\\\\n# Auto-call the wrapper function\\\\n\\\")\\n\\t\\tfile:write(\\\"run_selection()\\\\n\\\")\\n\\telse\\n\\t\\t-- Write the original selection\\n\\t\\tfile:write(selection .. \\\"\\\\n\\\")\\n\\n\\t\\t-- For expressions, we'll add a print statement to see the result\\n\\t\\tif is_expression then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added print for expression\\\\n\\\")\\n\\t\\t\\tfile:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\\n\\t\\t-- For function definitions without calls, we'll add a call\\n\\t\\telseif is_function_def then\\n\\t\\t\\tlocal function_name = selection:match(\\\"def%s+([%w_]+)%s*%(\\\")\\n\\t\\t\\t-- Check if the function is already called in the selection\\n\\t\\t\\tif function_name and not selection:match(function_name .. \\\"%s*%(.-%)\\\") then\\n\\t\\t\\t\\tfile:write(\\\"\\\\n# Auto-added function call\\\\n\\\")\\n\\t\\t\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\t\\t\\tfile:write('    print(f\\\"Auto-executing function: ' .. function_name .. '\\\")\\\\n')\\n\\t\\t\\t\\tfile:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\\n\\t\\t\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\t\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\t\\tend\\n\\t\\t-- If there's no print statement in the code, add an output marker\\n\\t\\telseif not has_print and not selection:match(\\\"^%s*#\\\") then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added execution marker\\\\n\\\")\\n\\t\\t\\tfile:write('print(\\\"Code executed successfully.\\\")\\\\n')\\n\\t\\tend\\n\\tend\\n\\n\\tfile:close()\\n\\n\\t-- Run the temp file\\n\\tvim.notify(\\\"Running selected code...\\\", vim.log.levels.INFO)\\n\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Selected code executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Selected code execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Function to run a specific Python function\\nfunction M.run_python_function()\\n\\t-- Get current buffer content\\n\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\tlocal buffer_content = table.concat(lines, \\\"\\\\n\\\")\\n\\n\\t-- Find all function definitions\\n\\tlocal functions = {}\\n\\tfor line in buffer_content:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tlocal func_name = line:match(\\\"^def%s+([%w_]+)%s*%(\\\")\\n\\t\\tif func_name then\\n\\t\\t\\ttable.insert(functions, func_name)\\n\\t\\tend\\n\\tend\\n\\n\\tif #functions == 0 then\\n\\t\\tvim.notify(\\\"No functions found in current file\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Create temp file for function selection picker\\n\\tlocal run_function = function(func_name)\\n\\t\\t-- Create a temporary file with a main block to call the function\\n\\t\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\t\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\t\\tlocal temp_file = temp_dir .. \\\"/run_function.py\\\"\\n\\t\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\n\\t\\t-- Create a wrapper script that imports the current file and calls the function\\n\\t\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\t\\tif not file then\\n\\t\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\t\\treturn\\n\\t\\tend\\n\\n\\t\\t-- Get the module name (file name without .py)\\n\\t\\tlocal module_name = vim.fn.fnamemodify(current_file, \\\":t:r\\\")\\n\\t\\tlocal module_dir = vim.fn.fnamemodify(current_file, \\\":h\\\")\\n\\n\\t\\t-- Write imports\\n\\t\\tfile:write(\\\"import sys\\\\n\\\")\\n\\t\\tfile:write(\\\"sys.path.insert(0, \\\" .. vim.inspect(module_dir) .. \\\")\\\\n\\\")\\n\\t\\tfile:write(\\\"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\")\\n\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\tfile:write('    print(f\\\"Running function: ' .. func_name .. '\\\")\\\\n')\\n\\t\\tfile:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\\n\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\tfile:close()\\n\\n\\t\\t-- Run the temp file\\n\\t\\tvim.notify(\\\"Running function: \\\" .. func_name, vim.log.levels.INFO)\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\tend\\n\\n\\t-- If there's only one function, run it directly\\n\\tif #functions == 1 then\\n\\t\\trun_function(functions[1])\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Otherwise, show a picker to select the function\\n\\tvim.ui.select(functions, {\\n\\t\\tprompt = \\\"Select function to run:\\\",\\n\\t\\tformat_item = function(item)\\n\\t\\t\\treturn \\\"def \\\" .. item .. \\\"()\\\"\\n\\t\\tend,\\n\\t}, function(choice)\\n\\t\\tif choice then\\n\\t\\t\\trun_function(choice)\\n\\t\\tend\\n\\tend)\\nend\\n\\n-- Run current file\\nfunction M.run_file()\\n\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\tif current_file and current_file ~= \\\"\\\" then\\n\\t\\tvim.notify(\\\"Running: \\\" .. vim.fn.expand(\\\"%:t\\\"), vim.log.levels.INFO)\\n\\t\\t-- Run python on the current file and capture output to notifications\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(current_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution completed successfully\\\", vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\telse\\n\\t\\tvim.notify(\\\"No file is open\\\", vim.log.levels.WARN)\\n\\tend\\nend\\n\\n-- Set up command pickers for integration with UI plugins\\nfunction M.setup_pickers()\\n\\t-- Check if Snacks is available\\n\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t-- Register UV command source\\n\\t\\tSnacks.picker.sources.uv_commands = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t{ text = \\\"Run current file\\\", desc = \\\"Run current file with Python\\\", is_run_current = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run selection\\\", desc = \\\"Run selected Python code\\\", is_run_selection = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run function\\\", desc = \\\"Run specific Python function\\\", is_run_function = true },\\n\\t\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", desc = \\\"Install a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv sync\\\", desc = \\\"Sync packages from lockfile\\\" },\\n\\t\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\t\\tdesc = \\\"Sync all extras, groups and packages\\\",\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", desc = \\\"Remove a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv init\\\", desc = \\\"Initialize a new project\\\" },\\n\\t\\t\\t\\t}\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\treturn { { item.text .. \\\" - \\\" .. item.desc } }\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\t\\tif item.is_run_current then\\n\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_selection then\\n\\t\\t\\t\\t\\t\\t-- Check if there's a visual selection\\n\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\n\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\") -- Exit visual mode\\n\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t-- If not in visual mode, prompt the user to select text\\n\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t-- After notification, we'll set up a one-time autocmd to catch when visual mode is exited\\n\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\", -- When changing from any visual mode to normal mode\\n\\t\\t\\t\\t\\t\\t\\t\\tcallback = function(ev)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true -- Delete the autocmd after it's been triggered\\n\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_function then\\n\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\tlocal cmd = item.text\\n\\t\\t\\t\\t\\t-- Check if command needs input\\n\\t\\t\\t\\t\\tif cmd:match(\\\"%[(.-)%]\\\") then\\n\\t\\t\\t\\t\\t\\tlocal param_name = cmd:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\tvim.ui.input({ prompt = \\\"Enter \\\" .. param_name .. \\\": \\\" }, function(input)\\n\\t\\t\\t\\t\\t\\t\\tif not input or input == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t-- Replace the placeholder with actual input\\n\\t\\t\\t\\t\\t\\t\\tlocal actual_cmd = cmd:gsub(\\\"%[\\\" .. param_name .. \\\"%]\\\", input)\\n\\t\\t\\t\\t\\t\\t\\tM.run_command(actual_cmd)\\n\\t\\t\\t\\t\\t\\tend)\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t-- Run the command directly\\n\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\n\\t\\t-- Register UV venv source\\n\\t\\tSnacks.picker.sources.uv_venv = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\tlocal venvs = {}\\n\\t\\t\\t\\t-- Check for .venv directory (uv's default)\\n\\t\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\tif #venvs == 0 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\"Create new virtual environment (uv venv)\\\",\\n\\t\\t\\t\\t\\t\\tis_create = true,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\treturn venvs\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\treturn { { \\\"+ \\\" .. item.text } }\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tlocal icon = item.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\"\\n\\t\\t\\t\\t\\treturn { { icon .. item.text .. \\\" (Activate)\\\" } }\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\tM.activate_venv(item.path)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\tend\\n\\n\\t-- Check if Telescope is available\\n\\tlocal has_telescope, telescope = pcall(require, \\\"telescope\\\")\\n\\tif has_telescope then\\n\\t\\tlocal pickers = require(\\\"telescope.pickers\\\")\\n\\t\\tlocal finders = require(\\\"telescope.finders\\\")\\n\\t\\tlocal sorters = require(\\\"telescope.sorters\\\")\\n\\t\\tlocal actions = require(\\\"telescope.actions\\\")\\n\\t\\tlocal action_state = require(\\\"telescope.actions.state\\\")\\n\\n\\t\\t-- UV Commands picker for Telescope\\n\\t\\tM.pick_uv_commands = function()\\n\\t\\t\\tlocal items = {\\n\\t\\t\\t\\t{ text = \\\"Run current file\\\", is_run_current = true },\\n\\t\\t\\t\\t{ text = \\\"Run selection\\\", is_run_selection = true },\\n\\t\\t\\t\\t{ text = \\\"Run function\\\", is_run_function = true },\\n\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", cmd = \\\"uv add \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv sync\\\", cmd = \\\"uv sync\\\" },\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\tcmd = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", cmd = \\\"uv remove \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv init\\\", cmd = \\\"uv init\\\" },\\n\\t\\t\\t}\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Commands\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_run_current then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_selection then\\n\\t\\t\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\t\\t\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_function then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tif selection.needs_input then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal placeholder = selection.text:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.ui.input(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t{ prompt = \\\"Enter \\\" .. (placeholder or \\\"value\\\") .. \\\": \\\" },\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfunction(input)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tif input and input ~= \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal cmd = selection.cmd .. input\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(selection.cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\n\\t\\t-- UV venv picker for Telescope\\n\\t\\tM.pick_uv_venv = function()\\n\\t\\t\\tlocal items = {}\\n\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\ttable.insert(items, {\\n\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t})\\n\\t\\t\\tend\\n\\t\\t\\tif #items == 0 then\\n\\t\\t\\t\\ttable.insert(items, { text = \\\"Create new virtual environment (uv venv)\\\", is_create = true })\\n\\t\\t\\tend\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Virtual Environments\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\tlocal display = entry.is_create and \\\"+ \\\" .. entry.text\\n\\t\\t\\t\\t\\t\\t\\t\\tor ((entry.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\") .. entry.text .. \\\" (Activate)\\\")\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = display,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = display,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_create then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tM.activate_venv(selection.path)\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Set up user commands\\nfunction M.setup_commands()\\n\\t-- Set up UV commands\\n\\tvim.api.nvim_create_user_command(\\\"UVInit\\\", function()\\n\\t\\tM.run_command(\\\"uv init\\\")\\n\\tend, {})\\n\\n\\t-- Command to run selected code\\n\\tvim.api.nvim_create_user_command(\\\"UVRunSelection\\\", function()\\n\\t\\tM.run_python_selection()\\n\\tend, { range = true })\\n\\n\\t-- Command to run a specific function\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFunction\\\", function()\\n\\t\\tM.run_python_function()\\n\\tend, {})\\n\\n\\t-- Command to run the current file\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFile\\\", function()\\n\\t\\tM.run_file()\\n\\tend, {})\\n\\n\\t-- Command to add a package\\n\\tvim.api.nvim_create_user_command(\\\"UVAddPackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv add \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\n\\n\\t-- Command to remove a package\\n\\tvim.api.nvim_create_user_command(\\\"UVRemovePackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv remove \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\nend\\n\\n-- Set up keymaps\\nfunction M.setup_keymaps()\\n\\tlocal keymaps = M.config.keymaps\\n\\tlocal prefix = keymaps.prefix or \\\"<leader>x\\\"\\n\\n\\t-- Main UV command menu\\n\\tif keymaps.commands then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Run current file\\n\\tif keymaps.run_file then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"r\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFile<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Current File\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run selection\\n\\tif keymaps.run_selection then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"v\\\",\\n\\t\\t\\tprefix .. \\\"s\\\",\\n\\t\\t\\t\\\":<C-u>UVRunSelection<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Selection\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run function\\n\\tif keymaps.run_function then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"f\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFunction<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Function\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Environment management\\n\\tif keymaps.venv then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_venv')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope_venv = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope_venv then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_venv()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Initialize UV project\\n\\tif keymaps.init then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"i\\\",\\n\\t\\t\\t\\\"<cmd>UVInit<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Init\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Add a package\\n\\tif keymaps.add then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"a\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv add ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Add Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Remove a package\\n\\tif keymaps.remove then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"d\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv remove ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Remove Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Sync packages\\n\\tif keymaps.sync then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"c\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync Packages\\\" }\\n\\t\\t)\\n\\tend\\n\\tif keymaps.sync_all then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"C\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync --all-extras --all-packages --all-groups')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync All Extras, Groups and Packages\\\" }\\n\\t\\t)\\n\\tend\\nend\\n\\n-- Set up auto commands\\nfunction M.setup_autocommands()\\n\\tif M.config.auto_commands then\\n\\t\\t-- Auto-activate .venv if it exists\\n\\t\\tif M.config.auto_activate_venv then\\n\\t\\t\\tM.auto_activate_venv()\\n\\n\\t\\t\\t-- Also set up auto-command to check when entering a directory\\n\\t\\t\\tvim.api.nvim_create_autocmd({ \\\"DirChanged\\\" }, {\\n\\t\\t\\t\\tpattern = { \\\"global\\\" },\\n\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\tM.auto_activate_venv()\\n\\t\\t\\t\\tend,\\n\\t\\t\\t})\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Main setup function\\nfunction M.setup(opts)\\n\\t-- Merge user configuration with defaults\\n\\tM.config = vim.tbl_deep_extend(\\\"force\\\", M.config, opts or {})\\n\\n\\t-- Set up commands\\n\\tM.setup_commands()\\n\\n\\t-- Set up keymaps if enabled\\n\\tif M.config.keymaps ~= false then\\n\\t\\tM.setup_keymaps()\\n\\tend\\n\\n\\t-- Set up autocommands if enabled\\n\\tif M.config.auto_commands ~= false then\\n\\t\\tM.setup_autocommands()\\n\\tend\\n\\n\\t-- Set up pickers if integration is enabled\\n\\tif M.config.picker_integration then\\n\\t\\tM.setup_pickers()\\n\\tend\\n\\n\\t-- Make run_command globally accessible (can be removed if not needed)\\n\\t_G.run_command = M.run_command\\nend\\n\\nreturn M\\n\\n```\\n\\nFile: init.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c511d8c928e741c8b6e3305bc85905a5"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"61044"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a799350b0ac6121e1116984fe1134","spanId":"e44ccc8bc0a950ba","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976288944789000","endTimeUnixNano":"1762976288944789000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7993315c9c41b736ecbc6b2ccb44","spanId":"550e2de3540266d9","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976280924916000","endTimeUnixNano":"1762976288955013000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976288953275000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a799350bba5084306da28b1d1d306","spanId":"91a2b9461ec25966","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976288955189000","endTimeUnixNano":"1762976288955189000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a7993549b8291b7082827b06faf93","spanId":"24438a890c8c217b","parentSpanId":"dbf1d8d5b0951067","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976289948480000","endTimeUnixNano":"1762976289948480000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799354f83953afd0d5e669c127e6","spanId":"0e24282e27f66795","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976290040861000","endTimeUnixNano":"1762976290040861000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a7993549b8291b7082827b06faf93","spanId":"dbf1d8d5b0951067","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976289947622000","endTimeUnixNano":"1762976290050616000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976290048664000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a79935502420515f4ff325b4d9cf9","spanId":"bf7e0ea9b3793076","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976290050802000","endTimeUnixNano":"1762976290050802000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799358e35e2d8f7adcb3e78a18ef","spanId":"92643f81bda77c54","parentSpanId":"7842d85ebfa626f4","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976291044111000","endTimeUnixNano":"1762976291044111000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a7993315c9c41b736ecbc6b2ccb44","spanId":"89188f6c834f9543","parentSpanId":"c40ad79c357f8e20","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976280931548000","endTimeUnixNano":"1762976288945624000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a7993315c9c41b736ecbc6b2ccb44","spanId":"c40ad79c357f8e20","parentSpanId":"550e2de3540266d9","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976280928450000","endTimeUnixNano":"1762976288946037000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\n-- uv.nvim - Neovim plugin for uv Python package management integration\\n-- Author: Ben O'Mahony\\n-- License: MIT\\n\\nlocal M = {}\\n\\n-- Default configuration\\nM.config = {\\n\\t-- Auto-activate virtual environments when found\\n\\tauto_activate_venv = true,\\n\\tnotify_activate_venv = true,\\n\\n\\t-- Auto commands for directory changes\\n\\tauto_commands = true,\\n\\n\\t-- Integration with picker (like Telescope or other UI components)\\n\\tpicker_integration = true,\\n\\n\\t-- Keymaps to register (set to false to disable)\\n\\tkeymaps = {\\n\\t\\tprefix = \\\"<leader>x\\\", -- Main prefix for UV commands\\n\\t\\tcommands = true, -- Show UV commands menu (<leader>x)\\n\\t\\trun_file = true, -- Run current file (<leader>xr)\\n\\t\\trun_selection = true, -- Run selection (<leader>xs)\\n\\t\\trun_function = true, -- Run function (<leader>xf)\\n\\t\\tvenv = true, -- Environment management (<leader>xe)\\n\\t\\tinit = true, -- Initialize UV project (<leader>xi)\\n\\t\\tadd = true, -- Add a package (<leader>xa)\\n\\t\\tremove = true, -- Remove a package (<leader>xd)\\n\\t\\tsync = true, -- Sync packages (<leader>xc)\\n\\t\\tsync_all = true, -- uv sync --all-extras --all-groups --all-packages (<leader>xC)\\n\\t},\\n\\n\\t-- Execution options\\n\\texecution = {\\n\\t\\t-- Python run command template\\n\\t\\trun_command = \\\"uv run python\\\",\\n\\n\\t\\t-- Show output in notifications\\n\\t\\tnotify_output = true,\\n\\n\\t\\t-- Notification timeout in ms\\n\\t\\tnotification_timeout = 10000,\\n\\t},\\n}\\n\\n-- Command runner - runs shell commands and captures output\\nfunction M.run_command(cmd)\\n\\t-- Run command in background and capture output\\n\\tvim.fn.jobstart(cmd, {\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Command completed successfully: \\\" .. cmd, vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Command failed: \\\" .. cmd, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Only show meaningful output (not empty lines)\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Show errors\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.WARN)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Virtual environment activation\\nfunction M.activate_venv(venv_path)\\n\\t-- For Mac, run the source command to apply to the current shell\\n\\tlocal command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n\\t-- Set environment variables for the current Neovim instance\\n\\tvim.env.VIRTUAL_ENV = venv_path\\n\\tvim.env.PATH = venv_path .. \\\"/bin:\\\" .. vim.env.PATH\\n\\t-- Notify user\\n\\tif M.config.notify_activate_venv then\\n\\t\\tvim.notify(\\\"Activated virtual environment: \\\" .. venv_path, vim.log.levels.INFO)\\n\\tend\\nend\\n\\n-- Auto-activate the .venv if it exists at the project root\\nfunction M.auto_activate_venv()\\n\\tlocal venv_path = vim.fn.getcwd() .. \\\"/.venv\\\"\\n\\tif vim.fn.isdirectory(venv_path) == 1 then\\n\\t\\tM.activate_venv(venv_path)\\n\\t\\treturn true\\n\\tend\\n\\treturn false\\nend\\n\\n-- Function to create a temporary file with the necessary context and selected code\\nfunction M.run_python_selection()\\n\\t-- Get visual selection\\n\\tlocal get_visual_selection = function()\\n\\t\\tlocal start_pos = vim.fn.getpos(\\\"'<\\\")\\n\\t\\tlocal end_pos = vim.fn.getpos(\\\"'>\\\")\\n\\t\\tlocal lines = vim.fn.getline(start_pos[2], end_pos[2])\\n\\n\\t\\tif #lines == 0 then\\n\\t\\t\\treturn \\\"\\\"\\n\\t\\tend\\n\\n\\t\\t-- Adjust last line to end at the column position of end_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[#lines] = lines[#lines]:sub(1, end_pos[3])\\n\\t\\tend\\n\\n\\t\\t-- Adjust first line to start at the column position of start_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[1] = lines[1]:sub(start_pos[3])\\n\\t\\tend\\n\\n\\t\\treturn table.concat(lines, \\\"\\\\n\\\")\\n\\tend\\n\\n\\t-- Get current buffer content to extract imports and global variables\\n\\tlocal get_buffer_globals = function()\\n\\t\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\t\\tlocal imports = {}\\n\\t\\tlocal globals = {}\\n\\t\\tlocal in_class = false\\n\\t\\tlocal class_indent = 0\\n\\n\\t\\tfor _, line in ipairs(lines) do\\n\\t\\t\\t-- Detect imports\\n\\t\\t\\tif line:match(\\\"^%s*import \\\") or line:match(\\\"^%s*from .+ import\\\") then\\n\\t\\t\\t\\ttable.insert(imports, line)\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect class definitions to skip class variables\\n\\t\\t\\tif line:match(\\\"^%s*class \\\") then\\n\\t\\t\\t\\tin_class = true\\n\\t\\t\\t\\tclass_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Check if we're exiting a class block\\n\\t\\t\\tif in_class and line:match(\\\"^%s*[^%s#]\\\") then\\n\\t\\t\\t\\tlocal current_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\t\\tif current_indent <= class_indent then\\n\\t\\t\\t\\t\\tin_class = false\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect global variable assignments (not in class, not inside functions)\\n\\t\\t\\tif not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\\n\\t\\t\\t\\t-- Check if it's not indented (global scope)\\n\\t\\t\\t\\tif not line:match(\\\"^%s%s+\\\") then\\n\\t\\t\\t\\t\\ttable.insert(globals, line)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend\\n\\n\\t\\treturn imports, globals\\n\\tend\\n\\n\\t-- Get selected code\\n\\tlocal selection = get_visual_selection()\\n\\tif selection == \\\"\\\" then\\n\\t\\tvim.notify(\\\"No code selected\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Get imports and globals\\n\\tlocal imports, globals = get_buffer_globals()\\n\\n\\t-- Create temp file\\n\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\tlocal temp_file = temp_dir .. \\\"/run_selection.py\\\"\\n\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\tif not file then\\n\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Write imports\\n\\tfor _, imp in ipairs(imports) do\\n\\t\\tfile:write(imp .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write globals\\n\\tfor _, glob in ipairs(globals) do\\n\\t\\tfile:write(glob .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write selected code\\n\\tfile:write(\\\"# SELECTED CODE\\\\n\\\")\\n\\n\\t-- Check if the selection is all indented (which would cause syntax errors)\\n\\tlocal is_all_indented = true\\n\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tif not line:match(\\\"^%s+\\\") and line ~= \\\"\\\" then\\n\\t\\t\\tis_all_indented = false\\n\\t\\t\\tbreak\\n\\t\\tend\\n\\tend\\n\\n\\t-- Process the selection to determine what type of code it is\\n\\tlocal is_function_def = selection:match(\\\"^%s*def%s+[%w_]+%s*%(\\\")\\n\\tlocal is_class_def = selection:match(\\\"^%s*class%s+[%w_]+\\\")\\n\\tlocal has_print = selection:match(\\\"print%s*%(\\\")\\n\\tlocal is_expression = not is_function_def\\n\\t\\tand not is_class_def\\n\\t\\tand not selection:match(\\\"=\\\")\\n\\t\\tand not selection:match(\\\"%s*for%s+\\\")\\n\\t\\tand not selection:match(\\\"%s*if%s+\\\")\\n\\t\\tand not has_print\\n\\n\\t-- If the selection is all indented, we need to dedent it or wrap it in a function\\n\\tif is_all_indented then\\n\\t\\tfile:write(\\\"def run_selection():\\\\n\\\")\\n\\t\\t-- Write the selection with original indentation\\n\\t\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\t\\tfile:write(\\\"    \\\" .. line .. \\\"\\\\n\\\")\\n\\t\\tend\\n\\t\\tfile:write(\\\"\\\\n# Auto-call the wrapper function\\\\n\\\")\\n\\t\\tfile:write(\\\"run_selection()\\\\n\\\")\\n\\telse\\n\\t\\t-- Write the original selection\\n\\t\\tfile:write(selection .. \\\"\\\\n\\\")\\n\\n\\t\\t-- For expressions, we'll add a print statement to see the result\\n\\t\\tif is_expression then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added print for expression\\\\n\\\")\\n\\t\\t\\tfile:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\\n\\t\\t-- For function definitions without calls, we'll add a call\\n\\t\\telseif is_function_def then\\n\\t\\t\\tlocal function_name = selection:match(\\\"def%s+([%w_]+)%s*%(\\\")\\n\\t\\t\\t-- Check if the function is already called in the selection\\n\\t\\t\\tif function_name and not selection:match(function_name .. \\\"%s*%(.-%)\\\") then\\n\\t\\t\\t\\tfile:write(\\\"\\\\n# Auto-added function call\\\\n\\\")\\n\\t\\t\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\t\\t\\tfile:write('    print(f\\\"Auto-executing function: ' .. function_name .. '\\\")\\\\n')\\n\\t\\t\\t\\tfile:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\\n\\t\\t\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\t\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\t\\tend\\n\\t\\t-- If there's no print statement in the code, add an output marker\\n\\t\\telseif not has_print and not selection:match(\\\"^%s*#\\\") then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added execution marker\\\\n\\\")\\n\\t\\t\\tfile:write('print(\\\"Code executed successfully.\\\")\\\\n')\\n\\t\\tend\\n\\tend\\n\\n\\tfile:close()\\n\\n\\t-- Run the temp file\\n\\tvim.notify(\\\"Running selected code...\\\", vim.log.levels.INFO)\\n\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Selected code executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Selected code execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Function to run a specific Python function\\nfunction M.run_python_function()\\n\\t-- Get current buffer content\\n\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\tlocal buffer_content = table.concat(lines, \\\"\\\\n\\\")\\n\\n\\t-- Find all function definitions\\n\\tlocal functions = {}\\n\\tfor line in buffer_content:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tlocal func_name = line:match(\\\"^def%s+([%w_]+)%s*%(\\\")\\n\\t\\tif func_name then\\n\\t\\t\\ttable.insert(functions, func_name)\\n\\t\\tend\\n\\tend\\n\\n\\tif #functions == 0 then\\n\\t\\tvim.notify(\\\"No functions found in current file\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Create temp file for function selection picker\\n\\tlocal run_function = function(func_name)\\n\\t\\t-- Create a temporary file with a main block to call the function\\n\\t\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\t\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\t\\tlocal temp_file = temp_dir .. \\\"/run_function.py\\\"\\n\\t\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\n\\t\\t-- Create a wrapper script that imports the current file and calls the function\\n\\t\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\t\\tif not file then\\n\\t\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\t\\treturn\\n\\t\\tend\\n\\n\\t\\t-- Get the module name (file name without .py)\\n\\t\\tlocal module_name = vim.fn.fnamemodify(current_file, \\\":t:r\\\")\\n\\t\\tlocal module_dir = vim.fn.fnamemodify(current_file, \\\":h\\\")\\n\\n\\t\\t-- Write imports\\n\\t\\tfile:write(\\\"import sys\\\\n\\\")\\n\\t\\tfile:write(\\\"sys.path.insert(0, \\\" .. vim.inspect(module_dir) .. \\\")\\\\n\\\")\\n\\t\\tfile:write(\\\"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\")\\n\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\tfile:write('    print(f\\\"Running function: ' .. func_name .. '\\\")\\\\n')\\n\\t\\tfile:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\\n\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\tfile:close()\\n\\n\\t\\t-- Run the temp file\\n\\t\\tvim.notify(\\\"Running function: \\\" .. func_name, vim.log.levels.INFO)\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\tend\\n\\n\\t-- If there's only one function, run it directly\\n\\tif #functions == 1 then\\n\\t\\trun_function(functions[1])\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Otherwise, show a picker to select the function\\n\\tvim.ui.select(functions, {\\n\\t\\tprompt = \\\"Select function to run:\\\",\\n\\t\\tformat_item = function(item)\\n\\t\\t\\treturn \\\"def \\\" .. item .. \\\"()\\\"\\n\\t\\tend,\\n\\t}, function(choice)\\n\\t\\tif choice then\\n\\t\\t\\trun_function(choice)\\n\\t\\tend\\n\\tend)\\nend\\n\\n-- Run current file\\nfunction M.run_file()\\n\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\tif current_file and current_file ~= \\\"\\\" then\\n\\t\\tvim.notify(\\\"Running: \\\" .. vim.fn.expand(\\\"%:t\\\"), vim.log.levels.INFO)\\n\\t\\t-- Run python on the current file and capture output to notifications\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(current_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution completed successfully\\\", vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\telse\\n\\t\\tvim.notify(\\\"No file is open\\\", vim.log.levels.WARN)\\n\\tend\\nend\\n\\n-- Set up command pickers for integration with UI plugins\\nfunction M.setup_pickers()\\n\\t-- Check if Snacks is available\\n\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t-- Register UV command source\\n\\t\\tSnacks.picker.sources.uv_commands = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t{ text = \\\"Run current file\\\", desc = \\\"Run current file with Python\\\", is_run_current = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run selection\\\", desc = \\\"Run selected Python code\\\", is_run_selection = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run function\\\", desc = \\\"Run specific Python function\\\", is_run_function = true },\\n\\t\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", desc = \\\"Install a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv sync\\\", desc = \\\"Sync packages from lockfile\\\" },\\n\\t\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\t\\tdesc = \\\"Sync all extras, groups and packages\\\",\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", desc = \\\"Remove a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv init\\\", desc = \\\"Initialize a new project\\\" },\\n\\t\\t\\t\\t}\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\treturn { { item.text .. \\\" - \\\" .. item.desc } }\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\t\\tif item.is_run_current then\\n\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_selection then\\n\\t\\t\\t\\t\\t\\t-- Check if there's a visual selection\\n\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\n\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\") -- Exit visual mode\\n\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t-- If not in visual mode, prompt the user to select text\\n\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t-- After notification, we'll set up a one-time autocmd to catch when visual mode is exited\\n\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\", -- When changing from any visual mode to normal mode\\n\\t\\t\\t\\t\\t\\t\\t\\tcallback = function(ev)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true -- Delete the autocmd after it's been triggered\\n\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_function then\\n\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\tlocal cmd = item.text\\n\\t\\t\\t\\t\\t-- Check if command needs input\\n\\t\\t\\t\\t\\tif cmd:match(\\\"%[(.-)%]\\\") then\\n\\t\\t\\t\\t\\t\\tlocal param_name = cmd:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\tvim.ui.input({ prompt = \\\"Enter \\\" .. param_name .. \\\": \\\" }, function(input)\\n\\t\\t\\t\\t\\t\\t\\tif not input or input == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t-- Replace the placeholder with actual input\\n\\t\\t\\t\\t\\t\\t\\tlocal actual_cmd = cmd:gsub(\\\"%[\\\" .. param_name .. \\\"%]\\\", input)\\n\\t\\t\\t\\t\\t\\t\\tM.run_command(actual_cmd)\\n\\t\\t\\t\\t\\t\\tend)\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t-- Run the command directly\\n\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\n\\t\\t-- Register UV venv source\\n\\t\\tSnacks.picker.sources.uv_venv = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\tlocal venvs = {}\\n\\t\\t\\t\\t-- Check for .venv directory (uv's default)\\n\\t\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\tif #venvs == 0 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\"Create new virtual environment (uv venv)\\\",\\n\\t\\t\\t\\t\\t\\tis_create = true,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\treturn venvs\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\treturn { { \\\"+ \\\" .. item.text } }\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tlocal icon = item.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\"\\n\\t\\t\\t\\t\\treturn { { icon .. item.text .. \\\" (Activate)\\\" } }\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\tM.activate_venv(item.path)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\tend\\n\\n\\t-- Check if Telescope is available\\n\\tlocal has_telescope, telescope = pcall(require, \\\"telescope\\\")\\n\\tif has_telescope then\\n\\t\\tlocal pickers = require(\\\"telescope.pickers\\\")\\n\\t\\tlocal finders = require(\\\"telescope.finders\\\")\\n\\t\\tlocal sorters = require(\\\"telescope.sorters\\\")\\n\\t\\tlocal actions = require(\\\"telescope.actions\\\")\\n\\t\\tlocal action_state = require(\\\"telescope.actions.state\\\")\\n\\n\\t\\t-- UV Commands picker for Telescope\\n\\t\\tM.pick_uv_commands = function()\\n\\t\\t\\tlocal items = {\\n\\t\\t\\t\\t{ text = \\\"Run current file\\\", is_run_current = true },\\n\\t\\t\\t\\t{ text = \\\"Run selection\\\", is_run_selection = true },\\n\\t\\t\\t\\t{ text = \\\"Run function\\\", is_run_function = true },\\n\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", cmd = \\\"uv add \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv sync\\\", cmd = \\\"uv sync\\\" },\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\tcmd = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", cmd = \\\"uv remove \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv init\\\", cmd = \\\"uv init\\\" },\\n\\t\\t\\t}\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Commands\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_run_current then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_selection then\\n\\t\\t\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\t\\t\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_function then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tif selection.needs_input then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal placeholder = selection.text:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.ui.input(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t{ prompt = \\\"Enter \\\" .. (placeholder or \\\"value\\\") .. \\\": \\\" },\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfunction(input)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tif input and input ~= \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal cmd = selection.cmd .. input\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(selection.cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\n\\t\\t-- UV venv picker for Telescope\\n\\t\\tM.pick_uv_venv = function()\\n\\t\\t\\tlocal items = {}\\n\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\ttable.insert(items, {\\n\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t})\\n\\t\\t\\tend\\n\\t\\t\\tif #items == 0 then\\n\\t\\t\\t\\ttable.insert(items, { text = \\\"Create new virtual environment (uv venv)\\\", is_create = true })\\n\\t\\t\\tend\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Virtual Environments\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\tlocal display = entry.is_create and \\\"+ \\\" .. entry.text\\n\\t\\t\\t\\t\\t\\t\\t\\tor ((entry.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\") .. entry.text .. \\\" (Activate)\\\")\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = display,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = display,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_create then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tM.activate_venv(selection.path)\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Set up user commands\\nfunction M.setup_commands()\\n\\t-- Set up UV commands\\n\\tvim.api.nvim_create_user_command(\\\"UVInit\\\", function()\\n\\t\\tM.run_command(\\\"uv init\\\")\\n\\tend, {})\\n\\n\\t-- Command to run selected code\\n\\tvim.api.nvim_create_user_command(\\\"UVRunSelection\\\", function()\\n\\t\\tM.run_python_selection()\\n\\tend, { range = true })\\n\\n\\t-- Command to run a specific function\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFunction\\\", function()\\n\\t\\tM.run_python_function()\\n\\tend, {})\\n\\n\\t-- Command to run the current file\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFile\\\", function()\\n\\t\\tM.run_file()\\n\\tend, {})\\n\\n\\t-- Command to add a package\\n\\tvim.api.nvim_create_user_command(\\\"UVAddPackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv add \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\n\\n\\t-- Command to remove a package\\n\\tvim.api.nvim_create_user_command(\\\"UVRemovePackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv remove \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\nend\\n\\n-- Set up keymaps\\nfunction M.setup_keymaps()\\n\\tlocal keymaps = M.config.keymaps\\n\\tlocal prefix = keymaps.prefix or \\\"<leader>x\\\"\\n\\n\\t-- Main UV command menu\\n\\tif keymaps.commands then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Run current file\\n\\tif keymaps.run_file then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"r\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFile<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Current File\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run selection\\n\\tif keymaps.run_selection then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"v\\\",\\n\\t\\t\\tprefix .. \\\"s\\\",\\n\\t\\t\\t\\\":<C-u>UVRunSelection<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Selection\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run function\\n\\tif keymaps.run_function then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"f\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFunction<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Function\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Environment management\\n\\tif keymaps.venv then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_venv')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope_venv = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope_venv then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_venv()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Initialize UV project\\n\\tif keymaps.init then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"i\\\",\\n\\t\\t\\t\\\"<cmd>UVInit<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Init\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Add a package\\n\\tif keymaps.add then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"a\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv add ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Add Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Remove a package\\n\\tif keymaps.remove then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"d\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv remove ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Remove Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Sync packages\\n\\tif keymaps.sync then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"c\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync Packages\\\" }\\n\\t\\t)\\n\\tend\\n\\tif keymaps.sync_all then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"C\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync --all-extras --all-packages --all-groups')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync All Extras, Groups and Packages\\\" }\\n\\t\\t)\\n\\tend\\nend\\n\\n-- Set up auto commands\\nfunction M.setup_autocommands()\\n\\tif M.config.auto_commands then\\n\\t\\t-- Auto-activate .venv if it exists\\n\\t\\tif M.config.auto_activate_venv then\\n\\t\\t\\tM.auto_activate_venv()\\n\\n\\t\\t\\t-- Also set up auto-command to check when entering a directory\\n\\t\\t\\tvim.api.nvim_create_autocmd({ \\\"DirChanged\\\" }, {\\n\\t\\t\\t\\tpattern = { \\\"global\\\" },\\n\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\tM.auto_activate_venv()\\n\\t\\t\\t\\tend,\\n\\t\\t\\t})\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Main setup function\\nfunction M.setup(opts)\\n\\t-- Merge user configuration with defaults\\n\\tM.config = vim.tbl_deep_extend(\\\"force\\\", M.config, opts or {})\\n\\n\\t-- Set up commands\\n\\tM.setup_commands()\\n\\n\\t-- Set up keymaps if enabled\\n\\tif M.config.keymaps ~= false then\\n\\t\\tM.setup_keymaps()\\n\\tend\\n\\n\\t-- Set up autocommands if enabled\\n\\tif M.config.auto_commands ~= false then\\n\\t\\tM.setup_autocommands()\\n\\tend\\n\\n\\t-- Set up pickers if integration is enabled\\n\\tif M.config.picker_integration then\\n\\t\\tM.setup_pickers()\\n\\tend\\n\\n\\t-- Make run_command globally accessible (can be removed if not needed)\\n\\t_G.run_command = M.run_command\\nend\\n\\nreturn M\\n\\n```\\n\\nFile: init.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}},{"traceId":"019a7993549b8291b7082827b06faf93","spanId":"3e628549a10d59bf","parentSpanId":"bf59872d9948c3b8","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976289951268000","endTimeUnixNano":"1762976290041442000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a7993549b8291b7082827b06faf93","spanId":"bf59872d9948c3b8","parentSpanId":"dbf1d8d5b0951067","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976289950056000","endTimeUnixNano":"1762976290041718000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\n-- uv.nvim - Neovim plugin for uv Python package management integration\\n-- Author: Ben O'Mahony\\n-- License: MIT\\n\\nlocal M = {}\\n\\n-- Default configuration\\nM.config = {\\n\\t-- Auto-activate virtual environments when found\\n\\tauto_activate_venv = true,\\n\\tnotify_activate_venv = true,\\n\\n\\t-- Auto commands for directory changes\\n\\tauto_commands = true,\\n\\n\\t-- Integration with picker (like Telescope or other UI components)\\n\\tpicker_integration = true,\\n\\n\\t-- Keymaps to register (set to false to disable)\\n\\tkeymaps = {\\n\\t\\tprefix = \\\"<leader>x\\\", -- Main prefix for UV commands\\n\\t\\tcommands = true, -- Show UV commands menu (<leader>x)\\n\\t\\trun_file = true, -- Run current file (<leader>xr)\\n\\t\\trun_selection = true, -- Run selection (<leader>xs)\\n\\t\\trun_function = true, -- Run function (<leader>xf)\\n\\t\\tvenv = true, -- Environment management (<leader>xe)\\n\\t\\tinit = true, -- Initialize UV project (<leader>xi)\\n\\t\\tadd = true, -- Add a package (<leader>xa)\\n\\t\\tremove = true, -- Remove a package (<leader>xd)\\n\\t\\tsync = true, -- Sync packages (<leader>xc)\\n\\t\\tsync_all = true, -- uv sync --all-extras --all-groups --all-packages (<leader>xC)\\n\\t},\\n\\n\\t-- Execution options\\n\\texecution = {\\n\\t\\t-- Python run command template\\n\\t\\trun_command = \\\"uv run python\\\",\\n\\n\\t\\t-- Show output in notifications\\n\\t\\tnotify_output = true,\\n\\n\\t\\t-- Notification timeout in ms\\n\\t\\tnotification_timeout = 10000,\\n\\t},\\n}\\n\\n-- Command runner - runs shell commands and captures output\\nfunction M.run_command(cmd)\\n\\t-- Run command in background and capture output\\n\\tvim.fn.jobstart(cmd, {\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Command completed successfully: \\\" .. cmd, vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Command failed: \\\" .. cmd, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Only show meaningful output (not empty lines)\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Show errors\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.WARN)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Virtual environment activation\\nfunction M.activate_venv(venv_path)\\n\\t-- For Mac, run the source command to apply to the current shell\\n\\tlocal command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n\\t-- Set environment variables for the current Neovim instance\\n\\tvim.env.VIRTUAL_ENV = venv_path\\n\\tvim.env.PATH = venv_path .. \\\"/bin:\\\" .. vim.env.PATH\\n\\t-- Notify user\\n\\tif M.config.notify_activate_venv then\\n\\t\\tvim.notify(\\\"Activated virtual environment: \\\" .. venv_path, vim.log.levels.INFO)\\n\\tend\\nend\\n\\n-- Auto-activate the .venv if it exists at the project root\\nfunction M.auto_activate_venv()\\n\\tlocal venv_path = vim.fn.getcwd() .. \\\"/.venv\\\"\\n\\tif vim.fn.isdirectory(venv_path) == 1 then\\n\\t\\tM.activate_venv(venv_path)\\n\\t\\treturn true\\n\\tend\\n\\treturn false\\nend\\n\\n-- Function to create a temporary file with the necessary context and selected code\\nfunction M.run_python_selection()\\n\\t-- Get visual selection\\n\\tlocal get_visual_selection = function()\\n\\t\\tlocal start_pos = vim.fn.getpos(\\\"'<\\\")\\n\\t\\tlocal end_pos = vim.fn.getpos(\\\"'>\\\")\\n\\t\\tlocal lines = vim.fn.getline(start_pos[2], end_pos[2])\\n\\n\\t\\tif #lines == 0 then\\n\\t\\t\\treturn \\\"\\\"\\n\\t\\tend\\n\\n\\t\\t-- Adjust last line to end at the column position of end_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[#lines] = lines[#lines]:sub(1, end_pos[3])\\n\\t\\tend\\n\\n\\t\\t-- Adjust first line to start at the column position of start_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[1] = lines[1]:sub(start_pos[3])\\n\\t\\tend\\n\\n\\t\\treturn table.concat(lines, \\\"\\\\n\\\")\\n\\tend\\n\\n\\t-- Get current buffer content to extract imports and global variables\\n\\tlocal wget_buffer_globals = function()\\n\\t\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\t\\tlocal imports = {}\\n\\t\\tlocal globals = {}\\n\\t\\tlocal in_class = false\\n\\t\\tlocal class_indent = 0\\n\\n\\t\\tfor _, line in ipairs(lines) do\\n\\t\\t\\t-- Detect imports\\n\\t\\t\\tif line:match(\\\"^%s*import \\\") or line:match(\\\"^%s*from .+ import\\\") then\\n\\t\\t\\t\\ttable.insert(imports, line)\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect class definitions to skip class variables\\n\\t\\t\\tif line:match(\\\"^%s*class \\\") then\\n\\t\\t\\t\\tin_class = true\\n\\t\\t\\t\\tclass_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Check if we're exiting a class block\\n\\t\\t\\tif in_class and line:match(\\\"^%s*[^%s#]\\\") then\\n\\t\\t\\t\\tlocal current_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\t\\tif current_indent <= class_indent then\\n\\t\\t\\t\\t\\tin_class = false\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect global variable assignments (not in class, not inside functions)\\n\\t\\t\\tif not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\\n\\t\\t\\t\\t-- Check if it's not indented (global scope)\\n\\t\\t\\t\\tif not line:match(\\\"^%s%s+\\\") then\\n\\t\\t\\t\\t\\ttable.insert(globals, line)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend\\n\\n\\t\\treturn imports, globals\\n\\tend\\n\\n\\t-- Get selected code\\n\\tlocal selection = get_visual_selection()\\n\\tif selection == \\\"\\\" then\\n\\t\\tvim.notify(\\\"No code selected\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Get imports and globals\\n\\tlocal imports, globals = get_buffer_globals()\\n\\n\\t-- Create temp file\\n\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\tlocal temp_file = temp_dir .. \\\"/run_selection.py\\\"\\n\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\tif not file then\\n\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Write imports\\n\\tfor _, imp in ipairs(imports) do\\n\\t\\tfile:write(imp .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write globals\\n\\tfor _, glob in ipairs(globals) do\\n\\t\\tfile:write(glob .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write selected code\\n\\tfile:write(\\\"# SELECTED CODE\\\\n\\\")\\n\\n\\t-- Check if the selection is all indented (which would cause syntax errors)\\n\\tlocal is_all_indented = true\\n\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tif not line:match(\\\"^%s+\\\") and line ~= \\\"\\\" then\\n\\t\\t\\tis_all_indented = false\\n\\t\\t\\tbreak\\n\\t\\tend\\n\\tend\\n\\n\\t-- Process the selection to determine what type of code it is\\n\\tlocal is_function_def = selection:match(\\\"^%s*def%s+[%w_]+%s*%(\\\")\\n\\tlocal is_class_def = selection:match(\\\"^%s*class%s+[%w_]+\\\")\\n\\tlocal has_print = selection:match(\\\"print%s*%(\\\")\\n\\tlocal is_expression = not is_function_def\\n\\t\\tand not is_class_def\\n\\t\\tand not selection:match(\\\"=\\\")\\n\\t\\tand not selection:match(\\\"%s*for%s+\\\")\\n\\t\\tand not selection:match(\\\"%s*if%s+\\\")\\n\\t\\tand not has_print\\n\\n\\t-- If the selection is all indented, we need to dedent it or wrap it in a function\\n\\tif is_all_indented then\\n\\t\\tfile:write(\\\"def run_selection():\\\\n\\\")\\n\\t\\t-- Write the selection with original indentation\\n\\t\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\t\\tfile:write(\\\"    \\\" .. line .. \\\"\\\\n\\\")\\n\\t\\tend\\n\\t\\tfile:write(\\\"\\\\n# Auto-call the wrapper function\\\\n\\\")\\n\\t\\tfile:write(\\\"run_selection()\\\\n\\\")\\n\\telse\\n\\t\\t-- Write the original selection\\n\\t\\tfile:write(selection .. \\\"\\\\n\\\")\\n\\n\\t\\t-- For expressions, we'll add a print statement to see the result\\n\\t\\tif is_expression then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added print for expression\\\\n\\\")\\n\\t\\t\\tfile:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\\n\\t\\t-- For function definitions without calls, we'll add a call\\n\\t\\telseif is_function_def then\\n\\t\\t\\tlocal function_name = selection:match(\\\"def%s+([%w_]+)%s*%(\\\")\\n\\t\\t\\t-- Check if the function is already called in the selection\\n\\t\\t\\tif function_name and not selection:match(function_name .. \\\"%s*%(.-%)\\\") then\\n\\t\\t\\t\\tfile:write(\\\"\\\\n# Auto-added function call\\\\n\\\")\\n\\t\\t\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\t\\t\\tfile:write('    print(f\\\"Auto-executing function: ' .. function_name .. '\\\")\\\\n')\\n\\t\\t\\t\\tfile:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\\n\\t\\t\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\t\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\t\\tend\\n\\t\\t-- If there's no print statement in the code, add an output marker\\n\\t\\telseif not has_print and not selection:match(\\\"^%s*#\\\") then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added execution marker\\\\n\\\")\\n\\t\\t\\tfile:write('print(\\\"Code executed successfully.\\\")\\\\n')\\n\\t\\tend\\n\\tend\\n\\n\\tfile:close()\\n\\n\\t-- Run the temp file\\n\\tvim.notify(\\\"Running selected code...\\\", vim.log.levels.INFO)\\n\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Selected code executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Selected code execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Function to run a specific Python function\\nfunction M.run_python_function()\\n\\t-- Get current buffer content\\n\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\tlocal buffer_content = table.concat(lines, \\\"\\\\n\\\")\\n\\n\\t-- Find all function definitions\\n\\tlocal functions = {}\\n\\tfor line in buffer_content:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tlocal func_name = line:match(\\\"^def%s+([%w_]+)%s*%(\\\")\\n\\t\\tif func_name then\\n\\t\\t\\ttable.insert(functions, func_name)\\n\\t\\tend\\n\\tend\\n\\n\\tif #functions == 0 then\\n\\t\\tvim.notify(\\\"No functions found in current file\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Create temp file for function selection picker\\n\\tlocal run_function = function(func_name)\\n\\t\\t-- Create a temporary file with a main block to call the function\\n\\t\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\t\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\t\\tlocal temp_file = temp_dir .. \\\"/run_function.py\\\"\\n\\t\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\n\\t\\t-- Create a wrapper script that imports the current file and calls the function\\n\\t\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\t\\tif not file then\\n\\t\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\t\\treturn\\n\\t\\tend\\n\\n\\t\\t-- Get the module name (file name without .py)\\n\\t\\tlocal module_name = vim.fn.fnamemodify(current_file, \\\":t:r\\\")\\n\\t\\tlocal module_dir = vim.fn.fnamemodify(current_file, \\\":h\\\")\\n\\n\\t\\t-- Write imports\\n\\t\\tfile:write(\\\"import sys\\\\n\\\")\\n\\t\\tfile:write(\\\"sys.path.insert(0, \\\" .. vim.inspect(module_dir) .. \\\")\\\\n\\\")\\n\\t\\tfile:write(\\\"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\")\\n\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\tfile:write('    print(f\\\"Running function: ' .. func_name .. '\\\")\\\\n')\\n\\t\\tfile:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\\n\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\tfile:close()\\n\\n\\t\\t-- Run the temp file\\n\\t\\tvim.notify(\\\"Running function: \\\" .. func_name, vim.log.levels.INFO)\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\tend\\n\\n\\t-- If there's only one function, run it directly\\n\\tif #functions == 1 then\\n\\t\\trun_function(functions[1])\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Otherwise, show a picker to select the function\\n\\tvim.ui.select(functions, {\\n\\t\\tprompt = \\\"Select function to run:\\\",\\n\\t\\tformat_item = function(item)\\n\\t\\t\\treturn \\\"def \\\" .. item .. \\\"()\\\"\\n\\t\\tend,\\n\\t}, function(choice)\\n\\t\\tif choice then\\n\\t\\t\\trun_function(choice)\\n\\t\\tend\\n\\tend)\\nend\\n\\n-- Run current file\\nfunction M.run_file()\\n\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\tif current_file and current_file ~= \\\"\\\" then\\n\\t\\tvim.notify(\\\"Running: \\\" .. vim.fn.expand(\\\"%:t\\\"), vim.log.levels.INFO)\\n\\t\\t-- Run python on the current file and capture output to notifications\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(current_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution completed successfully\\\", vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\telse\\n\\t\\tvim.notify(\\\"No file is open\\\", vim.log.levels.WARN)\\n\\tend\\nend\\n\\n-- Set up command pickers for integration with UI plugins\\nfunction M.setup_pickers()\\n\\t-- Check if Snacks is available\\n\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t-- Register UV command source\\n\\t\\tSnacks.picker.sources.uv_commands = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t{ text = \\\"Run current file\\\", desc = \\\"Run current file with Python\\\", is_run_current = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run selection\\\", desc = \\\"Run selected Python code\\\", is_run_selection = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run function\\\", desc = \\\"Run specific Python function\\\", is_run_function = true },\\n\\t\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", desc = \\\"Install a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv sync\\\", desc = \\\"Sync packages from lockfile\\\" },\\n\\t\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\t\\tdesc = \\\"Sync all extras, groups and packages\\\",\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", desc = \\\"Remove a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv init\\\", desc = \\\"Initialize a new project\\\" },\\n\\t\\t\\t\\t}\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\treturn { { item.text .. \\\" - \\\" .. item.desc } }\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\t\\tif item.is_run_current then\\n\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_selection then\\n\\t\\t\\t\\t\\t\\t-- Check if there's a visual selection\\n\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\n\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\") -- Exit visual mode\\n\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t-- If not in visual mode, prompt the user to select text\\n\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t-- After notification, we'll set up a one-time autocmd to catch when visual mode is exited\\n\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\", -- When changing from any visual mode to normal mode\\n\\t\\t\\t\\t\\t\\t\\t\\tcallback = function(ev)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true -- Delete the autocmd after it's been triggered\\n\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_function then\\n\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\tlocal cmd = item.text\\n\\t\\t\\t\\t\\t-- Check if command needs input\\n\\t\\t\\t\\t\\tif cmd:match(\\\"%[(.-)%]\\\") then\\n\\t\\t\\t\\t\\t\\tlocal param_name = cmd:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\tvim.ui.input({ prompt = \\\"Enter \\\" .. param_name .. \\\": \\\" }, function(input)\\n\\t\\t\\t\\t\\t\\t\\tif not input or input == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t-- Replace the placeholder with actual input\\n\\t\\t\\t\\t\\t\\t\\tlocal actual_cmd = cmd:gsub(\\\"%[\\\" .. param_name .. \\\"%]\\\", input)\\n\\t\\t\\t\\t\\t\\t\\tM.run_command(actual_cmd)\\n\\t\\t\\t\\t\\t\\tend)\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t-- Run the command directly\\n\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\n\\t\\t-- Register UV venv source\\n\\t\\tSnacks.picker.sources.uv_venv = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\tlocal venvs = {}\\n\\t\\t\\t\\t-- Check for .venv directory (uv's default)\\n\\t\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\tif #venvs == 0 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\"Create new virtual environment (uv venv)\\\",\\n\\t\\t\\t\\t\\t\\tis_create = true,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\treturn venvs\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\treturn { { \\\"+ \\\" .. item.text } }\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tlocal icon = item.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\"\\n\\t\\t\\t\\t\\treturn { { icon .. item.text .. \\\" (Activate)\\\" } }\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\tM.activate_venv(item.path)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\tend\\n\\n\\t-- Check if Telescope is available\\n\\tlocal has_telescope, telescope = pcall(require, \\\"telescope\\\")\\n\\tif has_telescope then\\n\\t\\tlocal pickers = require(\\\"telescope.pickers\\\")\\n\\t\\tlocal finders = require(\\\"telescope.finders\\\")\\n\\t\\tlocal sorters = require(\\\"telescope.sorters\\\")\\n\\t\\tlocal actions = require(\\\"telescope.actions\\\")\\n\\t\\tlocal action_state = require(\\\"telescope.actions.state\\\")\\n\\n\\t\\t-- UV Commands picker for Telescope\\n\\t\\tM.pick_uv_commands = function()\\n\\t\\t\\tlocal items = {\\n\\t\\t\\t\\t{ text = \\\"Run current file\\\", is_run_current = true },\\n\\t\\t\\t\\t{ text = \\\"Run selection\\\", is_run_selection = true },\\n\\t\\t\\t\\t{ text = \\\"Run function\\\", is_run_function = true },\\n\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", cmd = \\\"uv add \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv sync\\\", cmd = \\\"uv sync\\\" },\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\tcmd = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", cmd = \\\"uv remove \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv init\\\", cmd = \\\"uv init\\\" },\\n\\t\\t\\t}\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Commands\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_run_current then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_selection then\\n\\t\\t\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\t\\t\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_function then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tif selection.needs_input then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal placeholder = selection.text:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.ui.input(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t{ prompt = \\\"Enter \\\" .. (placeholder or \\\"value\\\") .. \\\": \\\" },\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfunction(input)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tif input and input ~= \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal cmd = selection.cmd .. input\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(selection.cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\n\\t\\t-- UV venv picker for Telescope\\n\\t\\tM.pick_uv_venv = function()\\n\\t\\t\\tlocal items = {}\\n\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\ttable.insert(items, {\\n\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t})\\n\\t\\t\\tend\\n\\t\\t\\tif #items == 0 then\\n\\t\\t\\t\\ttable.insert(items, { text = \\\"Create new virtual environment (uv venv)\\\", is_create = true })\\n\\t\\t\\tend\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Virtual Environments\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\tlocal display = entry.is_create and \\\"+ \\\" .. entry.text\\n\\t\\t\\t\\t\\t\\t\\t\\tor ((entry.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\") .. entry.text .. \\\" (Activate)\\\")\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = display,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = display,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_create then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tM.activate_venv(selection.path)\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Set up user commands\\nfunction M.setup_commands()\\n\\t-- Set up UV commands\\n\\tvim.api.nvim_create_user_command(\\\"UVInit\\\", function()\\n\\t\\tM.run_command(\\\"uv init\\\")\\n\\tend, {})\\n\\n\\t-- Command to run selected code\\n\\tvim.api.nvim_create_user_command(\\\"UVRunSelection\\\", function()\\n\\t\\tM.run_python_selection()\\n\\tend, { range = true })\\n\\n\\t-- Command to run a specific function\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFunction\\\", function()\\n\\t\\tM.run_python_function()\\n\\tend, {})\\n\\n\\t-- Command to run the current file\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFile\\\", function()\\n\\t\\tM.run_file()\\n\\tend, {})\\n\\n\\t-- Command to add a package\\n\\tvim.api.nvim_create_user_command(\\\"UVAddPackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv add \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\n\\n\\t-- Command to remove a package\\n\\tvim.api.nvim_create_user_command(\\\"UVRemovePackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv remove \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\nend\\n\\n-- Set up keymaps\\nfunction M.setup_keymaps()\\n\\tlocal keymaps = M.config.keymaps\\n\\tlocal prefix = keymaps.prefix or \\\"<leader>x\\\"\\n\\n\\t-- Main UV command menu\\n\\tif keymaps.commands then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Run current file\\n\\tif keymaps.run_file then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"r\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFile<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Current File\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run selection\\n\\tif keymaps.run_selection then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"v\\\",\\n\\t\\t\\tprefix .. \\\"s\\\",\\n\\t\\t\\t\\\":<C-u>UVRunSelection<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Selection\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run function\\n\\tif keymaps.run_function then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"f\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFunction<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Function\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Environment management\\n\\tif keymaps.venv then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_venv')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope_venv = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope_venv then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_venv()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Initialize UV project\\n\\tif keymaps.init then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"i\\\",\\n\\t\\t\\t\\\"<cmd>UVInit<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Init\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Add a package\\n\\tif keymaps.add then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"a\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv add ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Add Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Remove a package\\n\\tif keymaps.remove then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"d\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv remove ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Remove Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Sync packages\\n\\tif keymaps.sync then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"c\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync Packages\\\" }\\n\\t\\t)\\n\\tend\\n\\tif keymaps.sync_all then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"C\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync --all-extras --all-packages --all-groups')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync All Extras, Groups and Packages\\\" }\\n\\t\\t)\\n\\tend\\nend\\n\\n-- Set up auto commands\\nfunction M.setup_autocommands()\\n\\tif M.config.auto_commands then\\n\\t\\t-- Auto-activate .venv if it exists\\n\\t\\tif M.config.auto_activate_venv then\\n\\t\\t\\tM.auto_activate_venv()\\n\\n\\t\\t\\t-- Also set up auto-command to check when entering a directory\\n\\t\\t\\tvim.api.nvim_create_autocmd({ \\\"DirChanged\\\" }, {\\n\\t\\t\\t\\tpattern = { \\\"global\\\" },\\n\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\tM.auto_activate_venv()\\n\\t\\t\\t\\tend,\\n\\t\\t\\t})\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Main setup function\\nfunction M.setup(opts)\\n\\t-- Merge user configuration with defaults\\n\\tM.config = vim.tbl_deep_extend(\\\"force\\\", M.config, opts or {})\\n\\n\\t-- Set up commands\\n\\tM.setup_commands()\\n\\n\\t-- Set up keymaps if enabled\\n\\tif M.config.keymaps ~= false then\\n\\t\\tM.setup_keymaps()\\n\\tend\\n\\n\\t-- Set up autocommands if enabled\\n\\tif M.config.auto_commands ~= false then\\n\\t\\tM.setup_autocommands()\\n\\tend\\n\\n\\t-- Set up pickers if integration is enabled\\n\\tif M.config.picker_integration then\\n\\t\\tM.setup_pickers()\\n\\tend\\n\\n\\t-- Make run_command globally accessible (can be removed if not needed)\\n\\t_G.run_command = M.run_command\\nend\\n\\nreturn M\\n\\n```\\n\\nFile: init.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c511d8c928e741c8b6e3305bc85905a5"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"61044"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a799359bafafc370ca6511bc0c6d8","spanId":"a326d50776b97e23","parentSpanId":"1d52486aea3a7139","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762976291258499000","endTimeUnixNano":"1762976291258499000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of 'get_buffer_globals =...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"get_buffer_globals ="}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a799359bafafc370ca6511bc0c6d8","spanId":"b52ade61752319b7","parentSpanId":"1d52486aea3a7139","flags":256,"name":"creating_quick_fix","kind":1,"startTimeUnixNano":"1762976291258663000","endTimeUnixNano":"1762976291258774000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"code_actions"}},{"key":"code.lineno","value":{"intValue":"332"}},{"key":"title","value":{"stringValue":"Improve global variable detection or provide a disclaimer."}},{"key":"logfire.msg_template","value":{"stringValue":"creating_quick_fix"}},{"key":"logfire.msg","value":{"stringValue":"creating_quick_fix"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"title\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a799359bafafc370ca6511bc0c6d8","spanId":"1d52486aea3a7139","flags":256,"name":"code_actions","kind":1,"startTimeUnixNano":"1762976291258172000","endTimeUnixNano":"1762976291258834000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"code_actions"}},{"key":"code.lineno","value":{"intValue":"315"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"code_actions"}},{"key":"logfire.msg","value":{"stringValue":"code_actions"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a79936049001d04db7f086b4f9c68","spanId":"1ba283d927554e41","flags":256,"name":"Document changed: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976292937627000","endTimeUnixNano":"1762976292937627000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Document changed: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document changed: file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_change"}},{"key":"code.lineno","value":{"intValue":"305"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a799358e35e2d8f7adcb3e78a18ef","spanId":"7842d85ebfa626f4","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976291042977000","endTimeUnixNano":"1762976292949328000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976292946612000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a799360559e359275b103b90ed45a","spanId":"9721c40bc531787d","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976292949637000","endTimeUnixNano":"1762976292949637000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799364326cee488560e7eb7ab3d1","spanId":"35e901ac017bf5fa","parentSpanId":"dab51a9ad7dfa04c","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976293938854000","endTimeUnixNano":"1762976293938854000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a799358e35e2d8f7adcb3e78a18ef","spanId":"ebdac6bd7a3c326b","parentSpanId":"f553bdb1627acdd7","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976291047895000","endTimeUnixNano":"1762976292938170000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a799358e35e2d8f7adcb3e78a18ef","spanId":"f553bdb1627acdd7","parentSpanId":"7842d85ebfa626f4","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976291046452000","endTimeUnixNano":"1762976292938527000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\n-- uv.nvim - Neovim plugin for uv Python package management integration\\n-- Author: Ben O'Mahony\\n-- License: MIT\\n\\nlocal M = {}\\n\\n-- Default configuration\\nM.config = {\\n\\t-- Auto-activate virtual environments when found\\n\\tauto_activate_venv = true,\\n\\tnotify_activate_venv = true,\\n\\n\\t-- Auto commands for directory changes\\n\\tauto_commands = true,\\n\\n\\t-- Integration with picker (like Telescope or other UI components)\\n\\tpicker_integration = true,\\n\\n\\t-- Keymaps to register (set to false to disable)\\n\\tkeymaps = {\\n\\t\\tprefix = \\\"<leader>x\\\", -- Main prefix for UV commands\\n\\t\\tcommands = true, -- Show UV commands menu (<leader>x)\\n\\t\\trun_file = true, -- Run current file (<leader>xr)\\n\\t\\trun_selection = true, -- Run selection (<leader>xs)\\n\\t\\trun_function = true, -- Run function (<leader>xf)\\n\\t\\tvenv = true, -- Environment management (<leader>xe)\\n\\t\\tinit = true, -- Initialize UV project (<leader>xi)\\n\\t\\tadd = true, -- Add a package (<leader>xa)\\n\\t\\tremove = true, -- Remove a package (<leader>xd)\\n\\t\\tsync = true, -- Sync packages (<leader>xc)\\n\\t\\tsync_all = true, -- uv sync --all-extras --all-groups --all-packages (<leader>xC)\\n\\t},\\n\\n\\t-- Execution options\\n\\texecution = {\\n\\t\\t-- Python run command template\\n\\t\\trun_command = \\\"uv run python\\\",\\n\\n\\t\\t-- Show output in notifications\\n\\t\\tnotify_output = true,\\n\\n\\t\\t-- Notification timeout in ms\\n\\t\\tnotification_timeout = 10000,\\n\\t},\\n}\\n\\n-- Command runner - runs shell commands and captures output\\nfunction M.run_command(cmd)\\n\\t-- Run command in background and capture output\\n\\tvim.fn.jobstart(cmd, {\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Command completed successfully: \\\" .. cmd, vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Command failed: \\\" .. cmd, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Only show meaningful output (not empty lines)\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Show errors\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.WARN)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Virtual environment activation\\nfunction M.activate_venv(venv_path)\\n\\t-- For Mac, run the source command to apply to the current shell\\n\\tlocal command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n\\t-- Set environment variables for the current Neovim instance\\n\\tvim.env.VIRTUAL_ENV = venv_path\\n\\tvim.env.PATH = venv_path .. \\\"/bin:\\\" .. vim.env.PATH\\n\\t-- Notify user\\n\\tif M.config.notify_activate_venv then\\n\\t\\tvim.notify(\\\"Activated virtual environment: \\\" .. venv_path, vim.log.levels.INFO)\\n\\tend\\nend\\n\\n-- Auto-activate the .venv if it exists at the project root\\nfunction M.auto_activate_venv()\\n\\tlocal venv_path = vim.fn.getcwd() .. \\\"/.venv\\\"\\n\\tif vim.fn.isdirectory(venv_path) == 1 then\\n\\t\\tM.activate_venv(venv_path)\\n\\t\\treturn true\\n\\tend\\n\\treturn false\\nend\\n\\n-- Function to create a temporary file with the necessary context and selected code\\nfunction M.run_python_selection()\\n\\t-- Get visual selection\\n\\tlocal get_visual_selection = function()\\n\\t\\tlocal start_pos = vim.fn.getpos(\\\"'<\\\")\\n\\t\\tlocal end_pos = vim.fn.getpos(\\\"'>\\\")\\n\\t\\tlocal lines = vim.fn.getline(start_pos[2], end_pos[2])\\n\\n\\t\\tif #lines == 0 then\\n\\t\\t\\treturn \\\"\\\"\\n\\t\\tend\\n\\n\\t\\t-- Adjust last line to end at the column position of end_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[#lines] = lines[#lines]:sub(1, end_pos[3])\\n\\t\\tend\\n\\n\\t\\t-- Adjust first line to start at the column position of start_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[1] = lines[1]:sub(start_pos[3])\\n\\t\\tend\\n\\n\\t\\treturn table.concat(lines, \\\"\\\\n\\\")\\n\\tend\\n\\n\\t-- Get current buffer content to extract imports and global variables\\n\\tlocal get_buffer_globals = function()\\n\\t\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\t\\tlocal imports = {}\\n\\t\\tlocal globals = {}\\n\\t\\tlocal in_class = false\\n\\t\\tlocal class_indent = 0\\n\\n\\t\\tfor _, line in ipairs(lines) do\\n\\t\\t\\t-- Detect imports\\n\\t\\t\\tif line:match(\\\"^%s*import \\\") or line:match(\\\"^%s*from .+ import\\\") then\\n\\t\\t\\t\\ttable.insert(imports, line)\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect class definitions to skip class variables\\n\\t\\t\\tif line:match(\\\"^%s*class \\\") then\\n\\t\\t\\t\\tin_class = true\\n\\t\\t\\t\\tclass_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Check if we're exiting a class block\\n\\t\\t\\tif in_class and line:match(\\\"^%s*[^%s#]\\\") then\\n\\t\\t\\t\\tlocal current_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\t\\tif current_indent <= class_indent then\\n\\t\\t\\t\\t\\tin_class = false\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect global variable assignments (not in class, not inside functions)\\n\\t\\t\\tif not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\\n\\t\\t\\t\\t-- Check if it's not indented (global scope)\\n\\t\\t\\t\\tif not line:match(\\\"^%s%s+\\\") then\\n\\t\\t\\t\\t\\ttable.insert(globals, line)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend\\n\\n\\t\\treturn imports, globals\\n\\tend\\n\\n\\t-- Get selected code\\n\\tlocal selection = get_visual_selection()\\n\\tif selection == \\\"\\\" then\\n\\t\\tvim.notify(\\\"No code selected\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Get imports and globals\\n\\tlocal imports, globals = get_buffer_globals()\\n\\n\\t-- Create temp file\\n\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\tlocal temp_file = temp_dir .. \\\"/run_selection.py\\\"\\n\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\tif not file then\\n\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Write imports\\n\\tfor _, imp in ipairs(imports) do\\n\\t\\tfile:write(imp .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write globals\\n\\tfor _, glob in ipairs(globals) do\\n\\t\\tfile:write(glob .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write selected code\\n\\tfile:write(\\\"# SELECTED CODE\\\\n\\\")\\n\\n\\t-- Check if the selection is all indented (which would cause syntax errors)\\n\\tlocal is_all_indented = true\\n\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tif not line:match(\\\"^%s+\\\") and line ~= \\\"\\\" then\\n\\t\\t\\tis_all_indented = false\\n\\t\\t\\tbreak\\n\\t\\tend\\n\\tend\\n\\n\\t-- Process the selection to determine what type of code it is\\n\\tlocal is_function_def = selection:match(\\\"^%s*def%s+[%w_]+%s*%(\\\")\\n\\tlocal is_class_def = selection:match(\\\"^%s*class%s+[%w_]+\\\")\\n\\tlocal has_print = selection:match(\\\"print%s*%(\\\")\\n\\tlocal is_expression = not is_function_def\\n\\t\\tand not is_class_def\\n\\t\\tand not selection:match(\\\"=\\\")\\n\\t\\tand not selection:match(\\\"%s*for%s+\\\")\\n\\t\\tand not selection:match(\\\"%s*if%s+\\\")\\n\\t\\tand not has_print\\n\\n\\t-- If the selection is all indented, we need to dedent it or wrap it in a function\\n\\tif is_all_indented then\\n\\t\\tfile:write(\\\"def run_selection():\\\\n\\\")\\n\\t\\t-- Write the selection with original indentation\\n\\t\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\t\\tfile:write(\\\"    \\\" .. line .. \\\"\\\\n\\\")\\n\\t\\tend\\n\\t\\tfile:write(\\\"\\\\n# Auto-call the wrapper function\\\\n\\\")\\n\\t\\tfile:write(\\\"run_selection()\\\\n\\\")\\n\\telse\\n\\t\\t-- Write the original selection\\n\\t\\tfile:write(selection .. \\\"\\\\n\\\")\\n\\n\\t\\t-- For expressions, we'll add a print statement to see the result\\n\\t\\tif is_expression then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added print for expression\\\\n\\\")\\n\\t\\t\\tfile:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\\n\\t\\t-- For function definitions without calls, we'll add a call\\n\\t\\telseif is_function_def then\\n\\t\\t\\tlocal function_name = selection:match(\\\"def%s+([%w_]+)%s*%(\\\")\\n\\t\\t\\t-- Check if the function is already called in the selection\\n\\t\\t\\tif function_name and not selection:match(function_name .. \\\"%s*%(.-%)\\\") then\\n\\t\\t\\t\\tfile:write(\\\"\\\\n# Auto-added function call\\\\n\\\")\\n\\t\\t\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\t\\t\\tfile:write('    print(f\\\"Auto-executing function: ' .. function_name .. '\\\")\\\\n')\\n\\t\\t\\t\\tfile:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\\n\\t\\t\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\t\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\t\\tend\\n\\t\\t-- If there's no print statement in the code, add an output marker\\n\\t\\telseif not has_print and not selection:match(\\\"^%s*#\\\") then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added execution marker\\\\n\\\")\\n\\t\\t\\tfile:write('print(\\\"Code executed successfully.\\\")\\\\n')\\n\\t\\tend\\n\\tend\\n\\n\\tfile:close()\\n\\n\\t-- Run the temp file\\n\\tvim.notify(\\\"Running selected code...\\\", vim.log.levels.INFO)\\n\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Selected code executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Selected code execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Function to run a specific Python function\\nfunction M.run_python_function()\\n\\t-- Get current buffer content\\n\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\tlocal buffer_content = table.concat(lines, \\\"\\\\n\\\")\\n\\n\\t-- Find all function definitions\\n\\tlocal functions = {}\\n\\tfor line in buffer_content:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tlocal func_name = line:match(\\\"^def%s+([%w_]+)%s*%(\\\")\\n\\t\\tif func_name then\\n\\t\\t\\ttable.insert(functions, func_name)\\n\\t\\tend\\n\\tend\\n\\n\\tif #functions == 0 then\\n\\t\\tvim.notify(\\\"No functions found in current file\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Create temp file for function selection picker\\n\\tlocal run_function = function(func_name)\\n\\t\\t-- Create a temporary file with a main block to call the function\\n\\t\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\t\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\t\\tlocal temp_file = temp_dir .. \\\"/run_function.py\\\"\\n\\t\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\n\\t\\t-- Create a wrapper script that imports the current file and calls the function\\n\\t\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\t\\tif not file then\\n\\t\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\t\\treturn\\n\\t\\tend\\n\\n\\t\\t-- Get the module name (file name without .py)\\n\\t\\tlocal module_name = vim.fn.fnamemodify(current_file, \\\":t:r\\\")\\n\\t\\tlocal module_dir = vim.fn.fnamemodify(current_file, \\\":h\\\")\\n\\n\\t\\t-- Write imports\\n\\t\\tfile:write(\\\"import sys\\\\n\\\")\\n\\t\\tfile:write(\\\"sys.path.insert(0, \\\" .. vim.inspect(module_dir) .. \\\")\\\\n\\\")\\n\\t\\tfile:write(\\\"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\")\\n\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\tfile:write('    print(f\\\"Running function: ' .. func_name .. '\\\")\\\\n')\\n\\t\\tfile:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\\n\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\tfile:close()\\n\\n\\t\\t-- Run the temp file\\n\\t\\tvim.notify(\\\"Running function: \\\" .. func_name, vim.log.levels.INFO)\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\tend\\n\\n\\t-- If there's only one function, run it directly\\n\\tif #functions == 1 then\\n\\t\\trun_function(functions[1])\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Otherwise, show a picker to select the function\\n\\tvim.ui.select(functions, {\\n\\t\\tprompt = \\\"Select function to run:\\\",\\n\\t\\tformat_item = function(item)\\n\\t\\t\\treturn \\\"def \\\" .. item .. \\\"()\\\"\\n\\t\\tend,\\n\\t}, function(choice)\\n\\t\\tif choice then\\n\\t\\t\\trun_function(choice)\\n\\t\\tend\\n\\tend)\\nend\\n\\n-- Run current file\\nfunction M.run_file()\\n\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\tif current_file and current_file ~= \\\"\\\" then\\n\\t\\tvim.notify(\\\"Running: \\\" .. vim.fn.expand(\\\"%:t\\\"), vim.log.levels.INFO)\\n\\t\\t-- Run python on the current file and capture output to notifications\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(current_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution completed successfully\\\", vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\telse\\n\\t\\tvim.notify(\\\"No file is open\\\", vim.log.levels.WARN)\\n\\tend\\nend\\n\\n-- Set up command pickers for integration with UI plugins\\nfunction M.setup_pickers()\\n\\t-- Check if Snacks is available\\n\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t-- Register UV command source\\n\\t\\tSnacks.picker.sources.uv_commands = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t{ text = \\\"Run current file\\\", desc = \\\"Run current file with Python\\\", is_run_current = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run selection\\\", desc = \\\"Run selected Python code\\\", is_run_selection = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run function\\\", desc = \\\"Run specific Python function\\\", is_run_function = true },\\n\\t\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", desc = \\\"Install a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv sync\\\", desc = \\\"Sync packages from lockfile\\\" },\\n\\t\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\t\\tdesc = \\\"Sync all extras, groups and packages\\\",\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", desc = \\\"Remove a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv init\\\", desc = \\\"Initialize a new project\\\" },\\n\\t\\t\\t\\t}\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\treturn { { item.text .. \\\" - \\\" .. item.desc } }\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\t\\tif item.is_run_current then\\n\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_selection then\\n\\t\\t\\t\\t\\t\\t-- Check if there's a visual selection\\n\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\n\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\") -- Exit visual mode\\n\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t-- If not in visual mode, prompt the user to select text\\n\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t-- After notification, we'll set up a one-time autocmd to catch when visual mode is exited\\n\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\", -- When changing from any visual mode to normal mode\\n\\t\\t\\t\\t\\t\\t\\t\\tcallback = function(ev)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true -- Delete the autocmd after it's been triggered\\n\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_function then\\n\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\tlocal cmd = item.text\\n\\t\\t\\t\\t\\t-- Check if command needs input\\n\\t\\t\\t\\t\\tif cmd:match(\\\"%[(.-)%]\\\") then\\n\\t\\t\\t\\t\\t\\tlocal param_name = cmd:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\tvim.ui.input({ prompt = \\\"Enter \\\" .. param_name .. \\\": \\\" }, function(input)\\n\\t\\t\\t\\t\\t\\t\\tif not input or input == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t-- Replace the placeholder with actual input\\n\\t\\t\\t\\t\\t\\t\\tlocal actual_cmd = cmd:gsub(\\\"%[\\\" .. param_name .. \\\"%]\\\", input)\\n\\t\\t\\t\\t\\t\\t\\tM.run_command(actual_cmd)\\n\\t\\t\\t\\t\\t\\tend)\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t-- Run the command directly\\n\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\n\\t\\t-- Register UV venv source\\n\\t\\tSnacks.picker.sources.uv_venv = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\tlocal venvs = {}\\n\\t\\t\\t\\t-- Check for .venv directory (uv's default)\\n\\t\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\tif #venvs == 0 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\"Create new virtual environment (uv venv)\\\",\\n\\t\\t\\t\\t\\t\\tis_create = true,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\treturn venvs\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\treturn { { \\\"+ \\\" .. item.text } }\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tlocal icon = item.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\"\\n\\t\\t\\t\\t\\treturn { { icon .. item.text .. \\\" (Activate)\\\" } }\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\tM.activate_venv(item.path)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\tend\\n\\n\\t-- Check if Telescope is available\\n\\tlocal has_telescope, telescope = pcall(require, \\\"telescope\\\")\\n\\tif has_telescope then\\n\\t\\tlocal pickers = require(\\\"telescope.pickers\\\")\\n\\t\\tlocal finders = require(\\\"telescope.finders\\\")\\n\\t\\tlocal sorters = require(\\\"telescope.sorters\\\")\\n\\t\\tlocal actions = require(\\\"telescope.actions\\\")\\n\\t\\tlocal action_state = require(\\\"telescope.actions.state\\\")\\n\\n\\t\\t-- UV Commands picker for Telescope\\n\\t\\tM.pick_uv_commands = function()\\n\\t\\t\\tlocal items = {\\n\\t\\t\\t\\t{ text = \\\"Run current file\\\", is_run_current = true },\\n\\t\\t\\t\\t{ text = \\\"Run selection\\\", is_run_selection = true },\\n\\t\\t\\t\\t{ text = \\\"Run function\\\", is_run_function = true },\\n\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", cmd = \\\"uv add \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv sync\\\", cmd = \\\"uv sync\\\" },\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\tcmd = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", cmd = \\\"uv remove \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv init\\\", cmd = \\\"uv init\\\" },\\n\\t\\t\\t}\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Commands\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_run_current then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_selection then\\n\\t\\t\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\t\\t\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_function then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tif selection.needs_input then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal placeholder = selection.text:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.ui.input(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t{ prompt = \\\"Enter \\\" .. (placeholder or \\\"value\\\") .. \\\": \\\" },\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfunction(input)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tif input and input ~= \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal cmd = selection.cmd .. input\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(selection.cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\n\\t\\t-- UV venv picker for Telescope\\n\\t\\tM.pick_uv_venv = function()\\n\\t\\t\\tlocal items = {}\\n\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\ttable.insert(items, {\\n\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t})\\n\\t\\t\\tend\\n\\t\\t\\tif #items == 0 then\\n\\t\\t\\t\\ttable.insert(items, { text = \\\"Create new virtual environment (uv venv)\\\", is_create = true })\\n\\t\\t\\tend\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Virtual Environments\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\tlocal display = entry.is_create and \\\"+ \\\" .. entry.text\\n\\t\\t\\t\\t\\t\\t\\t\\tor ((entry.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\") .. entry.text .. \\\" (Activate)\\\")\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = display,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = display,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_create then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tM.activate_venv(selection.path)\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Set up user commands\\nfunction M.setup_commands()\\n\\t-- Set up UV commands\\n\\tvim.api.nvim_create_user_command(\\\"UVInit\\\", function()\\n\\t\\tM.run_command(\\\"uv init\\\")\\n\\tend, {})\\n\\n\\t-- Command to run selected code\\n\\tvim.api.nvim_create_user_command(\\\"UVRunSelection\\\", function()\\n\\t\\tM.run_python_selection()\\n\\tend, { range = true })\\n\\n\\t-- Command to run a specific function\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFunction\\\", function()\\n\\t\\tM.run_python_function()\\n\\tend, {})\\n\\n\\t-- Command to run the current file\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFile\\\", function()\\n\\t\\tM.run_file()\\n\\tend, {})\\n\\n\\t-- Command to add a package\\n\\tvim.api.nvim_create_user_command(\\\"UVAddPackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv add \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\n\\n\\t-- Command to remove a package\\n\\tvim.api.nvim_create_user_command(\\\"UVRemovePackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv remove \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\nend\\n\\n-- Set up keymaps\\nfunction M.setup_keymaps()\\n\\tlocal keymaps = M.config.keymaps\\n\\tlocal prefix = keymaps.prefix or \\\"<leader>x\\\"\\n\\n\\t-- Main UV command menu\\n\\tif keymaps.commands then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Run current file\\n\\tif keymaps.run_file then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"r\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFile<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Current File\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run selection\\n\\tif keymaps.run_selection then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"v\\\",\\n\\t\\t\\tprefix .. \\\"s\\\",\\n\\t\\t\\t\\\":<C-u>UVRunSelection<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Selection\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run function\\n\\tif keymaps.run_function then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"f\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFunction<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Function\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Environment management\\n\\tif keymaps.venv then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_venv')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope_venv = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope_venv then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_venv()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Initialize UV project\\n\\tif keymaps.init then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"i\\\",\\n\\t\\t\\t\\\"<cmd>UVInit<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Init\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Add a package\\n\\tif keymaps.add then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"a\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv add ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Add Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Remove a package\\n\\tif keymaps.remove then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"d\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv remove ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Remove Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Sync packages\\n\\tif keymaps.sync then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"c\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync Packages\\\" }\\n\\t\\t)\\n\\tend\\n\\tif keymaps.sync_all then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"C\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync --all-extras --all-packages --all-groups')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync All Extras, Groups and Packages\\\" }\\n\\t\\t)\\n\\tend\\nend\\n\\n-- Set up auto commands\\nfunction M.setup_autocommands()\\n\\tif M.config.auto_commands then\\n\\t\\t-- Auto-activate .venv if it exists\\n\\t\\tif M.config.auto_activate_venv then\\n\\t\\t\\tM.auto_activate_venv()\\n\\n\\t\\t\\t-- Also set up auto-command to check when entering a directory\\n\\t\\t\\tvim.api.nvim_create_autocmd({ \\\"DirChanged\\\" }, {\\n\\t\\t\\t\\tpattern = { \\\"global\\\" },\\n\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\tM.auto_activate_venv()\\n\\t\\t\\t\\tend,\\n\\t\\t\\t})\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Main setup function\\nfunction M.setup(opts)\\n\\t-- Merge user configuration with defaults\\n\\tM.config = vim.tbl_deep_extend(\\\"force\\\", M.config, opts or {})\\n\\n\\t-- Set up commands\\n\\tM.setup_commands()\\n\\n\\t-- Set up keymaps if enabled\\n\\tif M.config.keymaps ~= false then\\n\\t\\tM.setup_keymaps()\\n\\tend\\n\\n\\t-- Set up autocommands if enabled\\n\\tif M.config.auto_commands ~= false then\\n\\t\\tM.setup_autocommands()\\n\\tend\\n\\n\\t-- Set up pickers if integration is enabled\\n\\tif M.config.picker_integration then\\n\\t\\tM.setup_pickers()\\n\\tend\\n\\n\\t-- Make run_command globally accessible (can be removed if not needed)\\n\\t_G.run_command = M.run_command\\nend\\n\\nreturn M\\n\\n```\\n\\nFile: init.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c511d8c928e741c8b6e3305bc85905a5"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"61044"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a7993700395295bd8b39d46d24d78","spanId":"dc06e6140d1f790d","flags":256,"name":"Document saved: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976296963585000","endTimeUnixNano":"1762976296963585000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document saved: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document saved: file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_save"}},{"key":"code.lineno","value":{"intValue":"298"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a799364326cee488560e7eb7ab3d1","spanId":"dab51a9ad7dfa04c","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976293938554000","endTimeUnixNano":"1762976296971412000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976296969794000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a7993700bd6f0446cd8987b0f1a1c","spanId":"eff100b3bfe69f79","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976296971564000","endTimeUnixNano":"1762976296971564000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a799373eddc0fe8ee93bcc78d477e","spanId":"8c7bad5cb82316fc","parentSpanId":"9ef187a778fbafed","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976297966451000","endTimeUnixNano":"1762976297966451000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a799364326cee488560e7eb7ab3d1","spanId":"433c10b14d3429f7","parentSpanId":"2771dac5583c392e","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976293940035000","endTimeUnixNano":"1762976296963976000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a799364326cee488560e7eb7ab3d1","spanId":"2771dac5583c392e","parentSpanId":"dab51a9ad7dfa04c","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976293939468000","endTimeUnixNano":"1762976296964184000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\n-- uv.nvim - Neovim plugin for uv Python package management integration\\n-- Author: Ben O'Mahony\\n-- License: MIT\\n\\nlocal M = {}\\n\\n-- Default configuration\\nM.config = {\\n\\t-- Auto-activate virtual environments when found\\n\\tauto_activate_venv = true,\\n\\tnotify_activate_venv = true,\\n\\n\\t-- Auto commands for directory changes\\n\\tauto_commands = true,\\n\\n\\t-- Integration with picker (like Telescope or other UI components)\\n\\tpicker_integration = true,\\n\\n\\t-- Keymaps to register (set to false to disable)\\n\\tkeymaps = {\\n\\t\\tprefix = \\\"<leader>x\\\", -- Main prefix for UV commands\\n\\t\\tcommands = true, -- Show UV commands menu (<leader>x)\\n\\t\\trun_file = true, -- Run current file (<leader>xr)\\n\\t\\trun_selection = true, -- Run selection (<leader>xs)\\n\\t\\trun_function = true, -- Run function (<leader>xf)\\n\\t\\tvenv = true, -- Environment management (<leader>xe)\\n\\t\\tinit = true, -- Initialize UV project (<leader>xi)\\n\\t\\tadd = true, -- Add a package (<leader>xa)\\n\\t\\tremove = true, -- Remove a package (<leader>xd)\\n\\t\\tsync = true, -- Sync packages (<leader>xc)\\n\\t\\tsync_all = true, -- uv sync --all-extras --all-groups --all-packages (<leader>xC)\\n\\t},\\n\\n\\t-- Execution options\\n\\texecution = {\\n\\t\\t-- Python run command template\\n\\t\\trun_command = \\\"uv run python\\\",\\n\\n\\t\\t-- Show output in notifications\\n\\t\\tnotify_output = true,\\n\\n\\t\\t-- Notification timeout in ms\\n\\t\\tnotification_timeout = 10000,\\n\\t},\\n}\\n\\n-- Command runner - runs shell commands and captures output\\nfunction M.run_command(cmd)\\n\\t-- Run command in background and capture output\\n\\tvim.fn.jobstart(cmd, {\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Command completed successfully: \\\" .. cmd, vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Command failed: \\\" .. cmd, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Only show meaningful output (not empty lines)\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Show errors\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.WARN)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Virtual environment activation\\nfunction M.activate_venv(venv_path)\\n\\t-- For Mac, run the source command to apply to the current shell\\n\\tlocal command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n\\t-- Set environment variables for the current Neovim instance\\n\\tvim.env.VIRTUAL_ENV = venv_path\\n\\tvim.env.PATH = venv_path .. \\\"/bin:\\\" .. vim.env.PATH\\n\\t-- Notify user\\n\\tif M.config.notify_activate_venv then\\n\\t\\tvim.notify(\\\"Activated virtual environment: \\\" .. venv_path, vim.log.levels.INFO)\\n\\tend\\nend\\n\\n-- Auto-activate the .venv if it exists at the project root\\nfunction M.auto_activate_venv()\\n\\tlocal venv_path = vim.fn.getcwd() .. \\\"/.venv\\\"\\n\\tif vim.fn.isdirectory(venv_path) == 1 then\\n\\t\\tM.activate_venv(venv_path)\\n\\t\\treturn true\\n\\tend\\n\\treturn false\\nend\\n\\n-- Function to create a temporary file with the necessary context and selected code\\nfunction M.run_python_selection()\\n\\t-- Get visual selection\\n\\tlocal get_visual_selection = function()\\n\\t\\tlocal start_pos = vim.fn.getpos(\\\"'<\\\")\\n\\t\\tlocal end_pos = vim.fn.getpos(\\\"'>\\\")\\n\\t\\tlocal lines = vim.fn.getline(start_pos[2], end_pos[2])\\n\\n\\t\\tif #lines == 0 then\\n\\t\\t\\treturn \\\"\\\"\\n\\t\\tend\\n\\n\\t\\t-- Adjust last line to end at the column position of end_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[#lines] = lines[#lines]:sub(1, end_pos[3])\\n\\t\\tend\\n\\n\\t\\t-- Adjust first line to start at the column position of start_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[1] = lines[1]:sub(start_pos[3])\\n\\t\\tend\\n\\n\\t\\treturn table.concat(lines, \\\"\\\\n\\\")\\n\\tend\\n\\n\\t-- Get current buffer content to extract imports and global variables\\n\\tlocal get_buffer_globals = function() -- Consider using a more robust Python parser (if available via external tool) or adding a disclaimer about limitations.\\n\\t\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\t\\tlocal imports = {}\\n\\t\\tlocal globals = {}\\n\\t\\tlocal in_class = false\\n\\t\\tlocal class_indent = 0\\n\\n\\t\\tfor _, line in ipairs(lines) do\\n\\t\\t\\t-- Detect imports\\n\\t\\t\\tif line:match(\\\"^%s*import \\\") or line:match(\\\"^%s*from .+ import\\\") then\\n\\t\\t\\t\\ttable.insert(imports, line)\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect class definitions to skip class variables\\n\\t\\t\\tif line:match(\\\"^%s*class \\\") then\\n\\t\\t\\t\\tin_class = true\\n\\t\\t\\t\\tclass_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Check if we're exiting a class block\\n\\t\\t\\tif in_class and line:match(\\\"^%s*[^%s#]\\\") then\\n\\t\\t\\t\\tlocal current_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\t\\tif current_indent <= class_indent then\\n\\t\\t\\t\\t\\tin_class = false\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect global variable assignments (not in class, not inside functions)\\n\\t\\t\\tif not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\\n\\t\\t\\t\\t-- Check if it's not indented (global scope)\\n\\t\\t\\t\\tif not line:match(\\\"^%s%s+\\\") then\\n\\t\\t\\t\\t\\ttable.insert(globals, line)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend\\n\\n\\t\\treturn imports, globals\\n\\tend\\n\\n\\t-- Get selected code\\n\\tlocal selection = get_visual_selection()\\n\\tif selection == \\\"\\\" then\\n\\t\\tvim.notify(\\\"No code selected\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Get imports and globals\\n\\tlocal imports, globals = get_buffer_globals()\\n\\n\\t-- Create temp file\\n\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\tlocal temp_file = temp_dir .. \\\"/run_selection.py\\\"\\n\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\tif not file then\\n\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Write imports\\n\\tfor _, imp in ipairs(imports) do\\n\\t\\tfile:write(imp .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write globals\\n\\tfor _, glob in ipairs(globals) do\\n\\t\\tfile:write(glob .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write selected code\\n\\tfile:write(\\\"# SELECTED CODE\\\\n\\\")\\n\\n\\t-- Check if the selection is all indented (which would cause syntax errors)\\n\\tlocal is_all_indented = true\\n\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tif not line:match(\\\"^%s+\\\") and line ~= \\\"\\\" then\\n\\t\\t\\tis_all_indented = false\\n\\t\\t\\tbreak\\n\\t\\tend\\n\\tend\\n\\n\\t-- Process the selection to determine what type of code it is\\n\\tlocal is_function_def = selection:match(\\\"^%s*def%s+[%w_]+%s*%(\\\")\\n\\tlocal is_class_def = selection:match(\\\"^%s*class%s+[%w_]+\\\")\\n\\tlocal has_print = selection:match(\\\"print%s*%(\\\")\\n\\tlocal is_expression = not is_function_def\\n\\t\\tand not is_class_def\\n\\t\\tand not selection:match(\\\"=\\\")\\n\\t\\tand not selection:match(\\\"%s*for%s+\\\")\\n\\t\\tand not selection:match(\\\"%s*if%s+\\\")\\n\\t\\tand not has_print\\n\\n\\t-- If the selection is all indented, we need to dedent it or wrap it in a function\\n\\tif is_all_indented then\\n\\t\\tfile:write(\\\"def run_selection():\\\\n\\\")\\n\\t\\t-- Write the selection with original indentation\\n\\t\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\t\\tfile:write(\\\"    \\\" .. line .. \\\"\\\\n\\\")\\n\\t\\tend\\n\\t\\tfile:write(\\\"\\\\n# Auto-call the wrapper function\\\\n\\\")\\n\\t\\tfile:write(\\\"run_selection()\\\\n\\\")\\n\\telse\\n\\t\\t-- Write the original selection\\n\\t\\tfile:write(selection .. \\\"\\\\n\\\")\\n\\n\\t\\t-- For expressions, we'll add a print statement to see the result\\n\\t\\tif is_expression then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added print for expression\\\\n\\\")\\n\\t\\t\\tfile:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\\n\\t\\t-- For function definitions without calls, we'll add a call\\n\\t\\telseif is_function_def then\\n\\t\\t\\tlocal function_name = selection:match(\\\"def%s+([%w_]+)%s*%(\\\")\\n\\t\\t\\t-- Check if the function is already called in the selection\\n\\t\\t\\tif function_name and not selection:match(function_name .. \\\"%s*%(.-%)\\\") then\\n\\t\\t\\t\\tfile:write(\\\"\\\\n# Auto-added function call\\\\n\\\")\\n\\t\\t\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\t\\t\\tfile:write('    print(f\\\"Auto-executing function: ' .. function_name .. '\\\")\\\\n')\\n\\t\\t\\t\\tfile:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\\n\\t\\t\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\t\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\t\\tend\\n\\t\\t-- If there's no print statement in the code, add an output marker\\n\\t\\telseif not has_print and not selection:match(\\\"^%s*#\\\") then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added execution marker\\\\n\\\")\\n\\t\\t\\tfile:write('print(\\\"Code executed successfully.\\\")\\\\n')\\n\\t\\tend\\n\\tend\\n\\n\\tfile:close()\\n\\n\\t-- Run the temp file\\n\\tvim.notify(\\\"Running selected code...\\\", vim.log.levels.INFO)\\n\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Selected code executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Selected code execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Function to run a specific Python function\\nfunction M.run_python_function()\\n\\t-- Get current buffer content\\n\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\tlocal buffer_content = table.concat(lines, \\\"\\\\n\\\")\\n\\n\\t-- Find all function definitions\\n\\tlocal functions = {}\\n\\tfor line in buffer_content:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tlocal func_name = line:match(\\\"^def%s+([%w_]+)%s*%(\\\")\\n\\t\\tif func_name then\\n\\t\\t\\ttable.insert(functions, func_name)\\n\\t\\tend\\n\\tend\\n\\n\\tif #functions == 0 then\\n\\t\\tvim.notify(\\\"No functions found in current file\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Create temp file for function selection picker\\n\\tlocal run_function = function(func_name)\\n\\t\\t-- Create a temporary file with a main block to call the function\\n\\t\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\t\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\t\\tlocal temp_file = temp_dir .. \\\"/run_function.py\\\"\\n\\t\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\n\\t\\t-- Create a wrapper script that imports the current file and calls the function\\n\\t\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\t\\tif not file then\\n\\t\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\t\\treturn\\n\\t\\tend\\n\\n\\t\\t-- Get the module name (file name without .py)\\n\\t\\tlocal module_name = vim.fn.fnamemodify(current_file, \\\":t:r\\\")\\n\\t\\tlocal module_dir = vim.fn.fnamemodify(current_file, \\\":h\\\")\\n\\n\\t\\t-- Write imports\\n\\t\\tfile:write(\\\"import sys\\\\n\\\")\\n\\t\\tfile:write(\\\"sys.path.insert(0, \\\" .. vim.inspect(module_dir) .. \\\")\\\\n\\\")\\n\\t\\tfile:write(\\\"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\")\\n\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\tfile:write('    print(f\\\"Running function: ' .. func_name .. '\\\")\\\\n')\\n\\t\\tfile:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\\n\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\tfile:close()\\n\\n\\t\\t-- Run the temp file\\n\\t\\tvim.notify(\\\"Running function: \\\" .. func_name, vim.log.levels.INFO)\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\tend\\n\\n\\t-- If there's only one function, run it directly\\n\\tif #functions == 1 then\\n\\t\\trun_function(functions[1])\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Otherwise, show a picker to select the function\\n\\tvim.ui.select(functions, {\\n\\t\\tprompt = \\\"Select function to run:\\\",\\n\\t\\tformat_item = function(item)\\n\\t\\t\\treturn \\\"def \\\" .. item .. \\\"()\\\"\\n\\t\\tend,\\n\\t}, function(choice)\\n\\t\\tif choice then\\n\\t\\t\\trun_function(choice)\\n\\t\\tend\\n\\tend)\\nend\\n\\n-- Run current file\\nfunction M.run_file()\\n\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\tif current_file and current_file ~= \\\"\\\" then\\n\\t\\tvim.notify(\\\"Running: \\\" .. vim.fn.expand(\\\"%:t\\\"), vim.log.levels.INFO)\\n\\t\\t-- Run python on the current file and capture output to notifications\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(current_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution completed successfully\\\", vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\telse\\n\\t\\tvim.notify(\\\"No file is open\\\", vim.log.levels.WARN)\\n\\tend\\nend\\n\\n-- Set up command pickers for integration with UI plugins\\nfunction M.setup_pickers()\\n\\t-- Check if Snacks is available\\n\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t-- Register UV command source\\n\\t\\tSnacks.picker.sources.uv_commands = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t{ text = \\\"Run current file\\\", desc = \\\"Run current file with Python\\\", is_run_current = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run selection\\\", desc = \\\"Run selected Python code\\\", is_run_selection = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run function\\\", desc = \\\"Run specific Python function\\\", is_run_function = true },\\n\\t\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", desc = \\\"Install a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv sync\\\", desc = \\\"Sync packages from lockfile\\\" },\\n\\t\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\t\\tdesc = \\\"Sync all extras, groups and packages\\\",\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", desc = \\\"Remove a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv init\\\", desc = \\\"Initialize a new project\\\" },\\n\\t\\t\\t\\t}\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\treturn { { item.text .. \\\" - \\\" .. item.desc } }\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\t\\tif item.is_run_current then\\n\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_selection then\\n\\t\\t\\t\\t\\t\\t-- Check if there's a visual selection\\n\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\n\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\") -- Exit visual mode\\n\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t-- If not in visual mode, prompt the user to select text\\n\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t-- After notification, we'll set up a one-time autocmd to catch when visual mode is exited\\n\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\", -- When changing from any visual mode to normal mode\\n\\t\\t\\t\\t\\t\\t\\t\\tcallback = function(ev)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true -- Delete the autocmd after it's been triggered\\n\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_function then\\n\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\tlocal cmd = item.text\\n\\t\\t\\t\\t\\t-- Check if command needs input\\n\\t\\t\\t\\t\\tif cmd:match(\\\"%[(.-)%]\\\") then\\n\\t\\t\\t\\t\\t\\tlocal param_name = cmd:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\tvim.ui.input({ prompt = \\\"Enter \\\" .. param_name .. \\\": \\\" }, function(input)\\n\\t\\t\\t\\t\\t\\t\\tif not input or input == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t-- Replace the placeholder with actual input\\n\\t\\t\\t\\t\\t\\t\\tlocal actual_cmd = cmd:gsub(\\\"%[\\\" .. param_name .. \\\"%]\\\", input)\\n\\t\\t\\t\\t\\t\\t\\tM.run_command(actual_cmd)\\n\\t\\t\\t\\t\\t\\tend)\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t-- Run the command directly\\n\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\n\\t\\t-- Register UV venv source\\n\\t\\tSnacks.picker.sources.uv_venv = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\tlocal venvs = {}\\n\\t\\t\\t\\t-- Check for .venv directory (uv's default)\\n\\t\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\tif #venvs == 0 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\"Create new virtual environment (uv venv)\\\",\\n\\t\\t\\t\\t\\t\\tis_create = true,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\treturn venvs\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\treturn { { \\\"+ \\\" .. item.text } }\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tlocal icon = item.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\"\\n\\t\\t\\t\\t\\treturn { { icon .. item.text .. \\\" (Activate)\\\" } }\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\tM.activate_venv(item.path)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\tend\\n\\n\\t-- Check if Telescope is available\\n\\tlocal has_telescope, telescope = pcall(require, \\\"telescope\\\")\\n\\tif has_telescope then\\n\\t\\tlocal pickers = require(\\\"telescope.pickers\\\")\\n\\t\\tlocal finders = require(\\\"telescope.finders\\\")\\n\\t\\tlocal sorters = require(\\\"telescope.sorters\\\")\\n\\t\\tlocal actions = require(\\\"telescope.actions\\\")\\n\\t\\tlocal action_state = require(\\\"telescope.actions.state\\\")\\n\\n\\t\\t-- UV Commands picker for Telescope\\n\\t\\tM.pick_uv_commands = function()\\n\\t\\t\\tlocal items = {\\n\\t\\t\\t\\t{ text = \\\"Run current file\\\", is_run_current = true },\\n\\t\\t\\t\\t{ text = \\\"Run selection\\\", is_run_selection = true },\\n\\t\\t\\t\\t{ text = \\\"Run function\\\", is_run_function = true },\\n\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", cmd = \\\"uv add \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv sync\\\", cmd = \\\"uv sync\\\" },\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\tcmd = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", cmd = \\\"uv remove \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv init\\\", cmd = \\\"uv init\\\" },\\n\\t\\t\\t}\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Commands\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_run_current then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_selection then\\n\\t\\t\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\t\\t\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_function then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tif selection.needs_input then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal placeholder = selection.text:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.ui.input(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t{ prompt = \\\"Enter \\\" .. (placeholder or \\\"value\\\") .. \\\": \\\" },\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfunction(input)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tif input and input ~= \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal cmd = selection.cmd .. input\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(selection.cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\n\\t\\t-- UV venv picker for Telescope\\n\\t\\tM.pick_uv_venv = function()\\n\\t\\t\\tlocal items = {}\\n\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\ttable.insert(items, {\\n\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t})\\n\\t\\t\\tend\\n\\t\\t\\tif #items == 0 then\\n\\t\\t\\t\\ttable.insert(items, { text = \\\"Create new virtual environment (uv venv)\\\", is_create = true })\\n\\t\\t\\tend\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Virtual Environments\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\tlocal display = entry.is_create and \\\"+ \\\" .. entry.text\\n\\t\\t\\t\\t\\t\\t\\t\\tor ((entry.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\") .. entry.text .. \\\" (Activate)\\\")\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = display,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = display,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_create then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tM.activate_venv(selection.path)\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Set up user commands\\nfunction M.setup_commands()\\n\\t-- Set up UV commands\\n\\tvim.api.nvim_create_user_command(\\\"UVInit\\\", function()\\n\\t\\tM.run_command(\\\"uv init\\\")\\n\\tend, {})\\n\\n\\t-- Command to run selected code\\n\\tvim.api.nvim_create_user_command(\\\"UVRunSelection\\\", function()\\n\\t\\tM.run_python_selection()\\n\\tend, { range = true })\\n\\n\\t-- Command to run a specific function\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFunction\\\", function()\\n\\t\\tM.run_python_function()\\n\\tend, {})\\n\\n\\t-- Command to run the current file\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFile\\\", function()\\n\\t\\tM.run_file()\\n\\tend, {})\\n\\n\\t-- Command to add a package\\n\\tvim.api.nvim_create_user_command(\\\"UVAddPackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv add \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\n\\n\\t-- Command to remove a package\\n\\tvim.api.nvim_create_user_command(\\\"UVRemovePackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv remove \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\nend\\n\\n-- Set up keymaps\\nfunction M.setup_keymaps()\\n\\tlocal keymaps = M.config.keymaps\\n\\tlocal prefix = keymaps.prefix or \\\"<leader>x\\\"\\n\\n\\t-- Main UV command menu\\n\\tif keymaps.commands then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Run current file\\n\\tif keymaps.run_file then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"r\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFile<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Current File\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run selection\\n\\tif keymaps.run_selection then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"v\\\",\\n\\t\\t\\tprefix .. \\\"s\\\",\\n\\t\\t\\t\\\":<C-u>UVRunSelection<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Selection\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run function\\n\\tif keymaps.run_function then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"f\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFunction<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Function\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Environment management\\n\\tif keymaps.venv then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_venv')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope_venv = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope_venv then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_venv()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Initialize UV project\\n\\tif keymaps.init then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"i\\\",\\n\\t\\t\\t\\\"<cmd>UVInit<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Init\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Add a package\\n\\tif keymaps.add then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"a\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv add ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Add Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Remove a package\\n\\tif keymaps.remove then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"d\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv remove ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Remove Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Sync packages\\n\\tif keymaps.sync then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"c\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync Packages\\\" }\\n\\t\\t)\\n\\tend\\n\\tif keymaps.sync_all then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"C\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync --all-extras --all-packages --all-groups')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync All Extras, Groups and Packages\\\" }\\n\\t\\t)\\n\\tend\\nend\\n\\n-- Set up auto commands\\nfunction M.setup_autocommands()\\n\\tif M.config.auto_commands then\\n\\t\\t-- Auto-activate .venv if it exists\\n\\t\\tif M.config.auto_activate_venv then\\n\\t\\t\\tM.auto_activate_venv()\\n\\n\\t\\t\\t-- Also set up auto-command to check when entering a directory\\n\\t\\t\\tvim.api.nvim_create_autocmd({ \\\"DirChanged\\\" }, {\\n\\t\\t\\t\\tpattern = { \\\"global\\\" },\\n\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\tM.auto_activate_venv()\\n\\t\\t\\t\\tend,\\n\\t\\t\\t})\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Main setup function\\nfunction M.setup(opts)\\n\\t-- Merge user configuration with defaults\\n\\tM.config = vim.tbl_deep_extend(\\\"force\\\", M.config, opts or {})\\n\\n\\t-- Set up commands\\n\\tM.setup_commands()\\n\\n\\t-- Set up keymaps if enabled\\n\\tif M.config.keymaps ~= false then\\n\\t\\tM.setup_keymaps()\\n\\tend\\n\\n\\t-- Set up autocommands if enabled\\n\\tif M.config.auto_commands ~= false then\\n\\t\\tM.setup_autocommands()\\n\\tend\\n\\n\\t-- Set up pickers if integration is enabled\\n\\tif M.config.picker_integration then\\n\\t\\tM.setup_pickers()\\n\\tend\\n\\n\\t-- Make run_command globally accessible (can be removed if not needed)\\n\\t_G.run_command = M.run_command\\nend\\n\\nreturn M\\n\\n```\\n\\nFile: init.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c511d8c928e741c8b6e3305bc85905a5"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"61044"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a799386966f4e605d867ddffbd7ff","spanId":"336014b8882ee4c1","flags":256,"name":"Document opened: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976302742477000","endTimeUnixNano":"1762976302742477000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document opened: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document opened: file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_open"}},{"key":"code.lineno","value":{"intValue":"291"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a799373eddc0fe8ee93bcc78d477e","spanId":"9ef187a778fbafed","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976297965521000","endTimeUnixNano":"1762976302752353000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.level_num","value":{"intValue":"17"}},{"key":"logfire.exception.fingerprint","value":{"stringValue":"e720c7a9f0107cb9e83d2bbacd62701180fe65009e65cbc31cd5420ef569071b"}}],"events":[{"timeUnixNano":"1762976302750239000","name":"exception","attributes":[{"key":"exception.type","value":{"stringValue":"asyncio.exceptions.CancelledError"}},{"key":"exception.message","value":{"stringValue":""}},{"key":"exception.stacktrace","value":{"stringValue":"Traceback (most recent call last):\n  File \"/Users/benomahony/Code/open_source/ai-lsp/src/ai_lsp/main.py\", line 202, in analyze_document\n    result = await self.agent.run(prompt)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 562, in run\n    async for _ in agent_run:\n        pass\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/agent.py\", line 2178, in __anext__\n    next_node = await self._graph_run.__anext__()\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 809, in __anext__\n    return await self.next(self._next_node)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_graph/graph.py\", line 782, in next\n    self._next_node = await node.run(ctx)\n                      ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 299, in run\n    return await self._make_request(ctx)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/_agent_graph.py\", line 359, in _make_request\n    model_response = await ctx.deps.model.request(message_history, model_settings, model_request_parameters)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/instrumented.py\", line 215, in request\n    response = await super().request(messages, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/wrapper.py\", line 30, in request\n    return await self.wrapped.request(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 181, in request\n    response = await self._generate_content(messages, False, model_settings, model_request_parameters)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/pydantic_ai/models/google.py\", line 304, in _generate_content\n    return await func(model=self._model_name, contents=contents, config=config)  # type: ignore\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 7428, in generate_content\n    response = await self._generate_content(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        model=model, contents=contents, config=parsed_config\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/models.py\", line 6381, in _generate_content\n    response = await self._api_client.async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        'post', path, request_dict, http_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1211, in async_request\n    result = await self._async_request(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n        http_request=http_request, http_options=http_options, stream=False\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1156, in _async_request\n    return await self._async_retry(  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self._async_request_once, http_request, stream\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 111, in __call__\n    do = await self.iter(retry_state=retry_state)\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 153, in iter\n    result = await action(retry_state)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/_utils.py\", line 99, in inner\n    return call(*args, **kwargs)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/__init__.py\", line 398, in <lambda>\n    self._add_action_func(lambda rs: rs.outcome.result())\n                                     ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 449, in result\n    return self.__get_result()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"/Users/benomahony/Library/Application Support/uv/python/cpython-3.13.0-macos-aarch64-none/lib/python3.13/concurrent/futures/_base.py\", line 401, in __get_result\n    raise self._exception\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/tenacity/asyncio/__init__.py\", line 114, in __call__\n    result = await fn(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/google/genai/_api_client.py\", line 1089, in _async_request_once\n    response = await session.request(\n               ^^^^^^^^^^^^^^^^^^^^^^\n    ...<6 lines>...\n    )\n    ^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 770, in _request\n    resp = await handler(req)\n           ^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client.py\", line 748, in _connect_and_send_request\n    await resp.start(conn)\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/client_reqrep.py\", line 532, in start\n    message, payload = await protocol.read()  # type: ignore[union-attr]\n                       ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/benomahony/Code/open_source/ai-lsp/.venv/lib/python3.13/site-packages/aiohttp/streams.py\", line 672, in read\n    await self._waiter\nasyncio.exceptions.CancelledError\n"}},{"key":"exception.escaped","value":{"stringValue":"True"}}]}],"status":{"message":"CancelledError: ","code":2}},{"traceId":"019a799386a095eab712cb77eb0ef7df","spanId":"0198d52faf8634b4","flags":256,"name":"Analysis cancelled for {uri}","kind":1,"startTimeUnixNano":"1762976302752547000","endTimeUnixNano":"1762976302752547000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Analysis cancelled for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Analysis cancelled for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.debounced_analyze"}},{"key":"code.lineno","value":{"intValue":"169"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}},{"traceId":"019a79938a808eec8f491953fb623024","spanId":"d16680ac332d5b8b","parentSpanId":"e5e7e1831fbcef48","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976303744628000","endTimeUnixNano":"1762976303744628000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a799373eddc0fe8ee93bcc78d477e","spanId":"2e875b7043f85199","parentSpanId":"8353c60911f349aa","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976297968714000","endTimeUnixNano":"1762976302743041000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}},{"traceId":"019a799373eddc0fe8ee93bcc78d477e","spanId":"8353c60911f349aa","parentSpanId":"9ef187a778fbafed","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976297967830000","endTimeUnixNano":"1762976302743325000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"Analyze this lua code for issues:\\n\\n```lua\\n-- uv.nvim - Neovim plugin for uv Python package management integration\\n-- Author: Ben O'Mahony\\n-- License: MIT\\n\\nlocal M = {}\\n\\n-- Default configuration\\nM.config = {\\n\\t-- Auto-activate virtual environments when found\\n\\tauto_activate_venv = true,\\n\\tnotify_activate_venv = true,\\n\\n\\t-- Auto commands for directory changes\\n\\tauto_commands = true,\\n\\n\\t-- Integration with picker (like Telescope or other UI components)\\n\\tpicker_integration = true,\\n\\n\\t-- Keymaps to register (set to false to disable)\\n\\tkeymaps = {\\n\\t\\tprefix = \\\"<leader>x\\\", -- Main prefix for UV commands\\n\\t\\tcommands = true, -- Show UV commands menu (<leader>x)\\n\\t\\trun_file = true, -- Run current file (<leader>xr)\\n\\t\\trun_selection = true, -- Run selection (<leader>xs)\\n\\t\\trun_function = true, -- Run function (<leader>xf)\\n\\t\\tvenv = true, -- Environment management (<leader>xe)\\n\\t\\tinit = true, -- Initialize UV project (<leader>xi)\\n\\t\\tadd = true, -- Add a package (<leader>xa)\\n\\t\\tremove = true, -- Remove a package (<leader>xd)\\n\\t\\tsync = true, -- Sync packages (<leader>xc)\\n\\t\\tsync_all = true, -- uv sync --all-extras --all-groups --all-packages (<leader>xC)\\n\\t},\\n\\n\\t-- Execution options\\n\\texecution = {\\n\\t\\t-- Python run command template\\n\\t\\trun_command = \\\"uv run python\\\",\\n\\n\\t\\t-- Show output in notifications\\n\\t\\tnotify_output = true,\\n\\n\\t\\t-- Notification timeout in ms\\n\\t\\tnotification_timeout = 10000,\\n\\t},\\n}\\n\\n-- Command runner - runs shell commands and captures output\\nfunction M.run_command(cmd)\\n\\t-- Run command in background and capture output\\n\\tvim.fn.jobstart(cmd, {\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Command completed successfully: \\\" .. cmd, vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Command failed: \\\" .. cmd, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Only show meaningful output (not empty lines)\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t-- Show errors\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.WARN)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Virtual environment activation\\nfunction M.activate_venv(venv_path)\\n\\t-- For Mac, run the source command to apply to the current shell\\n\\tlocal command = \\\"source \\\" .. venv_path .. \\\"/bin/activate\\\"\\n\\t-- Set environment variables for the current Neovim instance\\n\\tvim.env.VIRTUAL_ENV = venv_path\\n\\tvim.env.PATH = venv_path .. \\\"/bin:\\\" .. vim.env.PATH\\n\\t-- Notify user\\n\\tif M.config.notify_activate_venv then\\n\\t\\tvim.notify(\\\"Activated virtual environment: \\\" .. venv_path, vim.log.levels.INFO)\\n\\tend\\nend\\n\\n-- Auto-activate the .venv if it exists at the project root\\nfunction M.auto_activate_venv()\\n\\tlocal venv_path = vim.fn.getcwd() .. \\\"/.venv\\\"\\n\\tif vim.fn.isdirectory(venv_path) == 1 then\\n\\t\\tM.activate_venv(venv_path)\\n\\t\\treturn true\\n\\tend\\n\\treturn false\\nend\\n\\n-- Function to create a temporary file with the necessary context and selected code\\nfunction M.run_python_selection()\\n\\t-- Get visual selection\\n\\tlocal get_visual_selection = function()\\n\\t\\tlocal start_pos = vim.fn.getpos(\\\"'<\\\")\\n\\t\\tlocal end_pos = vim.fn.getpos(\\\"'>\\\")\\n\\t\\tlocal lines = vim.fn.getline(start_pos[2], end_pos[2])\\n\\n\\t\\tif #lines == 0 then\\n\\t\\t\\treturn \\\"\\\"\\n\\t\\tend\\n\\n\\t\\t-- Adjust last line to end at the column position of end_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[#lines] = lines[#lines]:sub(1, end_pos[3])\\n\\t\\tend\\n\\n\\t\\t-- Adjust first line to start at the column position of start_pos\\n\\t\\tif #lines > 0 then\\n\\t\\t\\tlines[1] = lines[1]:sub(start_pos[3])\\n\\t\\tend\\n\\n\\t\\treturn table.concat(lines, \\\"\\\\n\\\")\\n\\tend\\n\\n\\t-- Get current buffer content to extract imports and global variables\\n\\tlocal get_buffer_globals = function() -- Consider using a more robust Python parser (if available via external tool) or adding a disclaimer about limitations.\\n\\t\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\t\\tlocal imports = {}\\n\\t\\tlocal globals = {}\\n\\t\\tlocal in_class = false\\n\\t\\tlocal class_indent = 0\\n\\n\\t\\tfor _, line in ipairs(lines) do\\n\\t\\t\\t-- Detect imports\\n\\t\\t\\tif line:match(\\\"^%s*import \\\") or line:match(\\\"^%s*from .+ import\\\") then\\n\\t\\t\\t\\ttable.insert(imports, line)\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect class definitions to skip class variables\\n\\t\\t\\tif line:match(\\\"^%s*class \\\") then\\n\\t\\t\\t\\tin_class = true\\n\\t\\t\\t\\tclass_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Check if we're exiting a class block\\n\\t\\t\\tif in_class and line:match(\\\"^%s*[^%s#]\\\") then\\n\\t\\t\\t\\tlocal current_indent = line:match(\\\"^(%s*)\\\"):len()\\n\\t\\t\\t\\tif current_indent <= class_indent then\\n\\t\\t\\t\\t\\tin_class = false\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\n\\t\\t\\t-- Detect global variable assignments (not in class, not inside functions)\\n\\t\\t\\tif not in_class and not line:match(\\\"^%s*def \\\") and line:match(\\\"^%s*[%w_]+ *=\\\") then\\n\\t\\t\\t\\t-- Check if it's not indented (global scope)\\n\\t\\t\\t\\tif not line:match(\\\"^%s%s+\\\") then\\n\\t\\t\\t\\t\\ttable.insert(globals, line)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend\\n\\n\\t\\treturn imports, globals\\n\\tend\\n\\n\\t-- Get selected code\\n\\tlocal selection = get_visual_selection()\\n\\tif selection == \\\"\\\" then\\n\\t\\tvim.notify(\\\"No code selected\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Get imports and globals\\n\\tlocal imports, globals = get_buffer_globals()\\n\\n\\t-- Create temp file\\n\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\tlocal temp_file = temp_dir .. \\\"/run_selection.py\\\"\\n\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\tif not file then\\n\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Write imports\\n\\tfor _, imp in ipairs(imports) do\\n\\t\\tfile:write(imp .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write globals\\n\\tfor _, glob in ipairs(globals) do\\n\\t\\tfile:write(glob .. \\\"\\\\n\\\")\\n\\tend\\n\\tfile:write(\\\"\\\\n\\\")\\n\\n\\t-- Write selected code\\n\\tfile:write(\\\"# SELECTED CODE\\\\n\\\")\\n\\n\\t-- Check if the selection is all indented (which would cause syntax errors)\\n\\tlocal is_all_indented = true\\n\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tif not line:match(\\\"^%s+\\\") and line ~= \\\"\\\" then\\n\\t\\t\\tis_all_indented = false\\n\\t\\t\\tbreak\\n\\t\\tend\\n\\tend\\n\\n\\t-- Process the selection to determine what type of code it is\\n\\tlocal is_function_def = selection:match(\\\"^%s*def%s+[%w_]+%s*%(\\\")\\n\\tlocal is_class_def = selection:match(\\\"^%s*class%s+[%w_]+\\\")\\n\\tlocal has_print = selection:match(\\\"print%s*%(\\\")\\n\\tlocal is_expression = not is_function_def\\n\\t\\tand not is_class_def\\n\\t\\tand not selection:match(\\\"=\\\")\\n\\t\\tand not selection:match(\\\"%s*for%s+\\\")\\n\\t\\tand not selection:match(\\\"%s*if%s+\\\")\\n\\t\\tand not has_print\\n\\n\\t-- If the selection is all indented, we need to dedent it or wrap it in a function\\n\\tif is_all_indented then\\n\\t\\tfile:write(\\\"def run_selection():\\\\n\\\")\\n\\t\\t-- Write the selection with original indentation\\n\\t\\tfor line in selection:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\t\\tfile:write(\\\"    \\\" .. line .. \\\"\\\\n\\\")\\n\\t\\tend\\n\\t\\tfile:write(\\\"\\\\n# Auto-call the wrapper function\\\\n\\\")\\n\\t\\tfile:write(\\\"run_selection()\\\\n\\\")\\n\\telse\\n\\t\\t-- Write the original selection\\n\\t\\tfile:write(selection .. \\\"\\\\n\\\")\\n\\n\\t\\t-- For expressions, we'll add a print statement to see the result\\n\\t\\tif is_expression then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added print for expression\\\\n\\\")\\n\\t\\t\\tfile:write('print(f\\\"Expression result: {' .. selection:gsub(\\\"^%s+\\\", \\\"\\\"):gsub(\\\"%s+$\\\", \\\"\\\") .. '}\\\")\\\\n')\\n\\t\\t-- For function definitions without calls, we'll add a call\\n\\t\\telseif is_function_def then\\n\\t\\t\\tlocal function_name = selection:match(\\\"def%s+([%w_]+)%s*%(\\\")\\n\\t\\t\\t-- Check if the function is already called in the selection\\n\\t\\t\\tif function_name and not selection:match(function_name .. \\\"%s*%(.-%)\\\") then\\n\\t\\t\\t\\tfile:write(\\\"\\\\n# Auto-added function call\\\\n\\\")\\n\\t\\t\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\t\\t\\tfile:write('    print(f\\\"Auto-executing function: ' .. function_name .. '\\\")\\\\n')\\n\\t\\t\\t\\tfile:write(\\\"    result = \\\" .. function_name .. \\\"()\\\\n\\\")\\n\\t\\t\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\t\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\t\\tend\\n\\t\\t-- If there's no print statement in the code, add an output marker\\n\\t\\telseif not has_print and not selection:match(\\\"^%s*#\\\") then\\n\\t\\t\\tfile:write(\\\"\\\\n# Auto-added execution marker\\\\n\\\")\\n\\t\\t\\tfile:write('print(\\\"Code executed successfully.\\\")\\\\n')\\n\\t\\tend\\n\\tend\\n\\n\\tfile:close()\\n\\n\\t-- Run the temp file\\n\\tvim.notify(\\\"Running selected code...\\\", vim.log.levels.INFO)\\n\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\ton_stdout = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_stderr = function(_, data)\\n\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\tvim.notify(\\\"Selected code executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\telse\\n\\t\\t\\t\\tvim.notify(\\\"Selected code execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\tend\\n\\t\\tend,\\n\\t\\tstdout_buffered = true,\\n\\t\\tstderr_buffered = true,\\n\\t})\\nend\\n\\n-- Function to run a specific Python function\\nfunction M.run_python_function()\\n\\t-- Get current buffer content\\n\\tlocal lines = vim.api.nvim_buf_get_lines(0, 0, -1, false)\\n\\tlocal buffer_content = table.concat(lines, \\\"\\\\n\\\")\\n\\n\\t-- Find all function definitions\\n\\tlocal functions = {}\\n\\tfor line in buffer_content:gmatch(\\\"[^\\\\r\\\\n]+\\\") do\\n\\t\\tlocal func_name = line:match(\\\"^def%s+([%w_]+)%s*%(\\\")\\n\\t\\tif func_name then\\n\\t\\t\\ttable.insert(functions, func_name)\\n\\t\\tend\\n\\tend\\n\\n\\tif #functions == 0 then\\n\\t\\tvim.notify(\\\"No functions found in current file\\\", vim.log.levels.WARN)\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Create temp file for function selection picker\\n\\tlocal run_function = function(func_name)\\n\\t\\t-- Create a temporary file with a main block to call the function\\n\\t\\tlocal temp_dir = vim.fn.expand(\\\"$HOME\\\") .. \\\"/.cache/nvim/uv_run\\\"\\n\\t\\tvim.fn.mkdir(temp_dir, \\\"p\\\")\\n\\t\\tlocal temp_file = temp_dir .. \\\"/run_function.py\\\"\\n\\t\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\n\\t\\t-- Create a wrapper script that imports the current file and calls the function\\n\\t\\tlocal file = io.open(temp_file, \\\"w\\\")\\n\\t\\tif not file then\\n\\t\\t\\tvim.notify(\\\"Failed to create temporary file\\\", vim.log.levels.ERROR)\\n\\t\\t\\treturn\\n\\t\\tend\\n\\n\\t\\t-- Get the module name (file name without .py)\\n\\t\\tlocal module_name = vim.fn.fnamemodify(current_file, \\\":t:r\\\")\\n\\t\\tlocal module_dir = vim.fn.fnamemodify(current_file, \\\":h\\\")\\n\\n\\t\\t-- Write imports\\n\\t\\tfile:write(\\\"import sys\\\\n\\\")\\n\\t\\tfile:write(\\\"sys.path.insert(0, \\\" .. vim.inspect(module_dir) .. \\\")\\\\n\\\")\\n\\t\\tfile:write(\\\"import \\\" .. module_name .. \\\"\\\\n\\\\n\\\")\\n\\t\\tfile:write('if __name__ == \\\"__main__\\\":\\\\n')\\n\\t\\tfile:write('    print(f\\\"Running function: ' .. func_name .. '\\\")\\\\n')\\n\\t\\tfile:write(\\\"    result = \\\" .. module_name .. \\\".\\\" .. func_name .. \\\"()\\\\n\\\")\\n\\t\\tfile:write(\\\"    if result is not None:\\\\n\\\")\\n\\t\\tfile:write('        print(f\\\"Return value: {result}\\\")\\\\n')\\n\\t\\tfile:close()\\n\\n\\t\\t-- Run the temp file\\n\\t\\tvim.notify(\\\"Running function: \\\" .. func_name, vim.log.levels.INFO)\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(temp_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Function Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function executed successfully\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Function execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR)\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\tend\\n\\n\\t-- If there's only one function, run it directly\\n\\tif #functions == 1 then\\n\\t\\trun_function(functions[1])\\n\\t\\treturn\\n\\tend\\n\\n\\t-- Otherwise, show a picker to select the function\\n\\tvim.ui.select(functions, {\\n\\t\\tprompt = \\\"Select function to run:\\\",\\n\\t\\tformat_item = function(item)\\n\\t\\t\\treturn \\\"def \\\" .. item .. \\\"()\\\"\\n\\t\\tend,\\n\\t}, function(choice)\\n\\t\\tif choice then\\n\\t\\t\\trun_function(choice)\\n\\t\\tend\\n\\tend)\\nend\\n\\n-- Run current file\\nfunction M.run_file()\\n\\tlocal current_file = vim.fn.expand(\\\"%:p\\\")\\n\\tif current_file and current_file ~= \\\"\\\" then\\n\\t\\tvim.notify(\\\"Running: \\\" .. vim.fn.expand(\\\"%:t\\\"), vim.log.levels.INFO)\\n\\t\\t-- Run python on the current file and capture output to notifications\\n\\t\\tvim.fn.jobstart(M.config.execution.run_command .. \\\" \\\" .. vim.fn.shellescape(current_file), {\\n\\t\\t\\ton_stdout = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Output\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_stderr = function(_, data)\\n\\t\\t\\t\\tif data and #data > 1 then\\n\\t\\t\\t\\t\\tlocal output = table.concat(data, \\\"\\\\n\\\")\\n\\t\\t\\t\\t\\tif output and output:match(\\\"%S\\\") then\\n\\t\\t\\t\\t\\t\\tvim.notify(output, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\t\\ttitle = \\\"Python Error\\\",\\n\\t\\t\\t\\t\\t\\t\\ttimeout = M.config.execution.notification_timeout,\\n\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\ton_exit = function(_, exit_code)\\n\\t\\t\\t\\tif exit_code == 0 then\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution completed successfully\\\", vim.log.levels.INFO, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tvim.notify(\\\"Program execution failed with exit code: \\\" .. exit_code, vim.log.levels.ERROR, {\\n\\t\\t\\t\\t\\t\\ttitle = \\\"Python Execution\\\",\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tstdout_buffered = true,\\n\\t\\t\\tstderr_buffered = true,\\n\\t\\t})\\n\\telse\\n\\t\\tvim.notify(\\\"No file is open\\\", vim.log.levels.WARN)\\n\\tend\\nend\\n\\n-- Set up command pickers for integration with UI plugins\\nfunction M.setup_pickers()\\n\\t-- Check if Snacks is available\\n\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t-- Register UV command source\\n\\t\\tSnacks.picker.sources.uv_commands = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t{ text = \\\"Run current file\\\", desc = \\\"Run current file with Python\\\", is_run_current = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run selection\\\", desc = \\\"Run selected Python code\\\", is_run_selection = true },\\n\\t\\t\\t\\t\\t{ text = \\\"Run function\\\", desc = \\\"Run specific Python function\\\", is_run_function = true },\\n\\t\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", desc = \\\"Install a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv sync\\\", desc = \\\"Sync packages from lockfile\\\" },\\n\\t\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\t\\tdesc = \\\"Sync all extras, groups and packages\\\",\\n\\t\\t\\t\\t\\t},\\n\\t\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", desc = \\\"Remove a package\\\" },\\n\\t\\t\\t\\t\\t{ text = \\\"uv init\\\", desc = \\\"Initialize a new project\\\" },\\n\\t\\t\\t\\t}\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\treturn { { item.text .. \\\" - \\\" .. item.desc } }\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\t\\tif item.is_run_current then\\n\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_selection then\\n\\t\\t\\t\\t\\t\\t-- Check if there's a visual selection\\n\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\n\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\") -- Exit visual mode\\n\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t-- If not in visual mode, prompt the user to select text\\n\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t-- After notification, we'll set up a one-time autocmd to catch when visual mode is exited\\n\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\", -- When changing from any visual mode to normal mode\\n\\t\\t\\t\\t\\t\\t\\t\\tcallback = function(ev)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true -- Delete the autocmd after it's been triggered\\n\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\telseif item.is_run_function then\\n\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\tlocal cmd = item.text\\n\\t\\t\\t\\t\\t-- Check if command needs input\\n\\t\\t\\t\\t\\tif cmd:match(\\\"%[(.-)%]\\\") then\\n\\t\\t\\t\\t\\t\\tlocal param_name = cmd:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\tvim.ui.input({ prompt = \\\"Enter \\\" .. param_name .. \\\": \\\" }, function(input)\\n\\t\\t\\t\\t\\t\\t\\tif not input or input == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\treturn\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t-- Replace the placeholder with actual input\\n\\t\\t\\t\\t\\t\\t\\tlocal actual_cmd = cmd:gsub(\\\"%[\\\" .. param_name .. \\\"%]\\\", input)\\n\\t\\t\\t\\t\\t\\t\\tM.run_command(actual_cmd)\\n\\t\\t\\t\\t\\t\\tend)\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t-- Run the command directly\\n\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\n\\t\\t-- Register UV venv source\\n\\t\\tSnacks.picker.sources.uv_venv = {\\n\\t\\t\\tfinder = function()\\n\\t\\t\\t\\tlocal venvs = {}\\n\\t\\t\\t\\t-- Check for .venv directory (uv's default)\\n\\t\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\tif #venvs == 0 then\\n\\t\\t\\t\\t\\ttable.insert(venvs, {\\n\\t\\t\\t\\t\\t\\ttext = \\\"Create new virtual environment (uv venv)\\\",\\n\\t\\t\\t\\t\\t\\tis_create = true,\\n\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\tend\\n\\t\\t\\t\\treturn venvs\\n\\t\\t\\tend,\\n\\t\\t\\tformat = function(item)\\n\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\treturn { { \\\"+ \\\" .. item.text } }\\n\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\tlocal icon = item.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\"\\n\\t\\t\\t\\t\\treturn { { icon .. item.text .. \\\" (Activate)\\\" } }\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t\\tconfirm = function(picker, item)\\n\\t\\t\\t\\tpicker:close()\\n\\t\\t\\t\\tif item then\\n\\t\\t\\t\\t\\tif item.is_create then\\n\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\tM.activate_venv(item.path)\\n\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\tend\\n\\t\\t\\tend,\\n\\t\\t}\\n\\tend\\n\\n\\t-- Check if Telescope is available\\n\\tlocal has_telescope, telescope = pcall(require, \\\"telescope\\\")\\n\\tif has_telescope then\\n\\t\\tlocal pickers = require(\\\"telescope.pickers\\\")\\n\\t\\tlocal finders = require(\\\"telescope.finders\\\")\\n\\t\\tlocal sorters = require(\\\"telescope.sorters\\\")\\n\\t\\tlocal actions = require(\\\"telescope.actions\\\")\\n\\t\\tlocal action_state = require(\\\"telescope.actions.state\\\")\\n\\n\\t\\t-- UV Commands picker for Telescope\\n\\t\\tM.pick_uv_commands = function()\\n\\t\\t\\tlocal items = {\\n\\t\\t\\t\\t{ text = \\\"Run current file\\\", is_run_current = true },\\n\\t\\t\\t\\t{ text = \\\"Run selection\\\", is_run_selection = true },\\n\\t\\t\\t\\t{ text = \\\"Run function\\\", is_run_function = true },\\n\\t\\t\\t\\t{ text = \\\"uv add [package]\\\", cmd = \\\"uv add \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv sync\\\", cmd = \\\"uv sync\\\" },\\n\\t\\t\\t\\t{\\n\\t\\t\\t\\t\\ttext = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t\\tcmd = \\\"uv sync --all-extras --all-packages --all-groups\\\",\\n\\t\\t\\t\\t},\\n\\t\\t\\t\\t{ text = \\\"uv remove [package]\\\", cmd = \\\"uv remove \\\", needs_input = true },\\n\\t\\t\\t\\t{ text = \\\"uv init\\\", cmd = \\\"uv init\\\" },\\n\\t\\t\\t}\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Commands\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = entry.text,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_run_current then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_file()\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_selection then\\n\\t\\t\\t\\t\\t\\t\\t\\tlocal mode = vim.fn.mode()\\n\\t\\t\\t\\t\\t\\t\\t\\tif mode == \\\"v\\\" or mode == \\\"V\\\" or mode == \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.cmd(\\\"normal! \\\\27\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.defer_fn(function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tend, 100)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\\"Please select text first. Enter visual mode (v) and select code to run.\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.log.levels.INFO\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.api.nvim_create_autocmd(\\\"ModeChanged\\\", {\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpattern = \\\"[vV\\\\x16]*:n\\\",\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_selection()\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tonce = true,\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t})\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\telseif selection.is_run_function then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_python_function()\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tif selection.needs_input then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal placeholder = selection.text:match(\\\"%[(.-)%]\\\")\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.ui.input(\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t{ prompt = \\\"Enter \\\" .. (placeholder or \\\"value\\\") .. \\\": \\\" },\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfunction(input)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tif input and input ~= \\\"\\\" then\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tlocal cmd = selection.cmd .. input\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tvim.notify(\\\"Cancelled\\\", vim.log.levels.INFO)\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t)\\n\\t\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(selection.cmd)\\n\\t\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\n\\t\\t-- UV venv picker for Telescope\\n\\t\\tM.pick_uv_venv = function()\\n\\t\\t\\tlocal items = {}\\n\\t\\t\\tif vim.fn.isdirectory(\\\".venv\\\") == 1 then\\n\\t\\t\\t\\ttable.insert(items, {\\n\\t\\t\\t\\t\\ttext = \\\".venv\\\",\\n\\t\\t\\t\\t\\tpath = vim.fn.getcwd() .. \\\"/.venv\\\",\\n\\t\\t\\t\\t\\tis_current = vim.env.VIRTUAL_ENV and vim.env.VIRTUAL_ENV:match(\\\".venv$\\\") ~= nil,\\n\\t\\t\\t\\t})\\n\\t\\t\\tend\\n\\t\\t\\tif #items == 0 then\\n\\t\\t\\t\\ttable.insert(items, { text = \\\"Create new virtual environment (uv venv)\\\", is_create = true })\\n\\t\\t\\tend\\n\\n\\t\\t\\tpickers\\n\\t\\t\\t\\t.new({}, {\\n\\t\\t\\t\\t\\tprompt_title = \\\"UV Virtual Environments\\\",\\n\\t\\t\\t\\t\\tfinder = finders.new_table({\\n\\t\\t\\t\\t\\t\\tresults = items,\\n\\t\\t\\t\\t\\t\\tentry_maker = function(entry)\\n\\t\\t\\t\\t\\t\\t\\tlocal display = entry.is_create and \\\"+ \\\" .. entry.text\\n\\t\\t\\t\\t\\t\\t\\t\\tor ((entry.is_current and \\\"\\u25cf \\\" or \\\"\\u25cb \\\") .. entry.text .. \\\" (Activate)\\\")\\n\\t\\t\\t\\t\\t\\t\\treturn {\\n\\t\\t\\t\\t\\t\\t\\t\\tvalue = entry,\\n\\t\\t\\t\\t\\t\\t\\t\\tdisplay = display,\\n\\t\\t\\t\\t\\t\\t\\t\\tordinal = display,\\n\\t\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t\\t}),\\n\\t\\t\\t\\t\\tsorter = sorters.get_generic_fuzzy_sorter(),\\n\\t\\t\\t\\t\\tattach_mappings = function(prompt_bufnr, map)\\n\\t\\t\\t\\t\\t\\tlocal function on_select()\\n\\t\\t\\t\\t\\t\\t\\tlocal selection = action_state.get_selected_entry().value\\n\\t\\t\\t\\t\\t\\t\\tactions.close(prompt_bufnr)\\n\\t\\t\\t\\t\\t\\t\\tif selection.is_create then\\n\\t\\t\\t\\t\\t\\t\\t\\tM.run_command(\\\"uv venv\\\")\\n\\t\\t\\t\\t\\t\\t\\telse\\n\\t\\t\\t\\t\\t\\t\\t\\tM.activate_venv(selection.path)\\n\\t\\t\\t\\t\\t\\t\\tend\\n\\t\\t\\t\\t\\t\\tend\\n\\n\\t\\t\\t\\t\\t\\tmap(\\\"i\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\tmap(\\\"n\\\", \\\"<CR>\\\", on_select)\\n\\t\\t\\t\\t\\t\\treturn true\\n\\t\\t\\t\\t\\tend,\\n\\t\\t\\t\\t})\\n\\t\\t\\t\\t:find()\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Set up user commands\\nfunction M.setup_commands()\\n\\t-- Set up UV commands\\n\\tvim.api.nvim_create_user_command(\\\"UVInit\\\", function()\\n\\t\\tM.run_command(\\\"uv init\\\")\\n\\tend, {})\\n\\n\\t-- Command to run selected code\\n\\tvim.api.nvim_create_user_command(\\\"UVRunSelection\\\", function()\\n\\t\\tM.run_python_selection()\\n\\tend, { range = true })\\n\\n\\t-- Command to run a specific function\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFunction\\\", function()\\n\\t\\tM.run_python_function()\\n\\tend, {})\\n\\n\\t-- Command to run the current file\\n\\tvim.api.nvim_create_user_command(\\\"UVRunFile\\\", function()\\n\\t\\tM.run_file()\\n\\tend, {})\\n\\n\\t-- Command to add a package\\n\\tvim.api.nvim_create_user_command(\\\"UVAddPackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv add \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\n\\n\\t-- Command to remove a package\\n\\tvim.api.nvim_create_user_command(\\\"UVRemovePackage\\\", function(opts)\\n\\t\\tM.run_command(\\\"uv remove \\\" .. opts.args)\\n\\tend, { nargs = 1 })\\nend\\n\\n-- Set up keymaps\\nfunction M.setup_keymaps()\\n\\tlocal keymaps = M.config.keymaps\\n\\tlocal prefix = keymaps.prefix or \\\"<leader>x\\\"\\n\\n\\t-- Main UV command menu\\n\\tif keymaps.commands then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua Snacks.picker.pick('uv_commands')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"v\\\",\\n\\t\\t\\t\\tprefix,\\n\\t\\t\\t\\t\\\":<C-u>lua require('uv').pick_uv_commands()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Commands (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Run current file\\n\\tif keymaps.run_file then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"r\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFile<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Current File\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run selection\\n\\tif keymaps.run_selection then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"v\\\",\\n\\t\\t\\tprefix .. \\\"s\\\",\\n\\t\\t\\t\\\":<C-u>UVRunSelection<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Selection\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Run function\\n\\tif keymaps.run_function then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"f\\\",\\n\\t\\t\\t\\\"<cmd>UVRunFunction<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Run Function\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Environment management\\n\\tif keymaps.venv then\\n\\t\\tif _G.Snacks and _G.Snacks.picker then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua Snacks.picker.pick('uv_venv')<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\t\\tlocal has_telescope_venv = pcall(require, \\\"telescope\\\")\\n\\t\\tif has_telescope_venv then\\n\\t\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\t\\\"n\\\",\\n\\t\\t\\t\\tprefix .. \\\"e\\\",\\n\\t\\t\\t\\t\\\"<cmd>lua require('uv').pick_uv_venv()<CR>\\\",\\n\\t\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Environment (Telescope)\\\" }\\n\\t\\t\\t)\\n\\t\\tend\\n\\tend\\n\\n\\t-- Initialize UV project\\n\\tif keymaps.init then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"i\\\",\\n\\t\\t\\t\\\"<cmd>UVInit<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Init\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Add a package\\n\\tif keymaps.add then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"a\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv add ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Add Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Remove a package\\n\\tif keymaps.remove then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"d\\\",\\n\\t\\t\\t\\\"<cmd>lua vim.ui.input({prompt = 'Enter package name: '}, function(input) if input and input ~= '' then require('uv').run_command('uv remove ' .. input) end end)<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Remove Package\\\" }\\n\\t\\t)\\n\\tend\\n\\n\\t-- Sync packages\\n\\tif keymaps.sync then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"c\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync Packages\\\" }\\n\\t\\t)\\n\\tend\\n\\tif keymaps.sync_all then\\n\\t\\tvim.api.nvim_set_keymap(\\n\\t\\t\\t\\\"n\\\",\\n\\t\\t\\tprefix .. \\\"C\\\",\\n\\t\\t\\t\\\"<cmd>lua require('uv').run_command('uv sync --all-extras --all-packages --all-groups')<CR>\\\",\\n\\t\\t\\t{ noremap = true, silent = true, desc = \\\"UV Sync All Extras, Groups and Packages\\\" }\\n\\t\\t)\\n\\tend\\nend\\n\\n-- Set up auto commands\\nfunction M.setup_autocommands()\\n\\tif M.config.auto_commands then\\n\\t\\t-- Auto-activate .venv if it exists\\n\\t\\tif M.config.auto_activate_venv then\\n\\t\\t\\tM.auto_activate_venv()\\n\\n\\t\\t\\t-- Also set up auto-command to check when entering a directory\\n\\t\\t\\tvim.api.nvim_create_autocmd({ \\\"DirChanged\\\" }, {\\n\\t\\t\\t\\tpattern = { \\\"global\\\" },\\n\\t\\t\\t\\tcallback = function()\\n\\t\\t\\t\\t\\tM.auto_activate_venv()\\n\\t\\t\\t\\tend,\\n\\t\\t\\t})\\n\\t\\tend\\n\\tend\\nend\\n\\n-- Main setup function\\nfunction M.setup(opts)\\n\\t-- Merge user configuration with defaults\\n\\tM.config = vim.tbl_deep_extend(\\\"force\\\", M.config, opts or {})\\n\\n\\t-- Set up commands\\n\\tM.setup_commands()\\n\\n\\t-- Set up keymaps if enabled\\n\\tif M.config.keymaps ~= false then\\n\\t\\tM.setup_keymaps()\\n\\tend\\n\\n\\t-- Set up autocommands if enabled\\n\\tif M.config.auto_commands ~= false then\\n\\t\\tM.setup_autocommands()\\n\\tend\\n\\n\\t-- Set up pickers if integration is enabled\\n\\tif M.config.picker_integration then\\n\\t\\tM.setup_pickers()\\n\\tend\\n\\n\\t-- Make run_command globally accessible (can be removed if not needed)\\n\\t_G.run_command = M.run_command\\nend\\n\\nreturn M\\n\\n```\\n\\nFile: init.lua\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"c511d8c928e741c8b6e3305bc85905a5"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"61044"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a79938a808eec8f491953fb623024","spanId":"e5e7e1831fbcef48","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976303744248000","endTimeUnixNano":"1762976329275932000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/Code/open_source/uv.nvim/lua/uv/init.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a79938a808eec8f491953fb623024","spanId":"5162ff739cbd71ff","parentSpanId":"e5e7e1831fbcef48","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976303745300000","endTimeUnixNano":"1762976329276044000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a79938a808eec8f491953fb623024","spanId":"38c774158a684121","parentSpanId":"5162ff739cbd71ff","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976303745833000","endTimeUnixNano":"1762976329276083000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"b8e1c89ecac846fa84becc16fb9648d1"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"73995"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a799439f77366806d8b30d62ca4b3","spanId":"d5c81defb0289392","flags":256,"name":"Initializing AI Language Server","kind":1,"startTimeUnixNano":"1762976348663849000","endTimeUnixNano":"1762976348663849000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Initializing AI Language Server"}},{"key":"logfire.msg","value":{"stringValue":"Initializing AI Language Server"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"77"}}],"status":{}},{"traceId":"019a79943b5b81050484eea41da7351e","spanId":"083dc80e61a954e3","flags":256,"name":"AI agent initialized successfully","kind":1,"startTimeUnixNano":"1762976349019634000","endTimeUnixNano":"1762976349019634000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI agent initialized successfully"}},{"key":"logfire.msg","value":{"stringValue":"AI agent initialized successfully"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.__init__"}},{"key":"code.lineno","value":{"intValue":"115"}}],"status":{}},{"traceId":"019a79943b6dd5022164be1de5720765","spanId":"d33547be09433821","flags":256,"name":"Document opened: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976349037454000","endTimeUnixNano":"1762976349037454000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document opened: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document opened: file:///Users/benomahony/.config/nvim/lua/plugins/custom-lsps.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_open"}},{"key":"code.lineno","value":{"intValue":"291"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/custom-lsps.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a79943f5cda87ac5e24c1b7657c9c","spanId":"686169f537f7f240","parentSpanId":"c69727fa151f4f47","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976350045993000","endTimeUnixNano":"1762976350045993000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/custom-lsps.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/custom-lsps.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"b8e1c89ecac846fa84becc16fb9648d1"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"73995"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a79943f5cda87ac5e24c1b7657c9c","spanId":"d4974f7d8dce4227","parentSpanId":"5531592d84b4cb8d","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976350050565000","endTimeUnixNano":"1762976358156704000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.usage.input_tokens","value":{"intValue":"792"}},{"key":"gen_ai.usage.output_tokens","value":{"intValue":"174"}},{"key":"gen_ai.usage.details.thoughts_tokens","value":{"intValue":"1292"}},{"key":"gen_ai.usage.details.text_prompt_tokens","value":{"intValue":"792"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.system\": \"google-gla\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"[Scrubbed due to 'API_KEY']\", \"role\": \"user\", \"gen_ai.system\": \"google-gla\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}, {\"index\": 0, \"message\": {\"role\": \"assistant\", \"tool_calls\": [{\"id\": \"pyd_ai_7e387a4432ab47b2ab4e8279398b570f\", \"type\": \"function\", \"function\": {\"name\": \"final_result\", \"arguments\": {\"issues\": [{\"issue_snippet\": \"/Users/benomahony/Code/open_source/ai-lsp\", \"suggested_fixes\": [{\"target_snippet\": \"/Users/benomahony/Code/open_source/ai-lsp\", \"title\": \"Make the server path configurable or dynamic\", \"replacement_snippet\": \"vim.env.AI_LSP_SERVER_DIR or vim.fn.stdpath(\\\"data\\\") .. \\\"/ai-lsp-server\\\"\"}], \"message\": \"The path to the 'ai-lsp' server directory is hardcoded. This makes the configuration non-portable and will prevent the LSP from working for other users or if the project directory is moved. Configurations should be environment-agnostic.\", \"severity\": \"error\"}]}}}]}, \"gen_ai.system\": \"google-gla\", \"event.name\": \"gen_ai.choice\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"events\": {\"type\": \"array\"}, \"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.scrubbed","value":{"stringValue":"[{\"path\": [\"attributes\", \"events\", 1, \"content\"], \"matched_substring\": \"API_KEY\"}]"}}],"status":{}},{"traceId":"019a79943f5cda87ac5e24c1b7657c9c","spanId":"5531592d84b4cb8d","parentSpanId":"c69727fa151f4f47","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976350048536000","endTimeUnixNano":"1762976358160372000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"final_result","value":{"stringValue":"{\"issues\": [{\"issue_snippet\": \"/Users/benomahony/Code/open_source/ai-lsp\", \"severity\": \"error\", \"message\": \"The path to the 'ai-lsp' server directory is hardcoded. This makes the configuration non-portable and will prevent the LSP from working for other users or if the project directory is moved. Configurations should be environment-agnostic.\", \"suggested_fixes\": [{\"title\": \"Make the server path configurable or dynamic\", \"target_snippet\": \"/Users/benomahony/Code/open_source/ai-lsp\", \"replacement_snippet\": \"vim.env.AI_LSP_SERVER_DIR or vim.fn.stdpath(\\\"data\\\") .. \\\"/ai-lsp-server\\\"\"}]}]}"}},{"key":"gen_ai.usage.input_tokens","value":{"intValue":"792"}},{"key":"gen_ai.usage.output_tokens","value":{"intValue":"174"}},{"key":"gen_ai.usage.details.thoughts_tokens","value":{"intValue":"1292"}},{"key":"gen_ai.usage.details.text_prompt_tokens","value":{"intValue":"792"}},{"key":"all_messages_events","value":{"stringValue":"[{\"role\": \"system\", \"content\": \"You are an AI code analyzer that provides semantic insights that traditional LSPs cannot detect.\\n\\nONLY flag issues that require deep semantic understanding:\\n- Logic errors in algorithms or business logic\\n- Subtle race conditions or concurrency issues  \\n- Architectural problems and design pattern violations\\n- Security vulnerabilities requiring context understanding\\n- Performance anti-patterns that need semantic analysis\\n- Complex data flow issues\\n- Domain-specific best practice violations\\n- Accessibility issues requiring UX understanding\\n\\nDO NOT flag issues that normal LSPs handle:\\n- Syntax errors\\n- Basic type errors  \\n- Undefined variables\\n- Import issues\\n- Basic formatting problems\\n- Simple linting rules\\n\\nFor each issue, provide:\\n- The exact issue_snippet that has the problem (ONLY the problematic token/value, e.g. just \\\"python\\\" not 'command = \\\"python\\\"')\\n- Clear explanation of WHY this needs human attention in the message\\n- Use severity: \\\"info\\\" for suggestions, \\\"warning\\\" for concerns, \\\"error\\\" for serious logic issues\\n- When possible, provide suggested_fixes with:\\n  - target_snippet: the exact code to replace (same as issue_snippet usually)\\n  - replacement_snippet: the replacement code\\n  - title: clear description of the fix\\n\\nFocus on insights that require understanding code intent and context. Keep issue_snippet to the absolute minimum - just the problematic token.\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.system.message\"}, {\"content\": \"[Scrubbed due to 'API_KEY']\", \"role\": \"user\", \"gen_ai.message.index\": 0, \"event.name\": \"gen_ai.user.message\"}, {\"role\": \"assistant\", \"tool_calls\": [{\"id\": \"pyd_ai_7e387a4432ab47b2ab4e8279398b570f\", \"type\": \"function\", \"function\": {\"name\": \"final_result\", \"arguments\": {\"issues\": [{\"issue_snippet\": \"/Users/benomahony/Code/open_source/ai-lsp\", \"suggested_fixes\": [{\"target_snippet\": \"/Users/benomahony/Code/open_source/ai-lsp\", \"title\": \"Make the server path configurable or dynamic\", \"replacement_snippet\": \"vim.env.AI_LSP_SERVER_DIR or vim.fn.stdpath(\\\"data\\\") .. \\\"/ai-lsp-server\\\"\"}], \"message\": \"The path to the 'ai-lsp' server directory is hardcoded. This makes the configuration non-portable and will prevent the LSP from working for other users or if the project directory is moved. Configurations should be environment-agnostic.\", \"severity\": \"error\"}]}}}], \"gen_ai.message.index\": 1, \"event.name\": \"gen_ai.assistant.message\"}, {\"content\": \"Final result processed.\", \"role\": \"tool\", \"id\": \"pyd_ai_7e387a4432ab47b2ab4e8279398b570f\", \"name\": \"final_result\", \"gen_ai.message.index\": 2, \"event.name\": \"gen_ai.tool.message\"}]"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"all_messages_events\": {\"type\": \"array\"}, \"final_result\": {\"type\": \"object\"}}}"}},{"key":"logfire.scrubbed","value":{"stringValue":"[{\"path\": [\"attributes\", \"all_messages_events\", 1, \"content\"], \"matched_substring\": \"API_KEY\"}]"}}],"status":{}}]},{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a79943f5cda87ac5e24c1b7657c9c","spanId":"560b9aee259ffa54","parentSpanId":"c69727fa151f4f47","flags":256,"name":"AI analysis completed, found {len(result.output.issues)} issues","kind":1,"startTimeUnixNano":"1762976358163502000","endTimeUnixNano":"1762976358163502000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"AI analysis completed, found {len(result.output.issues)} issues"}},{"key":"logfire.msg","value":{"stringValue":"AI analysis completed, found 1 issues"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"203"}},{"key":"len(result.output.issues)","value":{"intValue":"1"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(result.output.issues)\":{}}}"}}],"status":{}},{"traceId":"019a79943f5cda87ac5e24c1b7657c9c","spanId":"fd8ff70196de91f7","parentSpanId":"c69727fa151f4f47","flags":256,"name":"Found {len(positions)} occurrences of '{snippet[:20]}...'","kind":1,"startTimeUnixNano":"1762976358166132000","endTimeUnixNano":"1762976358166132000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Found {len(positions)} occurrences of '{snippet[:20]}...'"}},{"key":"logfire.msg","value":{"stringValue":"Found 1 occurrences of '/Users/benomahony/Co...'"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.find_snippet_in_text"}},{"key":"code.lineno","value":{"intValue":"151"}},{"key":"len(positions)","value":{"intValue":"1"}},{"key":"snippet[:20]","value":{"stringValue":"/Users/benomahony/Co"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(positions)\":{},\"snippet[:20]\":{}}}"}}],"status":{}},{"traceId":"019a79943f5cda87ac5e24c1b7657c9c","spanId":"c69727fa151f4f47","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976350044363000","endTimeUnixNano":"1762976358166385000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/custom-lsps.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a79945f19e2db25ef047d3ae71b84","spanId":"4b436dcd3325c828","flags":256,"name":"Published {len(diagnostics)} diagnostics for {uri}","kind":1,"startTimeUnixNano":"1762976358169915000","endTimeUnixNano":"1762976358169915000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"5"}},{"key":"logfire.msg_template","value":{"stringValue":"Published {len(diagnostics)} diagnostics for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Published 1 diagnostics for file:///Users/benomahony/.config/nvim/lua/plugins/custom-lsps.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer._delayed_analyze"}},{"key":"code.lineno","value":{"intValue":"181"}},{"key":"len(diagnostics)","value":{"intValue":"1"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/custom-lsps.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"len(diagnostics)\":{},\"uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"b8e1c89ecac846fa84becc16fb9648d1"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"73995"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a799623d87c40089c8dd330b9eb7b","spanId":"be10f5ef8e882e8b","flags":256,"name":"Document opened: {params.text_document.uri}","kind":1,"startTimeUnixNano":"1762976474072770000","endTimeUnixNano":"1762976474072770000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Document opened: {params.text_document.uri}"}},{"key":"logfire.msg","value":{"stringValue":"Document opened: file:///Users/benomahony/.config/nvim/lua/plugins/inlay-hints.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"did_open"}},{"key":"code.lineno","value":{"intValue":"291"}},{"key":"params.text_document.uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/inlay-hints.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"params.text_document.uri\":{}}}"}}],"status":{}},{"traceId":"019a799627c288df20b0ec2392560ccc","spanId":"f761f1cd1a57df07","parentSpanId":"36ee958d165d8097","flags":256,"name":"Starting AI analysis for {uri}","kind":1,"startTimeUnixNano":"1762976475074826000","endTimeUnixNano":"1762976475074826000","attributes":[{"key":"logfire.span_type","value":{"stringValue":"log"}},{"key":"logfire.level_num","value":{"intValue":"9"}},{"key":"logfire.msg_template","value":{"stringValue":"Starting AI analysis for {uri}"}},{"key":"logfire.msg","value":{"stringValue":"Starting AI analysis for file:///Users/benomahony/.config/nvim/lua/plugins/inlay-hints.lua"}},{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"188"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/inlay-hints.lua"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}}],"status":{}}]}]}]}
{"resourceSpans":[{"resource":{"attributes":[{"key":"service.instance.id","value":{"stringValue":"b8e1c89ecac846fa84becc16fb9648d1"}},{"key":"telemetry.sdk.language","value":{"stringValue":"python"}},{"key":"telemetry.sdk.name","value":{"stringValue":"opentelemetry"}},{"key":"telemetry.sdk.version","value":{"stringValue":"1.38.0"}},{"key":"service.name","value":{"stringValue":"ai-lsp"}},{"key":"process.pid","value":{"intValue":"73995"}},{"key":"process.runtime.name","value":{"stringValue":"cpython"}},{"key":"process.runtime.version","value":{"stringValue":"3.13.0"}},{"key":"process.runtime.description","value":{"stringValue":"3.13.0 (main, Oct 16 2024, 08:05:40) [Clang 18.1.8 ]"}},{"key":"service.version","value":{"stringValue":"fee7b6632b1e5cd772ec1b55b25da31016c75755"}}]},"scopeSpans":[{"scope":{"name":"logfire","version":"4.14.2"},"spans":[{"traceId":"019a799627c288df20b0ec2392560ccc","spanId":"36ee958d165d8097","flags":256,"name":"analyze_document","kind":1,"startTimeUnixNano":"1762976475074459000","endTimeUnixNano":"1762976479576553000","attributes":[{"key":"code.filepath","value":{"stringValue":"src/ai_lsp/main.py"}},{"key":"code.function","value":{"stringValue":"AILanguageServer.analyze_document"}},{"key":"code.lineno","value":{"intValue":"187"}},{"key":"uri","value":{"stringValue":"file:///Users/benomahony/.config/nvim/lua/plugins/inlay-hints.lua"}},{"key":"logfire.msg_template","value":{"stringValue":"analyze_document"}},{"key":"logfire.msg","value":{"stringValue":"analyze_document"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\":\"object\",\"properties\":{\"uri\":{}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}}]},{"scope":{"name":"pydantic-ai","version":"0.4.11"},"spans":[{"traceId":"019a799627c288df20b0ec2392560ccc","spanId":"b6bfbec554a278a0","parentSpanId":"36ee958d165d8097","flags":256,"name":"agent run","kind":1,"startTimeUnixNano":"1762976475075650000","endTimeUnixNano":"1762976479576646000","attributes":[{"key":"model_name","value":{"stringValue":"gemini-2.5-flash"}},{"key":"agent_name","value":{"stringValue":"agent"}},{"key":"logfire.msg","value":{"stringValue":"agent run"}},{"key":"logfire.span_type","value":{"stringValue":"span"}}],"status":{}},{"traceId":"019a799627c288df20b0ec2392560ccc","spanId":"d6e10eaa5cee33b2","parentSpanId":"b6bfbec554a278a0","flags":256,"name":"chat gemini-2.5-flash","kind":1,"startTimeUnixNano":"1762976475076331000","endTimeUnixNano":"1762976479576688000","attributes":[{"key":"gen_ai.operation.name","value":{"stringValue":"chat"}},{"key":"gen_ai.system","value":{"stringValue":"google-gla"}},{"key":"gen_ai.request.model","value":{"stringValue":"gemini-2.5-flash"}},{"key":"server.address","value":{"stringValue":"generativelanguage.googleapis.com"}},{"key":"model_request_parameters","value":{"stringValue":"{\"function_tools\": [], \"output_mode\": \"tool\", \"output_object\": null, \"output_tools\": [{\"name\": \"final_result\", \"parameters_json_schema\": {\"properties\": {\"issues\": {\"items\": {\"properties\": {\"issue_snippet\": {\"type\": \"string\"}, \"severity\": {\"enum\": [\"error\", \"warning\", \"info\", \"hint\"], \"type\": \"string\"}, \"message\": {\"type\": \"string\"}, \"suggested_fixes\": {\"items\": {\"properties\": {\"title\": {\"type\": \"string\"}, \"target_snippet\": {\"type\": \"string\"}, \"replacement_snippet\": {\"type\": \"string\"}}, \"required\": [\"title\", \"target_snippet\", \"replacement_snippet\"], \"type\": \"object\"}, \"type\": \"array\", \"nullable\": true}}, \"required\": [\"issue_snippet\", \"severity\", \"message\"], \"type\": \"object\"}, \"type\": \"array\"}}, \"required\": [\"issues\"], \"type\": \"object\"}, \"description\": \"The final response which ends this conversation\", \"outer_typed_dict_key\": null, \"strict\": true, \"kind\": \"output\"}], \"allow_text_output\": false}"}},{"key":"logfire.json_schema","value":{"stringValue":"{\"type\": \"object\", \"properties\": {\"model_request_parameters\": {\"type\": \"object\"}}}"}},{"key":"logfire.span_type","value":{"stringValue":"span"}},{"key":"logfire.msg","value":{"stringValue":"chat gemini-2.5-flash"}},{"key":"gen_ai.response.model","value":{"stringValue":"gemini-2.5-flash"}}],"status":{}}]}]}]}
